---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r}
a <- report_spp1[report_spp1$file_name == unique(report_spp1$file_name)[jj], ]

spp_sci <- a$species_name[1]
spp_sci1 <- a$species_name1[1]
spp_code <- a$species_code # eval(expr = parse(text = a$species_code[1]))
spp_print <- a$print_name[1]
spp_file <- a$file_name[1]

spp_plot_sizecomps <- 
#   ifelse(sizecomp %>% 
#            dplyr::filter(species_code %in% spp_code & 
#                            SRVY == "NBS") %>% 
#            nrow() == 0, 
#     FALSE, 
    a$plot_sizecomps[1]#)
# 
spp_plot_idw <-
#   ifelse(cpue_biomass_station %>%
#     dplyr::ungroup() %>% 
#     dplyr::select(year, stationid, #hauljoin, 
#                   SRVY, cpue_kgha, 
#                   group, species_name) %>%
#     dplyr::filter(!is.na(cpue_kgha)) %>%
#     dplyr::arrange(-year) %>%
#     dplyr::filter(tolower(group) %in% tolower(spp_print) &
#                     year %in% nbsyr) %>% 
#     dplyr::left_join(
#       x = ., 
#       y = station_info %>% 
#         dplyr::select(-reg), 
#       by = c("stationid", "SRVY")) %>% 
#     dplyr::filter(!is.na(latitude) & !is.na(longitude)) %>% 
#            nrow() == 0, 
#          FALSE, 
         a$plot_idw[1]#)
```

## fig_idw_bottemp_[spp]_[above and below]

> thoughts on set.breaks rounding?
> need to figure out NBS issue

```{r fig_idw_bottemp_}
nickname0 <- paste0("fig_idw_bottemp_", spp_file, "_")

  table_raw0 <- cpue %>%
      dplyr::filter(!is.na(cpue_kgha)) %>% 
      dplyr::arrange(-year) %>% 
    dplyr::filter(common_name %in% spp_common & 
                    year %in% unlist(temps_avg_yr_abovebelow))
  
  # set.breaks <- quantile(table_raw0$cpue_kgha, probs = c(0, .25, .5, .75, .95))
  # set.breaks <- round(set.breaks, digits = ifelse(max(set.breaks)>100, 0, 1))
  set.breaks <- quantile(table_raw0$cpue_kgha, probs = c(0, .95))
    set.breaks <- plyr::round_any(x = set.breaks, 
                                  accuracy = ifelse(max(set.breaks)>300, 100, ifelse(max(set.breaks)>100, 50, 10)),
                                  f = ceiling)
    set.breaks <- seq(from = min(set.breaks), to = max(set.breaks), length.out = 5)


for (i in 1:2) { # two cases, above and below
  subobj <- TRUE
  newobj <- ifelse(i==1, TRUE, FALSE)
  TF <- ifelse(i==1, FALSE, TRUE)
  case <- ifelse(i==1, "below", "above")
  
  header <- paste0("Contour maps of ",spp_common," (*",spp_sci,
                   "*) distribution and relative abundance (kg/ha) from the ",
                   NMFSReports::text_list(sort(temps_avg_yr_abovebelow[,case])),
                   " Bering Sea shelf bottom trawl surveys, which were years when the survey mean bottom temperature was ",
                   case,
                   " the long-term stratum area-weighted mean.")
  nickname <- paste0(nickname0, case)

  table_raw <- table_raw0 %>% 
    dplyr::filter(year %in% temps_avg_yr_abovebelow[,case])
  
  figure <- plot_idw_xbyx(
    yrs = temps_avg_yr_abovebelow[,case],
    dat = table_raw,
    cruises = cruises,
    lat = "latitude",
    lon = "longitude",
    var = "cpue_kgha",
    grid = "continuous.grid",
    extrap.box = extrap.box,
    key.title = "Relative Abundance (kg/ha)",
    workfaster = workfaster,
    SRVY = SRVY, 
    set.breaks = set.breaks)
  
  # figure <- plot(1,1)

  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_figures[nickname][[1]][[1]]$res <- res <- paste0("
###### 

",res,"

")

}
    
    
    
    
    
    
    # Temperature break value -- Add a loop here for the temperatures you need
library(coldpool)
library(akgfmaps)

nbs_ebs_layers <- akgfmaps::get_base_layers(select.region = "ebs",
                                            set.crs = coldpool:::ebs_proj_crs)

year_vec <- as.numeric(gsub("[^0-9.-]", "", names(coldpool:::nbs_ebs_bottom_temperature)))

coords <- raster::coordinates(coldpool:::nbs_ebs_bottom_temperature)

for(i in 1:length(year_vec)) {
  sel_layer_df <- data.frame(x = coords[,1],
                             y = coords[,2],
                             temperature = coldpool:::nbs_ebs_bottom_temperature@data@values[,i])
  sel_layer_df <- sel_layer_df[!is.na(sel_layer_df$temperature),]
  sel_layer_df$year <- year_vec[i]
  
  if(i == 1) {
    bt_year_df <- sel_layer_df
  } else{
    bt_year_df <- dplyr::bind_rows(bt_year_df, sel_layer_df)
  }
}

# Union to combine strata 31, 32 into 30, etc.
nbs_ebs_agg_strata <- nbs_ebs_layers$survey.strata %>%
  dplyr::mutate(agg_stratum = Stratum) %>%
  dplyr::mutate(agg_stratum = replace(agg_stratum, agg_stratum %in% c(31,32), 30),
                agg_stratum = replace(agg_stratum, agg_stratum %in% c(41,42,43), 40),
                agg_stratum = replace(agg_stratum, agg_stratum %in% c(61,62), 60)) %>% 
  dplyr::group_by(agg_stratum) %>% 
  dplyr::summarise()

panel_extent <- data.frame(y = c(53, 67),
                           x = c(-174, -156)) %>%
  akgfmaps::transform_data_frame_crs(out.crs = coldpool:::ebs_proj_crs)

# Temperature break value -- Add a loop here for the temperatures you need
temp_break <- 2

ggplot2::ggplot() +
  ggplot2::geom_sf(data = nbs_ebs_layers$akland, 
                   fill = "grey70", 
                   color = "black") +
  ggplot2::geom_sf(data = nbs_ebs_layers$survey.area, fill = "grey65") +
  ggplot2::geom_tile(data = bt_year_df %>%
                       dplyr::filter(year == 2021, 
                                     temperature <= temp_break),
                     aes(x = x,
                         y = y),
                     fill = "magenta",
                     alpha = 0.5) +
  ggplot2::geom_contour(data = bt_year_df %>%
                          dplyr::filter(year == 2021),
                        aes(x = x,
                            y = y,
                            z = temperature),
                        breaks = 2,
                        color = "magenta",
                        size = rel(1.1)) +
  ggplot2::geom_sf(data = nbs_ebs_agg_strata, 
                   fill = NA,
                   color = "black") +
  ggplot2::geom_text(data = data.frame(x = -158.5, 
                                       y = 62.4, 
                                       lab = "Alaska") %>%
                       akgfmaps::transform_data_frame_crs(out.crs = coldpool:::ebs_proj_crs),
                     mapping = aes(x = x,
                                   y = y,
                                   label = lab),
                     size = rel(8)) +
  ggplot2::coord_sf(xlim = panel_extent$x, 
                    ylim = panel_extent$y) +
  ggplot2::scale_x_continuous(name = "Longitude", 
                              breaks = nbs_ebs_layers$lon.breaks) + 
  ggplot2::scale_y_continuous(name = "Latitude", 
                              breaks = nbs_ebs_layers$lat.breaks) +
  theme_bw() +
  ggplot2::theme(axis.title = element_blank(),
                 axis.text = element_text(color = "black"),
                 axis.ticks = element_line(color = "black"),
                 panel.border = element_rect(color = "black", fill = NA),
                 panel.background = element_rect(color = "black", fill = NA),
                 legend.key.width = unit(12, "mm"),
                 legend.position = "none",
                 legend.direction = "horizontal", 
                 plot.margin = unit(c(5.5, 5.5,-25,5.5), units = "pt"))


```


## tab_cpue_biomass_[spp]

```{r tab_majortaxa_pchange}
nickname <- paste0("tab_cpue_biomass_", spp_file) 
header <- "Mean CPUE by weight (kg/ha) with standard deviation, and estimated biomass (t) with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for walleye pollock (Gadus chalcogrammus) by stratum for the 2017 eastern and northern Bering Sea bottom trawl surveys. Differences in sums of estimates and totals are due to rounding."

table_raw <- table_print <- data.frame(
  x = 1, 
  y = 1, 
  label = "This is a placeholder")

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```
