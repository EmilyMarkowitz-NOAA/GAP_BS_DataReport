---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

## vars

```{r vars}
a <- report_spp1[report_spp1$file_name == unique(report_spp1$file_name)[jj], ]

spp_sci <- a$species_name[1]
spp_sci1 <- a$species_name1[1]
spp_code <- unique(a$species_code0) # eval(expr = parse(text = a$species_code[1]))
spp_print <- a$print_name[1]
spp_file <- a$file_name[1]
spp_taxon <- a$taxon[1]

spp_plot_sizecomp <- nrow(length_maxyr[length_maxyr$species_code %in% spp_code,]) > 0 # ifelse(is.na(a$plot_sizecomp[1]), FALSE, a$plot_sizecomp[1])
spp_plot_idw <- ifelse(is.na(a$plot_idw[1]), FALSE, a$plot_idw[1])
spp_plot_pa <- ifelse(is.na(a$plot_pa[1]), FALSE, a$plot_pa[1])
spp_plot_idw_coldwarm <- ifelse(is.na(a$plot_idw_coldwarm[1]), FALSE, a$plot_idw_coldwarm[1])
spp_plot_idw <- ifelse(spp_plot_idw_coldwarm, TRUE, spp_plot_idw)
spp_table_cpue <- ifelse(is.na(a$table_cpue[1]), FALSE, a$table_cpue[1])
text_spp <- ifelse(is.na(a$text_spp[1]), FALSE, a$text_spp[1])

negative <- "#EDA247"
positive <- "#57C4AD"
neutral <- "#E6E1BC"

```

## fig_pres_biomass_

```{r, fig_pres_biomass_}

height <- 4
width <- 6

nickname <- paste0("fig_pres_",spp_file,"_biomass")

# Biomass
bio <- biomass %>%
  dplyr::filter(stratum == 999 & species_code %in% spp_code) %>% 
  dplyr::select(SRVY, year, species_code, upperb, lowerb, varbio, biomass, taxon) %>% 
  dplyr::rename(y = biomass, 
                lower = lowerb, 
                upper = upperb, 
                var = varbio) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY")  %>% 
  dplyr::left_join(x = . , 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1) ,
                   by = "species_code")  %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long)) 

y_long <- "Biomass"
a <- table_change_pres(dat = bio, 
                       yrs = sort(yrs, decreasing = TRUE), 
                       maxyr = maxyr, 
                       compareyr = compareyr, 
                       unit = "metric tons", 
                       unt = "mt", 
                       y_long = y_long, 
                       digits = 2)

b <- a$table_raw %>% 
  dplyr::arrange(Survey) %>% 
  dplyr::mutate(dplyr::across(dplyr::starts_with("20"), gsub, pattern = ",", replace = "")) %>% 
  dplyr::filter(Survey %in% SRVY1)

for (i in which(colnames(b) %in% yrs)) {
  for (ii in 1:nrow(b)) {
    temp <- find_units(dat = as.numeric(b[ii,i]))
    b[ii,i] <- paste0(formatC(x = as.numeric(b[ii,i])/temp$divby, 
                              digits = ifelse(temp$divby>1, 0, 1), 
                              big.mark = ",", format = "f", 
                              drop0trailing = TRUE), 
                      temp$unit_wrd)
  }
}


for (i in (grep(pattern = "change_", x = names(b)))) {
  for (ii in 1:nrow(b)) {
    # temp <- find_units(dat = as.numeric(b[ii,i]))
    b[ii,i] <- paste0(formatC(x = as.numeric(b[ii,i]), 
                              digits = ifelse(as.numeric(b[ii,i]) < 10 & as.numeric(b[ii,i]) >=-10, 2, 1), 
                              # digits = ifelse(b[ii,i]>10, 0, 1), 
                              big.mark = ",", format = "f", 
                              drop0trailing = TRUE), 
                      temp$unit_wrd)
  }
}

# find_units(dat = b$`2010`[1])

header <- NMFSReports::text_list(paste0("**", b$Survey, " ", y_long, "** ", 
                                        unlist(b[grep(pattern = as.character(maxyr), 
                                                      x = names(b))[1]]), 
                                        " ", a$unt, " (",
                                        unlist(b[grep(pattern = paste0("_", maxyr), 
                                                      x = names(b))]), 
                                        "%) from ", max(yrs[yrs != maxyr]), 
                                        " ", 
                                        unlist(b[grep(pattern = as.character(max(yrs[yrs != maxyr])), 
                                                      x = names(b))[1]]), 
                                        " ", a$unt, "")) # , sep_last = "\n\n"

if (length(spp_code)>1) {
  bio <- bio %>%
    dplyr::group_by(SRVY, year, SRVY_long) %>%
    dplyr::summarise(y = sum(y),
                     var = sum(var),
                     upper = mean(upper),
                     lower = mean(upper))
}

figure <- plot_timeseries(dat = bio,
                          unit = "metric tons",
                          unt = "mt",
                          y_long = "biomass",
                          error_bar = ifelse(length(spp_code)>1, FALSE, TRUE),
                          spp_print = spp_print)



# descr <- ggdraw() + draw_label(label = paste0(b$Survey, " ", y_long, "\n", 
#                                         unlist(b[grep(pattern = as.character(maxyr), 
#                                                                 x = names(b))[1]]), 
#                                         " ", a$unt, " (",
#                                         unlist(b[grep(pattern = paste0("_", maxyr), 
#                                                                 x = names(b))]), 
#                                         "%)\nfrom ", max(yrs[yrs != maxyr]), 
#                                         "\n", 
#                                         unlist(b[grep(pattern = as.character(max(yrs[yrs != maxyr])), 
#                                                                 x = names(b))[1]]), 
#                                         " ", a$unt, ""), 
#                                fontface='bold', color = "#00467f")

text0 <- 
  c(paste0(b$Survey, " ", y_long), 
    paste0(maxyr, ": ", unlist(b[grep(pattern = as.character(maxyr), 
                                      x = names(b))[1]]), 
           " ", a$unt), 
    paste0(max(yrs[yrs != maxyr]), 
           ": ", 
           unlist(b[grep(pattern = as.character(max(yrs[yrs != maxyr])), 
                         x = names(b))[1]]), 
           " ", a$unt, ""), 
    
    
    ifelse(unlist(b[grep(pattern = paste0("_", maxyr), x = names(b))]) == "Inf", 
           "", 
           paste0("(",
                  unlist(b[grep(pattern = paste0("_", maxyr), 
                                x = names(b))]), 
                  "%)")))

descr <- ggdraw() + draw_text(text = text0, 
                              fontface=c('bold', "plain", "plain", "plain"), 
                              y = seq(from = 0.8, to = ifelse(length(text0)>4, 0.4, 0.6), 
                                      length.out = length(text0)),
                              color = c("#00467f", "#00467f", "#00467f", 
                                        ifelse(grepl(pattern = "-", 
                                                     x = unlist(b[grep(pattern = paste0("_", maxyr), x = names(b))])), 
                                               "red", 
                                               "#006400"# "green"
                                        )))

figure <- cowplot::plot_grid(figure, descr, nrow = 1, rel_widths = c(1, .4))

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_pres_abundance_

```{r, fig_pres_abundance_}

height <- 4
width <- 6

nickname <- paste0("fig_pres_",spp_file,"_abundance")

# Abundance
pop <- biomass %>%
  dplyr::filter(stratum == 999) %>%
  dplyr::select(SRVY, year, species_code, upperp, lowerp, varpop, population, taxon) %>%
  dplyr::filter(species_code %in% spp_code) %>% 
  dplyr::rename(y = population,
                lower = lowerp,
                upper = upperp,
                var = varpop) %>%
  dplyr::left_join(x = . ,
                   y = haul_cruises_maxyr %>%
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::left_join(x = . , 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1) ,
                   by = "species_code")  %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))

y_long <- "Abundance"
a <- table_change_pres(dat = pop, 
                       yrs = yrs, 
                       maxyr = maxyr, 
                       compareyr = compareyr, 
                       unit = "individuals", 
                       unt = "", 
                       y_long = y_long, 
                       digits = 0)

b <- a$table_raw %>% 
  dplyr::arrange(Survey) %>% 
  dplyr::mutate(dplyr::across(dplyr::starts_with("20"), 
                              gsub, pattern = ",", replace = "")) %>% 
  dplyr::filter(Survey %in% SRVY1)

for (i in which(colnames(b) %in% yrs)) {
  for (ii in 1:nrow(b)) {
    temp <- find_units(dat = as.numeric(b[ii,i]))
    b[ii,i] <- paste0(formatC(x = as.numeric(b[ii,i])/temp$divby, 
                              digits = ifelse(temp$divby>1, 0, 1), 
                              big.mark = ",", format = "f", 
                              drop0trailing = TRUE), 
                      temp$unit_wrd)
  }
}


for (i in (grep(pattern = "change_", x = names(b)))) {
  for (ii in 1:nrow(b)) {
    # temp <- find_units(dat = as.numeric(b[ii,i]))
    b[ii,i] <- paste0(formatC(x = as.numeric(b[ii,i]), 
                              digits = ifelse(as.numeric(b[ii,i]) < 10 & as.numeric(b[ii,i]) >= -10, 2, 1), 
                              big.mark = ",", format = "f", 
                              drop0trailing = TRUE))
  }
}

# find_units(dat = b$`2010`[1])

header <- NMFSReports::text_list(paste0("**", b$Survey, " ", y_long, "** ", 
                                        unlist(b[grep(pattern = as.character(maxyr), 
                                                      x = names(b))[1]]), 
                                        a$unt, " (",
                                        unlist(b[grep(pattern = paste0("_", maxyr), 
                                                      x = names(b))]), 
                                        "%) from ", max(yrs[yrs != maxyr]), 
                                        " ", 
                                        unlist(b[grep(pattern = as.character(max(yrs[yrs != maxyr])), 
                                                      x = names(b))[1]]), 
                                        a$unt, "")) # , sep_last = "\n\n"

if (length(spp_code)>1) {
  pop <- pop %>% 
    dplyr::group_by(SRVY, year, SRVY_long) %>%
    dplyr::summarise(y = sum(y), 
                     var = sum(var), 
                     upper = mean(upper), 
                     lower = mean(upper))
}

figure <- plot_timeseries(dat = pop,
                          unit = "", 
                          unt = "",
                          y_long = "abundance",
                          error_bar = ifelse(length(spp_code)>1, FALSE, TRUE), 
                          spp_print = spp_print)

text0 <- c(paste0(b$Survey, " ", y_long), 
           paste0(maxyr, ": ", unlist(b[grep(pattern = as.character(maxyr), 
                                             x = names(b))[1]]), 
                  " ", a$unt), 
           paste0(max(yrs[yrs != maxyr]), 
                  ": ", 
                  unlist(b[grep(pattern = as.character(max(yrs[yrs != maxyr])), 
                                x = names(b))[1]]), 
                  " ", a$unt, ""), 
           paste0("(",
                  unlist(b[grep(pattern = paste0("_", maxyr), 
                                x = names(b))]), 
                  "%)"))

descr <- ggdraw() + draw_text(text = text0, 
                              fontface=c('bold', "plain", "plain", "plain"), 
                              y = seq(from = 0.8, to = ifelse(length(text0)>4, 0.4, 0.6), 
                                      length.out = length(text0)),
                              color = c("#00467f", "#00467f", "#00467f", 
                                        ifelse(grepl(pattern = "-", 
                                                     x = unlist(b[grep(pattern = paste0("_", maxyr), x = names(b))])), 
                                               "red", "green")))

figure <- cowplot::plot_grid(figure, descr, nrow = 1, rel_widths = c(1, .4))

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_pres_sizecomp_[spp]


```{r fig_pres_sizecomp_}

if (spp_plot_sizecomp) {
  
  height <- 6
  width <- 6.5
  header <- ""
  nickname <- paste0("fig_pres_",spp_file,"_lengths")
  
  
  length_data0 <- length_data %>%
    dplyr::filter(species_code %in% spp_code) %>% 
    dplyr::select(SRVY, species_code, frequency, sex, length,
                  length_type, length_type, name, year, 
                  sentancefrag) %>%
    dplyr::filter(species_code %in% spp_code)
  
  sizecomp0 <- sizecomp %>% 
    dplyr::left_join(x = ., 
                     y = report_spp1 %>% 
                       dplyr::select(print_name, species_code, species_name1), 
                     by = "species_code") %>% 
    dplyr::filter(print_name == spp_print) %>% 
    dplyr::left_join(x = . , 
                     y = haul_cruises_maxyr %>% 
                       dplyr::select(SRVY, SRVY_long),
                     by = "SRVY") %>% 
    dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long)) %>% 
    dplyr::filter(species_code %in% spp_code)
  
  header <- paste0("Total abundance-at-length estimates of ",
                   spp_print, ifelse(is.na(spp_sci), "", 
                                     paste0(" (",spp_sci,")")), 
                   ifelse(SRVY %in% c("NEBS", "NBS"), 
                          paste0(" by sex (",NMFSReports::text_list(tolower(unique(sizecomp0$sex))), ")"), 
                          ""), 
                   " observed during the ",
                   NMFSReports::text_list(unique(sizecomp0$SRVY)), 
                   " shelf bottom trawl survey", 
                   ifelse(length(unique(sizecomp0$SRVY))==1 & length(unique(sizecomp0$year))==1, "", "s"),
                   ".")
  
  if (nrow(sizecomp0) != 0) {
    
    # get size unit/type
    if (tolower(spp_print) %in% c("red king crab", "blue king crab")) {
      type <- "carapace lengths"
    } else   if (tolower(spp_print) %in% c("snow crab")) {
      type <- "carapace widths"
    } else {
      type <- unique(length_data0$sentancefrag)
    }
    
    if (sum(length_data0$SRVY == "NBS")>0) {
      length_data_nbs <- length_data0 %>%
        dplyr::filter(SRVY %in% "NBS" & 
                        year %in% yrs)
      
      sizecomp_nbs <- sizecomp0 %>% 
        dplyr::filter(SRVY %in% "NBS" & 
                        year %in% yrs)  
      
      figure1 <- plot_sizecomp(
        sizecomp0 = sizecomp_nbs,
        length_data0 = length_data_nbs, 
        spp_code = spp_code,
        spp_print = paste0("NBS ", spp_print), 
        type = type, 
        print_n = FALSE)
    }
    
    if (sum(length_data0$SRVY == "EBS")>0) {
      length_data_ebs <- length_data0 %>%
        dplyr::filter(SRVY %in% "EBS")
      
      sizecomp_ebs <- sizecomp0 %>% 
        dplyr::filter(SRVY %in% "EBS") 
      
      figure2 <- plot_sizecomp(
        sizecomp0 = sizecomp_ebs,
        length_data0 = length_data_ebs, 
        spp_code = spp_code,
        spp_print = paste0("EBS ", spp_print), 
        type = type, 
        print_n = FALSE, 
        ridgeline = TRUE)
    }
    
    
    
    if (sum(length_data0$SRVY == "EBS")>0 & 
        sum(length_data0$SRVY == "NBS")>0) {
      figure <- cowplot::plot_grid(figure1, figure2, nrow = 1)
    } else if (sum(length_data0$SRVY == "EBS")>0) {
      figure <- figure2
    } else if (sum(length_data0$SRVY == "NBS")>0) {
      figure <- figure1
    }
    
    # save yo' stuff and do a lot of behind the scenes work
    # alt: this does the same thing as calling "child = " in the chunk header
    res <- knitr::knit_child(
      text = knitr::knit_expand(
        file = system.file("rmd/_child_save_fig.Rmd", 
                           package = "NMFSReports")), 
      quiet = TRUE
    )
    
    list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")
  }
}

```

## fig_pres_idw/pa_cpue_[spp]

```{r fig_pres_idw_cpue_[spp]}

if (spp_plot_idw | spp_plot_pa) {
  
  # yrs <- yrs[(length(yrs)-4):length(yrs)]
  
  nickname <- paste0("fig_pres_", spp_file, "_", 
                     ifelse(spp_plot_pa, "presence", "distribution"))
  
  height <- 4 #ifelse(SRVY == "NEBS", 5.5, 4.25) 
  width <- full_page_portrait_width # 6.5
  
  if (spp_plot_idw) {
    
    table_raw <- cpue %>%
      dplyr::filter(!is.na(cpue_kgha) & 
                      cpue_kgha != 0 & 
                      species_code %in% spp_code & 
                      year %in% yrs) %>% 
      dplyr::arrange(desc(year))
    
    spp_plot_pa <- ifelse(nrow(table_raw)<2, TRUE, spp_plot_pa)
    spp_plot_idw <- ifelse(isTRUE(spp_plot_pa), FALSE, spp_plot_idw)
  } 
  
  
  if (spp_plot_pa) {
    
    table_raw <- catch_haul_cruises %>%
      dplyr::filter(!is.na(number_fish) & 
                      number_fish != 0 & 
                      species_code %in% spp_code & 
                      year %in% yrs) %>% 
      dplyr::arrange(desc(year))
    
  }
  
  # only if both species re only found in prt of the region, chnge the extrp.box
  map.area0 <- map.area
  reg_dat0 <- reg_dat
  if (length(unique(table_raw$SRVY))==1 & SRVY == "NEBS") { # is this species in only 1 of the 2 survey areas (when SRVY == NEBS)?
    map.area0 <- ifelse(unique(table_raw$SRVY) == "EBS", "bs.south", "bs.north")
    reg_dat0 <- report_types[[unique(table_raw$SRVY)]]$reg_dat
    survey_reg_col <- gray.colors(length(unique(reg_dat0$survey.area$SURVEY))+2)
    survey_reg_col <- survey_reg_col[-((length(survey_reg_col)-1):length(survey_reg_col))]
    reg_dat0$survey.area <- reg_dat0$survey.area %>%
      dplyr::mutate(
        SRVY = dplyr::case_when(
          SURVEY == "EBS_SHELF" ~ "EBS", 
          SURVEY == "NBS_SHELF" ~ "NBS"), 
        color = alpha(colour = survey_reg_col, 0.7), 
        SRVY_long = dplyr::case_when(
          SRVY == "EBS" ~ "Eastern Bering Sea", 
          SRVY == "NBS" ~ "Northern Bering Sea"))
    height <- ifelse(reg_dat0$survey.area$SURVEY == "EBS_SHELF", 4.25, 3.5)
  }
  
  if (spp_plot_idw) {
    
    header <- paste0(stringr::str_to_sentence(spp_print), ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")")), 
                     " distribution and relative biomass (kg/ha) from the ",
                     compareyr," (left) and ",maxyr,
                     " (right) ", NMFSReports::text_list(unique(table_raw$SRVY)),  " shelf bottom trawl survey", 
                     ifelse(length(unique(table_raw$SRVY))>1, "s", ""),".")
    set.breaks <- set_breaks(dat = table_raw, var = "cpue_kgha")
    
    table_raw <- dplyr::left_join(
      x = cpue %>%
        dplyr::filter(year %in% yrs & 
                        SRVY %in% SRVY1) %>%
        dplyr::select(year, SRVY, stratum, stationid, latitude, longitude) %>% 
        dplyr::distinct(), 
      y = table_raw, 
      by  = c("year", "SRVY", "stratum", "stationid", "latitude", "longitude")) %>% 
      dplyr::mutate(cpue_kgha = ifelse(is.na(cpue_kgha), 0, cpue_kgha))
    
    figure <- plot_idw_xbyx(
      yrs = yrs,
      dat = table_raw, 
      lat = "latitude",
      lon = "longitude",
      var = "cpue_kgha",
      year = "year",
      grid = "extrapolation.grid",
      reg_dat = reg_dat0, 
      region = map.area0, 
      key.title = paste0(stringr::str_to_sentence(spp_print), "\nrelative biomass (kg/ha)"),
      set.breaks = set.breaks,
      row0 = 1)
    
  } else if (spp_plot_pa) {
    header <- paste0(stringr::str_to_sentence(spp_print), ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")")), 
                     " presence from the ",
                     compareyr," (left) and ",maxyr,
                     " (right) ", NMFSReports::text_list(unique(table_raw$SRVY)),  " shelf bottom trawl survey", 
                     ifelse(length(unique(table_raw$SRVY))>1, "s", ""),
                     ". This species has not been caught in enough quantity or at enough stations to adequately characterize a distribution.")
    
    
    table_raw <- catch_haul_cruises %>% 
      dplyr::select(SRVY, year, start_latitude, start_longitude, number_fish, species_code) %>% 
      dplyr::rename(latitude = start_latitude, 
                    longitude = start_longitude) %>% 
      dplyr::filter(!is.na(number_fish) &
                      number_fish != 0 &
                      species_code == spp_code & 
                      year %in% yrs &
                      SRVY %in% unique(table_raw$SRVY))
    
    figure <- plot_pa_xbyx(
      yrs = yrs,
      dat = table_raw,
      lat = "latitude",
      lon = "longitude",
      year = "year",
      reg_dat = reg_dat0, 
      key.title = paste0(stringr::str_to_sentence(spp_print), " presence"),
      row0 = 1)
    
  }
  
  height0 <- height
  width0 <- width
  nickname0 <- nickname
  table_raw0 <- table_raw
  header0 <- header
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res
  
}

```



## fig_pres_idw/pa_cpue_[spp]_cold_pool

```{r fig_pres_idw_cpue_[spp]_cold_pool}

if (spp_plot_idw | spp_plot_pa) {
  
  # yrs <- yrs[(length(yrs)-4):length(yrs)]
  
  nickname <- paste0(nickname0, 
                     "_cold_pool")
  height <- height0
  width <- width0
  table_raw <- table_raw0
  header <- paste0(header0, " A yellow outline of the cold pool is featured for reference. ")
  
  if (spp_plot_idw) {
    
    figure <- plot_idw_xbyx(
      yrs = yrs,
      dat = table_raw, 
      lat = "latitude",
      lon = "longitude",
      var = "cpue_kgha",
      year = "year",
      grid = "extrapolation.grid",
      reg_dat = reg_dat0, 
      region = map.area0, 
      key.title = paste0(stringr::str_to_sentence(spp_print), "\nrelative biomass (kg/ha)"),
      set.breaks = set.breaks,
      row0 = 1, 
      plot_coldpool = TRUE)
    
  } else if (spp_plot_pa) {
    
    figure <- plot_pa_xbyx(
      yrs = yrs,
      dat = table_raw0,
      lat = "latitude",
      lon = "longitude",
      year = "year",
      reg_dat = reg_dat0, 
      key.title = paste0(stringr::str_to_sentence(spp_print), " presence"),
      row0 = 1, 
      plot_coldpool = TRUE)
    
  }
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res
  
}

```