---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r}
a <- report_spp1[report_spp1$file_name == unique(report_spp1$file_name)[jj], ]

spp_sci <- a$species_name[1]
spp_sci1 <- a$species_name1[1]
spp_code <- a$species_code # eval(expr = parse(text = a$species_code[1]))
spp_print <- a$print_name[1]
spp_file <- a$file_name[1]

spp_plot_sizecomps <- 
#   ifelse(sizecomp %>% 
#            dplyr::filter(species_code %in% spp_code & 
#                            SRVY == "NBS") %>% 
#            nrow() == 0, 
#     FALSE, 
    a$plot_sizecomp[1]#)
# 
spp_plot_idw <-
#   ifelse(cpue_biomass_station %>%
#     dplyr::ungroup() %>% 
#     dplyr::select(year, stationid, #hauljoin, 
#                   SRVY, cpue_kgha, 
#                   group, species_name) %>%
#     dplyr::filter(!is.na(cpue_kgha)) %>%
#     dplyr::arrange(-year) %>%
#     dplyr::filter(tolower(group) %in% tolower(spp_print) &
#                     year %in% nbsyr) %>% 
#     dplyr::left_join(
#       x = ., 
#       y = station_info %>% 
#         dplyr::select(-reg), 
#       by = c("stationid", "SRVY")) %>% 
#     dplyr::filter(!is.na(latitude) & !is.na(longitude)) %>% 
#            nrow() == 0, 
#          FALSE, 
         ifelse(sum(a$plot_idw[1], a$plot_idw_coldwarm[1], na.rm = TRUE)>0, TRUE, FALSE)
```

```{r}
# find basic info about species
haul0 <- catch_haul_cruises %>% 
    dplyr::select("stationid", "stratum", "start_latitude", "start_longitude", 
                  "bottom_depth", "gear_temperature" ,"surface_temperature", 
                  "survey_name", "SRVY", "year", "species_code", 
                  "weight", "number_fish", "hauljoin")

haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY_long == "eastern Bering Sea"] <- "southeastern Bering Sea"

# Biomass
bio <- biomass %>%
  dplyr::filter(stratum == 999) %>% 
  dplyr::select(SRVY, year, species_code, upperb, lowerb, varbio, biomass, taxon) %>% 
  dplyr::left_join(x = ., 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1), 
                   by = "species_code") %>% 
  dplyr::filter(print_name == spp_print) %>% 
  dplyr::rename(y = biomass, 
                lower = lowerb, 
                upper = upperb, 
                var = varbio) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))


# Abundance
pop <- biomass %>%
  dplyr::filter(stratum == 999) %>% 
  dplyr::select(SRVY, year, species_code, upperp, lowerp, varpop, population, taxon) %>% 
  dplyr::left_join(x = ., 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1), 
                   by = "species_code") %>% 
  dplyr::filter(print_name == spp_print) %>% 
  dplyr::rename(y = population, 
                lower = lowerp, 
                upper = upperp, 
                var = varpop) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))

# Lengths
lengths <- length_data %>% 
  dplyr::filter(species_code %in% spp_code) %>% 
  dplyr::select(SRVY, species_code, frequency, sex, length,
                sample_type, length_type, name, year, 
                sentancefrag)

# Size Comps
sizec <- sizecomp %>% 
  dplyr::left_join(x = ., 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1), 
                   by = "species_code") %>% 
  dplyr::filter(print_name == spp_print) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))

```

> var or upper lower?

## fig_biomass_

```{r, fig_biomass_}
header <- ""
nickname <- paste0("fig_biomass_", spp_file)

height <- 4
width <- 6

figure <- plot_timeseries(dat = bio, 
                          unit = "metric tons", 
                          unt = "mt", 
                          y_long = "Biomass")
# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## tab_biomass_

```{r tab_biomass_}
nickname <- paste0("tab_biomass_", spp_file)
header <- ""

table_print <- table_change_pres(dat = bio, 
                  yrs = nbsyr, 
                  maxyr = maxyr, 
                  compareyr = compareyr, 
                  unit = "metric tons", 
                  unt = "mt", 
                  y_long = "Biomass")


  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```


## fig_abund_

> pop?

```{r, fig_abund_}
header <- ""
nickname <- paste0("fig_abund_", spp_file)

height <- 4
width <- 6

figure <- plot_timeseries(dat = pop, 
                          unit = "", 
                          unt = "", 
                          y_long = "Abundance")
# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## tab_abund_

```{r tab_abund_}
nickname <- paste0("tab_abund_", spp_file)
header <- ""

table_print <- table_change_pres(dat = pop, 
                  yrs = nbsyr, 
                  maxyr = maxyr, 
                  compareyr = compareyr, 
                          unit = "", 
                          unt = "", 
                          y_long = "Abundance")


  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_sizecomp_nbs_[spp]


```{r fig_sizecomp_nbs_}
if (spp_plot_sizecomps) {
 
  height <- 5
  width <- 3
  header <- ""
  nickname <- paste0("fig_sizecomp_nbs_", spp_file)

  length_data0 <- lengths %>%
      dplyr::filter(species_code %in% spp_code &
                      SRVY %in% "NBS" & 
                      year %in% nbsyr)
  
  
  sizecomp0 <- sizec %>% 
      dplyr::filter(species_code %in% spp_code &
                      SRVY %in% "NBS" & 
                      year %in% nbsyr)    
  
  
  # get size unit/type
  if (tolower(spp_print) %in% c("red king crab", "blue king crab")) {
    type <- "carapace lengths"
  } else   if (tolower(spp_print) %in% c("snow crab")) {
    type <- "carapace widths"
  } else {
    type <- unique(length_data0$sentancefrag)
  }
  
  figure <- plot_sizecomp(
    sizecomp0 = sizecomp0,
    length_data0 = length_data0, 
    SRVY1 = "NBS",
    spp_code = spp_code,
    spp_print = spp_print, 
    type = type, 
    print_n = TRUE)
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")
}
```

## fig_sizecomp_ebs_[spp]

```{r fig_sizecomp_ebs_}
if (spp_plot_sizecomps) {
 
  height <- 5
  width <- 3
  header <- ""
  nickname <- paste0("fig_sizecomps_ebs_", spp_file)

  length_data0 <- lengths %>%
      dplyr::filter(species_code %in% spp_code &
                      SRVY %in% "EBS")
  
  
  sizecomp0 <- sizec %>% 
      dplyr::filter(species_code %in% spp_code &
                      SRVY %in% "EBS")    
  
  
  # get size unit/type
  if (tolower(spp_print) %in% c("red king crab", "blue king crab")) {
    type <- "carapace lengths"
  } else   if (tolower(spp_print) %in% c("snow crab")) {
    type <- "carapace widths"
  } else {
    type <- unique(length_data0$sentancefrag)
  }
  
  figure <- plot_sizecomp(
    sizecomp0 = sizecomp0,
    length_data0 = length_data0, 
    SRVY1 = "EBS",
    spp_code = spp_code,
    spp_print = spp_print, 
    type = type, 
    print_n = FALSE, 
    ridgeline = TRUE)
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")
}
```


## fig_idw_[spp]

```{r fig_idw_}
if (spp_plot_idw) {
  
  nickname <- paste0("fig_idw_", spp_file)
  header <- ""
  
  height <- ifelse(pres_img, 4, 5.5)# ifelse(length(names(nbsyr))>=4, 6, 3)
  width <- ifelse(pres_img, 9, 4)
  
  # table_raw <- table_print <- data.frame(
  #   x = 1,
  #   y = 1,
  #   label = "This is a placeholder")
  # 
  # figure <- ggplot(data = table_raw,
  #                  mapping = aes(x = x, y = y))

  
  table_raw <- cpue %>% 
    dplyr::select(year, stationid, #hauljoin,
                  SRVY, cpue_kgha, species_code, 
                  latitude, longitude)  %>% 
  dplyr::left_join(x = ., 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1), 
                   by = "species_code") %>% 
  dplyr::filter(print_name == spp_print) %>% 
  # dplyr::rename(y = cpue_kgha) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long)) %>%
  dplyr::filter(!is.na(cpue_kgha),
                  # tolower(species_name) %in% tolower(report_spp1$species_name[jj]) &
                  year %in% nbsyr) %>%
    dplyr::arrange(-year) %>%
    dplyr::filter(!is.na(latitude) & !is.na(longitude)) %>%
    dplyr::ungroup()
  
  

  # table_raw <- cpue_biomass_station %>%
  #   dplyr::ungroup() %>%
  #   dplyr::select(year, stationid, #hauljoin,
  #                 SRVY, cpue_kgha,
  #                 group, species_name,
  #                 latitude, longitude) %>%
  #   dplyr::filter(!is.na(cpue_kgha),
  #                 tolower(species_name) %in% tolower(report_spp1$species_name[jj]) &
  #                 year %in% nbsyr) %>%
  #   dplyr::arrange(-year) %>%
  #   dplyr::filter(!is.na(latitude) & !is.na(longitude))


  figure <- plot_idw_xbyx(
    yrs = nbsyr,
    dat = table_raw,
    cruises = cruises,
    lat = "latitude",
    lon = "longitude",
    var = "cpue_kgha",
    grid = "extrapolation.grid",
    extrap.box = extrap.box,
    key.title = paste0(str_to_title(spp_print), "\nRelative Abundance (kg/ha)"),
    workfaster = TRUE,
    SRVY = SRVY,
    nrow = ifelse(pres_img, 1, 2),
    set.breaks = "auto", 
    plot_coldpool = FALSE)

  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")
}

```
