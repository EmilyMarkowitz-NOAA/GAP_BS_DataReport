---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

## fig_sample_grid

```{r fig_sample_grid}
header <- paste0("Map of the Bering Sea survey stations sampled in ",maxyr," during the EBS and NBS survey. The area enclosed within the light gray line contains the EBS shelf stations that have been sampled annually since 1982, whereas the area outlined in the dark gray line are the NBS stations that were sampled in ",maxyr,". The dots within each area indicate each station location.") # TOLEDO
nickname <- "fig_sample_grid"
width <- 6
height <- 6


figure <- plot_survey_stations(reg_dat, station_info, haul_cruises_maxyr)

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")
```


## fig_sampled_survey_stations

### How do I know what stations were retowed?

> Do I show stations missed?

```{r fig_sampled_survey_stations}
# header <- paste0("Sampled survey stations by vessel and the stratification scheme used for data analysis of ",maxyr," ",NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)," continental shelf bottom trawl surveys.")
nickname <- "fig_sampled_survey_stations"
header <- paste0("Sampled survey stations by vessel and the stratification scheme used for data analysis of ",maxyr," ",NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)," continental shelf bottom trawl surveys. The map also depicts the stations sampled by each survey vessel and where, if any, Norton Sound crab resampling was done.")
# header <- paste0("Map of the Bering Sea survey stations sampled in ",maxyr," during the EBS and NBS survey. The area enclosed within the light gray line contains the EBS shelf stations that have been sampled annually since 1982, whereas the area outlined in the dark gray line are the NBS stations that were sampled in ",maxyr,". The dots within each area indicate each station location.") # TOLEDO
width <- 6
height <- 6

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- 
  dplyr::left_join(x = reg_dat0$survey.grid, 
                   y = dplyr::left_join(x = haul_maxyr, 
                                        y = vessel_info) %>% 
                     dplyr::select(stationid, vessel_name, vess_shape) %>%
                     dplyr::mutate(vess_col = dplyr::case_when(
                       (vess_shape == vessel_info$vess_shape[1]) ~ nmfspalette::nmfs_cols("dkgray"), 
                       (vess_shape == vessel_info$vess_shape[2]) ~ nmfspalette::nmfs_cols("supdkgray"))) %>% 
                     dplyr::rename(STATIONID = stationid), 
                   by = ("STATIONID"))

if (crab_resample == TRUE) {
  
  reg_dat0$survey.grid <- dplyr::left_join(
    x = reg_dat0$survey.grid, 
    y = haul_maxyr_crabretow %>% 
      dplyr::mutate(study = "crab_resample", 
                    study_col = nmfspalette::nmfs_cols("medgray"),
                    study = "crab_resample", 
                    study_long = "Red King Crab\nResample") %>% 
      dplyr::select(stationid, study, study_col, study_long) %>%
      dplyr::rename(STATIONID = stationid) %>% 
      unique(), 
    by = ("STATIONID")) 
}

# vess <- survey.grid0 %>% dplyr::filter(!is.na(vessel_name))


figure <- plot_survey_stations(reg_dat = reg_dat0, 
                               station_info, 
                               haul_cruises_maxyr, 
                               station_grid = FALSE, 
                               stratum_no = TRUE, 
                               station_pts_srvy = FALSE, 
                               station_pts_vess = TRUE, 
                               crab_resample = crab_resample) # defined in data.r

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_vessels

```{r fig_vessels}
header <- paste0("Photographs of the *F/V Vesteraalen* (left) and *F/V Alaska Knight* (right).")
alttext <- paste0("Photographs of the fishing vessels *Vesteraalen* (left) and *Alaska Knight* (right), which were chartered for the ",maxyr," survey.")
nickname <- "fig_vessels"
height <- 2.5
width <- 6

# Select data and make plot
p1 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "94_vesterhaalen.png")), 
                      scale = 0.9 )

p2 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "163_alaskaknight.png")), 
                      scale = 0.9 )

figure <- cowplot::plot_grid(p1, p2,  
                             ncol = 2, rel_heights = c(0.1, 1))

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_trawl_gear

```{r fig_trawl_gear}
header <- paste0("Schematic diagram of the 83-112 eastern otter trawl gear used during the ", maxyr ," eastern and northern Bering Sea bottom trawl surveys.")
footnote<- NA
nickname <- "fig_trawl_gear"
alttext <- paste0(header)
height <- 6
width <- 4

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "EASTERN83-112.png")) )

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_trawl_net_simple

```{r fig_trawl_net_simple}
header <- paste0("Diagram and specific characteristics of the 83/112 Eastern trawl net.")
footnote<- NA
nickname <- "fig_trawl_net_simple"
alttext <- "Diagram specifying standardized design and specific characteristics of the 83/112 Eastern trawl net."
height = 4
width <- 6

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "bottom_trawl_net.png")), scale = 0.9 )

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## tab_length_samples

```{r tab_length_samples}
nickname <- paste0("tab_length_samples") 
header <- paste0("Lengths collected during the ", maxyr, 
                   " Northern and Eastern Bering shelf bottom trawl survey.")

table_raw <- length_maxyr   %>% 
  dplyr::ungroup()%>% 
  dplyr::select("SRVY", species_code) %>% 
  dplyr::group_by("SRVY" = SRVY, species_code) %>% # also type?
  dplyr::summarise(length = as.numeric(n())) %>% 
  dplyr::ungroup() %>%
  dplyr::left_join(x = ., 
                     y = spp_info %>% dplyr::select(species_code,  common_name), 
                     by = "species_code") %>% 
    dplyr::select(-species_code)   %>%
  dplyr::filter(!grepl(pattern = " crab", x = common_name)) %>% 
    dplyr::arrange(desc(length))  %>% 
    tidyr::pivot_wider(data = ., id_cols = c("common_name"), 
                       names_from = "SRVY", values_from = "length")  %>% 
  dplyr::ungroup()

table_print <- 
  rbind.data.frame(
    # first 20
    table_raw[1:20,],
    # summed rest
    table_raw[21:nrow(table_raw),] %>%
      dplyr::mutate(common_name = paste0("other taxa (", nrow(table_raw[21:nrow(table_raw),]), ")")) %>%
      dplyr::group_by(common_name) %>% # also type?
      dplyr::summarise(EBS = as.numeric(sum(EBS, na.rm = TRUE)), 
                       NBS = as.numeric(sum(NBS, na.rm = TRUE))) %>%
      dplyr::ungroup(),
    # total
    table_raw %>%
      dplyr::mutate(common_name = "Total") %>%
      dplyr::group_by(common_name) %>% # also type?
      dplyr::summarise(EBS = as.numeric(sum(EBS, na.rm = TRUE)), 
                       NBS = as.numeric(sum(NBS, na.rm = TRUE))) %>%
      dplyr::ungroup())  %>% 
  dplyr::mutate(EBS = xunits(EBS, val_under_x_words = -1), 
                NBS = xunits(NBS, val_under_x_words = -1))

table_print[is.na(table_print)]<- "-"
  
table_print <- flextable::flextable(table_print) %>%
    flextable::set_header_labels(x = .,
                                 common_name = "Common name") %>%
    flextable::valign(valign = "top") %>%
    flextable::bold(x = ., 
                      i = c((nrow(table_print)-1), nrow(table_print))) %>% 
  
    NMFSReports::theme_flextable_nmfstm(x = ., 
                        font = "Arial") 
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## tab_age_samples

```{r tab_age_samples}
nickname <- paste0("tab_age_samples") 
header <- paste0("Otoliths collected during the ", maxyr, 
                   " Northern and Eastern Bering shelf bottom trawl survey.")

table_raw <- readr::read_csv(paste0(dir_out_rawdata, "/0_otolith_collections.csv"), skip = 1) %>% 
  dplyr::select(-SRVY) %>%
  dplyr::arrange((EBS)) %>%
  dplyr::arrange(sample_type) %>% 
  mutate_at('EBS', as.numeric) %>% 
  mutate_at('NBS', as.numeric) %>% 
  dplyr::relocate(sample_type)
  # dplyr::rename(" " = sample_type)

table_print <- table_raw %>%
      dplyr::ungroup()  %>% 
  dplyr::mutate(EBS = xunits(EBS, val_under_x_words = -1), 
                NBS = xunits(NBS, val_under_x_words = -1))
table_print[is.na(table_print)] <- "-"


table_print <- table_print %>% 
  flextable::as_grouped_data(x = ., groups = c("sample_type")) %>% 
  flextable::as_flextable(x = ., hide_grouplabel = TRUE) %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(sample_type) ) %>%
  NMFSReports::theme_flextable_nmfstm(x = ., 
                        font = "Arial") 

  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```


## fig_mean_temperature

> prev: fig_temp_weight_mean

```{r fig_mean_temperature}
nickname <- "fig_mean_temperature"
header <- paste0("Average summer surface (green triangles) and bottom (blue circles) temperatures (°C) on the EBS shelf based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr," and NBS shelf based on data collected during standardized summer bottom trawl surveys from ", NMFSReports::text_list(nbsyr),". Dashed lines represent the time series mean.")
alttext <- paste0("Graph showing average summer surface (green triangles) and bottom (blue circles) temperatures (°C) on the EBS shelf (left) based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr," and NBS shelf (right) based on data collected during standardized summer bottom trawl surveys from ", NMFSReports::text_list(nbsyr),". Dashed horizontal lines represent the time series mean.")
# header <- paste0("Time series of mean survey surface and near-bottom temperatures in the EBS weighted by stratum based on expendable bathythermograph casts or digital dataloggers attached to the headrope during the EBS bottom trawl surveys from 1982 to ", maxyr, ". The 1982-1987 means (triangles). The dashed lines represent the grand stratum-area weighted mean water temperatures for 1982-", maxyr, ".")
# nickname <- "fig_temp_weight_mean"
# header <- paste0("Average summer surface (green triangles) and bottom (blue circles) temperatures (°C) on the eastern Bering Sea (EBS) shelf based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr," and northern Bering Sea (NBS) shelf based on data collected during standardized summer bottom trawl surveys from ", NMFSReports::text_list(nbsyr),". Dashed lines represent the time series mean.")

height <- dim(readPNG(paste0(dir_img, "average_temperature.png")))[1]/300 # 4
width <- dim(readPNG(paste0(dir_img, "average_temperature.png")))[2]/300 # 6

# https://github.com/sean-rohan-NOAA/coldpool/blob/main/plots/average_temperature.png

# get the most updated file, just in case
# a <- url_exists("https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/average_temperature.png?token=ASDSFQFRRFKSYHOBYF4WWJ3BP4O5O", 
#                 "https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/average_temperature.png?token=ASDSFQFYZNMG4X3DZDLXZT3BRH5VO")
# if (length(a)>0 ) {
#   figure <- 
#     cowplot::ggdraw() +
#     cowplot::draw_image(a)
# } else {
# https://github.com/sean-rohan-NOAA/coldpool/blob/main/plots/stacked_temperature.png?raw=true
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "average_temperature.png")) )
# }


# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```


## fig_cold_pool_area

> Figure header from 2019: Figure 4. Mean summer surface and bottom temperatures for the 38-year times series from the EBS shelf bottom trawl survey (A) and the cumulative proportion of EBS shelf area covered by each one-degree bottom isotherm range (B).

```{r fig_cold_pool_area}
# header <- paste0("Percentage of the EBS shelf from 1982–",maxyr," bottom area that is occupied by the cold pool in one degree Celsius increments.")
header <- paste0("Graph showing annual cold pool extent in the EBS, based on observations from the EBS bottom trawl survey. Extent of the cold pool is shown in proportion to the total southern EBS shelf survey area. Shading denotes bottom temperatures \u2264 2°C (aqua blue), \u2264 1°C (cerulean blue), \u2264 0°C (cobalt blue), and \u2264 -1°C (dark navy blue).")
alttext <- paste0("Cold pool extent in the EBS, as measured using observations from the EBS bottom trawl survey. Extent of the cold pool in proportion to the total EBS shelf survey area from 1982–",maxyr,". Shading denotes bottom temperatures \u2264 2°C (aqua blue), \u2264 1°C (cerulean blue), \u2264 0°C (cobalt blue), and \u2264 -1°C (dark navy blue).")
footnote <- "Areas were summarized from areas in inverse distance weighted rasters."
nickname <- "fig_cold_pool_area"
# alttext <- paste0(header, " Purple is the percentage area < -1°C, blue is the percentage area < 1°C, green is the percentage area < 1°C, and yellow is the percentage area < 2°C. Celsius increments.")
height <- dim(readPNG(paste0(dir_img, "stacked_temperature_simple_label.png")))[1]/300 # 4
width <- dim(readPNG(paste0(dir_img, "stacked_temperature_simple_label.png")))[2]/300 # 6

# get the most updated file, just in case
a<-  url_exists("https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/stacked_temperature_simple_label.png?token=ASDSFQHEDQ5TQT45TR7ZDALBP4OWS", 
                "https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/stacked_temperature_simple_label.png?token=ASDSFQFPHFWX5FHJQBIY7PLBRKQIS")
if (length(a)>0 ) {
  figure <- 
    cowplot::ggdraw() +
    cowplot::draw_image(a)
} else {
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "stacked_temperature_simple_label.png")) )
}

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```


## fig_st_all_nebs_surveys

```{r fig_idw_surftemp_maxyr}
header <- paste0("Contour map of surface temperatures from the ",maxyr," ",
                 NMFSReports::text_list(haul_cruises_maxyr$survey_name)," shelf bottom trawl surveys.")
nickname <- "fig_idw_surftemp_maxyr"

height <- 7
width <- 6

# header <- paste0("Map showing surface temperatures (°C) in the NBS and EBS during the ",
#                  NMFSReports::text_list(nbsyr),
#                  " surveys, which are the years when the survey included the full NBS shelf.")


  rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_surface_temperature,
                                subset = paste0("ebs_ste_", nbsyr, "_surface_temperature"))
  figure <- plot_temps_facet(
    rasterbrick = rasterbrick, 
    key.title = expression(bold("Surface Temperature (°C)")), 
    reg_dat = reg_dat, 
    colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
    viridis_palette_option = "H") 

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

## fig_bt_all_nebs_surveys

```{r fig_bt_all_nebs_surveys}
nickname <- "fig_bt_all_nebs_surveys"
height <- 7
width <- 6

header <- paste0("Map showing bottom temperatures (°C) in the NBS and EBS during the ",
                 NMFSReports::text_list(nbsyr),
                 " surveys, which are the years when the survey included the full NBS shelf.")

rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_bottom_temperature,
                                subset = paste0("ebs_ste_", nbsyr, "_gear_temperature"))
figure <- plot_temps_facet(
    rasterbrick = rasterbrick, 
    key.title = expression(bold("Bottom Temperature (°C)")), 
    reg_dat = reg_dat, 
    colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
    viridis_palette_option = "H") 

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("
###### 

",res,"

")

```

