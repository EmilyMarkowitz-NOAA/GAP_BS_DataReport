---
output:
  officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

## vars

```{r vars}
a <- report_spp1[which(report_spp1$file_name == comb[jj]), ]

spp_sci <- a$species_name[1]
spp_sci1 <- a$species_name1[1]
spp_code <- a$species_code
spp_print <- a$print_name[1]
spp_file <- a$file_name[1]
spp_taxon <- a$taxon[1]

# report_title == "community"
dataTcommF <- FALSE
spp_plot_sizecomp <- a$plot_sizecomp[1]
spp_plot_idw <- a$plot_idw[1]
spp_plot_pa <- FALSE
spp_table_cpue <- FALSE
spp_text <- TRUE

if (report_title == "data") {
  dataTcommF <- TRUE
  spp_plot_idw <- a$plot_idw[1]
  spp_plot_pa <- FALSE # a$plot_pa[1]
  spp_table_cpue <- a$table_cpue[1]
  spp_text <- a$text_spp[1]
}
```


## tab-stats-[spp] pres

```{r tab-stats-[spp], eval = (report_title == "community")}

nickname <- paste0("tab-stats-", spp_file)

header <- paste0("Summary ranges of biomass and population information, and environmental variables that ", 
                            spp_print, " (", spp_sci, ") have been found in across the ", 
                            SURVEY, " survey area", plural_surveys,". ")

### Stats table ----------------------------------------------------------------

haul0 <- catch_haul_cruises %>% 
  dplyr::select("station", "stratum", "latitude_dd_start", "longitude_dd_start", 
                "depth_m", "bottom_temperature_c" ,"surface_temperature_c", 
                "survey_name", "SRVY", "year", "species_code", 
                "weight_kg", "count", "hauljoin")

temp_stat <- dplyr::left_join(
  x = haul0 %>% 
    dplyr::filter(year == maxyr) %>% 
    dplyr::select(station, SRVY) %>% 
    dplyr::distinct() %>% 
    dplyr::select(SRVY) %>% 
    table() %>% 
    data.frame() %>% 
    dplyr::rename(tot = Freq), 
  y = haul0 %>% 
    dplyr::filter(species_code %in% spp_code & year == maxyr) %>% 
    dplyr::select(station, SRVY) %>% 
    dplyr::distinct() %>% 
    dplyr::select(SRVY) %>% 
    table() %>% 
    data.frame() %>% 
    dplyr::rename(spp = Freq), 
  by = "SRVY") %>% 
  dplyr::mutate(str = paste0(spp, " of ", tot, 
                             "\n(", formatC(spp/tot*100, digits = 1, format = "f", big.mark = ","), "%)")) %>% 
  dplyr::filter(!is.na(spp))

### Env table ------------------------------------------------------------------

temp_env <- haul0 %>% 
  dplyr::filter(SRVY %in% SRVY1 & 
                  year == maxyr & 
                  species_code %in% spp_code) %>% 
  dplyr::select(SRVY, 
                # "Latitude (°N)" = latitude_dd_start, 
                # "Longitude (°W)" = longitude_dd_start, 
                "Bottom Depth (m)" = depth_m, 
                "Bottom Temperature (°C)" = bottom_temperature_c, 
                "Surface Temperature (°C)" = surface_temperature_c) %>% 
  dplyr::group_by(SRVY) %>% 
  dplyr::summarise(across(where(is.numeric), .fns = 
                            list(Min = min,
                                 Max = max))) %>%
  tidyr::pivot_longer(is.numeric,
                      names_sep='_',
                      names_to=c('variable', '.value')) %>%
  dplyr::mutate(across(is.numeric, formatC, big.mark = ",", digits = 1, format = "f"), 
                val = paste0(Min, " —\n", Max)) %>%
  dplyr::relocate(variable, dplyr::ends_with(SRVY1[1])) %>% 
  dplyr::select(-Min, -Max) %>% 
  tidyr::pivot_wider(id_cols = "SRVY",
                     names_from = "variable",
                     values_from = "val")
  # tidyr::pivot_wider(id_cols = "variable",
  #                    names_from = "SRVY",
  #                    values_from = c("val"))

### Biomass table --------------------------------------------------------------

yrs <- c(maxyr, compareyr)

temp_bio <- dplyr::left_join(
  x = total_biomass %>% 
    dplyr::group_by(SRVY, year) %>% 
    dplyr::summarise(total = sum(total, na.rm = TRUE)), 
  y = biomass %>% 
    dplyr::filter(year %in% yrs & 
                    species_code %in% spp_code &
                    stratum %in% 999) %>%
    dplyr::select(SRVY, year, biomass_mt, population_count, 
                  cpue_kgkm2_mean, cpue_nokm2_mean) %>% 
    dplyr::filter((biomass_mt !=0)), 
  by = c("year", "SRVY")) %>% 
  dplyr::filter(year %in% yrs) %>% 
  dplyr::group_by(SRVY, year, total) %>% 
  dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),  
                   population_count = sum(population_count, na.rm = TRUE),  
                   cpue_kgkm2_mean = sum(cpue_kgkm2_mean, na.rm = TRUE),  
                   cpue_nokm2_mean = sum(cpue_nokm2_mean, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(print_name = spp_print)

if (sum(is.na(temp_bio$print_name[temp_bio$SRVY == "NBS"])) == 
    nrow(temp_bio[temp_bio$SRVY == "NBS",])) {
  temp_bio <- temp_bio %>% 
    dplyr::filter(SRVY != "NBS")
}

if (sum(is.na(temp_bio$print_name[temp_bio$SRVY == "EBS"])) == 
    nrow(temp_bio[temp_bio$SRVY == "EBS",])) {
  temp_bio <- temp_bio %>% 
    dplyr::filter(SRVY != "EBS")
}

temp_bio1 <- data.frame()
for (i in 1:nrow(temp_bio)) {
  
  compareyr0 <- ifelse(temp_bio$year[i] == min(yrs), min(yrs), max(yrs[yrs < temp_bio$year[i]]))
  srvy0 <- temp_bio$SRVY[i]
  temp_bio0 <- ifelse(temp_bio$year[i] == min(yrs), NA, 
                      temp_bio$biomass_mt[temp_bio$SRVY == srvy0 & temp_bio$year == compareyr0])
  
  temp_bio1  <- dplyr::bind_rows(
    temp_bio1, 
    c(
      SRVY = temp_bio$SRVY[i], 
      year = temp_bio$year[i], 
      "Population" = ifelse(is.na(temp_bio$population_count[i]), 
                              "-", 
                              xunits(temp_bio$population_count[i])), 
      "Biomass (t)" = ifelse(is.na(temp_bio$biomass_mt[i]), 
                               "-", 
                               paste0(xunits(temp_bio$biomass_mt[i], 
                                             val_under_x_words = NULL))), 
      "Biomass % of Survey Total" = dplyr::case_when(
        is.na(temp_bio$biomass_mt[i]) ~ "-", 
        paste0(formatC(x = (temp_bio$biomass_mt[i]/temp_bio$total[i])*100, 
                       digits = 1, format = "f", big.mark = ","), "%") == "0.0%" ~ "<0.01%", 
        TRUE ~ paste0(formatC(x = (temp_bio$biomass_mt[i]/temp_bio$total[i])*100, 
                              digits = 1, format = "f", big.mark = ","), "%") ), 
      "Biomass % Change" = dplyr::case_when(
        temp_bio$year[i] == min(yrs) ~ "-",
        is.na(temp_bio$biomass_mt[i]) ~ "-", #paste0("none caught in ", temp_bio$year[i]), 
        is.na(temp_bio0) ~ "-", #paste0("none caught in ", compareyr0), 
        abs(pchange(start = temp_bio$biomass_mt[i], end = temp_bio0, value_only = TRUE)) < 1 ~ "no change",
        TRUE ~ sub(replacement = "", pattern = "an ", 
                   x = gsub(pattern = "a ", replacement = "", 
                            x = paste0(pchange(end = temp_bio$biomass_mt[i], 
                                               start = temp_bio0), " from ", compareyr0)) ) ))
  )
}

### Combine temp tables --------------------------------------------------------

table_raw <- temp_stat %>% 
                     dplyr::select(SRVY, "Stations Present" = str) %>% 
  dplyr::left_join(temp_env) %>% 
  dplyr::left_join(temp_bio1 %>% 
                     dplyr::filter(year == maxyr) %>% 
                     dplyr::select(-year)) %>% 
  dplyr::left_join(data.frame(SRVY = SRVY1, 
                              Survey = stringr::str_to_title(SRVY11))) %>% 
  dplyr::select(-SRVY) %>% 
  dplyr::relocate(Survey) %>% 
  dplyr::arrange(Survey) 

if (sum(table_raw$`Biomass\n% of Total` == "0.0%") == nrow(table_raw)) {
  table_raw <- table_raw %>% 
    dplyr::select(-`Biomass\n% of Total`)
}

### print table ----------------------------------------------------------------

table_print <- 
  flextable::flextable(data = table_raw) %>% 
  flextable::bold(j = 1, part = "body") %>% 
  flextable::theme_zebra() %>% 
  flextable::bg(i = ~ grepl(x = `Biomass % Change`, pattern = "increase"), 
                bg = positive, 
                j = "Biomass % Change") %>% 
  flextable::bg(i = ~ grepl(x = `Biomass % Change`, pattern = "decrease"), 
                bg = negative, 
                j = "Biomass % Change")  %>%
  flextable::bg(i = ~ grepl(x = `Biomass % Change`, pattern = "no change"), 
                bg = neutral, 
                j = "Biomass % Change")  %>%
  theme_flextable_nmfstm(row_lines = FALSE, 
                         font = font0, 
                         pad = 0, 
                         pgwidth = full_page_portrait_width) %>% 
  flextable::padding(x = ., 
                     part = "all", 
                     padding.left = 5) %>% 
  flextable::set_header_labels(Survey = "")


res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```




## fig-[spp]-[bio/pop]-pres prep

```{r fig-[spp]-[bio/pop]-pres, eval = (report_title %in% c("ptpres", "community"))}
table_raw0 <- biomass %>%
  dplyr::filter(stratum == 999 & 
                  species_code %in% spp_code) %>% 
  # dplyr::select(SRVY, year, species_code, area_id, #population_var, biomass_var, 
  #               biomass_mt, population_count) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises %>% 
                     dplyr::select(SRVY, SRVY_long) %>% 
                     dplyr::distinct(),
                   by = "SRVY")  %>% 
  dplyr::arrange(SRVY_long) %>%
  dplyr::mutate(print_name = spp_print, 
                SRVY_long = stringr::str_to_title(SRVY_long) ) %>% 
  # dplyr::group_by(SRVY, year, species_code, SRVY_long, print_name, area_id) %>% 
  # dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
  #                  population_count = sum(population_count, na.rm = TRUE)) %>% 
  dplyr::ungroup()

temp00 <- function(table_raw0, 
                   var, 
                   maxyr, 
                   compareyr, 
                   unit, 
                   unt, 
                   y_long, 
                   legend_combined = TRUE, 
                   mean_in_legend = FALSE, 
                   error_bar = TRUE, 
                   description = TRUE) {
  
  pcol <- viridis::mako(n = 2, begin = .2, end = .6, direction = -1)
  
  table_raw <- table_raw0 %>% 
    dplyr::rename(y = paste0(var))  %>% 
    dplyr::mutate(col = dplyr::case_when(
      SRVY == "EBS" ~ pcol[1],
      SRVY == "NBS" ~ pcol[2]))
  
  if (error_bar) {
    table_raw <- table_raw %>% 
      dplyr::rename(
        y_ci_up = ci_up, 
        y_ci_dw = ci_dw) 
  }
  
  figure <- plot_timeseries(dat = table_raw,
                            unit = unit,
                            unt = unt,
                            y_long = y_long,
                            error_bar = error_bar,
                            spp_print = table_raw$print_name[1],
                            mean_in_legend = TRUE)
  
  if (legend_combined) {
    figure <- figure +
      ggplot2::theme(legend.position = "none")
  }
  
  if (description) {
    
    table_raw00 <- table_raw %>%
      dplyr::filter(year %in% c(maxyr,compareyr)) %>% 
      dplyr::select(year, y, SRVY)
    
    a <- find_units(dat = table_raw0[names(table_raw0) == var], unt = unt, unit = unit)
    
    b <- table_raw00 %>% 
      dplyr::mutate(year0 = dplyr::case_when(
        year == maxyr ~ "maxyr",
        year == compareyr ~ "compareyr"), 
        y = y/a$divby) %>% 
      tidyr::pivot_wider(id_cols = "SRVY", names_from = "year0", values_from = "y") %>% 
      dplyr::mutate(pchange0 = pchange(start = compareyr, end = maxyr, value_only = TRUE), 
                    dplyr::across(dplyr::ends_with("yr"), formatC, format = "f", big.mark = ",", digits = 2), 
                    col = dplyr::case_when(
                      pchange0 > 0 ~ positive, 
                      pchange0 < 0 ~ negative, 
                      TRUE ~ "black"), 
                    pchange0 = formatC(x = pchange0, format = "f", big.mark = ",", digits = 2))
    
    mean_in_legend <- FALSE
    str0 <- c()
    col0 <- c()
    for (i in 1:nrow(b)){
      b0 <- b[i,]
      
      str00 <- c(paste0(b0$SRVY, " ", y_long), # ifelse(i == 1, paste0(" ", y_long), "")), 
                 # compareyr total
                 ifelse(b0$compareyr %in% c("NA", "Inf"), 
                        "", 
                        paste0(compareyr, ": ", b0$compareyr, " ", a$unit_wrd)), 
                 # maxyr total
                 ifelse(b0$maxyr %in% c("NA", "Inf"), 
                        "", 
                        paste0(maxyr, ": ", b0$maxyr, " ", a$unit_wrd)), 
                 # maxyr and compareyr % change
                 ifelse(b0$pchange0 %in% c(" NA", "NA", "Inf"), 
                        "", 
                        paste0("\n(", b0$pchange0, "%)\n")), 
                 "")
      
      col00 <- c(
        rep_len(x = "#00447C", 
                length.out = (length(str00)-2)),
        b0$col,  "#00447C")
      str0 <- c(str0, str00)
      col0 <- c(col0, col00)
    }
    
    if (nrow(b) == 1) {
      str00 <- c(str00, rep_len(x = "", length.out = length(str00)))
    }
    
    descr <- ggdraw() + 
      draw_text(text = str0, 
                fontface = 
                  rep_len(x = c('bold', 
                                rep_len(x = "plain", 
                                        length.out = 4)), 
                          length.out = length(str0)), 
                y = seq(from = 0.8, 
                        to = ifelse(length(str0) == ifelse(mean_in_legend, 5, 6), 0.7, 0.1), 
                        length.out = length(str0)),
                color = col0)
    
    
    figure <- cowplot::plot_grid(figure,
                                 descr,
                                 nrow = 1,
                                 rel_widths = c(.7, .3),
                                 rel_heights = c(0.5, 0.5))
  }
  
  legend0 <- ggpubr::get_legend(figure)
  
  return(figure)
}
```

## fig-[spp]-biomass-pres

```{r, fig-[spp]-biomass-pres-ci, eval = (report_title %in% c("ptpres", "community"))}
if (report_title %in% c("community", "data")) {
  nickname <- paste0("fig-", spp_file, "-biomass")
  description <- FALSE
height <- 3
width <- full_page_portrait_width
} else if (report_title %in% c("ptpres", "compres")) {
  nickname <- paste0("fig-", jj, "-", spp_file, "-1-biomass-pres")
height <- 4
}

table_raw <- table_raw0 %>% 
  dplyr::rename(ci_up = biomass_95ci_up, 
                ci_dw = biomass_95ci_dw) %>% 
  dplyr::group_by(year, survey_definition_id, SRVY, SRVY_long) %>% 
  dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                   ci_up = sum(ci_up, na.rm = TRUE), 
                   ci_dw = sum(ci_dw, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(species_name = spp_print, 
                common_name = spp_print, 
                print_name = spp_print, 
                taxon = spp_taxon)

figure <- temp00(table_raw0 = table_raw, 
                 var = "biomass_mt", 
                 maxyr = maxyr, 
                 compareyr = compareyr, 
                 unit = "metric tons", 
                 unt = "t", 
                 y_long = "Biomass", 
                 mean_in_legend = TRUE, 
                 error_bar = ifelse(length(unique(table_raw0$species_code))>1, FALSE, TRUE), 
                 description = description)

header <- "Biomass over time. "

res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```

## fig-[spp]-population-pres


```{r, fig-[spp]-population-pres-cv, eval = (report_title == "ptpres")}

if (report_title %in% c("community", "data")) {
  nickname <- paste0("fig-",spp_file, "-population")
  description <- FALSE
height <- 3
width <- full_page_portrait_width
} else if (report_title %in% c("ptpres", "compres")) {
nickname <- paste0("fig-", jj, "-", spp_file, "-2-population-pres")
height <- 4
}

table_raw <- table_raw0 %>% 
  dplyr::rename(ci_up = population_95ci_up, 
                ci_dw = population_95ci_dw) %>% 
  dplyr::group_by(year, survey_definition_id, SRVY, SRVY_long) %>% 
  dplyr::summarise(population_count = sum(population_count, na.rm = TRUE), 
                   ci_up = sum(ci_up, na.rm = TRUE), 
                   ci_dw = sum(ci_dw, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(species_name = spp_print, 
                common_name = spp_print, 
                print_name = spp_print, 
                taxon = spp_taxon)

y_long <- "Population"
unit = "individuals"
unt = ""
table_raw <- table_raw0 %>% 
  dplyr::rename(ci_dw = population_95ci_up, 
                ci_dw = population_95ci_dw)
figure <- temp00(table_raw0 = table_raw, 
                 var = "population_count", 
                 maxyr = maxyr, 
                 compareyr = compareyr, 
                 unit = "individuals", 
                 unt = "", 
                 y_long = "Population", 
                 mean_in_legend = TRUE, 
                 error_bar = TRUE)
header <- "" # a$header

res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```

