---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

## vars

```{r vars}
a <- report_spp1[report_spp1$file_name == unique(report_spp1$file_name)[jj], ]

spp_sci <- a$species_name[1]
spp_sci1 <- a$species_name1[1]
spp_code <- a$species_code # eval(expr = parse(text = a$species_code[1]))
spp_print <- a$print_name[1]
spp_file <- a$file_name[1]
spp_taxon <- a$taxon[1]

spp_plot_sizecomp <- ifelse(is.na(a$plot_sizecomp[1]), FALSE, a$plot_sizecomp[1])
spp_plot_idw <- ifelse(is.na(a$plot_idw[1]), FALSE, a$plot_idw[1])
spp_plot_idw_coldwarm <- ifelse(is.na(a$plot_idw_coldwarm[1]), FALSE, a$plot_idw_coldwarm[1])
spp_table_cpue <- ifelse(is.na(a$table_cpue[1]), FALSE, a$table_cpue[1])
text_spp <- ifelse(is.na(a$text_spp[1]), FALSE, a$text_spp[1])
```

## data_wrangle

```{r data_wrangle}
# find basic info about species
# haul0 <- catch_haul_cruises %>% 
#   dplyr::select("stationid", "stratum", "start_latitude", "start_longitude", 
#                 "bottom_depth", "gear_temperature" ,"surface_temperature", 
#                 "survey_name", "SRVY", "year", "species_code", 
#                 "weight", "number_fish", "hauljoin")

haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY_long == "eastern Bering Sea"] <- "southeastern Bering Sea"

# Biomass
bio <- biomass %>%
  dplyr::filter(stratum == 999) %>% 
  dplyr::select(SRVY, year, species_code, upperb, lowerb, varbio, biomass, taxon) %>% 
  dplyr::left_join(x = ., 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1), 
                   by = "species_code") %>% 
  dplyr::filter(print_name == spp_print) %>% 
  dplyr::rename(y = biomass, 
                lower = lowerb, 
                upper = upperb, 
                var = varbio) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))


# Abundance
pop <- biomass %>%
  dplyr::filter(stratum == 999) %>% 
  dplyr::select(SRVY, year, species_code, upperp, lowerp, varpop, population, taxon) %>% 
  dplyr::left_join(x = ., 
                   y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, species_name1), 
                   by = "species_code") %>% 
  dplyr::filter(print_name == spp_print) %>% 
  dplyr::rename(y = population, 
                lower = lowerp, 
                upper = upperp, 
                var = varpop) %>% 
  dplyr::left_join(x = . , 
                   y = haul_cruises_maxyr %>% 
                     dplyr::select(SRVY, SRVY_long),
                   by = "SRVY") %>% 
  dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))

# # Lengths
# lengths <- length_data %>% 
#   dplyr::filter(species_code %in% spp_code) %>% 
#   dplyr::select(SRVY, species_code, frequency, sex, length,
#                 sample_type, length_type, name, year, 
#                 sentancefrag)
# 
# # Size Comps
# sizec <- sizecomp %>% 
#   dplyr::left_join(x = ., 
#                    y = report_spp1 %>% 
#                      dplyr::select(print_name, species_code, species_name1), 
#                    by = "species_code") %>% 
#   dplyr::filter(print_name == spp_print) %>% 
#   dplyr::left_join(x = . , 
#                    y = haul_cruises_maxyr %>% 
#                      dplyr::select(SRVY, SRVY_long),
#                    by = "SRVY") %>% 
#   dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long))

```

## fig_idw_cpue_[taxon]_[spp]_[above and below]

```{r fig_idw_cpue_[taxon]_[spp]_[above and below]}

if (spp_plot_idw_coldwarm){
  nickname0 <- paste0("fig_idw_cpue_",spp_taxon,"_", spp_file, "_")

  
  table_raw0 <- cpue %>%
    dplyr::filter(!is.na(cpue_kgha)) %>% 
    dplyr::arrange(desc(year)) %>% 
    dplyr::filter(species_code %in% spp_code & 
                    # dplyr::filter(common_name %in% spp_common & 
                    year %in% unlist(temps_avg_yr_abovebelow))
  
  set.breaks <- set_breaks(dat = table_raw0, 
                           var = "cpue_kgha")
  
  for (i in 1:2) { # two cases, above and below
    subobj <- TRUE
    newobj <- ifelse(i==1, TRUE, FALSE)
    TF <- ifelse(i==1, FALSE, TRUE)
    case <- ifelse(i==1, "below", "above")
    
    height <- ifelse(length(temps_avg_yr_abovebelow[,case])>2, full_page_portrait_height, 5)
    width <- full_page_portrait_width # 6.5

    header <- paste0("Contour maps of ",spp_print, ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")")), 
                     " distribution and relative biomass (kg/ha) from the ",
                     NMFSReports::text_list(sort(temps_avg_yr_abovebelow[,case])),
                     " Bering Sea shelf bottom trawl surveys, which were years when the survey mean bottom temperature was ",
                     case,
                     " the long term mean.")
    nickname <- paste0(nickname0, case)
    
    table_raw <- table_raw0 %>% 
      dplyr::filter(year %in% temps_avg_yr_abovebelow[,case])
    
    
  if (length(year)<10) {
  row <- 3
  } else if (length(year)<6) {
  row <- 2
  # } else {
  # row <- 4
  }
    
    figure <- plot_idw_xbyx(
      yrs = temps_avg_yr_abovebelow[,case],
      dat = table_raw,
      cruises = cruises,
      lat = "latitude",
      lon = "longitude",
      var = "cpue_kgha",
      grid = "extrapolation.grid",
      extrap.box = extrap.box,
      key.title = paste0(stringr::str_to_sentence(spp_print), "
relative biomass (kg/ha)"),
      workfaster = workfaster,
      SRVY = SRVY, 
      set.breaks = set.breaks, 
      row = row)
    

  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_figures[nickname][[1]]$res <- res
        
  }
}

```

## fig_idw_cpue_[taxon]_[spp]

```{r fig_idw_cpue_[taxon]_[spp]}

if (spp_plot_idw){
  
  nickname <- paste0("fig_idw_cpue_", spp_taxon, "_", spp_file)
  
  height <- 5
  # width <- 6.5
  # height <- full_page_portrait_height # 7
  width <- full_page_portrait_width # 6.5
  
  table_raw <- cpue %>%
    dplyr::filter(!is.na(cpue_kgha)) %>% 
    dplyr::filter(species_code %in% spp_code & 
                    year %in% c(maxyr, compareyr)) %>% 
    dplyr::arrange(desc(year))
  
  
  header <- paste0("Contour maps of ",spp_print, ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")")), 
                   " distribution and relative biomass (kg/ha) from the ",
                   compareyr," (left) and ",maxyr,
                   " (right) EBS (eastern Bering Sea) and NBS (northern Bering Sea) bottom trawl surveys.")
  
  figure <- plot_idw_xbyx(
    yrs = c(maxyr, compareyr),
    dat = table_raw,
    cruises = cruises,
    lat = "latitude",
    lon = "longitude",
    var = "cpue_kgha",
    grid = "extrapolation.grid",
    extrap.box = extrap.box,
      key.title = paste0(stringr::str_to_sentence(spp_print), "
relative biomass (kg/ha)"),
    workfaster = workfaster,
    SRVY = SRVY, 
    set.breaks = set.breaks, 
    row = 1)
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_figures[nickname][[1]]$res <- res

}

```

## fig_sizecomp_[taxon]_[spp]

> need to think bout this for EBS-only. in 2016, included stratum-specific values

```{r fig_sizecomp_[taxon]_[spp]}
if (spp_plot_sizecomp) {
  
  # height <- 6
  # width <- 6.5#ifelse(SRVY == "NEBS", 6, 4)
  height <- full_page_portrait_height # 7
  width <- full_page_portrait_width # 6.5
  
  header <- paste0("Total abundance-at-length estimates of ",
                   spp_print, ifelse(is.na(spp_sci), "", 
                                     paste0(" (",spp_sci,")")), 
                   " by sex (males, females, unsexed) and for all sexes combined comparing the ",
                   compareyr," and ",maxyr," ",
                   NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY)), 
                   " Shelf Bottom Trawl Surveys.")
  
  nickname <- paste0("fig_sizecomp_", spp_taxon, "_", spp_file)
  
  length_data0 <- length_data %>%
    dplyr::filter(species_code %in% spp_code &
                      SRVY %in% SRVY1)# &
  # SRVY %in% "NBS" & 
  # year %in% nbsyr)
  
  type <- unique(length_data0$sentancefrag)
  
  sizecomp0 <- sizecomp %>%
      dplyr::filter(species_code %in% spp_code &
                      SRVY %in% SRVY1 &
                      year %in% c(compareyr, maxyr))
  
  if (SRVY == "NEBS") {
  sizecomp0 <- dplyr::bind_rows(
    sizecomp0, 
    sizecomp %>%
      dplyr::filter(species_code %in% spp_code &
                      SRVY %in% SRVY &
                      year %in% nbsyr) %>% 
      dplyr::group_by(year, taxon, species_code, sex, pop) %>% 
      dplyr::summarise(length) %>% 
      dplyr::mutate(SRVY = "EBS + NBS")) %>% 
    dplyr::mutate(SRVY = factor(x = SRVY, levels = c("EBS", "NBS", "EBS + NBS"), ordered = TRUE))
  }
  
  figure <- plot_sizecomp(
    sizecomp0 = sizecomp0,
    spp_code = spp_code,
    spp_print = stringr::str_to_sentence(spp_print),
    type = type,
    print_n = FALSE)
  
  # fig1 <- plot_sizecomp(
  #   sizecomp0 = sizecomp %>% 
  #   dplyr::filter(species_code %in% spp_code &
  #                   SRVY %in% "NBS" & 
  #                   year %in% nbsyr),
  #   spp_code = spp_code,
  #   spp_print = paste0("NBS ", spp_print), 
  #   type = type, 
  #   print_n = FALSE)
  # 
  # fig2 <- plot_sizecomp(
  #   sizecomp0 =  sizecomp %>% 
  #   dplyr::filter(species_code %in% spp_code &
  #                   SRVY %in% "EBS" & 
  #                   year %in% nbsyr),
  #   spp_code = spp_code,
  #   spp_print = paste0("EBS ", spp_print), 
  #   type = type, 
  #   print_n = FALSE)
  # 
  # fig3 <- plot_sizecomp(
  #   sizecomp0 =  sizecomp %>% 
  #   dplyr::filter(species_code %in% spp_code &
  #                   SRVY %in% c("NBS", "EBS") & 
  #                   year %in% nbsyr),
  #   spp_code = spp_code,
  #   spp_print = paste0("EBS and NBS ", spp_print), 
  #   type = type, 
  #   print_n = FALSE)
  # 
  # sizecomp0 <- sizecomp %>% 
  #   dplyr::filter(species_code %in% spp_code &
  #                   SRVY %in% "EBS")  
  # 
  #   if (nrow(sizecomp0) != 0) {
  # 
  #   type <- unique(length_data0$sentancefrag)  # get size unit/type
  # 
  # fig2 <- plot_sizecomp(
  #   sizecomp0 = sizecomp %>% 
  #   dplyr::filter(species_code %in% spp_code &
  #                   SRVY %in% "EBS"),
  #   length_data0 = length_data0, 
  #   spp_code = spp_code,
  #   spp_print = paste0("EBS ", spp_print), 
  #   type = type, 
  #   print_n = FALSE, 
  #   ridgeline = TRUE)
  # }  
  # 
  #   figure <- ggpubr::ggarrange(fig2, fig1, 
  #           labels = c("A", "B"), nrow = 1)#, widths = c(2,1))
  
  
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_figures[nickname][[1]]$res <- res
  
}
```


## fig_timeseries_[taxon]_[spp]

```{r, fig_timeseries_[taxon]_[spp]}
# nickname <- paste0("fig_timeseries_", spp_file)
# header <- "Timeseries of biomass and abundance." # TOLEDO
# height <- 9
# width <- 6
# 
# #Biomass
# y_long <- "Biomass"
# a <- table_change_pres(dat = bio, 
#                        yrs = nbsyr, 
#                        maxyr = maxyr, 
#                        compareyr = compareyr, 
#                        unit = "metric tons", 
#                        unt = "mt", 
#                        y_long = y_long, 
#                        digits = 2)
# 
# fig1 <- plot_timeseries(dat = bio, 
#                           unit = "metric tons", 
#                           unt = "mt", 
#                           y_long = "biomass", 
#                           spp_print = spp_print)
# # Abundance
# y_long <- "Abundance"
# a <- table_change_pres(dat = pop, 
#                                  yrs = nbsyr, 
#                                  maxyr = maxyr, 
#                                  compareyr = compareyr, 
#                                  unit = "", 
#                                  unt = "", 
#                                  y_long = y_long, 
#                        digits = 2)
# 
# fig2 <- plot_timeseries(dat = pop, 
#                           unit = "", 
#                           unt = "", 
#                           y_long = "abundance", 
#                           spp_print = spp_print)
# 
# figure <- ggpubr::ggarrange(fig1, fig2, 
#           labels = c("A", "B"), nrow = 2)#, widths = c(2,1))
# 
# 
# # save yo' stuff and do a lot of behind the scenes work
# # alt: this does the same thing as calling "child = " in the chunk header
# res <- knitr::knit_child(
#   text = knitr::knit_expand(
#     file = system.file("rmd/_child_save_fig.Rmd", 
#                        package = "NMFSReports")), 
#   quiet = TRUE
# )
# 
# list_figures[nickname][[1]]$res <- res
   # 
```

## tab_estimates_maxyr_[taxon]_[spp]_[wt or num]

```{r tab_estimates_maxyr_[taxon]_[spp]_[wt or num]}
if (spp_table_cpue) {

nickname0 <- paste0("tab_estimates_maxyr_", spp_taxon, "_", spp_file, "_") 

temp <- biomass_strat %>% 
  dplyr::filter(year == maxyr &
                  species_code %in% spp_code) %>% 
  dplyr::select(SRVY, stratum, 
                meanwgtcpue, varmnwgtcpue, 
                biomass, varbio, upperb, lowerb, 
                meannumcpue, varmnnumcpue, 
                population, varpop, upperp, lowerp, 
                haulcount, catcount, numcount, lencount) %>% 
  dplyr::mutate(stratum = as.character(stratum)) %>%
  dplyr::arrange(stratum) %>% 
  dplyr::arrange(SRVY) %>% 
  dplyr::mutate(stratum = ifelse(stratum == 999, "Total", stratum))

# for (i in 1:nrow(haul_cruises_maxyr)) {
#   if (nrow(haul_cruises_maxyr)>1) {
#     subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
#     newobj <- ifelse(i==1, TRUE, FALSE)
#   }
  

for (i in 1:2) {
  subobj <- TRUE
  newobj <- ifelse(i==1, TRUE, FALSE)
  table_raw <- table_print <- data.frame()
  
  if (i == 1){ # CPUE (WT/HA) and BIOMASS
    nickname <- paste0(nickname0, "wt")
    header <- paste0("Mean CPUE by weight (kg/ha) with standard deviation, and estimated biomass (mt) with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for ",
                     spp_print, ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")")),
                     " by stratum for the ",maxyr," ",                     
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY, 
                                                   " (", 
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " Shelf Trawl Surveys. Differences in sums of estimates and totals are due to rounding.")
    
    table_raw <- temp %>% 
      dplyr::select(SRVY, stratum, 
                    meanwgtcpue, varmnwgtcpue, 
                    biomass, varbio, upperb, lowerb, 
                    # haulcount, 
                    catcount, numcount, lencount) 
    
    if (nrow(table_raw) != 0) { # if none were caught, don't do any of this
      
    meanwgtcpue0<-find_units(unit = "kg/ha", unt = "kg/ha", dat = table_raw$meanwgtcpue)    
    varmnwgtcpue0<-find_units(unit = "", unt = "", table_raw$varmnwgtcpue)
    biomass0<-find_units(unit = "mt", unt = "mt", table_raw$biomass)
    varbio0<-find_units(unit = "", unt = "", table_raw$varbio)
    
        header <- paste0("Mean CPUE by weight",meanwgtcpue0$unit_word,
                         " with standard deviation",varmnwgtcpue0$unit_word,
                         ", and estimated biomass",biomass0$unit_word,
                         " with standard deviation",varbio0$unit_word,
                         " and 95% lower (LCL) and upper (UCL) confidence limits for ",
                     spp_print, ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")")),
                     " by stratum for the ",maxyr," ",
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY,
                                                   " (",
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " Shelf Trawl Surveys. Differences in sums of estimates and totals are due to rounding.")
    
    table_print <- table_raw %>% 
      dplyr::mutate(meanwgtcpue = meanwgtcpue/meanwgtcpue0$divby) %>%
      dplyr::mutate(varmnwgtcpue = varmnwgtcpue/varmnwgtcpue0$divby) %>%
      dplyr::mutate(biomass = biomass/biomass0$divby) %>% 
      dplyr::mutate(upperb = upperb/biomass0$divby) %>% 
      dplyr::mutate(lowerb = lowerb/biomass0$divby) %>% 
      dplyr::mutate(varbio = varbio/varbio0$divby) %>% 
      dplyr::mutate(across(where(is.double) & ends_with("cpue"), 
                           formatC, big.mark=",", digits = 2, format = "f")) %>% 
      dplyr::mutate(across(where(is.double) & !ends_with("cpue"),# & ends_with("count"), 
                           formatC, big.mark=",", digits = 0, format = "f")) %>%
      flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL) %>% 
      flextable::as_flextable(font = font0, x = ., hide_grouplabel = TRUE) %>% 
      flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
      flextable::bold(x = ., #j = "stratum", 
                      i = ~ (stratum == "Total") ) %>%
      # flextable::padding(x = ., 
      #                    j = 1, i = ~ is.na(SRVY), 
      #                    padding.left = 20) %>%
      flextable::set_header_labels(
        x = ., 
        stratum = "Stratum", 
        meanwgtcpue = paste0("Mean CPUE", meanwgtcpue0$unit_word), 
        varmnwgtcpue = paste0("SD CPUE", varmnwgtcpue0$unit_word), 
        biomass = paste0("Estimated Biomass", biomass0$unit_word), 
        varbio = paste0("SD Biomass", varbio0$unit_word), 
        upperb = paste0("95% LCL", biomass0$unit_word), 
        lowerb = paste0("95% UCL", biomass0$unit_word), 
        # haulcount = "Total hauls", 
        catcount = "Hauls with weights", 
        numcount = "Hauls with counts", 
        lencount = "Hauls with lengths") %>% 
      # flextable::merge_v(j = "Region") %>%
      flextable::valign(valign = "top") %>%
      theme_flextable_nmfstm(font0 = font0, row_lines = FALSE, 
                             pgwidth = full_page_landscape_width)
    }
  } else { # CPUE No/HA and POPULATION
    
    
    
    nickname <- paste0(nickname0, "num")
    header <- paste0("Mean CPUE by number (no./ha) with standard deviation, and estimated population with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for ",spp_print, ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")"))," by stratum for the ",maxyr," ",
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                                   " shelf (", 
                                                   haul_cruises_maxyr$SRVY, "; ",
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " trawl survey. Differences in sums of estimates and totals are due to rounding.")
    
    table_raw <- temp %>% 
      dplyr::select(SRVY, stratum, 
                    meannumcpue, varmnnumcpue, 
                    population, varpop, upperp, lowerp, 
                    # haulcount, 
                    catcount, numcount, lencount)
    
    if (nrow(table_raw) != 0) { # if none were caught, don't do any of this
      
    meannumcpue0 <- find_units(unit = "no./ha", unt = "no./ha", dat = table_raw$meannumcpue)
    varmnnumcpue0 <- find_units(unit = "", unt = "", table_raw$varmnnumcpue)
    population0 <- find_units(unit = "", unt = "", table_raw$population)
    varpop0 <- find_units(unit = "", unt = "", table_raw$varpop)
    
        header <- paste0("Mean CPUE by number", meannumcpue0$unit_word,
                         " with standard deviation", varmnnumcpue0$unit_word,
                         " , and estimated population", population0$unit_word,
                         "  with standard deviation", varpop0$unit_word,
                         "  and 95% lower (LCL) and upper (UCL) confidence limits for ",spp_print, 
                         ifelse(is.na(spp_sci), "", paste0(" (",spp_sci,")"))," by stratum for the ",maxyr," ",
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                                   " shelf (", 
                                                   haul_cruises_maxyr$SRVY, "; ",
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " trawl survey. Differences in sums of estimates and totals are due to rounding.")
    
    table_print <- table_raw %>% 
      dplyr::mutate(meannumcpue = meannumcpue/meannumcpue0$divby) %>%
      dplyr::mutate(varmnnumcpue = varmnnumcpue/varmnnumcpue0$divby) %>%
      dplyr::mutate(population = population/population0$divby) %>% 
      dplyr::mutate(upperp = upperp/population0$divby) %>% 
      dplyr::mutate(lowerp = lowerp/population0$divby) %>% 
      dplyr::mutate(varpop = varpop/varpop0$divby) %>% 
      dplyr::mutate(across(where(is.double) & ends_with("cpue"), 
                           formatC, big.mark=",", digits = 2, format = "f")) %>% 
      dplyr::mutate(across(where(is.double) & !ends_with("cpue"),# & ends_with("count"), 
                           formatC, big.mark=",", digits = 0, format = "f")) %>%
      flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL) %>% 
      flextable::as_flextable(x = ., hide_grouplabel = TRUE) %>% 
      flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
      flextable::bold(x = ., #j = "stratum", 
                      i = ~ (stratum == "Total") ) %>%
      # flextable::padding(x = ., 
      #                    j = 1, i = ~ is.na(SRVY), 
      #                    padding.left = 20) %>%
      flextable::set_header_labels(
        x = ., 
                                   stratum = "Stratum", 
                                   meannumcpue = paste0("Mean CPUE", meannumcpue0$unit_word), 
                                   varmnnumcpue = paste0("SD CPUE", varmnnumcpue0$unit_word), 
                                   population = paste0("Estimated Population", population0$unit_word), 
                                   varpop = paste0("SD Population", varpop0$unit_word), 
                                   upperp = paste0("95% LCL", population0$unit_word), 
                                   lowerp = paste0("95% UCL", population0$unit_word), 
                                   # haulcount = "Total hauls", 
                                   catcount = "Hauls with weights", 
                                   numcount = "Hauls with counts", 
                                   lencount = "Hauls with lengths") %>% 
      # flextable::merge_v(j = "Region") %>%
      flextable::valign(valign = "top") %>%
      theme_flextable_nmfstm(row_lines = FALSE, font = font0, 
                             pgwidth = full_page_landscape_width)
    }
  }
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res
}
}
```
