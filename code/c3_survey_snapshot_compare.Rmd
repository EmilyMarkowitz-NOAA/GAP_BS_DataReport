
# `r maxyr` Survey Results with Snapshot Comparisons to `r compareyr`

The cumulative area sampled by trawls at the `r haul_cruises_maxyr$stations_completed[haul_cruises_maxyr$SRVY == "NBS"] ` completed stations was approximately `r round(temp, 2)` nmi^2^ (`r round(temp/divnmi2forkm2, 2)` km^2^), covering `r formatC(x = ((temp / sum(stratum$area_nmi2[stratum$SRVY == "NBS"], na.rm=TRUE)) * 100), format = "f", digits = 4)`% of the total area of the northern Bering Sea.

## Seafloor Bottom Temperature

```{r cold_pool_safekeeping1}
# safe keeping for automation later! 

# Bottom temperature is a major environmental driver that can affect the distribution of fishes, crabs, and other invertebrates on the shelf (Figs. `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')` and `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`). The highly variable annual bottom temperatures are related to the variability of the summer cold pool, defined by the extent of bottom temperatures below 2°C (35.6°F) on the EBS Shelf. The size of the cold pool each summer depends on sea ice coverage from the previous winter and the timing of its retreat during the spring and early summer. During the coldest years, the cold pool has extended southward on the middle shelf from the northern edge of the EBS survey area south into Bristol Bay and near the Alaska Peninsula. Some fish and invertebrate species appear to actively avoid areas of colder temperatures. Therefore, the location and extent of the cold pool may affect transboundary organism movement or, conversely, be utilized by Arctic species as a habitat refuge. During warm years, Arctic species may be forced to adjust to suboptimal conditions or redistribute due to the reduction in available cold pool habitat. The `r text_list(nbsyr)` NBS surveys, help provide a much broader view of the spatial pattern of bottom temperatures across the shelf and an improved understanding of how temperatures might affect distribution patterns or potential migration pathways available to fishes, crabs, and other invertebrates. 

```


```{r cold_pool_temps_ebs}
# temp <- cold_pool_index %>%
#   dplyr::filter(YEAR %in% nbsyr) %>%
#   dplyr::select(YEAR, MEAN_GEAR_TEMPERATURE, MEAN_SURFACE_TEMPERATURE) %>%
#   dplyr::rename(year = YEAR, 
#                 bt = MEAN_GEAR_TEMPERATURE, 
#                 st = MEAN_SURFACE_TEMPERATURE) 
# 
# temp$btt <- temp$bt[temp$year == maxyr]
# temp$stt <- temp$st[temp$year == maxyr]
# 
# temp0 <- temp %>% 
#   dplyr::mutate(
#     bt_zscore = (bt - mean(temp$bt))/sd(temp$bt), 
#     bt_thanotheryrs = dplyr::case_when(
#       abs(bt_zscore) < 0.1 ~ "nearly average",
#       bt_zscore > 0 & # positive
#         abs(bt_zscore) >= 1 ~ # greater than 1 sd from the mean
#         "warmer",
#       bt_zscore > 0 & abs(bt_zscore) < 1 ~ "slightly warmer",
#       bt_zscore < 0 & abs(bt_zscore) >= 1 ~ "colder",
#       bt_zscore < 0 & abs(bt_zscore) < 1 ~ "slightly colder",
#       TRUE ~ "the same as the mean"
#     ), 
#     st_zscore = (st - mean(temp$st))/sd(temp$st), 
#     st_thanotheryrs = dplyr::case_when(
#       abs(st_zscore) < 0.1 ~ "nearly average",
#       st_zscore > 0 & # positive
#         abs(st_zscore) >= 1 ~ # greater than 1 sd from the mean
#         "warmer",
#       st_zscore > 0 & abs(st_zscore) < 1 ~ "slightly warmer",
#       st_zscore < 0 & abs(st_zscore) >= 1 ~ "colder",
#       st_zscore < 0 & abs(st_zscore) < 1 ~ "slightly colder",
#       TRUE ~ "the same as the mean"
#     ))
# 
# # ---------------
# 
# temp <- coldpool_ebs_total_area %>%
#   dplyr::arrange((perc)) %>%
#   dplyr::mutate(rank = 1:nrow(.)) %>%
#   dplyr::arrange(desc(year))
# 
# # temp <- coldpool_ebs_total_area
# 
# # A large cold pool year
# str0 <- ""
# if (temp$rank[temp$year == maxyr] < 6) {
#   
#   temp0 <- temp[temp$rank <= temp$rank[temp$year == maxyr],] %>% 
#     dplyr::mutate(rank_ = "") %>% 
#     dplyr::arrange(rank)
#   for (i in 1:nrow(temp0)) {
#     temp0$rank_[i] <- numbers2words_th(x = temp0$rank[i])
#   }
#   
#   str0 <- paste0(ifelse(temp0$rank_[temp0$year == maxyr] != "first", 
#                           paste0(temp0$rank_[temp0$year == maxyr], " "), ""),
#                    "highest") 
# } 
# 
# # A small cold pool year
# if (abs(temp$rank[temp$year == maxyr]-length(temp$rank)) < 6) {
#   temp0 <- temp[temp$rank >= temp$rank[temp$year == maxyr],] %>% 
#     dplyr::mutate(rank = abs(rank-(nrow(temp)+1)), 
#                   rank_ = "") %>% 
#     dplyr::arrange(rank)
#   for (i in 1:nrow(temp0)) {
#     temp0$rank_[i] <- numbers2words_th(x = temp0$rank[i])
#   }
#   
#   str0 <- paste0(ifelse(temp0$rank_[temp0$year == maxyr] != "first", 
#                           paste0(temp0$rank_[temp0$year == maxyr], " "), ""),
#                    "lowest") 
# }
# 
# # put sentence together
# if (temp$rank[temp$year == maxyr] < 6 | abs(temp$rank[temp$year == maxyr]-length(temp$rank)) < 6) {
#   
#   temp4a <- ifelse(temp0$rank_[temp0$year == maxyr] != "first", 
#                    paste0(" followed by ", text_list(paste0(temp0$year[temp0$year != maxyr], 
#                                                                          " (", temp0$rank_[temp0$year != maxyr], ")"))), 
#                    "")
#   
#   str0 <- paste0(", which was the ", str0," areal coverage in the ", 
#                    haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == 'EBS'], 
#                    "-year time series", 
#                    temp4a, " (Figure ", 
#                    crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number'), 
#                    ")", ". ")
# } else {
#   str0 <- paste0("; Figure ", crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number'), ")")
# }

# The `r maxyr` mean EBS shelf bottom temperature were `r temp0$bt_thanotheryrs[temp0$year == maxyr]` and the surface temperature were `r temp0$st_thanotheryrs[temp0$year == maxyr]` compared to the annual time-series means (Figure `r crossref(list_obj = list_figures, nickname = "fig_mean_temperature", sublist = 'number')`). Over the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"] `-year time series (1982–`r maxyr`) of the EBS shelf bottom trawl survey, annual mean summer bottom temperatures were variable, ranging from `r round(min(temps_avg_yr$bt), digits = 1)`°C (`r round(c2f(min(temps_avg_yr$bt)), digits = 1)`°F) to `r round(max(temps_avg_yr$bt), digits = 1)`°C (`r round(c2f(max(temps_avg_yr$bt)), digits = 1)`°F; Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_all_nebs_surveys', sublist = 'number')`), with a grand mean for all years of `r round(temps_avg_yr$bt_mean[1], digits = 1)`°C  (`r round(c2f(temps_avg_yr$bt_mean[1]), digits = 1)`°F; Figure `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')`). During the last `r length(unlist(temps_avg_yr_abovebelow))-1` years, bottom temperatures from `r range_text(x = temps_avg_yr_abovebelow$below[temps_avg_yr_abovebelow$below != maxyr])` were colder than average ("cold stanza"), while `r range_text(x = temps_avg_yr_abovebelow$above[temps_avg_yr_abovebelow$above != maxyr])` were warmer than average ("warm stanza"; Figure `r crossref(list_obj = list_figures, nickname = "fig_mean_temperature", sublist = 'number')`). `r ifelse((maxyr>2020 & maxyr<(2021+length(unlist(temps_avg_yr_abovebelow)))), "Note that no surveys were conducted in 2020 due to the COVID-19 pandemic.", "")` The areal coverage of the summer survey cold pool in the EBS has varied greatly in size, from `r xunits(min(temp$area_km2, na.rm = TRUE)/divkm2fornmi2) ` nmi^2^ (`r xunits(min(temp$area_km2, na.rm = TRUE)) ` km^2^) in `r temp$year[temp$area_km2 == min(temp$area_km2, na.rm = TRUE)] ` to `r xunits(max(temp$area_km2, na.rm = TRUE)/divkm2fornmi2) ` nmi^2^ (`r xunits(max(temp$area_km2, na.rm = TRUE)) ` km^2^) in `r temp$year[temp$area_km2 == max(temp$area_km2, na.rm = TRUE)] `, respectively comprising `r round(temp$perc[temp$area_km2 == min(temp$area_km2, na.rm = TRUE)], digits = 1)`% to `r round(temp$perc[temp$area_km2 == max(temp$area_km2, na.rm = TRUE)], digits = 1)`% of EBS shelf area (Figure `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`). In `r maxyr`, the cold pool covered `r round(temp$perc[temp$year == maxyr], digits = 1) `% of the EBS shelf survey area (`r formatC(temp$area_km2[temp$year == maxyr]/divkm2fornmi2, digits = 0, big.mark = ",", format = "f") ` nmi^2^; `r formatC(temp$area_km2[temp$year == maxyr], digits = 0, big.mark = ",", format = "f") ` km^2^`r ifelse(str0 == "", ". ", str0)`

```



```{r cold_pool_temps_nbs}
# temp <- coldpool:::nbs_mean_temperature %>%
#   dplyr::filter(YEAR %in% nbsyr) %>%
#   dplyr::select(-LAST_UPDATE) %>%
#   dplyr::rename(year = YEAR, 
#                 bt = MEAN_GEAR_TEMPERATURE, 
#                 st = MEAN_SURFACE_TEMPERATURE) 
# 
# temp$btt <- temp$bt[temp$year == maxyr]
# temp$stt <- temp$st[temp$year == maxyr]
# 
# temp0 <- temp %>% 
#   dplyr::mutate(
#     bt_zscore = (bt - mean(temp$bt))/sd(temp$bt), 
#     bt_thanotheryrs = dplyr::case_when(
#       abs(bt_zscore) < 0.1 ~ "nearly average",
#       bt_zscore > 0 & # positive
#         abs(bt_zscore) >= 1 ~ # greater than 1 sd from the mean
#         "warmer",
#       bt_zscore > 0 & abs(bt_zscore) < 1 ~ "slightly warmer",
#       bt_zscore < 0 & abs(bt_zscore) >= 1 ~ "colder",
#       bt_zscore < 0 & abs(bt_zscore) < 1 ~ "slightly colder",
#       TRUE ~ "the same as the mean"
#     ), 
#     st_zscore = (st - mean(temp$st))/sd(temp$st), 
#     st_thanotheryrs = dplyr::case_when(
#       abs(st_zscore) < 0.1 ~ "nearly average",
#       st_zscore > 0 & # positive
#         abs(st_zscore) >= 1 ~ # greater than 1 sd from the mean
#         "warmer",
#       st_zscore > 0 & abs(st_zscore) < 1 ~ "slightly warmer",
#       st_zscore < 0 & abs(st_zscore) >= 1 ~ "colder",
#       st_zscore < 0 & abs(st_zscore) < 1 ~ "slightly colder",
#       TRUE ~ "the same as the mean"
#     ))
# 
# temp <- temp %>% 
#   dplyr::filter(year != maxyr) %>% 
#   dplyr::mutate(
#     btthanmaxyr = dplyr::case_when(
#       bt < btt  ~ "warmer",
#       bt > btt ~ "colder"),
#     stthanmaxyr = dplyr::case_when(
#       st < stt ~ "warmer",
#       st > stt ~ "colder"),
#     thanmaxyr = dplyr::case_when(
#       bt < btt & st < stt ~ "both warmer",
#       bt > btt & st > stt ~ "cold",
#       bt > btt & st < stt ~ "bt warmer, st colder",
#       bt < btt & st > stt ~ "bt colder, st warmer"),
#     btt = round(btt, digits = 2), 
#     stt = round(stt, digits = 2), 
#     bt = round(bt, digits = 2), 
#     st = round(st, digits = 2))
# 
# str0 <- paste0(
#   "In the NBS ", maxyr ,
#   " survey, the overall mean bottom temperature (",
#   unique(temp$btt),"°C) was ")
# 
# if (length(unique(temp$btthanmaxyr))==1) { # are the same
#   str0 <- paste0(str0, 
#                    unique(temp$btthanmaxyr),
#                    " than in ",
#                    text_list(temp$year)," (",
#                    text_list(paste(temp$bt, "°C", sep = "")),
#                    ifelse(length(temp$year)>1, ", respectively", ""), ")")
#   
# } else {# are different
#   for (i in 1:length(unique(temp$btthanmaxyr))) {
#     temp1 <- temp %>% 
#       dplyr::filter(btthanmaxyr == 
#                       unique(temp$btthanmaxyr)[i])
#     
#     str0 <- paste0(str0, ifelse(i==2, ", but ", ""), 
#                      unique(temp$btthanmaxyr)[i],
#                      " than in ",
#                      text_list(temp1$year)," (",
#                      text_list(paste(temp1$bt, "°C", sep = "")),
#                      ifelse(length(temp1$year)>1, ", respectively", ""), ")")
#   }
#   str0<-paste0(str0, ". ")    
# }
# 
# # percent area above 10*C
# temp2 <- coldpool:::nbs_ebs_surface_temperature
# # temp2 <- temp2[grepl(pattern = maxyr, x = names(temp2))]
# temp2 <- projectRaster(temp2, crs = crs(reg_dat$akland))
# temp2 <- as(temp2, "SpatialPixelsDataFrame")
# temp2 <- as.data.frame(temp2)
# temp3 <- gsub(pattern = "[A-Za-z]+", 
#               replacement = "", 
#               x = names(temp2[!(names(temp2) %in% c("x", "y"))]))
# temp3 <- gsub(pattern = "_", replacement = "", x = temp3) 
# colnames(temp2) <- c(temp3, "latitude", "longitude")
# 
# temp3 <- temp2 %>% 
#   dplyr::select(all_of(as.character(nbsyr)), latitude, longitude) %>% 
#   tidyr::pivot_longer(cols = all_of(as.character(nbsyr)), 
#                       names_to = "year", values_to = "st") %>%
#   dplyr::group_by(year) %>%
#   # dplyr::summarise(x = sum(st<=10)) %>% 
#   #TOLEDO, st should be >=10, but before it was giving trouble.  Flipped that sucka around and it seems to be outputting the correct number, but we are actually trying to calculate sea surf temps >=10C!
#   # dplyr::filter(x == FALSE) %>%
#   dplyr::mutate(x = st<=10) 
# 
# temp3 <- table(temp3[,c("year", "x")]) %>% 
#   data.frame() %>%
#   dplyr::filter(x == FALSE) %>% 
#   dplyr::mutate(perc = round((Freq/nrow(temp2))*100, digits = 0) )


# The annual mean NBS bottom temperatures in `r maxyr` were `r temp0$bt_thanotheryrs[temp0$year == maxyr]` and the surface temperatures were `r temp0$st_thanotheryrs[temp0$year == maxyr]` than in previous years (Figure `r crossref(list_obj = list_figures, nickname = "fig_mean_temperature", sublist = 'number')`). Bottom temperatures measured during the `r maxyr ` NBS survey ranged from `r round(min(haul_maxyr$gear_temperature[haul_maxyr$SRVY == "NBS"]), digits = 1)`°C to `r round(max(haul_maxyr$gear_temperature[haul_maxyr$SRVY == "NBS"]), digits = 1)`°C (Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_all_nebs_surveys', sublist = 'number')`) and sea surface temperatures ranged from `r round(min(haul_maxyr$surface_temperature[haul_maxyr$SRVY == "NBS"]), digits = 1)`°C to `r round(max(haul_maxyr$surface_temperature[haul_maxyr$SRVY == "NBS"]), digits = 1)`°C (Figure `r crossref(list_obj = list_figures, nickname = 'fig_st_all_nebs_surveys', sublist = 'number')`). In `r maxyr `, surface temperatures above 10°C were recorded in only `r temp3$perc[temp3$year == maxyr] `% of the NBS survey area, which was `r ifelse(sum(temp3$perc[temp3$year == maxyr]<mean(temp3$perc[temp3$year != maxyr])), "less", "more") ` than in past years, when temperatures above 10°C were recorded in `r min(temp3$perc[temp3$year != maxyr], na.rm = TRUE)`-`r max(temp3$perc[temp3$year != maxyr], na.rm = TRUE)`% of the NBS area (Figure `r crossref(list_obj = list_figures, nickname = 'fig_st_all_nebs_surveys', sublist = 'number')`). 

```

```{r results-cold-pool_insert, child=paste0(dir_out_rawdata, "/0-cold-pool.Rmd")}
```

<!-- \newpage -->

```{r fig-temperature-1}
nickname <- "fig-temperature-bt-1"
```

```{r temperature-1-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

```{r fig-temperature-2}
nickname <- "fig-temperature-bt-2"
```

```{r temperature-2-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

```{r fig-temperature-3}
nickname <- "fig-temperature-st-1"
```

```{r temperature-3-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

```{r fig-temperature-4}
nickname <- "fig-temperature-st-2"
```

```{r temperature-4-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

```{r fig-mean-temperature}
nickname <- "fig-mean-temperature"
```

```{r fig-mean-temperature-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

```{r fig-cold-pool-area}
nickname <- "fig-cold-pool-area"
```

```{r fig-cold-pool-area-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

## Survey Data and Specimen Collections

```{r specimen-collections}
  # obtain data
  load(file = paste0(dir_out_figtab, "tab-specimen-samples-EBS.rdata"))
  obj1 <- obj
  
    temp1 <- obj1$raw %>% 
      dplyr::filter(common_name != "Total" &
                      !(grepl(x = common_name, pattern = "crab", ignore.case = TRUE)))
  
  if (SRVY == "NEBS") {
  load(file = paste0(dir_out_figtab, "tab-specimen-samples-NBS.rdata")) # obj
      temp1 <- temp1 %>% dplyr::bind_rows(
    obj$raw %>% 
      dplyr::filter(common_name != "Total" &
                      !(grepl(x = common_name, pattern = "crab", ignore.case = TRUE))) )    
  }

  temp1 <- dplyr::bind_rows(
    obj1$raw %>% 
      dplyr::filter(common_name != "Total" &
                      !(grepl(x = common_name, pattern = "crab", ignore.case = TRUE))), 
    obj$raw %>% 
      dplyr::filter(common_name != "Total" &
                      !(grepl(x = common_name, pattern = "crab", ignore.case = TRUE))) ) %>% 
    dplyr::select(-SRVY) %>% 
    dplyr::group_by(common_name) %>% 
    dplyr::summarise(across(everything(), ~ sum(., na.rm = TRUE))) %>% 
    dplyr::ungroup()
  
  # list taxpn used in each sample
  temp3 <- c()
  for (i in 2:ncol(temp1)) {
    temp2 <-  temp1[, c(1, i)]
    temp2 <- temp2[temp2[,2]>0,]
    temp2$spp <- text_list(unique(temp2$common_name))
    temp3 <- dplyr::bind_cols(temp3, 
                              data.frame(temp = temp2$spp[1]) )
    names(temp3)[i-1] <- paste0("spp_", names(temp2)[2])
  }
  
  # count taxon used in each sample
  temp1 <- temp1 %>% 
    dplyr::select(-common_name) %>%
    tidyr::pivot_longer(cols = names(.), names_to = "var", values_to = "val") %>% 
    dplyr::filter(val != 0) %>% 
    dplyr::group_by(var) %>% 
    dplyr::summarise(n = n()) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(var = paste0("n_", var)) %>% 
    tidyr::pivot_wider(names_from = var, values_from = n)
  
  temp <- dplyr::bind_rows(
    obj$raw %>% 
      dplyr::filter(common_name == "Total") , 
    obj1$raw %>% 
      dplyr::filter(common_name == "Total") ) %>%
    # dplyr::filter(!(grepl(x = common_name, pattern = "crab", ignore.case = TRUE))) %>% 
    dplyr::select(-SRVY, -common_name) %>%
    dplyr::ungroup() %>% 
    dplyr::summarise(across(everything(), ~ sum(., na.rm = TRUE)))

  temp <- data.frame(t(temp))
  names(temp) <- "n_samples"
  temp$var <- rownames(temp)
  temp1 <- data.frame(t(temp1))
  names(temp1) <- "n_taxa"
  temp1$var <- gsub(pattern = "n_", replacement = "", x = rownames(temp1))
  temp3 <- data.frame(t(temp3))
  names(temp3) <- "text_taxa"
  temp3$var <- gsub(pattern = "spp_", replacement = "", x = rownames(temp3))
  
  temp0 <- dplyr::left_join(temp, temp1, by = "var") %>% 
    dplyr::left_join(temp3, by = "var") %>% 
    dplyr::mutate(var0 = tolower(gsub(pattern = "\n", x = var, replacement = " ")), 
                  taxa_type = "fish") %>% 
    dplyr::arrange(desc(n_samples))

  temp000 <- temp0 %>%
    dplyr::filter(var == "Length\nmeasurements")
    
  temp00 <- temp0 %>%
    dplyr::filter(var != "Length\nmeasurements")
  
    str0 <- text_list(
        paste0(xunits(temp00$n_samples), " ",
         (temp00$var0), " ",
         ifelse(temp00$n_samples == 1, "was", "were"),
         " collected from ",
         ifelse(temp00$n_samples == 1, "a", ""), # TOLEDO - what if starts with vowel???
         ifelse(temp00$n_taxa < 4, 
                temp00$text_taxa,
                paste0(xunits(temp00$n_taxa), " taxa")) ), sep = "; ")
    
str0 <- gsub(pattern = "  ", replacement = " ", x = str0)
```

From the `r text_list(SRVY1)` shelf trawl survey`r plural_surveys`, length measurements were collected from `r xunits(temp000$n_samples)` individual fish representing `r xunits(temp000$n_taxa)` fish taxa. Additionally, `r str0`. 

## Estimates of Fishes and Invertebrates

```{r biomass-inc-dec-tot}

# million metric tons of biomass collected in each region in each year
temp <- total_biomass %>% 
  dplyr::group_by(year, SRVY) %>% 
  dplyr::summarise(biomass_mmt = round(sum(total, na.rm = TRUE)/1e6, digits = 1)) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(desc(year))

# temp <- biomass %>%
#   dplyr::filter(stratum == 999 & 
#                   (species_code >= 40000 &
#                      species_code < 99991) |
#                   (species_code > 1 &
#                      species_code < 35000) &
#                   year %in% nbsyr) %>%
#   # dplyr::select(year, SRVY, biomass_mt) %>% 
#   dplyr::group_by(year, SRVY) %>% 
#   dplyr::summarise(biomass_mmt = round(sum(biomass_mt)/1e6, digits = 1)) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::arrange(desc(year))
```

In `r maxyr`, the total bottom-dwelling organismal biomass of the EBS shelf was estimated at `r temp$biomass_mmt[temp$year == maxyr & temp$SRVY == "EBS"] ` million metric tons (t) and the NBS shelf was estimated at `r temp$biomass_mmt[temp$year == maxyr & temp$SRVY == "NBS"] ` million t. Previously, the total bottom-dwelling animal biomass of the `r text_list(paste0(temp$year[temp$year != maxyr], " ", temp$SRVY[temp$year != maxyr], " shelf was estimated at ", temp$biomass_mmt[temp$year != maxyr], " million t"))`. The percent change in biomass varied by fish and invertebrate taxon (Table \@ref(tab:tab-majortaxa-pchange-NBS)). 

```{r biomass-inc-dec-spp}

load(file = paste0(dir_out_figtab, "tab-majortaxa-pchange-NBS.rdata"))

temp1 <- obj$raw %>%
      # dplyr::filter(SRVY == "NBS") %>%
      dplyr::select(print_name, change, change0, maxyr, taxon, SRVY) %>%
  dplyr::arrange(desc(change)) %>%
 # I defined "no marked change" in < 25 and > -25% change to get me through the code. What number should it be?
  dplyr::mutate(
    change_case = dplyr::case_when(
    change0 < -25 ~ "decreasing",
    change0 > 25 ~ "increasing",
    TRUE ~ "no notable change in" ),
    change_case1 = dplyr::case_when(
    change0 < -25 ~ "decreases",
    change0 > 25 ~ "increases",
    TRUE ~ NA
  ))  %>%
  dplyr::arrange(change_case)

temp44 <- temp1 %>%
  dplyr::group_by(taxon, change_case, SRVY) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(id_cols = c(change_case, SRVY), 
                     names_from = taxon, values_from = n) %>%
  dplyr::mutate(
    str0_fish = ifelse(is.na(fish), "", paste0(xunits(fish), " fish", ifelse(fish>1, "es", ""))),
    str0_invert = ifelse(is.na(invert), "", paste0(xunits(invert), " invertebrate", ifelse(invert>1, "s", ""))),
    str0 = paste0(str0_fish, ifelse(str0_invert == "", "", " and "), str0_invert))

temp3 <- temp1  %>%
  dplyr::arrange(desc(change0)) %>%
  dplyr::filter(#taxon == "fish"  &
                  # !grepl(x = print_name, pattern = "other ") &
                  !is.na(change_case1))

temp33 <- dplyr::bind_rows(
  head(temp3[which(temp3$SRVY == "EBS"),]), 
                          tail(temp3[which(temp3$SRVY == "EBS"),]), 
                          head(temp3[which(temp3$SRVY == "NBS"),]), 
                          tail(temp3[which(temp3$SRVY == "NBS"),])) %>%
  dplyr::group_by(change_case1, SRVY) %>%
  dplyr::summarise(spp_list = text_list(paste0(print_name, " (", change, ")"))) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(change_case1)

str0 <- ""

for (i in 1:length(SRVY00)) {

  temp3 <- temp33 %>% dplyr::filter(SRVY == SRVY1[i])
  temp4 <- temp44 %>% dplyr::filter(SRVY == SRVY1[i])
  
str0 <- paste0(str0, 
paste0(
  "In the ",SRVY1[i]," between ", compareyr, " and ", maxyr , ", ",
               text_list(paste0(temp4$str0, " experienced ", temp4$change_case, " biomass")),
  ifelse(i == 1, " within ± 25% change from the previous survey year. ", ". "),
               paste0("Prominent organisms that exhibited the largest ", temp3$change_case1,
" in biomass included ", temp3$spp_list,  
collapse = ifelse(i == 1, " (Table \\@ref(tab:tab-majortaxa-pchange-NBS)). ", ". ")), 
collapse = ". " ), ". " )
}

str0 <- gsub(pattern = ") (", replacement = "; ", x = str0, fixed = TRUE)

```

`r str0`

```{r biomass-inc-dec}

load(file = paste0(dir_out_figtab, "tab-majortaxa-pchange-NBS.rdata"))
temp1 <- obj$raw

# total biomass
temp2 <- total_biomass  %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(SRVY == "NBS") %>%
  dplyr::group_by(year) %>% 
  dplyr::summarise(total = sum(total, na.rm = TRUE)) %>% 
  dplyr::ungroup()

# calculate top 50% of haul
temp0 <- temp3 <- data.frame()
str0 <- str00 <- c()

for (i in 1:length(nbsyr)) {
  
  yr <- as.numeric(sort(nbsyr, decreasing = TRUE)[i])
  temp <- temp2$total[temp2$year == yr]
  
  temp5 <- temp1  %>% 
  dplyr::filter(SRVY == "NBS") %>% 
    dplyr::rename("x" = all_of(as.character(yr))) %>% 
    dplyr::arrange(desc(x)) %>% 
    dplyr::select(print_name, x, taxon) %>% # species_name, 
    dplyr::mutate(prop = x/temp) %>% 
    dplyr::mutate(cumsum = cumsum(prop))  %>% 
    dplyr::mutate(year = yr)
  
  # Top 50% spp
  temp4 <- temp5 %>% 
    dplyr::filter(dplyr::between(x = cumsum, left = 0, right = .55))
  
  temp3 <- rbind.data.frame(temp3, temp5)
  
  if (yr == maxyr) {
    str0 <- paste0(str0, 
                     paste0("In ", yr, ", ", 
                            text_list(paste0(temp4$print_name, " (", 
                                                          round(temp4$prop*100, digits = 0), "%)")), 
                            " together comprised over 50% of the total estimated biomass in the NBS. "))
  } else if (i==2) {
    str0 <- paste0(str0, 
                     paste0("Previously, in ", yr, ", ", 
                            text_list(
                              paste0(temp4$print_name, " (", round(temp4$prop*100, digits = 0), "%)"))))
  } else {
    str0 <- paste0(str0, 
                     paste0(ifelse(i==length(nbsyr), "; and in ", "; in "), yr, ", ", 
                            text_list(
                              paste0(temp4$print_name, " (", round(temp4$prop*100, digits = 0), "%)"))))
    
  }
  
  # str0 <- paste0(str0, ifelse(i %in% c(1,length(nbsyr)), "", ", "))
  str0 <- paste0(str0, ifelse(i == length(nbsyr), 
                                  " together comprised over 50% of the total estimated biomass in the NBS", ""))
  
  # Other cods: saffron cod and Arctic cod
  temp0 <- rbind.data.frame(temp0, 
                            temp5 %>% 
                              dplyr::filter(print_name %in% c("saffron cod","Arctic cod")) )
}

temp0 <- temp0 %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(prop = sum(prop, na.rm = TRUE)) %>% 
  dplyr::arrange(desc(year)) %>% 
  dplyr::mutate("perc" = paste0(round(x = prop*100, digits = 1), "%"))

temp3 <- temp3  %>% 
  # dplyr::mutate(case = dplyr::case_when(
  #   prop*100>0 ~ "increasing", 
  #   TRUE ~ "decreasing")) %>% 
  dplyr::select(taxon, year, x,) %>%
  dplyr::group_by(taxon, year) %>% 
  dplyr::summarise(biomass_mt = sum(x, na.rm = TRUE)) %>% 
  tidyr::pivot_wider(names_from = taxon, values_from = biomass_mt, id_cols = year) %>% 
  dplyr::mutate(total = (fish + invert), 
                invert_perc = invert/total, 
                invert_perc = formatC(x = invert_perc*100, digits = 0, big.mark = ",", format = "f")) %>% 
  dplyr::arrange(desc(year))

```

`r str0`. 

Saffron cod and Arctic cod accounted for `r text_list(paste0(temp0$perc, " of the total biomass in ", temp0$year)) `. Invertebrates (i.e., shrimps, sea squirts, sea stars, jellyfish, crabs, and urchins) made up `r text_list(paste0(temp3$invert_perc, "% of the biomass in ", temp3$year))`.

```{r ebs-vs-nbs}

temp5 <- 
  dplyr::left_join(
    x = biomass %>%
      dplyr::filter(#stratum == 999 & 
        species_code != 1,
        # SRVY == "NBS" & 
        year %in% nbsyr) %>% 
      dplyr::select(year, species_code, biomass_mt, SRVY), 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_code, taxon, species_name1) %>% 
      dplyr::rename(group = print_name, 
                    species_name = print_name), 
    # dplyr::mutate(species_name = as.character(unlist(lapply(strsplit(x = group, split = "_", fixed = TRUE), `[[`, 1)))),
    by = c("species_code")) %>% 
  dplyr::group_by(year, species_name, taxon, SRVY) %>% 
  dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE)) %>% 
  dplyr::left_join(x = ., 
                   y = stratum %>% 
                     dplyr::select(SRVY, area_km2) %>% 
                     dplyr::group_by(SRVY) %>% 
                     dplyr::summarise(area_km2 = sum(area_km2, na.rm = TRUE)), 
                   by = "SRVY") %>%
  dplyr::mutate(biomass_area = biomass_mt/area_km2) %>%
  tidyr::pivot_wider(id_cols = c(species_name, taxon), 
                     names_from = c(year, SRVY), 
                     values_from = c(biomass_area)) %>%
  dplyr::arrange(desc(all_of(paste0(maxyr, "_NBS")))) 

temp5$maxyr_EBS <- temp5[,names(temp5) %in% paste0(maxyr, "_EBS")]
temp5$maxyr_NBS <- temp5[,names(temp5) %in% paste0(maxyr, "_NBS")]

temp5 <- temp5 %>% 
  dplyr::mutate(maxyr_case = maxyr_EBS < maxyr_NBS, 
                extends_thru_both = (maxyr_case %in% c(TRUE, FALSE) & 
                                       maxyr_EBS > .05 &
                                       maxyr_NBS > .05)) 

# > \fancypagestyle{csaplscape}  https://www.google.com/url?sa=j&url=https%3A%2F%2Fgithub.com%2Fpbs-assess%2Fcsasdown%2Fissues%2F31&uct=1634361613&usg=PiE96PLA8FqdrWy10fl2phvIyX8.&source=meet

```

On average, NBS survey catches were smaller than those from the EBS. Distributions of some of the predominant species, such as `r text_list(temp5$species_name[temp5$extends_thru_both == TRUE])`, extended throughout much of both survey regions. Several key fish species were found in the NBS in greater numbers than the EBS, including `r text_list(temp5$species_name[temp5$maxyr_case == TRUE & temp5$taxon == "fish"])`.

Detailed summary profiles outlining several of the species showing ecologically significant trends are discussed in Table \@ref(tab:tab-majortaxa-pchange-NBS).

\pagebreak

```{r tab-majortaxa-pchange-NBS}
# <!---BLOCK_LANDSCAPE_START--->
nickname <- "tab-majortaxa-pchange-NBS"
# <!-- -BLOCK_LANDSCAPE_STOP- -->
```

```{r tab-majortaxa-pchange-NBS-child, child = paste0(dir_code, "_child_report_figtab.Rmd")}
```

# Summary Results for Select Major Taxa

Survey results for select taxa are presented with a photograph of the taxon, maps of geographic distribution of CPUE (kg/km^2), plots showing total population estimates at each length, and a short summary of results. Geographic maps of species distributions include both the EBS and NBS survey regions to better illustrate patterns and trends in fish distribution and movement. For comparison, distribution maps and abundance-at-size plots show survey data for the `r text_list(nbsyr) ` surveys. **You can help us with this document by providing names in local language(s) and cultural or traditional uses for each fish and invertebrate species reviewed in this report.**
