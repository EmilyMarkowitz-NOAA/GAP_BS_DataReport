---
output:
  officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

# Introduction

## fig-sampled-survey-stations

```{r fig-sampled-survey-stations}
nickname <- "fig-sampled-survey-stations"
header <- paste0("Stratification scheme used for data analysis of the ", maxyr," ",
                 text_list(haul_cruises_maxyr$SRVY_long),
                 " shelf bottom trawl survey", ifelse(SRVY == "NEBS", "s", ""), 
                 ". The map also depicts the stations sampled by the ",
                 text_list(paste0(vessels$vessel_ital, " (",
                                  vessels$vess_shape, ")")), 
                 ifelse(crab_resample == TRUE, " and where Bristol Bay crab resampling was conducted", ""), ". ")

height <- ifelse(SRVY == "NEBS", full_page_portrait_height, 6) # height <- 
width <- full_page_portrait_width

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- 
  dplyr::left_join(x = reg_dat0$survey.grid, 
                   y = dplyr::left_join(x = haul_maxyr, 
                                        y = vessels) %>% 
                     dplyr::select(station, vessel_name, vess_shape) %>%
                     dplyr::mutate(vess_col = dplyr::case_when(
                       (vess_shape == vessels$vess_shape[1]) ~ nmfspalette::nmfs_cols("dkgray"), 
                       (vess_shape == vessels$vess_shape[2]) ~ nmfspalette::nmfs_cols("supdkgray"))) %>% 
                     dplyr::rename(station = station), 
                   by = ("station"))

if (crab_resample == TRUE){
  reg_dat0$survey.grid <- dplyr::left_join(
    x = reg_dat0$survey.grid, 
    y = haul_maxyr_crabretow %>% 
      dplyr::mutate(study = "crab_resample", 
                    study_col = nmfspalette::nmfs_cols("medgray"),
                    study = "crab_resample", 
                    study_long = "Red King Crab\nResample") %>% 
      dplyr::select(station, study, study_col, study_long) %>%
      dplyr::rename(station = station) %>% 
      unique(), 
    by = ("station")) 
}

figure <- plot_survey_stations(
  reg_dat = reg_dat0, 
  station, 
  haul_cruises_maxyr, 
  station_grid = FALSE, 
  stratum_no = TRUE, 
  bathymetry = FALSE, 
  station_pts_srvy = FALSE, 
  station_pts_vess = TRUE, 
  study = crab_resample) # defined in data.r

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## fig-sample-grid

```{r fig-sample-grid}
header <- paste0("Sampling grid and station identifiers for the ",maxyr," ",
                 text_list(haul_cruises_maxyr$SRVY_long),
                 " continental shelf bottom trawl survey", 
                 ifelse(SRVY == "NEBS", "s", ""), 
                 ". ", ifelse(SRVY == "NBS", "", "Corner stations (denoted by circles) are not labeled for legibility. "))
nickname <- "fig-sample-grid"
subobj <- FALSE

height <- ifelse(SRVY == "NEBS", full_page_portrait_height, 6)
width <- full_page_portrait_width

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- reg_dat0$survey.grid %>% 
  dplyr::mutate(station = ifelse(!grepl(pattern = "-", x = station), "", station))
reg_dat0$place.labels <- reg_dat0$place.labels %>% 
  dplyr::filter(type %in% c("mainland", "peninsula"))

figure <- plot_survey_stations(reg_dat = reg_dat0, 
                               station = station, 
                               haul_cruises_maxyr = haul_cruises_maxyr, 
                               station_grid = TRUE, 
                               stratum_no = FALSE, 
                               station_pts_srvy = FALSE, 
                               place_labels = TRUE)

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

# Methods

## fig-vessels

```{r fig-vessels}
header <- paste0("Fishing vessels ",
                 text_list(paste0(vessels$vessel_ital, 
                                  " (", c("left", "right"), ")")),
                 " contracted to conduct the ",maxyr," ",
                 SURVEY,
                 " bottom trawl survey.")
nickname <- "fig-vessels"

height <- 2.5
width <- full_page_portrait_width

figure <- cowplot::plot_grid(
  cowplot::ggdraw() +
    cowplot::draw_image(readPNG(paste0(dir_img, vessels$img[1])), 
                        scale = 0.9 ), 
  cowplot::ggdraw() +
    cowplot::draw_image(readPNG(paste0(dir_img, vessels$img[2])), 
                        scale = 0.9 ),  
  ncol = 2, rel_heights = c(0.1, 1))

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## fig-trawl-gear

```{r fig-trawl-gear}
header <- paste0("Schematic diagram of the 83-112 eastern otter trawl gear used during the ", 
                 maxyr ," ", SURVEY ," bottom trawl survey", 
                 ifelse(length(SRVY1)>1, "s", ""), ".")
footnote<- NA
nickname <- "fig-trawl-gear"
alttext <- paste0(header)
height = 8
width <- full_page_portrait_width

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "EASTERN83-112.png")) )

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## tab-stratum-areas

```{r tab-stratum-areas}
header <- paste0("Stratum areas and sampling densities used during the ",maxyr,
                 " ", SURVEY ," bottom trawl survey", 
                 ifelse(length(SRVY1)>1, "s", ""),". Stratum area calculations were updated in ", 
                 stratum$year[1] , ". ")

nickname <- "tab-stratum-areas" 

temp <- stratum %>% 
  dplyr::select(area_km2, stations_avail, stations_completed, stratum, area_name, SRVY) %>% 
  dplyr::mutate(area_name = gsub(replacement = "Shelf", x = area_name, pattern = "Domain")) 

if (length(unique(station$SRVY))>1) {
  totals_sub <- temp %>%
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(
      area_km2 = sum(area_km2, na.rm = TRUE),
      stations_completed = sum(stations_completed, na.rm = TRUE), 
      stations_avail = sum(stations_avail, na.rm = TRUE)) %>%
    dplyr::mutate(area_name = "Total") 
}

totals <- temp %>% 
  dplyr::summarise(
    area_km2 = sum(area_km2, na.rm = TRUE), 
    stations_completed = sum(stations_completed, na.rm = TRUE), 
    stations_avail = sum(stations_avail, na.rm = TRUE)) %>% 
  dplyr::mutate(area_name = "Total", 
                SRVY = paste0("Z", text_list(SRVY1))) 

table_raw <- dplyr::bind_rows(
  temp, 
  if(exists("totals_sub")){totals_sub}, 
  totals) %>% 
  dplyr::mutate(
    density = round(area_km2/stations_completed, 0), 
    area_km2 = round(area_km2, digits = 0)) %>%
  dplyr::arrange(SRVY, area_name, stratum) %>% 
  dplyr::relocate(SRVY, area_name, stratum, area_km2, 
                  stations_avail, stations_completed, density) %>% 
  dplyr::mutate(SRVY = gsub(replacement = "", x = SRVY, pattern = "Z"))

table_print <- table_raw %>%
  flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL)  %>%
  flextable::as_flextable(font = font0, x = ., hide_grouplabel = TRUE) %>%
  flextable::compose(x = ., i = 1, j = "area_km2", part = "header",
                     value = as_paragraph("Representative\narea (km", as_sup("2"), ")")) %>%
  flextable::compose(x = ., i = 1, j = "density", part = "header",
                     value = as_paragraph("Sampling density\n(km", as_sup("2"), "/Stations successfully sampled)")) %>%  
  flextable::set_header_labels(., 
                               area_name = "",
                               stratum = "Stratum",
                               stations_avail = "Stations\nin stratum",
                               stations_completed = "Stations\nsuccessfully sampled") %>% 
  flextable::merge_v(j = "area_name") %>%
  flextable::merge_h_range(x = ., 
                           i = ~ stratum == "", 
                           j1 = "area_name", 
                           j2 = "stratum", 
                           part = "body") %>%
  flextable::valign(valign = "top") %>%
  theme_flextable_nmfstm(x = ., 
                         row_lines = FALSE, 
                         pad = 0, 
                         font0 = font0, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::align(x = ., j = c("stratum", "area_km2", "stations_completed", "density"), 
                   align = "right", part = "all")  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::padding(x = .,
                     j = 1, i = ~ is.na(SRVY),
                     padding.left = 5)   %>%
  flextable::hline(x = ., i = ~ !is.na(area_name), #j = SRVY, #border = fp_border(width = 3), 
                   part = "body")  %>%
  flextable::hline(x = ., i = ~ (area_name == "Total"), #j = SRVY, #border = fp_border(width = 3), 
                   part = "body", border = fp_border(width = 2)) 

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## tab-oto-collection-scheme

```{r tab-oto-collection-scheme-[SRVY]}
nickname <- paste0("tab-oto-collection-scheme") 

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                                sheet = "Sheet1", 
                                skip = 1) %>% 
  dplyr::filter(year == maxyr & 
                  !is.na(oto_target)) %>% 
  dplyr::mutate(oto_target = paste0(oto_target, ifelse(oto_rules != 1, paste0("; collect when \u2265", oto_rules, " individuals caught in each haul"), ""))) %>% 
  dplyr::left_join(
    y = report_spp1 %>% 
      dplyr::select(print_name, order) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::distinct() %>%
  dplyr::arrange(SRVY, oto_samp_type, order) %>% 
  dplyr::select(SRVY, print_name, oto_target, oto_samp_type)

header <- paste0("Otolith collection types and counts during the ", 
                 maxyr, " ", 
                 text_list(haul_cruises_maxyr$SRVY_long),
                 " shelf bottom trawl survey", ifelse(length(SRVY1)>1, "s", ""),".")

table_print <- table_raw %>% 
  flextable::as_grouped_data(x = ., groups = c(
    "SRVY", "oto_samp_type"), 
    columns = NULL) %>% 
  flextable::as_flextable(x = ., hide_grouplabel = TRUE) %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(oto_samp_type) ) %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>% 
  flextable::set_header_labels(.,
                               print_name = "Common name", 
                               oto_target = "Target collection number per haul") %>%
  theme_flextable_nmfstm(x = ., pad = 0, 
                         font0 = font0, 
                         row_lines = TRUE, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::padding(x = .,
                     j = 1, i = ~ !is.na(oto_samp_type),
                     padding.left = 5) %>%
  flextable::padding(x = .,
                     j = 1, i = ~ (is.na(oto_samp_type) &  is.na(SRVY)),
                     padding.left = 10) %>%
  flextable::width(x = ., j = "oto_target", width = 4.5, unit = "in") %>%
  flextable::width(x = ., j = c("print_name"), width = 2) %>% 
  flextable::hline(x = ., i = ~ !is.na(oto_samp_type), 
                   border = fp_border(color = "white"), 
                   part = "body") 

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## tab-stomach-collection-scheme

```{r tab-stomach-collection-scheme}
nickname <- paste0("tab-stomach-collection-scheme") 

header <- paste0("Stomach collection targets during the ", 
                 maxyr, " ", 
                 text_list(paste0( 
                   haul_cruises_maxyr$SRVY_long)),
                 " shelf bottom trawl survey.")

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                                sheet = "Sheet1", 
                                skip = 1) %>% 
  dplyr::filter(year == maxyr & !is.na(stomach_target)) %>% 
  dplyr::left_join(
    y = report_spp1 %>% 
      dplyr::select(print_name, order) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::distinct() %>%
  dplyr::arrange(SRVY, stomach_target, order) %>% 
  dplyr::select(SRVY, print_name, stomach_target) %>% 
  dplyr::mutate(stomach_target = as.character(round(as.numeric(stomach_target), digits = 0))) %>% 
  tidyr::pivot_wider(data = ., id_cols = c("print_name"), 
                     names_from = "SRVY", values_from = "stomach_target")

table_raw[is.na(table_raw)] <- "-"

table_print <- flextable::flextable(table_raw) %>% 
  flextable::set_header_labels(x = .,
                               print_name = "Common name", 
                               stomach_target = "Target collection number per survey") %>%
  theme_flextable_nmfstm(x = ., 
                         pad = 0, 
                         font0 = font0, 
                         row_lines = TRUE, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::align(x = ., j = c(SRVY1), 
                   align = "right", part = "all")   %>%
  flextable::width(x = ., width = (2.5/length(SRVY1)))  %>%
  flextable::width(x = ., j = "print_name", width = 4)  

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## tab-special-projects

```{r tab-special-projects}
nickname <- "tab-special-projects" 
places <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                             sheet = "affiliations", 
                             skip = 1)

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                                sheet = "projects", 
                                skip = 1)  %>% 
  dplyr::filter(!is.na(`Project title`) & 
                  year == maxyr) %>% 
  dplyr::select(SRVY, `Project title`, `Principal investigator`, Agency) %>% 
  dplyr::mutate(
    SRVY = gsub(pattern = "&", x = SRVY, replacement = "and"), 
    SRVY = factor(x = SRVY, 
                  levels = c("EBS and NBS", "EBS", "NBS"), 
                  labels = c("EBS and NBS", "EBS", "NBS"), 
                  ordered = TRUE))%>%
  dplyr::arrange(SRVY, Agency, `Principal investigator`, `Project title`)

header <- paste0("Special projects and collections undertaken during the ",
                 maxyr, " ", 
                 text_list(haul_cruises_maxyr$SRVY_long), 
                 " shelf bottom trawl survey, sorted by principal investigator and agency.")

# find places
temp0 <- unlist(strsplit(x = table_raw$Agency, split = " & ", fixed = TRUE))
temp0 <- unlist(strsplit(x = temp0, split = ", ", fixed = TRUE))
temp1 <- places[places$Agency %in% 
                  unique(temp0), ]

footnote0 <- paste(paste(temp1$Agency, " - ", temp1$agency_long, sep = ""), collapse = "; ")

table_print <- table_raw %>%
  flextable::as_grouped_data(groups = c("SRVY"), columns = NULL) %>% 
  flextable::as_flextable(., hide_grouplabel = TRUE)  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::width(x = ., j = "Agency", width = 2, unit = "in") %>%
  flextable::width(x = ., j = "Principal investigator", width = 3, unit = "in") %>%
  flextable::width(x = ., j = "Project title", width = 4, unit = "in") %>% 
  flextable::footnote(x = ., 
                      value = as_paragraph(footnote0), 
                      ref_symbols = "1",
                      part = "header", 
                      j = "Agency", i = 1)  %>%
  theme_flextable_nmfstm(x = ., 
                         font0 = font0, 
                         pad = 0, 
                         row_lines = TRUE, 
                         pgwidth = full_page_portrait_width) %>% 
  flextable::padding(x = .,
                     j = 1, i = ~ is.na(SRVY),
                     padding.left = 5) %>% 
  flextable::hline(x = ., i = ~ !is.na(SRVY), 
                   border = fp_border(color = "white"), 
                   part = "body")

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

# Results

## fig-mean-temperature

```{r fig-mean-temperature}
# code orig from sean rohan's coldpool package! Jan 23 2021 
nickname <- "fig-mean-temperature"
header <- paste0("Average summer surface and bottom and time-series average surface and bottom (dashed lines) temperatures (°C) on the eastern Bering Sea shelf, based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr,
                 ifelse(SRVY == "NEBS", 
                        paste0(" (left), and northern Bering Sea shelf based on data collected during standardized summer bottom trawl surveys (right)"), ""), 
                 ". ")

height <- 3.25
width <- full_page_portrait_width # 6.5

a <- plot_mean_temperatures(maxyr, SRVY)
for (jjj in 1:length(a)) { assign(names(a)[jjj], a[[jjj]]) }

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## fig-cold-pool-area

```{r fig-cold-pool-area}
header <- paste0("Annual summer cold pool extent on the EBS shelf, based on observations from the EBS bottom trawl survey. The extent of the cold pool is shown as a percentage of the total southern EBS shelf survey area. Shading denotes near-bottom temperatures \u2264 2°C, \u2264 1°C, \u2264 0°C, and \u2264 -1°C.")

footnote <- "Areas were summarized from areas in inverse distance weighted rasters."
nickname <- "fig-cold-pool-area"

height <- 3
width <- full_page_portrait_width

figure <- plot_coldpool_area(coldpool_ebs_bin_area = coldpool_ebs_bin_area, maxyr = maxyr)

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## fig-temperature-[SRVY]-[st/bt]

```{r fig-temperature-[SRVY]-[st/bt], eval = FALSE}
height <- full_page_portrait_height
width <- full_page_portrait_width
yrs0 <- (maxyr-17):maxyr 
row0 <- 3
reg_dat0 <- report_types$NEBS$reg_dat

for (case in c("bottom", "surface")) {
  for (case_yr in c(1,2)) {
    
    if (case_yr == 1) {
      yrs <- yrs0[1:(length(yrs0)/2)]
    } else if (case_yr == 2) {
      yrs <- yrs0[((length(yrs0)/2)+1):length(yrs0)]
    }
    
    if (case == "surface") {
      temp <- terra::unwrap(coldpool::nbs_ebs_surface_temperature)
    } else if (case == "bottom") {
      temp <- terra::unwrap(coldpool::nbs_ebs_bottom_temperature)
    }
    nbs_no_2018 <- raster::subset(
      x = temp, 
      subset = names(temp)[!grepl(x = names(temp),pattern = 2018)]) 
    sebs_only <- names(temp)[which(!(names(temp) %in% paste0("s", names(nbs_no_2018))))]
    sebs_temp <- raster::subset(temp, subset = sebs_only)
    
    a <- rasterbrick[[1]]
    names(a) <- gsub(pattern = gsub("[^0-9.-]", "", names(a)), 
                     replacement = "2020", 
                     x = names(a))
    terra::values(a[[1]]) <- NA
    
    # a@data@values <- rep_len(x = NA, length.out = length(a@data@values))
    # a@data@max <- a@data@min <- NA
    # rasterbrick$temp <- a
    # names(rasterbrick)[names(rasterbrick) == "temp"] <- a@data@names
    
    rasterbrick <- c(a, sebs_temp, nbs_no_2018)
    
    temperature_zscore <- coldpool::cold_pool_index %>% 
      dplyr::rename(var = dplyr::all_of(ifelse(case == "bottom", "MEAN_GEAR_TEMPERATURE", "MEAN_SURFACE_TEMPERATURE")), 
                    year = YEAR) %>%
      dplyr::select(year, var) %>% 
      dplyr::filter(year <= maxyr) %>%
      dplyr::arrange(var) %>% 
      dplyr::mutate(
        sd = sd(var, na.rm = TRUE), 
        mean = mean(var, na.rm = TRUE), 
        zscore  = ((var-mean)/sd), # z = (x-μ)/σ
        sign = dplyr::case_when(
          zscore <= -1 ~ "-", 
          zscore >= 1 ~ "+"), 
        color = dplyr::case_when(
          sign == "+" ~ negative, 
          sign == "-" ~ positive)) %>% 
      dplyr::arrange(year) %>% 
      dplyr::filter(year %in% yrs) 
    
    header <- paste0(stringr::str_to_title(case)," temperatures (°C) during the ", 
                     range_text(yrs), " ", 
                     ifelse(SRVY == "NEBS", "eastern and northern Bering Sea", "eastern Bering Sea"),
                     " shelf bottom trawl survey",
                     ifelse(SRVY=="NEBS", "s", ""),
                     ". Years in which the mean ", case, 
                     " temperature is 1 or more standard deviations above or below the time-series mean ", case, 
                     " temperature are denoted with '+' and '-' in the upper right-hand corner of each subplot, respectively. ")
    
    # Remove non-numeric characters from layer names for subsetting
    # names(rasterbrick) <- gsub("[^0-9.-]", "", names(rasterbrick))
    
    # Subset layers for the selected years
    rasterbrick <- terra::subset(rasterbrick, subset = yrs) # paste0("X", yrs))
    
    rasterbrick[names(rasterbrick) %in% yrs]
    
    nickname <- paste0("fig-temperature-", ifelse(case=="bottom", "bt", "st"), "-", case_yr)
    
    # Create figure
    key.title = ifelse(case == "bottom", 
                       expression(bold("Bottom temperature (°C)")), 
                       expression(bold("Surface temperature (°C)")))
    reg_dat = reg_dat0
    title0 = paste0("Eastern", ifelse(SRVY == "NEBS", " and northern", ""), 
                    " Bering Sea\n", 
                    case, " temperature (", range_text(yrs), ")") 
    
    figure <- plot_temperature_facet(
      rasterbrick = rasterbrick, 
      key.title = key.title, 
      reg_dat = reg_dat0, 
      row0 = row0, 
      title0 = title0, 
      temperature_zscore = temperature_zscore) 
    
    # Save figure
    res <- knitr::knit_child(
      text = knitr::knit_expand(
        file = paste0(dir_code, "_child_save_figtab.Rmd")),
      quiet = TRUE)
  }
}
```

## tab-specimen-samples

```{r tab-specimen-samples-}
nickname0 <- paste0("tab-specimen-samples-") 

# length data - from oracle
l <- lengths_maxyr %>% 
  dplyr::select(SRVY, species_code, frequency) %>% 
  dplyr::group_by(SRVY, species_code) %>% 
  dplyr::summarise(length = sum(frequency, na.rm = TRUE)) %>% 
  dplyr::ungroup() 

# age oto data - from oracle
a <- specimen_maxyr %>% 
  dplyr::filter(!is.na(species_code) & specimen_sample_type == 1) %>%
  dplyr::select("SRVY", species_code) %>% 
  dplyr::group_by("SRVY" = SRVY, species_code) %>% 
  dplyr::summarise(age = as.numeric(n())) %>% 
  dplyr::ungroup()

# other collections not in oracle
temp <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_other_field_collections.xlsx"), 
                           sheet = "Sheet1", 
                           skip = 1) %>%
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(SRVY, print_name, dplyr::starts_with("count_")) %>% 
  dplyr::select(where(~sum(!is.na(.x)) > 0)) 
names(temp) <- gsub(pattern = "count_", replacement = "", x = names(temp))

# Combine
table_raw0 <- 
  dplyr::full_join(x = l, y = a, 
                   by = c("SRVY", "species_code")) %>% 
  dplyr::left_join(x = ., 
                   y = spp_info %>% 
                     dplyr::mutate(
                       common_name = gsub(pattern = " (juvenile)", 
                                          replacement = "", x = common_name, fixed = TRUE), 
                       common_name = dplyr::case_when(
                         is.na(common_name) ~ species_name, 
                         common_name == "shorthorn (=warty) sculpin" ~ "shorthorn sculpin", 
                         TRUE ~ common_name)) %>% 
                     dplyr::select(species_code, common_name), 
                   by = "species_code") %>% 
  dplyr::group_by(SRVY, common_name) %>% 
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
  dplyr::ungroup() %>% 
  dplyr::full_join(x = ., 
                   y = temp, 
                   by = c("SRVY", "common_name" = "print_name")) %>% 
  dplyr::mutate(dplyr::across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
  dplyr::select(-species_code) %>% 
  dplyr::arrange(SRVY, common_name) %>% 
  dplyr::filter(!grepl(pattern = " crab", x = common_name, ignore.case = TRUE))

table_raw0$common_name[is.na(table_raw0$common_name)] <- "other" # TOLEDO

table_raw0 <- 
  dplyr::bind_rows(table_raw0, 
                   table_raw0 %>% 
                     dplyr::group_by(SRVY) %>% 
                     dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
                     dplyr::mutate(common_name = "Total") ) %>% 
  dplyr::relocate(SRVY, common_name, length, age) %>% 
  dplyr::rename("length_measurements" = length,
                "otolith_age_structure_samples" = age) #%>%
# data.frame()

for (i in 1:nrow(haul_cruises_maxyr)) {
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  header <- paste0("Biological data collected during the ", maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey. The annual crab Technical Memorandum produced by the shellfish assessment program summarizes crab samples collected during the survey. ")
  
  table_raw <- table_raw0 %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    dplyr::select(where(~ any(. != 0)))
  
  names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))] <- 
    stringr::str_to_sentence(names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))])
  
  names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))] <- 
    (gsub(pattern = "_",
          replacement = "\n", 
          x = names(table_raw)[!(names(table_raw) %in% 
                                   c("SRVY", "common_name"))], 
          fixed = TRUE))
  names(table_raw)[names(table_raw) == "Otolith\nage\nstructure\nsamples"] <- 
    "Otolith age\nstructure samples"
  names(table_raw)[names(table_raw) == "Pathobiology\nblood\nsamples"] <- 
    "Pathobiology\nblood samples"
  
  table_print <- table_raw %>% 
    dplyr::mutate(across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f")) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    dplyr::select(-"SRVY") 
  
  table_print[is.na(table_print) | table_print == "0"] <- "-"
  
  table_print <- table_print %>% 
    flextable::flextable(data = .) %>%
    flextable::set_header_labels(x = .,
                                 common_name = haul_cruises_maxyr$SRVY[i]) %>% 
    flextable::bold(x = ., i = which(table_print$common_name == "Total")) %>%
    flextable::valign(valign = "top") %>%
    theme_flextable_nmfstm(x = ., 
                           pad = 0, 
                           spacing = 0.4,
                           font0 = font0, 
                           pgwidth = full_page_portrait_width) %>%
    flextable::align(x = ., j = 2:ncol(table_print), 
                     align = "right", part = "all")  %>%
    flextable::width(x = ., width = (5/(ncol(table_raw)-2)), unit = "in") %>%
    flextable::width(x = ., j = "common_name", width = 1.5, unit = "in")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
}
```


## tab-species-composition

```{r tab-species-composition}
if (SRVY == "NEBS"){
  nickname <- "tab-species-composition" 
  header <- paste0("Composition of fish taxa encountered in the ",
                   text_list(paste0(haul_cruises_maxyr$SRVY_long, " shelf (", 
                                    haul_cruises_maxyr$SRVY, ")"))," survey catches. ")
  
  height <- full_page_portrait_height # 7
  width <- full_page_portrait_width # 6.5
  
  # Select data and make plot
  table_raw <- catch_haul_cruises_maxyr %>% 
    dplyr::select(species_code, SRVY, latitude_dd_start) %>% 
    dplyr::group_by(species_code, SRVY) %>% 
    dplyr::summarise(lat_max = max(latitude_dd_start, na.rm = TRUE),
                     lat_min = min(latitude_dd_start, na.rm = TRUE)) %>%
    dplyr::mutate(above_60 = (lat_max >= 60 & lat_min >= 60)) %>%
    tidyr::pivot_wider(data = ., 
                       id_cols = species_code, 
                       names_from = SRVY, 
                       values_from = c(above_60),#, lat_min, lat_max), 
                       values_fill = NA) %>% 
    dplyr::mutate(where = dplyr::case_when(
      !is.na(EBS) & !is.na(NBS) ~ "both", 
      is.na(NBS) & !is.na(EBS)~ "ebs", 
      is.na(EBS) & !is.na(NBS) ~ "nbs")) %>% 
    dplyr::left_join(y = spp_info, 
                     by = "species_code") %>% 
    dplyr::filter(taxon == "fish") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(species_code, common_name, all_of(SRVY1), where) %>% 
    dplyr::filter(!grepl(x = common_name, pattern = " unid.", fixed = TRUE) &
                    !grepl(x = common_name, pattern = " egg", fixed = TRUE) & 
                    !is.na(common_name)) %>%
    dplyr::arrange(common_name)
  
  temp <- table_raw %>% 
    dplyr::select(-species_code)
  
  temp1 <- temp %>% 
    dplyr::filter(where == "ebs" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -NBS) %>% 
    dplyr::rename(above_60 = EBS)
  
  temp2 <- temp %>% 
    dplyr::filter(where == "nbs" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -EBS) %>% 
    dplyr::rename(above_60 = NBS)
  
  # make the same length so they can be bound together
  if (nrow(temp1)>nrow(temp2)) {
    temp2 <- temp2 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  } else {
    temp1 <- temp1 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  }
  
  names(temp1) <- paste0(names(temp1), "_")
  
  temp0 <- dplyr::bind_cols(temp1, temp2)
  
  for (iii in 1:nrow(temp0)) {
    if (grepl(pattern = " unid.", x = temp0$report_name_scientific[iii])) {
      temp0$common_name[iii] <- paste0(temp0$common_name[iii], 
                                       " (", temp0$report_name_scientific[iii], ")")
      temp0$report_name_scientific[iii] <- NA
    }
    if (grepl(pattern = " unid.", x = temp0$report_name_scientific[iii])) {
      temp0$common_name_[iii] <- paste0(temp0$common_name_[iii], 
                                        " (", temp0$report_name_scientific_[iii], ")")
      temp0$report_name_scientific_[iii] <- NA
    }
  }
  
  table_print <- flextable::flextable(
    data = temp0,
    col_keys = c("dummy_ebs","dummy_nbs"))  %>%
    flextable::compose(j = "dummy_ebs", part = "body",
                       value = as_paragraph(
                         as_chunk(ifelse(!is.na(common_name_), 
                                         paste0(common_name_), ""),
                                  props = fp_text_default(bold = FALSE, font.size = 10, font.family = font0)), 
                         as_chunk(ifelse(!is.na(common_name_), 
                                         paste0(" (", common_name_, ")"), ""),
                                  props = fp_text_default(italic = TRUE, font.size = 10, font.family = font0)))) %>%  
    flextable::compose(j = "dummy_nbs", part = "body",
                       value = as_paragraph(
                         as_chunk(ifelse(!is.na(common_name), 
                                         paste0(common_name), ""),
                                  props = fp_text_default(bold = FALSE, font.size = 10, font.family = font0)), 
                         as_chunk(ifelse(!is.na(common_name), 
                                         paste0(" (", common_name, ")"), ""),
                                  props = fp_text_default(italic = TRUE, font.size = 10, font.family = font0)))) %>%  
    flextable::compose(x = ., i = 1, j = "dummy_ebs", part = "header",
                       as_paragraph("Encountered in EBS but not in NBS\nCommon Name ", 
                                    as_chunk(paste0("(Scientific Name)"),
                                             props = fp_text_default(italic = TRUE, bold = TRUE, 
                                                                     font.size = 10, font.family = font0)))) %>%  
    flextable::compose(x = ., i = 1, j = "dummy_nbs", part = "header",
                       as_paragraph("Encountered in NBS but not in EBS\nCommon Name ", 
                                    as_chunk(paste0("(Scientific Name)"),
                                             props = fp_text_default(italic = TRUE, bold = TRUE, 
                                                                     font.size = 10, font.family = font0)))) %>%  
    theme_flextable_nmfstm(x = ., 
                           font0 = font0, 
                           pad = 0, 
                           row_lines = FALSE, 
                           pgwidth = full_page_portrait_width) %>%
    flextable::vline(x = ., j = "dummy_ebs", part = "all") %>%
    flextable::padding(x = ., j = "dummy_nbs", padding.left = 5, part = "all")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
}
```

## tab-biomass-est-[SRVY]-[taxon]

```{r tab-biomass-est-[SRVY]-[taxon]}

temp <- function(exp0, 
                 maxyr, 
                 biomass_by_stratum0,
                 catch_haul_cruises_maxyr0,
                 total_biomass0,
                 spp_code_rnge) {
  
  confint <- function(n_haul, biomass_var) {
    out <- qt(p = 0.025, df = n_haul - 1, lower.tail = F) * sqrt(biomass_var)
    return(out)
  }
  
  biomass_by_stratum0 <- biomass_by_stratum0 %>% 
    dplyr::filter(year == maxyr)
  
  # species level --------------------------------------------------------------
  
  dat <- eval(parse( # select spp 
    text=gsub(pattern = "DATAFRAME", 
              replacement = "biomass_by_stratum0", 
              x = exp0) )) %>% 
    dplyr::ungroup() %>% 
    tidyr::separate(
      col = group0, 
      into = c("group", "taxon"), 
      sep = "_", 
      remove = FALSE) %>% 
    dplyr::select(SRVY, stratum, group, group0, taxon, biomass_mt, n_haul, biomass_var) %>% 
    dplyr::group_by(SRVY, stratum, group, group0, taxon) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     biomass_var = sum(biomass_var, na.rm = TRUE), 
                     n_haul = sum(n_haul, na.rm = TRUE), 
                     ci = confint(n_haul, biomass_var)) %>% 
    dplyr::ungroup()
  
  biomass_spp_bystrata <- dat %>%
    dplyr::group_by(SRVY, stratum, group, taxon) %>% # , n_haul
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     biomass_var = sum(biomass_var, na.rm = TRUE),
                     n_haul = mean(n_haul, na.rm = TRUE)) %>% # TOLEDO
    dplyr::mutate(ci = confint(n_haul, biomass_var))
  
  # biomass_spp_999 <- dat %>%
  #   dplyr::group_by(SRVY, group, taxon) %>% 
  #   dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
  #                    biomass_var = sum(biomass_var, na.rm = TRUE),
  #                    n_haul = mean(n_haul, na.rm = TRUE)) %>%
  #   dplyr::mutate(
  #     ci = confint(n_haul, biomass_var), 
  #     stratum = 999)
  
  # group level --------------------------------------------------------------
  
  dat0 <- eval(parse(
    text = gsub(pattern = "DATAFRAME",
                replacement = "catch_haul_cruises_maxyr0",
                x = exp0) )) %>%
    ungroup() %>%
    tidyr::separate(
      col = group0,
      into = c("group", "taxon"),
      sep = "_",
      remove = FALSE) %>%
    dplyr::filter(year == maxyr) %>%
    dplyr::distinct(SRVY, stratum, station, group, # not strictly necessary, but helpful
                    hauljoin, species_code) %>%
    dplyr::group_by(SRVY, group) %>%
    dplyr::summarise(num = n()) # the number of hauls the group was caught in for all stratum
  
  ## find estimated total biomass by stratum for group complexes (e.g., groups with more than one line)
  biomass_group_bystrata <- dat %>%
    dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
    dplyr:: group_by(SRVY, stratum, group) %>%
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     biomass_var = sum(biomass_var, na.rm = TRUE), 
                     n_haul = sum(n_haul, na.rm = TRUE)) %>% # do I need to sum n_haul from all spp or sum of tows where any of those species ever occured
    dplyr::mutate(ci = confint(n_haul, biomass_var), 
                  taxon = paste0("total ", gsub("\\s*\\([^\\)]+\\)","",as.character(group)))) %>% 
    dplyr::ungroup()
  
  # biomass_group_999 <- dat %>%  ## summarize by group to compare to prior years tech memo    
  #   dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
  #   dplyr::group_by(group, SRVY) %>%
  #   dplyr::summarize(biomass_mt = sum(biomass_mt, na.rm = TRUE),
  #                    biomass_var = sum(biomass_var, na.rm = TRUE)) %>%
  #   dplyr::left_join(x = ., 
  #                    y = dat0, 
  #                    by =  c("SRVY", "group")) %>%
  #   dplyr::mutate(
  #     n_haul = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
  #     ci = confint(n_haul, biomass_var), 
  #     taxon = paste0("total ", gsub("\\s*\\([^\\)]+\\)","", as.character(group))), 
  #     stratum = 999) %>% 
  #   dplyr::select(-num) %>% 
  #   dplyr::ungroup()
  
  # total level -----------------------------------------------------------------
  
  biomass_total_bystrata <- # find estimated total biomass for all stratum for all taxon
    biomass_by_stratum0 %>% 
    dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species codes greater than 35000 are invertebrates
    dplyr::mutate(group0 = "Total") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(SRVY, group0, stratum, biomass_mt, n_haul, biomass_var) %>% 
    dplyr::group_by(SRVY, group0, stratum) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     biomass_var = sum(biomass_var, na.rm = TRUE)) %>% 
    dplyr::ungroup() %>% 
    dplyr::left_join(
      y = catch_haul_cruises_maxyr0 %>% 
        dplyr::mutate(stratum = dplyr::case_when(
          (stratum == 31 | stratum == 32) ~ 30,
          (stratum == 41 | stratum == 42) | stratum == 43 ~ 40,
          (stratum == 61 | stratum == 62) ~ 60, 
          TRUE ~ as.numeric(stratum))) %>%
        dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species_code < 35000
        dplyr::group_by(year, SRVY, stratum) %>%
        dplyr::distinct(hauljoin) %>%
        dplyr::summarize(num = n()),  # number of hauls the group was caught in for all stratum,
      by = c("SRVY", "stratum")) %>% 
    dplyr::mutate(
      n_haul = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = NA, 
      taxon = NA, 
      group = "Total")
  
  # biomass_total_999 <-  # find estimated total biomass for all stratum for all taxon
  #   biomass_by_stratum0 %>% 
  #   dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species codes greater than 35000 are invertebrates
  #   dplyr::mutate(group0 = "Total") %>% 
  #   dplyr::ungroup() %>% 
  #   dplyr::select(SRVY, group0, biomass_mt, n_haul, biomass_var) %>% 
  #   dplyr::group_by(SRVY, group0) %>% 
  #   dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
  #                    biomass_var = sum(biomass_var, na.rm = TRUE)) %>% 
  #   dplyr::ungroup() %>% 
  #   dplyr::left_join(
  #     y = catch_haul_cruises_maxyr0 %>% 
  #       dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species_code < 35000
  #       dplyr::group_by(year, SRVY) %>%
  #       dplyr::distinct(hauljoin) %>%
  #       dplyr::summarize(num = n()),  # number of hauls the group was caught in for all stratum,
  #     by = "SRVY") %>% 
  #   dplyr::mutate(
  #     n_haul = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
  #     ci = confint(n_haul, biomass_var), # not right
  #     taxon = NA, 
  #     stratum = 999, 
  #     group = "Total")
  
  out <- dplyr::bind_rows(biomass_group_bystrata, 
                          # biomass_group_999, 
                          biomass_spp_bystrata,
                          # biomass_spp_999,
                          biomass_total_bystrata#, 
                          # biomass_total_999
  ) %>% 
    dplyr::select(-num, -n_haul, -biomass_var) %>%
    dplyr::mutate(
      order = dplyr::case_when(
        grepl(pattern = "other ", x = taxon) ~ 2,
        grepl(pattern = "total ", x = taxon) ~ 3,
        TRUE ~ 1)) %>%
    tidyr::pivot_wider(id_cols = c("group", "taxon", "order", "SRVY"), 
                       names_from = c("stratum"), 
                       values_from = c("biomass_mt", "ci")) %>% 
    dplyr::arrange(SRVY, group, order, taxon) %>% 
    dplyr::ungroup() %>% 
    dplyr::left_join(
      y = total_biomass0, 
      by = "SRVY")
  
  out$order <- 1:nrow(out)
  out$order[grepl(pattern = "other", x = out$group, ignore.case = TRUE)] <- nrow(out)+1
  out$order[grepl(pattern = "total", x = out$group, ignore.case = TRUE)] <- nrow(out)+2
  names(out) <- gsub(pattern = "biomass_mt_", replacement = "", x = names(out))
  
  out <- out %>% 
    dplyr::mutate(CI95 = ci_999, 
                  a = "±", 
                  prop = `999`/total) %>% 
    dplyr::arrange(order) %>%
    dplyr::relocate(SRVY, group, taxon, `999`, a, CI95, prop) %>% 
    dplyr::filter(`999` != 0) %>% # TOLEDO 
    dplyr::select(-order, -total, -dplyr::starts_with("ci_"))
  
  return(out)
}

FitFlextableToPage <- function(x, pgwidth = 6) {
  ft_out <- x %>% flextable::autofit()
  ft_out <- flextable::width(ft_out, width = dim(ft_out)$widths * 
                               pgwidth/(flextable::flextable_dim(ft_out)$widths))
  return(ft_out)
}

temp1 <- function(table_raw, strat, total) {
  
  footnote0 <- paste0("Total estimated biomass is ", 
                      formatC(x = total, digits = 0, format = "f", big.mark = ","), 
                      " t for fish and invertebrates in the ",  
                      unique(table_raw$SRVY), " bottom trawl survey.")
  
  table_raw0 <- table_raw %>% 
    dplyr::select("group", "taxon", "999", "a", "CI95", "prop", 
                  all_of(strat)) %>% 
    mutate_if(is.numeric , replace_na, replace = 0) %>% 
    dplyr::mutate(
      
      # biomass_mt = ifelse(is.na(biomass_mt), "-", round(biomass_mt, digits = 0)),
      # ci = ifelse(is.na(ci), "-", round(ci, digits = 0)),
      prop = ifelse(prop < 0.0001, "<0.0001", 
                    formatC(x = prop, digits = 4, 
                            format = "f", big.mark = ",")), 
      across(where(is.numeric), 
             formatC, big.mark=",", digits = 0, format = "f"), 
      # across(everything(), ~replace_na(.x, "-")),
      # across(everything(), ~replace_na(.x, "-")),
      `999` = paste0(`999`, " ", a)) %>% 
    dplyr::select(-a)
  
  table_print <- table_raw0 %>%
    flextable::flextable(data = .)  %>%
    flextable::merge_v(x = ., j = ~ group) %>%
    flextable::merge_h_range(x = ., i = ~ is.na(taxon), j1 = "group", j2 = "taxon", part = "body") %>%
    flextable::add_header_row(x = .,
                              top = TRUE,
                              values = c("Taxon",
                                         "Estimated total biomass (t) ± 95% confidence interval",
                                         "Proportion of total animal biomass",
                                         "Estimated biomass by stratum (t)"),
                              colwidths = c(2,2,1,length(strat)-1)) %>%
    flextable::width(x = .,  
                     width = ifelse(length(strat)>3, 0.7, 1.25),
                     unit = "in") %>%
    flextable::width(x = ., j = "prop", 
                     width = 0.8, unit = "in") %>%
    flextable::width(x = ., j = c("group"), 
                     width = 1, unit = "in") %>%    
    flextable::width(x = ., j = c("taxon"), 
                     ifelse(length(strat)>3, 1.5, 1), 
                     unit = "in") %>% 
    flextable::footnote(x = ., part = "header", i = 1, j = 5, ref_symbols = "1",
                        value = as_paragraph(footnote0)) %>%
    flextable::bold(x = ., i = ~ (grepl(pattern = "Total", x = group) )) %>%
    flextable::set_header_labels(.,
                                 "group" = "", 
                                 "taxon" = "",
                                 "999" = "", 
                                 "CI95" = "", 
                                 "prop" = "") %>%
    flextable::merge_at(x = ., j = c("group", "taxon"), part = "header") %>% 
    flextable::merge_at(x = ., j = c("999", "CI95"), part = "header") %>% 
    flextable::merge_at(x = ., j = c("prop"), part = "header") 
  
  row_lines <- TRUE
  pad = 0
  body_size = 10
  header_size = 10
  spacing = 0.6
  pgwidth = full_page_landscape_width
  std_b <- officer::fp_border(width = 2, color = "grey10")
  thin_b <- officer::fp_border(width = 0.5, color = "grey10") 
  
  x <- flextable::border_remove(x = table_print)
  if (row_lines == TRUE) {
    table_print <- flextable::hline(x = table_print, border = thin_b, part = "body")
  }
  
  table_print <- table_print %>% 
    flextable::hline(x = ., border = std_b, part = "header") %>% 
    flextable::hline_bottom(x = ., border = std_b, part = "body") %>% 
    flextable::bold(x = ., bold = TRUE, part = "header") %>% 
    flextable::align_text_col(x = ., align = "left", header = TRUE) %>% 
    flextable::align_nottext_col(x = ., align = "right", header = TRUE) %>% 
    flextable::padding(x = ., padding = pad, part = "all") %>% 
    flextable::font(x = ., fontname = font0, part = "all") %>% 
    flextable::fontsize(x = ., size = body_size - 2, part = "footer") %>% 
    flextable::fontsize(x = ., size = body_size, part = "body") %>% 
    flextable::fontsize(x = ., size = header_size, part = "header") %>% 
    flextable::fix_border_issues(x = .) %>% 
    flextable::align(x = ., j = c("999", "CI95", "prop",  strat), 
                     align = "right", part = "all") %>%
    flextable::align(x = ., 
                     j = c(strat), 
                     align = "center", i = 1, part = "header")
  
  return(list("table_raw" = table_raw, 
              "table_print" = table_print))
}


nickname0 <- "tab-biomass-est-"

for (taxon0 in c("fish", "invert")) {
  
  # # Select data and make plot
  # place species codes into groups and major species
  if (taxon0 == "fish") {
    exp0 <- ('DATAFRAME %>% dplyr::filter(species_code < 35000) %>% # species codes greater than 35000 are invertebrates
  dplyr::mutate(group0 = case_when(
    species_code == 471 ~ "Rajidae (skates)_Alaska skate",
    species_code >= 401 & 
      species_code <= 495 & 
      species_code != 471 ~ "Rajidae (skates)_other skates",
    species_code == 10210 ~ "Pleuronectidae (flatfishes)_yellowfin sole",
    species_code == 10261 ~ "Pleuronectidae (flatfishes)_northern rock sole",
    species_code == 10130 ~ "Pleuronectidae (flatfishes)_flathead sole",
    species_code == 10140 ~ "Pleuronectidae (flatfishes)_Bering flounder",
    species_code == 10285 ~ "Pleuronectidae (flatfishes)_Alaska plaice",
    species_code == 10110 ~ "Pleuronectidae (flatfishes)_arrowtooth flounder",
    species_code == 10112 ~ "Pleuronectidae (flatfishes)_Kamchatka flounder",
    species_code == 10120 ~ "Pleuronectidae (flatfishes)_Pacific halibut",
    species_code >= 10041 & 
      species_code <= 10295 & 
      species_code != 10210 &
      species_code != 10261 &
      species_code != 10130 &
      species_code != 10140 &
      species_code != 10285 &
      species_code != 10110 &
      species_code != 10112 &
      species_code != 10115 &
      species_code != 10120 ~ "Pleuronectidae (flatfishes)_other flatfish",
    species_code >= 21740 & species_code <= 21741 ~ "Gadidae (cods)_walleye pollock",
    species_code >= 21720 & species_code <= 21721 ~ "Gadidae (cods)_Pacific cod",
    species_code >= 21710 & 
      species_code <= 21737 &
      species_code != 21740 &
      species_code != 21741 &
      species_code != 21720 &
      species_code != 21721 ~ "Gadidae (cods)_other cods",
    species_code >= 20000 & species_code <= 20075 ~ "Agonidae (poachers)",
    species_code >= 21300 & species_code <= 21447 ~ "Cottidae (sculpins)",
    species_code >= 21900 & species_code <= 21935 ~ "Hexagrammidae (greenlings)",
    species_code >= 22170 & species_code <= 22199 ~ "Cyclopteridae (lumpsuckers)",
    species_code >= 22200 & species_code <= 22286 ~ "Liparidae (snailfishes)",
    species_code >= 23000 & species_code <= 23099 ~ "Osmeridae (smelts)",
    species_code >= 23800 & species_code <= 23870 ~ "Stichaeidae (blennies)", 
    species_code >= 24100 & species_code <= 24395 ~ "Zoarcidae (eelpouts)",
    species_code == 30060 ~ "Scorpaenidae (rockfishes)_Pacific ocean perch",
    species_code >= 30000 & 
      species_code <= 31550 & 
      species_code != 30060 ~ "Scorpaenidae (rockfishes)_other rockfish",
    TRUE ~ "Other"))')
    
    spp_code_rnge = "species_code < 35000"
    
  } else {
    exp0 <- ('DATAFRAME %>% dplyr::filter(species_code >= 40000 & 
                  species_code < 99991) %>% # groups greater than 99991 are empty shells, empty barnacles
  dplyr::mutate(group0 = dplyr::case_when(
    species_code >= 66000 & species_code <= 67499 ~ "Crustacea_shrimps",
    species_code >= 60000 & species_code <= 65999 ~ "Crustacea_other crustaceans",
    species_code >= 67500 & species_code <=	67999 ~ "Crustacea_other crustaceans", 
    species_code >= 69550	& species_code <= 68999 ~ "Crustacea_other crustaceans",
    species_code >= 71000 & species_code <= 73999 ~ "Mollusca_Gastropoda (snails)",
    species_code >= 74000 & species_code <= 75799 ~ "Mollusca_Pelecypoda (bivalves)",
    species_code >= 78500 & species_code <= 79600 ~ "Mollusca_squids",
    species_code >= 78010 & species_code <= 78499 ~ "Mollusca_octopuses",
    species_code >= 70000	& species_code <= 70999	~ "Mollusca_other mollusks",
    species_code >= 78000 & species_code <=	78009 ~ "Mollusca_other mollusks",
    species_code >= 80000	& species_code <= 82499 ~ "Echinodermata_Asteroidea (sea stars)",
    species_code >= 83000	& species_code <= 83701 ~ "Echinodermata_Ophiuroidea (brittle stars)",
    species_code >= 83800 & species_code <= 83701 ~ "Echinodermata_Ophiuroidea (brittle stars)",
    species_code >= 82500	& species_code <= 82749 ~ "Echinodermata_Echinoidea (sea urchins)",
    species_code >= 85000 & species_code <= 85999 ~ "Echinodermata_Holothuroidea (sea cucumbers)",
    species_code >= 98000	& species_code <= 99909 ~ "Ascidiacea",
    species_code >= 91000 & species_code <=	91999 ~ "Porifera (sponges)",
    species_code >= 40000	& species_code <= 44999 ~ "Coelenterata",
    species_code >= 45000	& species_code <= 59999 ~ "Other",
    species_code >= 92000	& species_code <= 97999 ~ "Other",
    species_code >= 99990 & species_code <=	99992 ~ "Other",
    species_code >= 77011 & species_code <= 77012 ~ "Other",
    species_code == 99987 ~ "Porifera (sponges)",
    TRUE ~ "Other"))')
    spp_code_rnge = "species_code >= 40000 & species_code < 99991"
  }
  
  table_raw1 <- temp(exp0 = exp0, 
                     maxyr = maxyr, 
                     biomass_by_stratum0 = biomass,
                     catch_haul_cruises_maxyr0 = catch_haul_cruises_maxyr,
                     total_biomass0 = total_biomass %>% 
                       dplyr::filter(year == maxyr &
                                       taxon == taxon0) %>% 
                       dplyr::select(total, SRVY), 
                     spp_code_rnge = spp_code_rnge)
  
  for (i in 1:nrow(haul_cruises_maxyr)) {
    
    header <- paste0("Biomass estimates (t) for major ", 
                     ifelse(taxon0 =="invert", "invertebrate", "fish") ,
                     " taxa collected during the ", 
                     maxyr, " ", 
                     haul_cruises_maxyr$SRVY_long[i],
                     " shelf bottom trawl survey.")
    
    nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i], "-", taxon0) 
    
    table_raw0 <- table_raw1 %>% 
      janitor::remove_empty(which = "cols")
    
    strat <- strat0[strat0 %in% names(table_raw0)]
    strat = strat[strat %in% report_types[[haul_cruises_maxyr$SRVY[i]]]$strat0]
    
    a <- temp1(table_raw = table_raw0 %>% 
                 dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]), 
               strat = strat, 
               total = total_biomass %>% 
                 dplyr::filter(year == maxyr &
                                 SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
                 dplyr::select(total) %>% 
                 unlist() %>% 
                 sum())
    
    table_raw <- a$table_raw
    table_print <- a$table_print
    
    # Save table
    res <- knitr::knit_child(
      text = knitr::knit_expand(
        file = paste0(dir_code, "_child_save_figtab.Rmd")), 
      quiet = TRUE
    )
  } 
}
```

## tab-majortaxa-pchange-[SRVY]

```{r tab-majortaxa-pchange-[SRVY]}

nickname0 <- "tab-majortaxa-pchange-" 
yrs <- nbsyr

table_raw0 <- biomass %>% 
  dplyr::left_join(y = report_spp1 %>% 
                     dplyr::select(print_name, species_code, group0), 
                   relationship = "many-to-many") %>% 
  dplyr::filter(stratum == 999 & 
                  SRVY %in% SRVY1 &
                  year %in% c(maxyr, compareyr) &
                  !is.na(group0)) %>%
  dplyr::group_by(print_name, SRVY, year, taxon) %>% 
  dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE)) %>% 
  dplyr::mutate(year = dplyr::case_when(
    year == maxyr ~ "maxyr",
    year == compareyr ~ "compareyr")) %>%
  tidyr::pivot_wider(id_cols = c(SRVY, print_name, taxon), 
                     names_from = year, 
                     values_from = biomass_mt) %>% 
  dplyr::mutate(
    print_name = gsub(pattern = "smelts (*Osmeridae*) include eulachon, capelin, and rainbow smelt", 
                      replacement = "smelts", 
                      x = print_name, fixed = TRUE),
    change = pchange(start = maxyr, end = compareyr, value_only = TRUE), 
    change0 = change,
    change = paste0(formatC(x = change, big.mark=",", digits = 1, format = "f"), "%"), 
    dplyr::across(dplyr::ends_with("yr"), formatC, big.mark=",", digits = 0, format = "f"), 
    dplyr::across(dplyr::ends_with("yr"), gsub, pattern = "NA%", replacement = ""), 
    dplyr::across(where(is.character), gsub, pattern = "NA", replacement = "") ) %>%
  dplyr::filter(!is.na(change0)) %>%
  dplyr::arrange(-change0) %>% 
  dplyr::ungroup()

for (i in 1:nrow(haul_cruises_maxyr)) {
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  header <- paste0(
    "Total estimated biomass in metric tons (t) and the percent change between the ",
    compareyr," and ",maxyr," ", 
    haul_cruises_maxyr$SRVY_long[i], 
    ' shelf bottom trawl surveys for predominant fish and invertebrate taxa. Crab data are summarized under other crabs and discussed in detail in the annual crab Technical Memorandum produced by the Shellfish Assessment Program. ')
  
  table_raw <- table_raw0 %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i])
  
  table_print <- table_raw  %>% 
    dplyr::select(-SRVY, -change0, -taxon) %>%
    flextable::flextable() %>%
    flextable::color(color = "red", # https://stackoverflow.com/questions/57474647/italic-and-color-in-an-r-flextable
                     i = grepl(pattern = "-", x = as.character(table_raw$change)), 
                     j = "change") %>% 
    flextable::width(x = ., j = "change", width = 1) %>% 
    flextable::set_header_labels(.,
                                 maxyr = maxyr, 
                                 compareyr = compareyr, 
                                 print_name = "Taxon", 
                                 change = paste0("Change (", maxyr, ", ", compareyr, ")" )) %>% 
    theme_flextable_nmfstm(x = ., 
                           font0 = font0, 
                           pad = 0, 
                           row_lines = FALSE, 
                           pgwidth = full_page_landscape_width) %>% 
    flextable::align(x = ., part = "all", align = "right") %>%
    flextable::align(x = ., part = "all", align = "left", j = c("print_name"))
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
}
```

## tab-est-spp-[SRVY]

```{r tab-est-spp-[SRVY]}
nickname0 <- paste0("tab-est-spp-") 

temp <- biomass %>% 
  dplyr::filter(year == maxyr &
                  stratum == 999) %>% 
  dplyr::select(species_code, SRVY, 
                cpue_kgkm2_mean, cpue_kgkm2_sd, 
                biomass_mt, biomass_sd, #upperb, lowerb, 
                cpue_nokm2_mean, cpue_nokm2_sd, 
                population_count, population_sd, # upperp, lowerp, 
                n_weight) %>%# n_haul, n_count, n_length
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(species_code, print_name, order, taxon), 
    by = "species_code") %>% 
  dplyr::filter(taxon == "fish" &
                  (n_weight != 0# & n_count != 0 & n_length != 0
                  ) & # if there were none in that survey, don't include
                  order > 0) %>% 
  dplyr::arrange(order) %>% 
  dplyr::select(-species_code, -order, -taxon) %>% 
  dplyr::relocate(print_name)

type <- c("wt", "num")
for (i in 1:2) {
  
  nickname <- paste0(nickname0, type[i]) 
  
  if (i == 1){ # CPUE (WT/HA) and BIOMASS
    
    header <- paste0("Mean CPUE by weight (kg/ha) with standard deviation, and estimated biomass (t) with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for common groundfish species for the ",
                     maxyr," ", text_list(paste0(SRVY1), 
                                          # text_list(paste0( 
                                          #   haul_cruises_maxyr$SRVY, " (",
                                          #   haul_cruises_maxyr$stations_completed,
                                          #   " stations completed)")),
                                          " shelf bottom trawl survey."))
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    cpue_kgkm2_mean, cpue_kgkm2_sd, 
                    biomass_mt, biomass_sd, #lowerb, upperb, 
                    # n_haul, 
                    n_weight#, n_count, n_length
      ) 
    
    table_print <- table_raw %>% 
      dplyr::mutate(cpue_kgkm2_mean = formatC(x = cpue_kgkm2_mean, 
                                             digits = 2, 
                                             format = "f", big.mark = ","), 
                    cpue_kgkm2_sd = formatC(x = cpue_kgkm2_sd, 
                                            digits = 2, 
                                            format = "f", big.mark = ","), 
                    biomass_mt = formatC(x = biomass_mt, 
                                         digits = 0, 
                                         format = "f", big.mark = ",") , 
                    # upperb = formatC(x = upperb, 
                    #                  digits = 0, 
                    #                  format = "f", big.mark = ",") , 
                    # lowerb = formatC(x = lowerb, 
                    #                  digits = 0, 
                    #                  format = "f", big.mark = ",") , 
                    biomass_sd = formatC(x = biomass_sd, 
                                         digits = 0, 
                                         format = "f", big.mark = ","))
    
    if (SRVY == "NEBS"){
      table_print <- table_print %>% 
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          SRVY = "Shelf area", 
          cpue_kgkm2_mean = paste0("Mean CPUE (kg/ha)"), 
          cpue_kgkm2_sd = paste0("SD CPUE"), 
          biomass_mt = paste0("Estimated\nBiomass"), 
          biomass_sd = paste0("SD Biomass"), 
          # lowerb = paste0("95% LCL"), 
          # upperb = paste0("95% UCL"), 
          # n_haul = "Total hauls", 
          n_weight = "Hauls with\nweights"#, 
          # n_count = "Hauls with\ncounts", 
          # n_length = "Hauls with\nlengths"
        ) 
    } else {
      table_print <- table_print %>% 
        dplyr::select(-SRVY) %>%
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          # SRVY = "Shelf area", 
          cpue_kgkm2_mean = paste0("Mean CPUE (kg/ha)"), 
          cpue_kgkm2_sd = paste0("SD CPUE"), 
          biomass_mt = paste0("Estimated\nBiomass"), 
          biomass_sd = paste0("SD Biomass"), 
          # lowerb = paste0("95% LCL"), 
          # upperb = paste0("95% UCL"), 
          # n_haul = "Total hauls", 
          n_weight = "Hauls with\nweights"#, 
          # n_count = "Hauls with\ncounts", 
          # n_length = "Hauls with\nlengths"
        ) 
    } 
    
  } else { # CPUE No/HA and population_count
    
    header <- paste0("Mean CPUE by number (no./ha) with standard deviation, and estimated population with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for other common groundfish species for the ", 
                     maxyr," ",
                     text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                      " shelf (", 
                                      haul_cruises_maxyr$SRVY, "; ",
                                      haul_cruises_maxyr$stations_completed,
                                      " stations completed)")),
                     " trawl surveys.")
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    cpue_nokm2_mean, cpue_nokm2_sd, 
                    population_count, population_sd, #lowerp, upperp, 
                    # n_haul, 
                    n_weight#, n_count, n_length
      )
    
    # population_count0 <- find_units(unit = "", unt = "", dat = table_raw$population_count)
    # population_sd0 <- find_units(unit = "", unt = "", dat = table_raw$population_sd)
    
    table_print <- table_raw %>% 
      dplyr::mutate(cpue_nokm2_mean = formatC(x = cpue_nokm2_mean, 
                                              digits = 2, 
                                              format = "f", big.mark = ","),
                    cpue_nokm2_sd = formatC(x = cpue_nokm2_sd, 
                                            digits = 2, 
                                            format = "f", big.mark = ","), 
                    population_count = formatC(x = population_count, 
                                               digits = 0, 
                                               format = "f", big.mark = ",") , 
                    # upperp = formatC(x = upperp, 
                    #                  digits = 0, 
                    #                  format = "f", big.mark = ",") , 
                    # lowerp = formatC(x = lowerp, 
                    #                  digits = 0, 
                    #                  format = "f", big.mark = ",") , 
                    population_sd = formatC(x = population_sd, 
                                            digits = 0, 
                                            format = "f", big.mark = ","))
    
    if (SRVY == "EBS") {
      table_print <- table_print %>% 
        dplyr::select(-SRVY) %>%
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          # SRVY = "Shelf area", 
          cpue_nokm2_mean = paste0("Mean CPUE (no/ha)"), 
          cpue_nokm2_sd = paste0("SD CPUE"), 
          population_count = paste0("Estimated\npopulation_count"), 
          population_sd = paste0("SD population_count"), 
          # lowerp = paste0("95% LCL"), 
          # upperp = paste0("95% UCL"), 
          # n_haul = "Total hauls", 
          n_weight = "Hauls with\nweights"#, 
          # n_count = "Hauls with\ncounts", 
          # n_length = "Hauls with\nlengths"
        ) 
    } else {
      table_print <- table_print %>% 
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          SRVY = "Shelf area", 
          cpue_nokm2_mean = paste0("Mean CPUE (no/ha)"), 
          cpue_nokm2_sd = paste0("SD CPUE"), 
          population_count = paste0("Estimated\npopulation_count"), 
          population_sd = paste0("SD population_count"), 
          # lowerp = paste0("95% LCL"), 
          # upperp = paste0("95% UCL"), 
          # n_haul = "Total hauls", 
          n_weight = "Hauls with\nweights"#, 
          # n_count = "Hauls with\ncounts", 
          # n_length = "Hauls with\nlengths"
        ) 
    }
  }
  
  
  table_print <- table_print %>% 
    flextable::width(x = ., j = "print_name", width = 3) %>%
    # flextable::width(x = ., j = "SRVY", width = 0.5) %>%
    flextable::merge_v(x = ., target = "print_name", 
                       j = "print_name", part = "body") %>% 
    flextable::valign(valign = "top") %>%  
    theme_flextable_nmfstm(x = ., 
                           font0 = font0, 
                           pad = 0, 
                           row_lines = TRUE, 
                           pgwidth = full_page_landscape_width) %>%
    flextable::align(x = ., align = "right", part = "all") %>%
    flextable::align(x = ., j = c("print_name"), #, "SRVY"
                     align = "left", part = "all") #%>%
  # flextable::hline(x = ., i = 1, part = "header")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
}
```
