---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

# Introduction

## fig_sample_grid

```{r fig_sample_grid}
header <- paste0("Sampling grid and station identifiers for the ", maxyr, " eastern and northern Bering Sea continental shelf bottom trawl surveys.")
nickname <- "fig_sample_grid"

# header <- paste0("Map of the Bering Sea survey stations sampled in ",maxyr," during the EBS and NBS survey. The area enclosed within the light gray line contains the EBS shelf stations that have been sampled annually since 1982, whereas the area outlined in the dark gray line are the NBS stations that were sampled in ",maxyr,". The dots within each area indicate each station location.") # TOLEDO
width <- 6
height <- 6

figure <- plot_survey_stations(reg_dat = reg_dat, 
                               station_info = station_info, 
                               haul_cruises_maxyr = haul_cruises_maxyr, 
                               station_grid = TRUE, 
                               stratum_no = FALSE, 
                               station_pts_srvy = FALSE)

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res #<- paste0("
# 
# 
# ",res,"
# 
# ")

```


## fig_sampled_survey_stations

### How do I know what stations were retowed?

> Do I show stations missed?

> issue with V in 2018

```{r fig_sampled_survey_stations}
# header <- paste0("Sampled survey stations by vessel and the stratification scheme used for data analysis of ",maxyr," ",NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)," continental shelf bottom trawl surveys.")
nickname <- "fig_sampled_survey_stations"
header <- paste0("Sampled survey stations by vessel and the stratification scheme used for data analysis of ",maxyr," ",NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)," continental shelf bottom trawl surveys. The map also depicts the stations sampled by each survey vessel and where, if any, Norton Sound crab resampling was done.")
# header <- paste0("Map of the Bering Sea survey stations sampled in ",maxyr," during the EBS and NBS survey. The area enclosed within the light gray line contains the EBS shelf stations that have been sampled annually since 1982, whereas the area outlined in the dark gray line are the NBS stations that were sampled in ",maxyr,". The dots within each area indicate each station location.") # TOLEDO
width <- 6
height <- 6

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- 
  dplyr::left_join(x = reg_dat0$survey.grid, 
                   y = dplyr::left_join(x = haul_maxyr, 
                                        y = vessel_info) %>% 
                     dplyr::select(stationid, vessel_name, vess_shape) %>%
                     dplyr::mutate(vess_col = dplyr::case_when(
                       (vess_shape == vessel_info$vess_shape[1]) ~ nmfspalette::nmfs_cols("dkgray"), 
                       (vess_shape == vessel_info$vess_shape[2]) ~ nmfspalette::nmfs_cols("supdkgray"))) %>% 
                     dplyr::rename(STATIONID = stationid), 
                   by = ("STATIONID"))

if (crab_resample == TRUE){
reg_dat0$survey.grid <- dplyr::left_join(
  x = reg_dat0$survey.grid, 
  y = haul_maxyr_crabretow %>% 
    dplyr::mutate(study = "crab_resample", 
                  study_col = nmfspalette::nmfs_cols("medgray"),
                  study = "crab_resample", 
                  study_long = "Red King Crab\nResample") %>% 
    dplyr::select(stationid, study, study_col, study_long) %>%
    dplyr::rename(STATIONID = stationid) %>% 
    unique(), 
  by = ("STATIONID")) 
}
# vess <- survey.grid0 %>% dplyr::filter(!is.na(vessel_name))


# figure <- plot_survey_stations(reg_dat = reg_dat0, 
#                                station_info, 
#                                haul_cruises_maxyr, 
#                                station_grid = FALSE, 
#                                stratum_no = TRUE, 
#                                station_pts_srvy = FALSE, 
#                                station_pts_vess = TRUE, 
#                                crab_resample = FALSE) # defined in data.r

figure <- plot_survey_stations(
  reg_dat = reg_dat0, 
  station_info, 
  haul_cruises_maxyr, 
  station_grid = FALSE, 
  stratum_no = TRUE, 
  station_pts_srvy = FALSE, 
  station_pts_vess = TRUE, 
  study = crab_resample) # defined in data.r

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")

```



## fig_vessels

```{r fig_vessels}
header <- paste0("Photographs of the *F/V Vesteraalen* (left) and *F/V Alaska Knight* (right).")
alttext <- paste0("Photographs of the fishing vessels *Vesteraalen* (left) and *Alaska Knight* (right), which were chartered for the ",maxyr," survey.")
nickname <- "fig_vessels"
height <- 2.5
width <- 6

# Select data and make plot
p1 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "94_vesterhaalen.png")), 
                      scale = 0.9 )

p2 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "163_alaskaknight.png")), 
                      scale = 0.9 )

figure <- cowplot::plot_grid(p1, p2,  
                             ncol = 2, rel_heights = c(0.1, 1))

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")

```

# Methods

## fig_trawl_gear

```{r fig_trawl_gear}
header <- paste0("Schematic diagram of the 83-112 eastern otter trawl gear used during the ", maxyr ," eastern and northern Bering Sea bottom trawl surveys.")
footnote<- NA
nickname <- "fig_trawl_gear"
alttext <- paste0(header)
height = 6
width = 5

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "EASTERN83-112.png")) )

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")

```


## tab_stratum_areas

### should density use stations_completed or stations_avail?

> superscripts


```{r tab_stratum_areas}
header <- paste0("Stratum areas and sampling densities for the ",maxyr,
                 " bottom trawl survey of the ",
                 NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, " shelf (", 
                                               haul_cruises_maxyr$SRVY, ")")),".")
nickname <- "tab_stratum_areas" 

# Select data and make plot
# strata_haul_count <- haul_maxyr %>% 
#   dplyr::select(stratum, stationid) %>% 
#   dplyr::group_by(stratum) %>% 
#   dplyr::summarise(count(stratum)) %>% 
#   dplyr::rename(stations_completed = "freq") %>% 
#   dplyr::select(stratum, stations_completed)
# 

temp <- stratum_info %>% 
  dplyr::select(area, stations_completed, stratum, type,  SRVY)

if (length(unique(station_info$SRVY))>1) {
  totals_sub <- stratum_info %>%
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(area = sum(area, na.rm = TRUE),
                     stations_completed = sum(stations_completed, n.rm = TRUE)) %>%
    dplyr::mutate(stratum = "") %>%
    dplyr::mutate(type = "Total") %>% 
    dplyr::relocate(names(temp))
}

totals <- stratum_info %>% 
  dplyr::summarise(area = sum(area, na.rm = TRUE), 
                   stations_completed = sum(stations_completed, n.rm = TRUE)) %>% 
  dplyr::mutate(stratum = "") %>% 
  dplyr::mutate(type = "Total") %>% 
  dplyr::mutate(SRVY = NMFSReports::text_list(SRVY1)) %>% 
  dplyr::relocate(names(temp))


table_raw <- 
  rbind.data.frame(temp, 
                   if(exists("totals_sub")){totals_sub}, 
                   totals) %>% 
  dplyr::mutate(density = round(area/stations_completed, 0)) %>% 
  dplyr::mutate(area = round(area, 0)) %>% 
  dplyr::mutate(Region = paste0(SRVY, " ", type)) %>% 
  dplyr::mutate(order = dplyr::case_when(
    Region == "EBS Inner Shelf" ~ 1,
    Region == "EBS Middle Shelf" ~ 2,
    Region == "EBS Outer Shelf" ~ 3,
    Region == "EBS Total" ~ 4,
    Region == "NBS Shelf" ~ 5,
    Region == "NBS Total" ~ 6,
    Region == "EBS and NBS Total" ~ 7
  ))  %>%
  dplyr::arrange(order, stratum) %>% #SRVY, stratum) %>% 
  dplyr::select(Region, stratum, area, stations_completed, density, -order) %>% 
  dplyr::relocate(Region, stratum, area, stations_completed, density)

table_print <- flextable::flextable(table_raw) %>%
  # flextable::display(., i = 1, col_key = "area", 
  #   pattern = "{{val}}{{pow}}", part = "header",
  #   formatters = list(val ~ as.character("km"), pow ~ as.character("2") ),
  #   fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 8))
  #   ) %>% 
  flextable::width(x = ., j = "stratum", width = 3) %>% 
  flextable::set_header_labels(., 
                               Region = "",
                               stratum = "Stratum",
                               area = "Representative\narea (km2)",
                               stations_completed = "Stations successfully\nsampled",
                               density = "Sampling density\n(km2/Stations successfully sampled)"
  ) %>% 
  flextable::merge_v(j = "Region") %>%
  flextable::valign(valign = "top") %>%
  theme_flextable_nmfstm()


# table_raw_stratum_areas <- table_raw

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")

```

## tab_specimen_samples_

```{r tab_specimen_samples_}
nickname0 <- paste0("tab_specimen_samples_") 

# length data - from oracle
l <- length_maxyr %>% 
  dplyr::select("SRVY", species_code) %>% 
  dplyr::group_by("SRVY" = SRVY, species_code) %>% # also type?
  dplyr::summarise(length = as.numeric(n())) %>% 
  dplyr::ungroup()  

# age oto data - from oracle
a <- specimen_maxyr %>% 
  dplyr::select("SRVY", species_code) %>% 
  dplyr::group_by("SRVY" = SRVY, species_code) %>% 
  dplyr::filter(!is.na(species_code)) %>%
  # also specimen_sample_type? 1 = otoliths, 
  # specimen_subsample_method 1=random, 2 = stratified?
  dplyr::summarise(age = as.numeric(n())) %>% 
  dplyr::ungroup() #%>% 

# other collections not in oracle
temp <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_other_field_collections.xlsx"), 
                         sheet = "Sheet1", 
                         skip = 1) %>%
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(SRVY, print_name, dplyr::starts_with("count_")) %>% 
  dplyr::select(where(~sum(!is.na(.x)) > 0)) 
names(temp) <- gsub(pattern = "count_", replacement = "", x = names(temp))

# Combine
table_raw0 <- 
  dplyr::full_join(x = l, y = a, 
                   by = c("SRVY", "species_code")) %>% 
  dplyr::left_join(x = ., 
                   y = spp_info %>% 
                     dplyr::mutate(common_name = dplyr::case_when(
                                     is.na(common_name) ~ report_name_scientific, 
                                     common_name == "shorthorn (=warty) sculpin" ~ "shorthorn sculpin", 
                                     TRUE ~ common_name)) %>% 
                     dplyr::select(species_code, common_name), 
                   by = "species_code") %>% 
  dplyr::full_join(x = ., 
                   y = temp, 
                   by = c("common_name" = "print_name", "SRVY")) %>% 
  dplyr::select(-species_code) %>% 
  # dplyr::rename(common_name = print_name) %>%
  dplyr::group_by(SRVY, common_name) %>% 
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
  dplyr::arrange(SRVY, common_name) 

table_raw0$common_name[is.na(table_raw0$common_name)] <- "other" # TOLEDO

table_raw0 <- 
  dplyr::bind_rows(table_raw0, 
                   table_raw0 %>% 
                     dplyr::group_by(SRVY) %>% 
                     dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
                     # dplyr::summarise(
                     #   length = sum(length, na.rm = TRUE),
                     #   age = sum(age, na.rm = TRUE), 
                     #   stomach = sum(stomach, na.rm = TRUE), 
                     #   pathobio = sum(pathobio, na.rm = TRUE)) %>% 
                     # dplyr::mutate(order = max(report_spp1$order)+1) %>% 
                     dplyr::mutate(common_name = "Total") # %>% 
                   # dplyr::left_join(x = ., y = temp)
  ) %>% 
  dplyr::relocate(SRVY, common_name, length, age) %>% 
  dplyr::rename("length_measurements" = length,
                "otolith_age_structure_measurements" = age) %>%
  data.frame()


for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  header <- paste0("Biological data collected during the ", maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey.")
  
  table_raw <- table_raw0 %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i])
  
    names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))] <- 
    stringr::str_to_sentence(gsub(pattern = "_",
                                replacement = " ", 
                                x = names(table_raw)[!(names(table_raw) %in% 
                                                         c("SRVY", "common_name"))], 
                                fixed = TRUE))
  
  
  table_print <- table_raw %>% 
    dplyr::mutate(across(where(is.numeric), 
                       formatC, big.mark=",", digits = 0, format = "f")) %>% 
    dplyr::ungroup() %>% 
      dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
      dplyr::select(-"SRVY") 
  table_print[is.na(table_print) | table_print == "0"] <- "-"

  
  table_print <- table_print %>% 
  flextable::flextable(data = .) %>%
    flextable::set_header_labels(x = .,
                                 common_name = haul_cruises_maxyr$SRVY[i]#,
                                 # Length = "Length\nmeasurements",
                                 # Age = "Age structure (otolith)\nmeasurements"
    ) %>%
      flextable::width(x = ., width = 1.5) %>% 
      flextable::width(x = ., j = 1, width = 3) %>% 
    # flextable::merge_v(j = "SRVY") %>%
    flextable::valign(valign = "top") %>%
    theme_flextable_nmfstm(x = .)
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
  
}

```

## tab_oto_collection_scheme_

```{r tab_oto_collection_scheme_}

nickname0 <- paste0("tab_oto_collection_scheme_") 


table_raw0 <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                         sheet = "Sheet1", 
                         skip = 1) %>% 
   dplyr::filter(year == maxyr & !is.na(oto_target)) %>% 
  dplyr::select(SRVY, print_name, species_code, oto_target, oto_rules, oto_samp_type) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_name1, order) %>% 
      dplyr::rename(species_name = species_name1) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::arrange(order) %>% 
  dplyr::arrange(oto_samp_type) %>% 
  dplyr::arrange(SRVY) %>% 
   dplyr::select(-order, -species_code) %>% 
   dplyr::relocate(SRVY, print_name, species_name, oto_samp_type, oto_target, oto_rules)
  
for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  header <- paste0("Otolith collection scheme during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i], " (", 
                   haul_cruises_maxyr$SRVY[i], ")",
                   " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
    
    table_raw <- table_raw0 %>% 
      dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
      dplyr::select(-SRVY, -species_name)
    
table_print <- table_raw %>% 
  flextable::as_grouped_data(x = ., groups = c(#"SRVY", 
                                               "oto_samp_type"), 
                             columns = NULL) %>% 
  flextable::as_flextable(x = ., hide_grouplabel = TRUE) %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(oto_samp_type) ) %>%
  # flextable::italic(x = ., j = "species_name") %>% 
  # flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::padding(x = ., 
                     j = 1, i = ~ #is.na(SRVY) & 
                       is.na(oto_samp_type), # TOLEDO
                     padding.left = 20) %>%
  flextable::width(x = ., j = "print_name", width = 4) %>% 
  # flextable::width(x = ., j = "species_name", width = 3.5) %>% 
  # flextable::width(x = ., j = "oto_target", width = 2) %>% 
  # flextable::padding(x = ., 
  #                    j = 1, i = ~ is.na(oto_samp_type), 
  #                    padding.left = 20) %>%
      flextable::set_header_labels(.,
                                 print_name = "Common name", 
                                 # species_name = "Scientific name", 
                                 oto_rules = "Collect when \u2265 n individuals caught in each haul",
                                 oto_target = "Target collection number per haul") %>%
  # flextable::compose(
  #   i = ~ !is.na(group), # when var_group not NA
  #   j = " ", # on column "var"
  #   value = as_paragraph(as_chunk(group))) %>%     # create a paragraph containing a chunk containing value of `var_group`
  # hline(i = ~ !is.na(SRVY), border = officer::fp_border() ) %>%
  NMFSReports::theme_flextable_nmfstm(x = ., row_lines = TRUE) 

    
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
}
```


## tab_stomach_collection_scheme

```{r tab_stomach_collection_scheme}

nickname <- paste0("tab_stomach_collection_scheme") 
  
header <- paste0("Stomach collection scheme during the ", 
                   maxyr, " ", 
                   NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, " (", 
                   haul_cruises_maxyr$SRVY, ")")),
                   " shelf bottom trawl survey.")
  
table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                         sheet = "Sheet1", 
                         skip = 1) %>% 
   dplyr::filter(year == maxyr & !is.na(stomach_target)) %>% 
  dplyr::select(SRVY, print_name, species_code, stomach_target) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_name1, order) %>% 
      dplyr::rename(species_name = species_name1) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::arrange(order) %>% 
  dplyr::arrange(stomach_target) %>% 
  dplyr::arrange(SRVY) %>% 
   dplyr::select(-order, -species_code) %>% 
   dplyr::relocate(SRVY, print_name, species_name, stomach_target) %>% 
  dplyr::mutate(stomach_target = as.character(round(as.numeric(stomach_target), digits = 0))) %>% 
  tidyr::pivot_wider(data = ., id_cols = c("print_name", "species_name"), names_from = "SRVY", values_from = "stomach_target")

  table_raw[is.na(table_raw)] <- "-"
    
table_print <- flextable::flextable(table_raw %>% 
                                      dplyr::select(-species_name)) %>% 
  # flextable::italic(x = ., j = "species_name") %>% 
      flextable::set_header_labels(.,
                                 print_name = "Common name", 
                                 # species_name = "Scientific name", 
                                 stomach_target = "Target collection number per survey") %>%
  NMFSReports::theme_flextable_nmfstm(x = ., row_lines = TRUE) 

    
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")

```

## tab_special_projects

```{r tab_special_projects}
nickname <- "tab_special_projects" 
places <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                         sheet = "affiliations", 
                         skip = 1)

newobj <- TRUE

temp <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                         sheet = "projects", 
                         skip = 1)  %>% 
  dplyr::filter(!is.na(`Project Title`) & 
                  year == maxyr) %>% 
  dplyr::select(SRVY, `Project Title`, `Principal investigator`, Agency) %>% 
  dplyr::arrange(desc(SRVY))

# for (i in 1:nrow(haul_cruises_maxyr)) {
#   if (nrow(haul_cruises_maxyr)>1) {
#     subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
#     newobj <- ifelse(i==1, TRUE, FALSE)
#   }
# nickname <- paste0(nickname0, "_", haul_cruises_maxyr$SRVY[i]) 
header <- paste0("Special projects and collections undertaken during the ",
                 maxyr, " ", 
                 # haul_cruises_maxyr$SRVY_long[i], 
                 "shelf bottom trawl survey by principal investigator and agency.")

table_raw <- temp #%>% 
# dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
# dplyr::select(-SRVY)

temp1 <- places[places$Agency %in% unique(table_raw$Agency), ]
footnote0 <- paste(paste(temp1$Agency, " - ", temp1$agency_long, sep = ""), collapse = "; ")
  
table_print <- table_raw %>%
    flextable::as_grouped_data(groups = c("SRVY"), columns = NULL) %>% 
    flextable::as_flextable(., hide_grouplabel = TRUE)  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::padding(x = ., 
                     j = 1, i = ~ is.na(SRVY), 
                     padding.left = 20) %>%
  theme_flextable_nmfstm(row_lines = TRUE) %>% 
  # flextable::width(x = ., j = "Agency", width = 1) %>% 
  flextable::width(x = ., j = "Principal investigator", width = 1.5) %>%
    flextable::width(x = ., j = "Project Title", width = 4) %>% 
  # flextable::set_header_labels(x = ., "SRVY" = "Region") %>%
  flextable::footnote(x = ., value = as_paragraph(footnote0), part = "header", j = "Agency") 

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")

# }

```


# Results


## fig_mean_temperature

> prev: fig_temp_weight_mean

```{r fig_mean_temperature}
nickname <- "fig_mean_temperature"
header <- paste0("Average summer surface (green triangles) and bottom (blue circles) temperatures (°C) on the EBS shelf based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr," and NBS shelf based on data collected during standardized summer bottom trawl surveys from ", NMFSReports::text_list(nbsyr),". Dashed lines represent the time series mean.")
alttext <- paste0("Graph showing average summer surface (green triangles) and bottom (blue circles) temperatures (°C) on the EBS shelf (left) based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr," and NBS shelf (right) based on data collected during standardized summer bottom trawl surveys from ", NMFSReports::text_list(nbsyr),". Dashed horizontal lines represent the time series mean.")
# header <- paste0("Time series of mean survey surface and near-bottom temperatures in the EBS weighted by stratum based on expendable bathythermograph casts or digital dataloggers attached to the headrope during the EBS bottom trawl surveys from 1982 to ", maxyr, ". The 1982-1987 means (triangles). The dashed lines represent the grand stratum-area weighted mean water temperatures for 1982-", maxyr, ".")
# nickname <- "fig_temp_weight_mean"
# header <- paste0("Average summer surface (green triangles) and bottom (blue circles) temperatures (°C) on the eastern Bering Sea (EBS) shelf based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr," and northern Bering Sea (NBS) shelf based on data collected during standardized summer bottom trawl surveys from ", NMFSReports::text_list(nbsyr),". Dashed lines represent the time series mean.")

height <- dim(readPNG(paste0(dir_img, "average_temperature.png")))[1]/300 # 4
width <- dim(readPNG(paste0(dir_img, "average_temperature.png")))[2]/300 # 6

# https://github.com/sean-rohan-NOAA/coldpool/blob/main/plots/average_temperature.png

# get the most updated file, just in case
# a <- url_exists("https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/average_temperature.png?token=ASDSFQFRRFKSYHOBYF4WWJ3BP4O5O", 
#                 "https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/average_temperature.png?token=ASDSFQFYZNMG4X3DZDLXZT3BRH5VO")
# if (length(a)>0 ) {
#   figure <- 
#     cowplot::ggdraw() +
#     cowplot::draw_image(a)
# } else {
# https://github.com/sean-rohan-NOAA/coldpool/blob/main/plots/stacked_temperature.png?raw=true
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "average_temperature.png")) )
# }


# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")

```


## fig_cold_pool_area

> Figure header from 2019: Figure 4. Mean summer surface and bottom temperatures for the 38-year times series from the EBS shelf bottom trawl survey (A) and the cumulative proportion of EBS shelf area covered by each one-degree bottom isotherm range (B).

```{r fig_cold_pool_area}
# header <- paste0("Percentage of the EBS shelf from 1982–",maxyr," bottom area that is occupied by the cold pool in one degree Celsius increments.")
header <- paste0("Graph showing annual cold pool extent in the EBS, based on observations from the EBS bottom trawl survey. Extent of the cold pool is shown in proportion to the total southern EBS shelf survey area. Shading denotes bottom temperatures \u2264 2°C (aqua blue), \u2264 1°C (cerulean blue), \u2264 0°C (cobalt blue), and \u2264 -1°C (dark navy blue).")
alttext <- paste0("Cold pool extent in the EBS, as measured using observations from the EBS bottom trawl survey. Extent of the cold pool in proportion to the total EBS shelf survey area from 1982–",maxyr,". Shading denotes bottom temperatures \u2264 2°C (aqua blue), \u2264 1°C (cerulean blue), \u2264 0°C (cobalt blue), and \u2264 -1°C (dark navy blue).")
footnote <- "Areas were summarized from areas in inverse distance weighted rasters."
nickname <- "fig_cold_pool_area"
# alttext <- paste0(header, " Purple is the percentage area < -1°C, blue is the percentage area < 1°C, green is the percentage area < 1°C, and yellow is the percentage area < 2°C. Celsius increments.")
height <- dim(readPNG(paste0(dir_img, "stacked_temperature_simple_label.png")))[1]/300/2 # 4
width <- dim(readPNG(paste0(dir_img, "stacked_temperature_simple_label.png")))[2]/300/2 # 6

# get the most updated file, just in case
# a<-  url_exists("https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/stacked_temperature_simple_label.png?token=ASDSFQHEDQ5TQT45TR7ZDALBP4OWS", 
#                 "https://raw.githubusercontent.com/sean-rohan-NOAA/coldpool/main/plots/stacked_temperature_simple_label.png?token=ASDSFQFPHFWX5FHJQBIY7PLBRKQIS")
# if (length(a)>0 ) {
#   figure <- 
#     cowplot::ggdraw() +
#     cowplot::draw_image(a)
# } else {
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "stacked_temperature_simple_label.png")) )
# }

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")

```



## fig_st_maxyr

> Summer bottom temperatures in the eastern Bering Sea continental shelf survey area, calculated from interpolation of temperature data from summer bottom trawl surveys conducted by AFSC/RACE/GAP. To load this data set, it is necessary to first load the coldpool package or raster and sp packages. Raster layers were interpolated using ordinary kriging with Matern covariance doi: 10.1007/978-1-4612-1494-6(Stein, 1999).

> Rasters of summer bottom temperature in the eastern Bering Sea at 5-km resolution

> still need nbs

```{r fig_st_maxyr}
header <- paste0("Contour map of surface temperatures from the ",maxyr," ",
                 NMFSReports::text_list(haul_cruises_maxyr$survey_name)," shelf bottom trawl surveys.")
nickname <- "fig_st_maxyr"
hieght <- 7
width <- 6
# temp <- raster::subset(x = coldpool:::ebs_surface_temperature, 
#                        subset = paste0("ste_",maxyr,"_surface_temperature")) 
# temp <- projectRaster(temp, crs = crs(reg_dat$akland))
# temp_spdf <- as(temp, "SpatialPixelsDataFrame")
# temp_df <- as.data.frame(temp_spdf)
# colnames(temp_df) <- c("value", "x", "y")
# 
# figure <- ggplot() +  
#   geom_sf(data = reg_dat$akland, color = NA, fill = "grey80") +
#   geom_tile(data=temp_df, aes(x=x, y=y, fill=value))  + 
#   scale_fill_viridis_c(#option = "plasma", 
#     na.value = "transparent", 
#     breaks = seq(from = -2, to = 20, by = 2),
#     labels = seq(from = -2, to = 20, by = 2)#,
#     # alpha = 0.75
#   ) + 
#   guides(fill=guide_legend(title="Surface\nTemperature (°C)\n\n")) +
#   geom_sf(data = reg_dat$bathymetry, color = "grey50") +
#   geom_sf(data = reg_dat$graticule,
#           color = "grey90",
#           alpha = 0.5) +
#   geom_sf(data = reg_dat$survey.area, 
#           color = "black", 
#           fill = NA, 
#           size = 1) +
#   scale_x_continuous(name = "Longitude", 
#                      breaks = reg_dat$lon.breaks) + 
#   scale_y_continuous(name = "Latitude", 
#                      breaks = reg_dat$lat.breaks) +
#   coord_sf(xlim = reg_dat$plot.boundary$x, 
#            ylim = reg_dat$plot.boundary$y) +
#   geom_text(data = subset(reg_dat$place.labels, type == "mainland"),
#             aes(x = x, y = y, label = lab),
#             size = 14, group = 99) +
#   geom_shadowtext(data = subset(reg_dat$place.labels, type == "peninsula"),
#                   aes(x = x, y = y, label = lab), size = 5, angle = 40,
#                   bg.color = "white", color = "black", group = 99) +
#   geom_shadowtext(
#     data = subset(reg_dat$place.labels, type %in% c("bathymetry", "islands")),
#     aes(x = x, y = y, label = lab),
#     bg.color = "white", color = "black",
#     size = 2, group = 99) +
#   
#   ggsn::scalebar(data = reg_dat$survey.grid,
#                  location = "bottomright",
#                  dist = 100,
#                  dist_unit = "km",
#                  transform = FALSE,
#                  st.dist = .02,
#                  height = 0.02,
#                  st.bottom = TRUE,
#                  st.size = 3,
#                  # transform = TRUE,
#                  model = reg_dat$crs) +
#   #set legend position and vertical arrangement
#   theme(
#     panel.background = element_rect(fill = "white", 
#                                     colour = NA), 
#     panel.border = element_rect(fill = NA, 
#                                 colour = "grey20"), 
#     strip.background = element_rect(fill = "grey85", 
#                                     colour = "grey20"),
#     legend.spacing.y = unit(-0.35, "cm"),
#     legend.title = element_text(size = 9),
#     legend.text = element_text(size = 7),
#     legend.background = element_rect(colour = "transparent", fill = "transparent"),
#     legend.key = element_rect(colour = "transparent", 
#                               fill = "transparent"),
#     legend.position = c(.15, .22),
#     legend.box.just = "left",
#     legend.box = "vertical"
#   )
# 
# # save yo' stuff and do a lot of behind the scenes work
# # alt: this does the same thing as calling "child = " in the chunk header
# res <- knitr::knit_child(
#   text = knitr::knit_expand(
#     file = system.file("rmd/_child_save_fig.Rmd", 
#                        package = "NMFSReports")), 
#   quiet = TRUE
# )
# 
# list_figures[nickname][[1]]$res <- res <- paste0("
# 
# 
# ",res,"
# 
# ")


# header <- paste0("Map showing surface temperatures (°C) in the NBS and EBS during the ",
#                  NMFSReports::text_list(nbsyr),
#                  " surveys, which are the years when the survey included the full NBS shelf.")

# EBS + NBS years
if (sum(grepl(pattern = maxyr, x = names(coldpool:::nbs_ebs_surface_temperature)))>0){
  rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_surface_temperature,
                                subset = paste0("ebs_ste_", maxyr, "_surface_temperature"))
} else { # in EBS only years
  rasterbrick <- raster::subset(x = coldpool:::ebs_surface_temperature,
                                subset = paste0("ste_", maxyr, "_surface_temperature"))
}

figure <- plot_temps_facet(
  rasterbrick = rasterbrick, 
  key.title = expression(bold("Surface Temperature (°C)")), 
  reg_dat = reg_dat, 
  colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
  viridis_palette_option = "H") 

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")

```

## fig_bt_timeseries_[above or below]

> need to figure out how to plot whole NBS

```{r fig_bt_timeseries_}
# nickname0 <- "fig_idw_bottemp_longterm_mean_"
nickname0 <- "fig_bt_timeseries_"

for (i in 1:2) { # two cases, above and below
  
  hieght <- 6
  width <- 6.5
  
  subobj <- TRUE
  newobj <- ifelse(i==1, TRUE, FALSE)
  TF <- ifelse(i==1, FALSE, TRUE)
  case <- ifelse(i==1, "below", "above")
  year <- sort(temps_avg_yr_abovebelow[,case])
  
  header <- paste0("Contour maps of the near-bottom temperatures from the ",
                   NMFSReports::text_list(year),
                   " Bering Sea shelf bottom trawl surveys, years when the survey mean bottom temperature was ",
                   case,
                   " the long-term stratum area-weighted mean.")
  nickname <- paste0(nickname0, case)
  
  # Just EBS
  rasterbrick <- raster::subset(x = coldpool:::ebs_bottom_temperature,
                                subset = paste0("ste_", year, "_gear_temperature"))
  names(rasterbrick) <- gsub(pattern = "_", replacement = "", x = (gsub(x = names(rasterbrick), pattern = "[a-zA-Z]+", replacement = "")))
  
  #     if (length(nbsyr[nbsyr %in% year])>0) {
  # # Both NBS and EBS
  #   rasterbrick0 <- raster::subset(x = coldpool:::nbs_ebs_bottom_temperature,
  #                               subset = paste0("ebs_ste_", nbsyr[nbsyr %in% year], "_gear_temperature"))
  #   
  #   names(rasterbrick0) <- gsub(pattern = "_", replacement = "", x = (gsub(x = names(rasterbrick0), pattern = "[a-zA-Z]+", replacement = "")))
  #   
  #   
  #   # rasterbrick[!(names(rasterbrick) %in% paste0("X", nbsyr[nbsyr %in% year]))] <- rasterbrick0[names(rasterbrick0) %in% paste0("X", nbsyr[nbsyr %in% year])]
  #   
  #       rasterbrick$X2010 <- rasterbrick0$X2010
  #   
  #   }
  
  
  figure <- plot_temps_facet(
    rasterbrick = rasterbrick,
    key.title = expression(bold("Bottom Temperature (°C)")),
    reg_dat = reg_dat,
    colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
    viridis_palette_option = "H")
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd",
                         package = "NMFSReports")),
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res <- paste0("
######

",res,"

")
}

```
## fig_st_all_nebs_surveys


```{r fig_st_all_nebs_surveys}

if (SRVY == "NEBS") {

nickname <- "fig_st_all_nebs_surveys"
height <- 7
width <- 6

header <- paste0("Map showing surface temperatures (°C) in the NBS and EBS during the ",
                 NMFSReports::text_list(nbsyr),
                 " surveys, which are the years when the survey included the full NBS shelf.")


rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_surface_temperature,
                              subset = paste0("ebs_ste_", nbsyr, "_surface_temperature"))
figure <- plot_temps_facet(
  rasterbrick = rasterbrick, 
  key.title = expression(bold("Surface Temperature (°C)")), 
  reg_dat = reg_dat, 
  colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
  viridis_palette_option = "H") 

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res <- paste0("


",res,"

")
}
```

## tab_species_composition

```{r tab_species_composition}

if (SRVY == "NEBS"){

nickname <- "tab_species_composition" 
header <- paste0("List of fish taxa from survey catches exclusive to the ",
                   NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, " shelf (", 
                                                 haul_cruises_maxyr$SRVY, ")")),". ")
# Taxa in bold only documented north of 60°N latitude. 

# Select data and make plot
table_raw <- catch_haul_cruises_maxyr %>% 
                     dplyr::select(species_code, SRVY, 
                                   "SRVY", start_latitude) %>% 
  dplyr::group_by(species_code, SRVY) %>% 
  dplyr::summarise(lat_max = max(start_latitude, na.rm = TRUE),
                   lat_min = min(start_latitude, na.rm = TRUE)) %>%
    dplyr::mutate(above_60 = (lat_max >= 60 & lat_min >= 60)) %>%
  tidyr::pivot_wider(data = ., 
                     id_cols = species_code, 
                     names_from = SRVY, 
                     values_from = c(above_60),#, lat_min, lat_max), 
                     values_fill = NA) %>% 
  dplyr::mutate(where = dplyr::case_when(
      !is.na(EBS) & !is.na(NBS) ~ "Present in EBS and NBS", 
      is.na(NBS) & !is.na(EBS)~ "Present in EBS but absent in NBS", 
      is.na(EBS) & !is.na(NBS) ~ "Present in NBS but absent in EBS")) %>% 
  dplyr::left_join(x = ., 
                   y = spp_info, #%>% 
                     # dplyr::rename(common_name = print_name), 
                   by = "species_code") %>% 
  dplyr::filter(taxon == "fish") %>% 
  dplyr::ungroup() %>% 
  dplyr::select(species_code, common_name, report_name_scientific, all_of(SRVY1), where) %>% 
  dplyr::filter(!grepl(x = common_name, pattern = " unid.", fixed = TRUE)) %>%
  dplyr::filter(!grepl(x = common_name, pattern = " egg", fixed = TRUE)) %>%
  dplyr::filter(!is.na(common_name)) %>%
  dplyr::arrange(common_name)

  
  temp <- table_raw %>% 
    dplyr::select(-species_code)

  temp1 <- temp %>% 
    dplyr::filter(where == "Present in EBS but absent in NBS" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -NBS) %>% 
    dplyr::rename(above_60 = EBS)
  
  temp2 <- temp %>% 
    dplyr::filter(where == "Present in NBS but absent in EBS" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -EBS) %>% 
    dplyr::rename(above_60 = NBS)
  
  # make the same length so they can be bound together
  if (nrow(temp1)>nrow(temp2)) {
    temp2 <- temp2 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  } else {
    temp1 <- temp1 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  }
  
  names(temp1) <- paste0(names(temp1), "_")
  
  temp <- dplyr::bind_cols(temp1, temp2)
  
  table_print <- temp %>%
    dplyr::select(-above_60, -above_60_) %>%
    flextable::flextable(data = .) %>%
    flextable::italic(x = .,
                      j = c(2,4)) %>%
    # flextable::bold(x = .,
    #                 i = which(temp1$above_60_),
    #                 j = 1:2) %>%
    # flextable::bold(x = .,
    #                 i = which(temp2$above_60),
    #                 j = 3:4) %>%
    # flextable::footnote(x = ., part = "header", i = 1, j = 1,
    #                     value = as_paragraph(footnote0)) %>%
    add_header_row(x = .,
                   values = c("Present in EBS but absent in NBS", "Present in NBS but absent in EBS"),
                   colwidths = c(2, 2)) %>%
    flextable::set_header_labels(.,
                                 common_name_ = "Common name",
                                 report_name_scientific_ = "Scientific name",
                                 common_name = "Common name",
                                 report_name_scientific = "Scientific name"
    ) %>%
    theme_flextable_nmfstm(row_lines = FALSE) %>%
    flextable::vline(x = ., j = 2, part = "all")

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
}
```

## tab_biomass_est_fish_ (EBS and NBS)

> waiting for actual data from rebecca

```{r tab_biomass_est_fish_}

nickname0 <- "tab_biomass_est_fish_"

# Select data and make plot
# temp <- cpue_biomass_station %>% 
  
  # TOLEDO - dummy data
  temp <- cbind.data.frame(taxon_group = c("A", "A", "C", "B", "B", "B"), 
                           taxon = letters[1:6],
                           head(airquality), 
                           head(airquality), 
                           head(airquality)[,3:5])
temp$taxon[c(2, 6)] <- paste0("Total ", temp$taxon[c(2, 6)])
names(temp) <- c("taxon_group", "taxon", "biomass", "a", "c95", "prop", 
                 "10", "20", "30", "40", "50", "60", "82", "90", "70", "71", "81")
temp$a <- "±"

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  header <- paste0("Biomass estimates (t) for major fish species and groups taken during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  
  footnote0 <- paste0("Proportion of total estimated biomass, fish and invertebrates combined, for the total survey area = ", NMFSReports::xunits(sum(temp$biomass, na.rm = TRUE))," t.")
  
  if (haul_cruises_maxyr$SRVY[i] == "EBS"){
    strat <- c("10", "20", "30", "40", "50", "60", "82", "90")
  } else {
    strat <- c("70", "71", "81")
  }
  
  table_raw <- temp %>% 
    dplyr::select("taxon_group", "taxon", "biomass", "a", "c95", "prop", 
                  all_of(strat))
  
  xx <- 1:nrow(table_raw)
  xx[!grepl(pattern = "Total ", x = table_raw$taxon)] <- NA
  xx_group <- as.numeric(factor(x = table_raw$taxon_group, 
                                labels = 1:length(unique(table_raw$taxon_group)),
                                levels = unique(table_raw$taxon_group),
                                ordered = FALSE))
  whichtobold <- xx + xx_group
  whichtobold <- whichtobold[!is.na(whichtobold)]
  
  table_print <- table_raw %>%
    flextable::as_grouped_data(groups = c("taxon_group"), columns = NULL) %>% 
    # groups = #names(table(xx_group))[table(xx_group)>1]) %>%
    flextable::flextable(data = .)  %>%
    flextable::add_header_row(top = TRUE, 
                              values = c("Taxon", 
                                         "Estimated total biomass (t) and 95% confidence", 
                                         "Proportion of total animal biomass", 
                                         "Estimated biomass by stratum (t)"), 
                              colwidths = c(2,3,1,length(strat))) %>% 
    flextable::align(i = 1, align = "center", part = "header")  %>%  
    flextable::footnote(x = ., part = "header", i = 1, j = 5, 
                        value = as_paragraph(footnote0)) %>%
    flextable::bold(x = ., part = "body", i = whichtobold) %>% 
    flextable::set_header_labels(.,
                                 "taxon_group" = "", 
                                 "taxon" = "", 
                                 "biomass" = "", 
                                 "c95" = "", 
                                 "a" = "", 
                                 "prop" = "") %>%
    NMFSReports::theme_flextable_nmfstm(row_lines = FALSE) 
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
  
} 

```

## tab_biomass_est_invert_ (EBS and NBS)

### waiting for actual data from rebecca

```{r tab_biomass_est_invert_}

nickname0 <- "tab_biomass_est_invert_"

# Select data and make plot
# TOLEDO - dummy data
temp <- cbind.data.frame(taxon_group = c("A", "A", "C", "B", "B", "B"), 
                         taxon = letters[1:6],
                         head(airquality), 
                         head(airquality), 
                         head(airquality)[,3:5])
temp$taxon[c(2, 6)] <- paste0("Total ", temp$taxon[c(2, 6)])
names(temp) <- c("taxon_group", "taxon", "biomass", "a", "c95", "prop", 
                 "10", "20", "30", "40", "50", "60", "82", "90", "70", "71", "81")
temp$a <- "±"

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  header <- paste0("Biomass estimates (t) for major fish species and groups taken during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  
  footnote0 <- paste0("Proportion of total estimated biomass, fish and invertebrates combined, for the total survey area = ", NMFSReports::xunits(sum(temp$biomass, na.rm = TRUE))," t.")
  
  if (haul_cruises_maxyr$SRVY[i] == "EBS"){
    strat <- c("10", "20", "30", "40", "50", "60", "82", "90")
  } else {
    strat <- c("70", "71", "81")
  }
  
  table_raw <- temp %>% 
    dplyr::select("taxon_group", "taxon", "biomass", "a", "c95", "prop", 
                  all_of(strat))
  
  xx <- 1:nrow(table_raw)
  xx[!grepl(pattern = "Total ", x = table_raw$taxon)] <- NA
  xx_group <- as.numeric(factor(x = table_raw$taxon_group, 
                                labels = 1:length(unique(table_raw$taxon_group)),
                                levels = unique(table_raw$taxon_group),
                                ordered = FALSE))
  whichtobold <- xx + xx_group
  whichtobold <- whichtobold[!is.na(whichtobold)]
  
  table_print <- table_raw %>%
    flextable::as_grouped_data(groups = c("taxon_group"), columns = NULL) %>% 
    # groups = #names(table(xx_group))[table(xx_group)>1]) %>%
    flextable::flextable(data = .)  %>%
    flextable::add_header_row(top = TRUE, 
                              values = c("Taxon", 
                                         "Estimated total biomass (t) and 95% confidence", 
                                         "Proportion of total animal biomass", 
                                         "Estimated biomass by stratum (t)"), 
                              colwidths = c(2,3,1,length(strat))) %>% 
    flextable::align(i = 1, align = "center", part = "header")  %>%  
    flextable::footnote(x = ., part = "header", i = 1, j = 5, 
                        value = as_paragraph(footnote0)) %>%
    flextable::bold(x = ., part = "body", i = whichtobold) %>% 
    flextable::set_header_labels(.,
                                 "taxon_group" = "", 
                                 "taxon" = "", 
                                 "biomass" = "", 
                                 "c95" = "", 
                                 "a" = "", 
                                 "prop" = "") %>%
    NMFSReports::theme_flextable_nmfstm(row_lines = FALSE) 
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
  
} 
```

## tab_biomass_compareyr_maxyr_percchange

```{r tab_biomass_compareyr_maxyr_percchange}

# nickname0 <- "tab_biomass_compareyr_maxyr_percchange_"
# 
# # Select data and make plot
# table_raw <- rbind.data.frame(biomass_maxyr, biomass_compareyr) %>% 
#   dplyr::left_join(x = ., 
#                    y = spp_info %>% 
#                      dplyr::select(used_in_counts, species_code),
#                    by = "species_code") %>%
#   dplyr::filter(stratum == 999 &
#                   used_in_counts == TRUE &
#                   !is.na(common_name) &
#                   !(grepl(pattern = " egg", x = common_name, fixed = T)) & 
#                   !(grepl(pattern = " sp.", x = common_name, fixed = T)) & 
#                   !(grepl(pattern = " unid.", x = common_name, fixed = T))) %>% 
#   dplyr::select(year, taxon, biomass, SRVY, species_code, common_name) %>% 
#   unique()  %>% 
#   dplyr::left_join(
#     x = ., 
#     y = rbind.data.frame(biomass_maxyr, biomass_compareyr) %>% 
#       dplyr::select(species_code, catcount, year, SRVY) %>% 
#       unique() %>% 
#       dplyr::group_by(species_code, SRVY) %>% 
#       dplyr::summarise(catcount = sum(catcount, na.rm = TRUE)), 
#     by = c("species_code", "SRVY")) %>%
#   dplyr::filter(catcount > 49) %>% 
#   tidyr::pivot_wider(names_from = year, 
#                      # id_cols = species_code, 
#                      values_fill = NA,
#                      values_from = biomass, 
#                      names_prefix = "b_") 
# 
# table_raw$pchange <- NMFSReports::pchange(start = unlist(table_raw[,paste0("b_", compareyr)]), 
#                                           end = unlist(table_raw[,paste0("b_", maxyr)]), 
#                                           value_only = TRUE)
# table_raw <- table_raw %>%
#   dplyr::filter(!is.infinite(pchange) &
#                   !is.na(pchange) &
#                   pchange != 0) %>% 
#   dplyr::arrange(-pchange, b_2017, common_name) %>% 
#   dplyr::relocate(common_name, paste0("b_", compareyr), paste0("b_", maxyr), 
#                   pchange, taxon, SRVY, species_code, catcount)
# 
# table_raw1 <- table_raw
# 
# for (i in 1:nrow(haul_cruises_maxyr)) {
#   if (nrow(haul_cruises_maxyr)>1) {
#     subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
#     newobj <- ifelse(i==1, TRUE, FALSE)
#   }
#   header <- paste0("Total estimated biomass in metric tons (t) and the percent change from the ",compareyr," and ",maxyr," ",haul_cruises_maxyr$SRVY[i]," (",haul_cruises_maxyr$SRVY_long[i],") bottom trawl surveys for invertebrate and fish taxa captured in greater than 50 trawl samples from both years combined.")
#   
#   nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
#   
#   table_raw <- table_raw1
#   
#   temp <- table_raw1 %>% 
#     dplyr::select(-SRVY, -species_code, -catcount) 
#   temp[,paste0("b_", compareyr)] <- round(x = temp[,paste0("b_", compareyr)], digits = 0)
#   temp[,paste0("b_", maxyr)] <- round(x = temp[,paste0("b_", maxyr)], digits = 0)
#   temp$pchange <- paste0(round(temp$pchange, digits = 0), "%")
#   
#   temp1 <- temp %>% 
#     dplyr::filter(taxon == "fish") %>% 
#     dplyr::select(-taxon) 
#   temp2 <- temp %>% 
#     dplyr::filter(taxon == "invert") %>% 
#     dplyr::select(-taxon) 
#   
#   # make the same length so they can be bound together
#   if (nrow(temp1)>nrow(temp2)) {
#     temp0 <- data.frame(matrix(data = NA, 
#                                nrow = (nrow(temp1)-nrow(temp2)),
#                                ncol = ncol(temp2)))
#     names(temp0) <- names(temp2)
#     temp2 <- rbind.data.frame(temp2, temp0)
#   } else {
#     temp0 <- data.frame(matrix(data = NA, 
#                                nrow = (nrow(temp2)-nrow(temp1)),
#                                ncol = ncol(temp1)))
#     names(temp0) <- names(temp1)
#     temp1 <- rbind.data.frame(temp1, temp0)
#   }
#   
#   names(temp1) <- paste0(names(temp1), "_")
#   
#   temp <-list(
#     "common_name" = "taxon", 
#     "common_name_" = "taxon", 
#     "pchange" = "change", 
#     "pchange" = "change", 
#     "a" = compareyr,
#     "b"  = maxyr, 
#     "a1" = compareyr,
#     "b1"  = maxyr)
#   names(temp)[5:8] <- c(paste0("b_", compareyr, "_"), 
#                         paste0("b_", maxyr, "_"), 
#                         paste0("b_", compareyr), 
#                         paste0("b_", maxyr))
#   
#   
#   table_print <- 
#     cbind.data.frame(temp2, 
#                      # "" = "",
#                      temp1) %>% 
#     flextable::flextable(data = .)  %>%
#     flextable::add_header_row(top = TRUE, 
#                               values = c("Invertebrate", 
#                                          "Biomass (t)", 
#                                          "%", 
#                                          "Fish", 
#                                          "Biomass (t)", 
#                                          "%"), 
#                               colwidths = c(1,2,1,1,2,1)) %>% 
#     flextable::align(i = 1, align = "center", part = "header")  %>%  
#     flextable::set_header_labels(., values = temp) %>%
#     NMFSReports::theme_flextable_nmfstm(row_lines = FALSE)  %>% 
#     flextable::vline(x = ., j = 4, part = "all")
#   
#   # save yo' stuff and do a lot of behind the scenes work
#   # alt: this does the same thing as calling "child = " in the chunk header
#   res <- knitr::knit_child(
#     text = knitr::knit_expand(
#       file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
#     quiet = TRUE
#   )
#   
# list_tables[nickname][[1]]$res <- res <- paste0("
# 
# 
# ",res,"
# 
# ")
#   
# } 

```


## tab_majortaxa_pchange_

```{r tab_majortaxa_pchange_}

nickname0 <- "tab_majortaxa_pchange_" 
yrs <- nbsyr
# header <- paste0("Major taxa sampled in the NBS bottom trawl survey for ",NMFSReports::text_list(nbsyr),", and the percentage change in biomass (metric tons) from ",compareyr," to ",maxyr," in descending order of percent (%) change.")

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 

header <- paste0(
  "Total estimated biomass in metric tons (t) and the percent change from the ",
                 compareyr," and ",maxyr," ", 
                 haul_cruises_maxyr$SRVY_long[i], 
                 " shelf (", 
                 haul_cruises_maxyr$SRVY[i], 
                 ") bottom trawl surveys for invertebrate and fish taxa captured in greater than 50 trawl samples from both years combined.")

a<-table_change(dat = cpue_biomass_total %>% 
                  dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>%
                  dplyr::rename(y = biomass_mt), 
                yrs = nbsyr, 
                maxyr = maxyr, 
                compareyr = compareyr, 
                remove_all = TRUE) 

table_raw <- a$table_raw %>% 
  dplyr::select(-"Survey", -starts_with("change_"), -ends_with(as.character(nbsyr[!(nbsyr %in% c(maxyr, compareyr))])))  

# table_print <- a$table_print

temp1 <- table_raw %>% 
  dplyr::filter(taxon == "fish")

temp2 <- table_raw %>% 
  dplyr::filter(taxon == "invert") 


if (nrow(temp1)>nrow(temp2)){
  temp2 <- temp2 %>% 
    dplyr::bind_rows(., 
                     data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))))) 
} else {
  temp1 <- temp1 %>% 
    dplyr::bind_rows(., 
                     data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1)))#, 
                                # report_name_scientific = NA, 
                                # above_60 = FALSE
                     ))
}

names(temp1) <- paste0(names(temp1), " ")

table_raw <- dplyr::bind_cols(temp1, temp2) %>% 
  dplyr::select(-dplyr::starts_with("taxon"))


table_print <- dplyr::bind_cols(temp1, temp2) %>%
  # dplyr::select(-taxon) %>% 
  dplyr::mutate(across(starts_with("change"), 
                       formatC, big.mark=",", digits = 1, format = "f")) %>%
  # dplyr::select(-taxon) %>% 
  dplyr::mutate(across(starts_with("change"), paste0, "%")) %>%
  dplyr::mutate(across(where(is.numeric), 
                       formatC, big.mark=",", digits = 0, format = "f")) %>%
  # dplyr::mutate(change = paste0(prettyNum(change, big.mark=","), "%")) %>% 
  dplyr::mutate(group = stringr::str_to_title(print_name)) %>% 
  dplyr::mutate(dplyr::across(where(is.character), gsub, pattern = "NA%", replacement = "")) %>% 
  dplyr::mutate(dplyr::across(where(is.character), gsub, pattern = "NA", replacement = ""))


if (TRUE) { # remove_all
  table_print$group <- gsub(pattern = "All ", replacement = "", 
                            x = table_print$group, fixed = TRUE)
}

table_print <- table_print %>% 
  dplyr::mutate(spp = dplyr::case_when(
    grepl(pattern = "sp.", x = species_name1, fixed = TRUE) ~ "sp.", 
    grepl(pattern = "spp.", x = species_name1, fixed = TRUE) ~ "spp.", 
    TRUE ~ "")) %>%
  dplyr::mutate(
    species_name = species_name1, 
    species_name1 = 
      gsub(pattern = " sp.", replacement = "", 
           x = species_name1, fixed = TRUE), 
    species_name1 =
      gsub(pattern = " spp.", replacement = "",
           x = species_name1, fixed = TRUE),
    species_name2 = dplyr::case_when(
      !grepl(pattern = " ", x = species_name, fixed = TRUE) ~ species_name1), 
    species_name1 = dplyr::case_when(
      grepl(pattern = " ", x = species_name, fixed = TRUE) ~ species_name1)) %>% 
  dplyr::rename("Fish taxon" = "print_name ", 
                "Invertebrate taxon" = "print_name")

table_print <- table_print %>%
  flextable::flextable(data = ., 
                       col_keys = c(ifelse(length(unique(table_print$SRVY)) == 1, 
                                           "", "Survey"), 
                                    "Fish taxon", 
                                    paste0(yrs, " "), "change ", 
                                    "Invertebrate taxon", 
                                    as.character(yrs), "change")) %>%
  # compose(j = "dummy", 
  #         value = as_paragraph(as_i(species_name1), species_name2, " ", spp)) %>% # https://stackoverflow.com/questions/57474647/italic-and-color-in-an-r-flextable
  flextable::color(color = "red", 
                   i = grepl(pattern = "-", x = as.character(table_print$change)), 
                   j = "change") %>% 
  flextable::color(color = "red", 
                   i = grepl(pattern = "-", x = as.character(table_print[, "change "])), 
                   j = "change ") %>% 
  flextable::width(x = ., j = "Fish taxon", width = 2.5) %>% 
  flextable::width(x = ., j = "Invertebrate taxon", width = 2.5) %>% 
  flextable::width(x = ., j = "change ", width = 1) %>% 
  flextable::width(x = ., j = "change", width = 1) %>% 
  flextable::set_header_labels(.,
                               # group = "Common name",
                               # dummy = "Taxon",
                               "change " = paste0("Change (", maxyr, ", ", compareyr, ")" ), 
                               change = paste0("Change (", maxyr, ", ", compareyr, ")" )) %>% 
  NMFSReports::theme_flextable_nmfstm(row_lines = FALSE, x = .)  %>% 
  flextable::vline(x = ., part = "all", j = 7)

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
}
```


## tab_estimates_maxyr_spp_

> can I remove the total hauls column and add it to the header, instead? 

```{r tab_estimates_maxyr_spp_}
nickname0 <- paste0("tab_estimates_maxyr_spp_") 

temp <- biomass %>% 
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(species_code, SRVY, 
                meanwgtcpue, varmnwgtcpue, 
                biomass, varbio, upperb, lowerb, 
                meannumcpue, varmnnumcpue, 
                population, varpop, upperp, lowerp, 
                # haulcount, 
                catcount, numcount, lencount) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(species_code, print_name, order, taxon), 
    by = "species_code") %>% 
  dplyr::filter(taxon == "fish" &
                  (catcount != 0 & numcount != 0 & lencount != 0) & # if there were none in that survey, don't include
                  order > 0) %>% 
  dplyr::arrange(order) %>% 
  dplyr::select(-species_code, -order, -taxon) %>% 
  dplyr::relocate(print_name)

# for (i in 1:2) {
#   subobj <- ifelse(i==1, TRUE, FALSE)
#   newobj <- ifelse(i==1, TRUE, FALSE)

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 


  if (i == 1){ # CPUE (WT/HA) and BIOMASS
    
    header <- paste0("Mean CPUE by weight (kg/ha) with standard deviation, and estimated biomass (t) with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for other common groundfish species for the ",
                     maxyr," ",
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                                   " shelf (", 
                                                   haul_cruises_maxyr$SRVY, "; ",
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " trawl surveys.")
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    meanwgtcpue, varmnwgtcpue, 
                    biomass, varbio, upperb, lowerb, 
                    # haulcount, 
                    catcount, numcount, lencount) 
    
    biomass0<-find_units(unit = "mt", unt = "mt", table_raw$biomass)
    varbio0<-find_units(unit = "", unt = "", table_raw$varbio)
    
    table_print <- table_raw %>% 
      # dplyr::mutate(meanwgtcpue = meanwgtcpue/meanwgtcpue0$divby) %>% 
      # dplyr::mutate(varmnwgtcpue = varmnwgtcpue/varmnwgtcpue0$divby) %>% 
      dplyr::mutate(biomass = biomass/biomass0$divby) %>% 
      dplyr::mutate(upperb = upperb/biomass0$divby) %>% 
      dplyr::mutate(lowerb = lowerb/biomass0$divby) %>% 
      dplyr::mutate(varbio = varbio/varbio0$divby) %>% 
      dplyr::mutate(across(where(is.double) & ends_with("cpue"), 
                           formatC, big.mark=",", digits = 2, format = "f")) %>% 
      dplyr::mutate(across(where(is.double) & !ends_with("cpue"),# & ends_with("count"), 
                           formatC, big.mark=",", digits = 0, format = "f")) 
    
    if (SRVY == "EBS") {
      table_print <- table_print %>% 
        dplyr::select(-SRVY)
    }
    
    table_print <- table_print %>%
      flextable::flextable(data = .) %>% 
      flextable::set_header_labels(
        x = ., 
        print_name = "Species", 
        SRVY = "Shelf area", 
        meanwgtcpue = paste0("Mean CPUE (kg/ha)"), 
        varmnwgtcpue = paste0("SD CPUE"), 
        biomass = paste0("Estimated Biomass", biomass0$unit_word), 
        varbio = paste0("SD Biomass", varbio0$unit_word), 
        upperp = paste0("95% LCL", biomass0$unit_word), 
        lowerp = paste0("95% UCL", biomass0$unit_word), 
        # haulcount = "Total hauls", 
        catcount = "Hauls with weights", 
        numcount = "Hauls with counts", 
        lencount = "Hauls with lengths") %>% 
      flextable::merge_v(x = ., target = "print_name", 
                         j = "print_name", part = "body") %>% 
      flextable::valign(valign = "top") %>%
      theme_flextable_nmfstm(row_lines = TRUE)
    
  } else { # CPUE No/HA and POPULATION
    
    header <- paste0("Mean CPUE by number (no./ha) with standard deviation, and estimated population with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for other common groundfish species for the ", 
                     maxyr," ",
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                                   " shelf (", 
                                                   haul_cruises_maxyr$SRVY, "; ",
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " trawl surveys.")
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    meannumcpue, varmnnumcpue, 
                    population, varpop, upperp, lowerp, 
                    # haulcount, 
                    catcount, numcount, lencount)
    
    population0 <- find_units(unit = "", unt = "", table_raw$population)
    varpop0 <- find_units(unit = "", unt = "", table_raw$varpop)
    
    table_print <- table_raw %>% 
      dplyr::mutate(population = population/population0$divby) %>% 
      dplyr::mutate(upperp = upperp/population0$divby) %>% 
      dplyr::mutate(lowerp = lowerp/population0$divby) %>% 
      dplyr::mutate(varpop = varpop/varpop0$divby) %>% 
      dplyr::mutate(across(where(is.double) & ends_with("cpue"), 
                           formatC, big.mark=",", digits = 2, format = "f")) %>% 
      dplyr::mutate(across(where(is.double) & !ends_with("cpue"),# & ends_with("count"), 
                           formatC, big.mark=",", digits = 0, format = "f")) 
    
    if (SRVY == "EBS") {
      table_print <- table_print %>% 
        dplyr::select(-SRVY)
    }
    
    table_print <- table_print %>%
      flextable::flextable(data = .) %>% 
      flextable::set_header_labels(
        x = ., 
        print_name = "Species", 
        SRVY = "Shelf area", 
        meannumcpue = paste0("Mean CPUE (no/ha)"), 
        varmnnumcpue = paste0("SD CPUE"), 
        population = paste0("Estimated Population", population0$unit_word), 
        varpop = paste0("SD Population", varpop0$unit_word), 
        upperp = paste0("95% LCL", population0$unit_word), 
        lowerp = paste0("95% UCL", population0$unit_word), 
        # haulcount = "Total hauls", 
        catcount = "Hauls with weights", 
        numcount = "Hauls with counts", 
        lencount = "Hauls with lengths") %>% 
      flextable::merge_v(x = ., target = "print_name", 
                         j = "print_name", part = "body") %>% 
      flextable::valign(valign = "top") %>%
      theme_flextable_nmfstm(row_lines = TRUE)
  }
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res <- paste0("


",res,"

")
}
```


