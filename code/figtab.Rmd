---
output:
  word_document: 
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

# Introduction

## fig_sampled_survey_stations

```{r fig_sampled_survey_stations}
nickname <- "fig_sampled_survey_stations"
header <- paste0("Sampled survey stations by vessel and the stratification scheme used for data analysis of the ", maxyr," ",
                 NMFSReports::text_list(haul_cruises_maxyr$SRVY),
                 " shelf bottom trawl survey", ifelse(SRVY == "NEBS", "s", ""), 
                 ". The map also depicts the stations sampled by the ",
                 NMFSReports::text_list(paste0(vessel_info$vessel_ital, " (",
                                               vessel_info$vess_shape, ")")), 
                 ifelse(crab_resample == TRUE, " and where Bristol Bay crab resampling was conducted", ""), ". ")

height <- ifelse(SRVY == "NEBS", full_page_portrait_height, 6) # height <- 6
width <- full_page_portrait_width # width <- 6.5

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- 
  dplyr::left_join(x = reg_dat0$survey.grid, 
                   y = dplyr::left_join(x = haul_maxyr, 
                                        y = vessel_info) %>% 
                     dplyr::select(stationid, vessel_name, vess_shape) %>%
                     dplyr::mutate(vess_col = dplyr::case_when(
                       (vess_shape == vessel_info$vess_shape[1]) ~ nmfspalette::nmfs_cols("dkgray"), 
                       (vess_shape == vessel_info$vess_shape[2]) ~ nmfspalette::nmfs_cols("supdkgray"))) %>% 
                     dplyr::rename(STATIONID = stationid), 
                   by = ("STATIONID"))

if (crab_resample == TRUE){
  reg_dat0$survey.grid <- dplyr::left_join(
    x = reg_dat0$survey.grid, 
    y = haul_maxyr_crabretow %>% 
      dplyr::mutate(study = "crab_resample", 
                    study_col = nmfspalette::nmfs_cols("medgray"),
                    study = "crab_resample", 
                    study_long = "Red King Crab\nResample") %>% 
      dplyr::select(stationid, study, study_col, study_long) %>%
      dplyr::rename(STATIONID = stationid) %>% 
      unique(), 
    by = ("STATIONID")) 
}
# vess <- survey.grid0 %>% dplyr::filter(!is.na(vessel_name))


# figure <- plot_survey_stations(reg_dat = reg_dat0, 
#                                station_info, 
#                                haul_cruises_maxyr, 
#                                station_grid = FALSE, 
#                                stratum_no = TRUE, 
#                                station_pts_srvy = FALSE, 
#                                station_pts_vess = TRUE, 
#                                crab_resample = FALSE) # defined in data.r

figure <- plot_survey_stations(
  reg_dat = reg_dat0, 
  station_info, 
  haul_cruises_maxyr, 
  station_grid = FALSE, 
  stratum_no = TRUE, 
  bathymetry = TRUE, 
  station_pts_srvy = FALSE, 
  station_pts_vess = TRUE, 
  study = crab_resample) # defined in data.r

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res

```

## fig_sample_grid

```{r fig_sample_grid}
header <- paste0("Sampling grid and station identifiers for the ",maxyr," ",
                 NMFSReports::text_list(haul_cruises_maxyr$SRVY),
                 " continental shelf bottom trawl survey", 
                 ifelse(SRVY == "NEBS", "s", ""), 
                 ". ", ifelse(SRVY == "NBS", "", "Corner stations (denoted by circles) are not labeled for legibility. "))
nickname <- "fig_sample_grid"
subobj <- FALSE

# header <- paste0("Map of the Bering Sea survey stations sampled in ",maxyr," during the EBS and NBS survey. The area enclosed within the light gray line contains the EBS shelf stations that have been sampled annually since 1982, whereas the area outlined in the dark gray line are the NBS stations that were sampled in ",maxyr,". The dots within each area indicate each station location.") # TOLEDO

height <- ifelse(SRVY == "NEBS", full_page_portrait_height, 6) # height <- 6
width <- full_page_portrait_width # width <- 6.5

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- reg_dat0$survey.grid %>% 
  dplyr::mutate(STATIONID = ifelse(!grepl(pattern = "-", x = STATIONID), "", STATIONID))
reg_dat0$place.labels <- reg_dat0$place.labels %>% 
  dplyr::filter(type %in% c("mainland", "peninsula"))

figure <- plot_survey_stations(reg_dat = reg_dat0, 
                               station_info = station_info, 
                               haul_cruises_maxyr = haul_cruises_maxyr, 
                               station_grid = TRUE, 
                               stratum_no = FALSE, 
                               station_pts_srvy = FALSE, 
                               place_labels = TRUE)

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res
```

# Methods

## fig_vessels

```{r fig_vessels}
header <- paste0("Fishing vessels ",
                 NMFSReports::text_list(paste0(vessel_info$vessel_ital, 
                                               " (", c("left", "right"), ")")),
                 " contracted to assist the ",maxyr," ",
                 NMFSReports::text_list(SRVY1),
                 " bottom trawl survey.")
nickname <- "fig_vessels"

height <- 2.5
width <- full_page_portrait_width # width <- 6.5

# Select data and make plot
p1 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, vessel_info$img[1])), 
                      scale = 0.9 )

p2 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, vessel_info$img[2])), 
                      scale = 0.9 )

figure <- cowplot::plot_grid(p1, p2,  
                             ncol = 2, rel_heights = c(0.1, 1))

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res

```

## fig_trawl_gear

```{r fig_trawl_gear}
header <- paste0("Schematic diagram of the 83-112 eastern otter trawl gear used during the ", 
                 maxyr ," ", NMFSReports::text_list(SRVY1) ," bottom trawl survey", 
                 ifelse(length(SRVY1)>1, "s", ""), ".")
footnote<- NA
nickname <- "fig_trawl_gear"
alttext <- paste0(header)
height = 8
width <- full_page_portrait_width # width <- 6.5

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "EASTERN83-112.png")) )

# save yo' stuff and do a lot of behind the scenes work
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res

```

## tab_stratum_areas

```{r tab_stratum_areas}
header <- paste0("Stratum areas and sampling densities used during the ",maxyr,
                 " ", NMFSReports::text_list(SRVY1) ," bottom trawl survey", 
                 ifelse(length(SRVY1)>1, "s", ""),". Stratum areas were calculated in ", 
                 stratum_info$year[1] , ". ")

nickname <- "tab_stratum_areas" 

temp <- stratum_info %>% 
  dplyr::select(area, stations_completed, stratum, type, SRVY) 

if (length(unique(station_info$SRVY))>1) {
  totals_sub <- stratum_info %>%
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(
      area = sum(area, na.rm = TRUE),
      stations_completed = sum(stations_completed, na.rm = TRUE)) %>%
    dplyr::mutate(stratum = "") %>%
    dplyr::mutate(type = "Total") %>% 
    dplyr::relocate(names(temp))
}

totals <- stratum_info %>% 
  dplyr::summarise(area = sum(area, na.rm = TRUE), 
                   stations_completed = sum(stations_completed, na.rm = TRUE)) %>% 
  dplyr::mutate(stratum = "") %>% 
  dplyr::mutate(type = "Total") %>% 
  dplyr::mutate(SRVY = NMFSReports::text_list(SRVY1)) %>% 
  dplyr::relocate(names(temp))

table_raw <- 
  rbind.data.frame(temp, 
                   if(exists("totals_sub")){totals_sub}, 
                   totals) %>% 
  dplyr::mutate(density = round(area/stations_completed, 0)) %>% 
  dplyr::mutate(area = round(area, 0)) %>% 
  dplyr::mutate(Region = paste0(SRVY, " ", type)) %>% 
  dplyr::mutate(order = dplyr::case_when(
    Region == "EBS Inner Shelf" ~ 1,
    Region == "EBS Middle Shelf" ~ 2,
    Region == "EBS Outer Shelf" ~ 3,
    Region == "EBS Total" ~ 4,
    Region == "NBS Shelf" ~ 5,
    Region == "NBS Total" ~ 6,
    Region == "EBS and NBS Total" ~ 7
  ))  %>%
  dplyr::arrange(order, stratum) %>% #SRVY, stratum) %>% 
  # dplyr::select(Region, stratum, area, stations_completed, density, -order) %>% 
  dplyr::select(-Region, -order) %>%
  dplyr::relocate(SRVY, type, #Region, 
                  stratum, area, stations_completed, density) %>% 
  dplyr::rename(Region = type)

table_print <- table_raw %>%
  flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL)  %>%
  flextable::as_flextable(font = font0, x = ., hide_grouplabel = TRUE) %>%
  flextable::compose(x = ., i = 1, j = "area", part = "header",
                     value = as_paragraph("Representative\narea (km", as_sup("2"), ")")) %>%
  flextable::compose(x = ., i = 1, j = "density", part = "header",
                     value = as_paragraph("Sampling density\n(km", as_sup("2"), "/Stations successfully sampled)")) %>%  
  flextable::set_header_labels(., 
                               Region = "",
                               stratum = "Stratum",
                               # area = "Representative\narea (km2)",
                               # density = "Sampling density\n(km2/Stations successfully sampled)"
                               stations_completed = "Stations\nsuccessfully sampled") %>% 
  flextable::merge_v(j = "Region") %>%
  flextable::merge_h_range(x = ., i = ~ stratum == "", j1 = "Region", j2 = "stratum", part = "body") %>%
  flextable::valign(valign = "top") %>%
  theme_flextable_nmfstm(x = ., 
                         row_lines = FALSE, 
                         pad = 0, 
                         font0 = font0, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::align(x = ., j = c("stratum", "area", "stations_completed", "density"), 
                   align = "right", part = "all")  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::padding(x = .,
                     j = 1, i = ~ is.na(SRVY),
                     padding.left = 5)   %>%
  flextable::hline(x = ., i = ~ !is.na(Region), #j = SRVY, #border = fp_border(width = 3), 
                   part = "body")  %>%
  flextable::hline(x = ., i = ~ (Region == "Total"), #j = SRVY, #border = fp_border(width = 3), 
                   part = "body", border = fp_border(width = 2)) 

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res

```

## tab_oto_collection_scheme

```{r tab_oto_collection_scheme_}

nickname0 <- paste0("tab_oto_collection_scheme_") 


table_raw0 <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                                 sheet = "Sheet1", 
                                 skip = 1) %>% 
  dplyr::filter(year == maxyr & !is.na(oto_target)) %>% 
  dplyr::select(SRVY, print_name, species_code, oto_target, oto_rules, oto_samp_type) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_name1, order) %>% 
      dplyr::rename(species_name = species_name1) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::arrange(order) %>% 
  dplyr::arrange(oto_samp_type) %>% 
  dplyr::arrange(SRVY) %>% 
  dplyr::select(-order, -species_code) %>% 
  dplyr::relocate(SRVY, print_name, species_name, oto_samp_type, oto_target, oto_rules)

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  header <- paste0("Otolith collection types and counts during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY[i],
                   " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  table_raw <- table_raw0 %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    # dplyr::mutate(oto_target = formatC(x = oto_target, digits = 0)) %>%
    dplyr::select(-SRVY, -species_name)
  
  table_raw$oto_target <- gsub(pattern = ".0", replacement = "", x = table_raw$oto_target)
  
  table_print <- table_raw %>% 
    flextable::as_grouped_data(x = ., groups = c(#"SRVY", 
      "oto_samp_type"), 
      columns = NULL) %>% 
    flextable::as_flextable(x = ., hide_grouplabel = TRUE) %>% 
    flextable::bold(x = ., j = 1, i = ~ !is.na(oto_samp_type) ) %>% 
    flextable::set_header_labels(.,
                                 print_name = "Common name", 
                                 # species_name = "Scientific name", 
                                 oto_rules = "Collect when \u2265 n individuals\n caught in each haul",
                                 oto_target = "Target collection number per haul") %>%
    # flextable::compose(
    #   i = ~ !is.na(group), # when var_group not NA
    #   j = " ", # on column "var"
    #   value = as_paragraph(as_chunk(group))) %>%     # create a paragraph containing a chunk containing value of `var_group`
    # hline(i = ~ !is.na(SRVY), border = officer::fp_border() ) %>%
    NMFSReports::theme_flextable_nmfstm(x = ., pad = 0, 
                                        font0 = font0, 
                                        row_lines = TRUE, 
                                        pgwidth = full_page_portrait_width)  %>%
    flextable::padding(x = .,
                       j = 1, i = ~ is.na(oto_samp_type),
                       padding.left = 5) %>%
    # flextable::width(x = ., j = "print_name", width = 1.5)  %>%
    flextable::width(x = ., j = "oto_rules", width = 1.5, unit = "in") %>%
    flextable::width(x = ., j = "oto_target", width = 3, unit = "in") %>%
    flextable::width(x = ., j = c("print_name"), width = 2) %>% 
    flextable::hline(x = ., i = ~ !is.na(oto_samp_type), 
                     border = fp_border(color = "white"), 
                     part = "body") 
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
}
```

## tab_stomach_collection_scheme

```{r tab_stomach_collection_scheme}

nickname <- paste0("tab_stomach_collection_scheme") 

header <- paste0("Stomach collection targets during the ", 
                 maxyr, " ", 
                 NMFSReports::text_list(paste0( 
                   haul_cruises_maxyr$SRVY)),
                 " shelf bottom trawl survey.")

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                                sheet = "Sheet1", 
                                skip = 1) %>% 
  dplyr::filter(year == maxyr & !is.na(stomach_target)) %>% 
  dplyr::select(SRVY, print_name, species_code, stomach_target) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_name1, order) %>% 
      dplyr::rename(species_name = species_name1) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::arrange(order) %>% 
  dplyr::arrange(stomach_target) %>% 
  dplyr::arrange(SRVY) %>% 
  dplyr::select(-order, -species_code) %>% 
  dplyr::relocate(SRVY, print_name, species_name, stomach_target) %>% 
  dplyr::mutate(stomach_target = as.character(round(as.numeric(stomach_target), digits = 0))) %>% 
  tidyr::pivot_wider(data = ., id_cols = c("print_name", "species_name"), 
                     names_from = "SRVY", values_from = "stomach_target")

table_raw[is.na(table_raw)] <- "-"

table_print <- flextable::flextable(table_raw %>% 
                                      dplyr::select(-species_name)) %>% 
  # flextable::italic(x = ., j = "species_name") %>% 
  flextable::set_header_labels(.,
                               print_name = "Common name", 
                               # species_name = "Scientific name", 
                               stomach_target = "Target collection number per survey") %>%
  NMFSReports::theme_flextable_nmfstm(x = ., 
                                      pad = 0, 
                                      font0 = font0, 
                                      row_lines = TRUE, 
                                      pgwidth = full_page_portrait_width)  %>%
  flextable::align(x = ., j = c(SRVY1), 
                   align = "right", part = "all")   %>%
  flextable::width(x = ., width = (2.5/length(SRVY1)))  %>%
  flextable::width(x = ., j = "print_name", width = 4)  


# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res

```

## tab_special_projects

```{r tab_special_projects}
nickname <- "tab_special_projects" 
places <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                             sheet = "affiliations", 
                             skip = 1) %>% 
  dplyr::arrange(Agency)

newobj <- TRUE

temp <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                           sheet = "projects", 
                           skip = 1)  %>% 
  dplyr::filter(!is.na(`Project Title`) & 
                  year == maxyr) %>% 
  dplyr::select(SRVY, `Project Title`, `Principal investigator`, Agency) %>% 
  dplyr::arrange(desc(SRVY))

# for (i in 1:nrow(haul_cruises_maxyr)) {
#   if (nrow(haul_cruises_maxyr)>1) {
#     subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
#     newobj <- ifelse(i==1, TRUE, FALSE)
#   }
# nickname <- paste0(nickname0, "_", haul_cruises_maxyr$SRVY[i]) 
header <- paste0("Special projects and collections undertaken during the ",
                 maxyr, " ", 
                 NMFSReports::text_list(haul_cruises_maxyr$SRVY), 
                 " shelf bottom trawl survey, sorted by principal investigator and agency.")

table_raw <- temp %>%
  dplyr::arrange(SRVY, Agency, `Principal investigator`, `Project Title`)

temp1 <- places[places$Agency %in% unique(table_raw$Agency), ]

footnote0 <- paste(paste(temp1$Agency, " - ", temp1$agency_long, sep = ""), collapse = "; ")

table_print <- table_raw %>%
  flextable::as_grouped_data(groups = c("SRVY"), columns = NULL) %>% 
  flextable::as_flextable(., hide_grouplabel = TRUE)  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::width(x = ., j = "Agency", width = 2, unit = "in") %>%
  flextable::width(x = ., j = "Principal investigator", width = 3, unit = "in") %>%
  flextable::width(x = ., j = "Project Title", width = 4, unit = "in") %>% 
  # flextable::set_header_labels(x = ., "SRVY" = "Region") %>%
  flextable::footnote(x = ., 
                      value = as_paragraph(footnote0), 
                      ref_symbols = "1",
                      part = "header", 
                      j = "Agency", i = 1)  %>%
  NMFSReports::theme_flextable_nmfstm(x = ., 
                                      font0 = font0, 
                                      pad = 0, 
                                      row_lines = TRUE, 
                                      pgwidth = full_page_portrait_width) %>% 
  flextable::padding(x = .,
                     j = 1, i = ~ is.na(SRVY),
                     padding.left = 5) %>% 
    flextable::hline(x = ., i = ~ !is.na(SRVY), 
                     border = fp_border(color = "white"), 
                     part = "body")

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
  quiet = TRUE
)

list_tables[nickname][[1]]$res <- res

```

# Results

## fig_mean_temperature

```{r fig_mean_temperature}

# code orig from sean rohan's coldpool package! Jan 23 2021 

nickname <- "fig_mean_temperature"
header <- paste0("Average summer surface (light blue triangles) and bottom (dark blue circles) and time-series average surface (dark blue dashed line) and bottom (light blue dashed line) temperatures (°C) on the EBS shelf, based on data collected during standardized summer bottom trawl surveys from 1982–",maxyr,
                 ifelse(SRVY == "NEBS", 
                        paste0(" (left), and NBS shelf based on data collected during standardized summer bottom trawl surveys (right)"), ""), 
                 ". ")

height = 3.25
width <- full_page_portrait_width # 6.5

a <- plot_mean_temperatures(maxyr, SRVY)
for (jjj in 1:length(a)) { assign(names(a)[jjj], a[[jjj]]) }

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res

```

## fig_cold_pool_area

```{r fig_cold_pool_area}
# header <- paste0("Percentage of the EBS shelf from 1982–",maxyr," bottom area that is occupied by the cold pool in one degree Celsius increments.")
header <- paste0("Annual summer cold pool extent on the EBS shelf, based on observations from the EBS bottom trawl survey. Extent of the cold pool is shown in proportion to the total southern EBS shelf survey area. Shading denotes near-bottom temperatures \u2264 2°C (aqua blue), \u2264 1°C (cerulean blue), \u2264 0°C (cobalt blue), and \u2264 -1°C (dark navy blue).")
# alttext <- paste0("Annual cold pool extent on the EBS shelf, as measured using observations from the EBS bottom trawl survey. Extent of the cold pool in proportion to the total EBS shelf survey area from 1982–",maxyr,". Shading denotes near-bottom temperatures \u2264 2°C (aqua blue), \u2264 1°C (cerulean blue), \u2264 0°C (cobalt blue), and \u2264 -1°C (dark navy blue).")

footnote <- "Areas were summarized from areas in inverse distance weighted rasters."
nickname <- "fig_cold_pool_area"

height <- 3
width <- full_page_portrait_width # 6.5


figure <- plot_coldpool_area(coldpool_ebs_bin_area, maxyr)

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

list_figures[nickname][[1]]$res <- res

```

## fig_st_maxyr

```{r fig_st_maxyr}
# header <- paste0("Contour map of surface temperatures from the ",maxyr," ",
#                  # NMFSReports::text_list(haul_cruises_maxyr$SRVY),
#                  "EBS", 
#                  " shelf bottom trawl surveys.")
# nickname <- "fig_st_maxyr"
# height <- 8
# width <- 6.5
# 
# # EBS + NBS years
# if (sum(grepl(pattern = maxyr, x = names(coldpool:::nbs_ebs_surface_temperature)))>0){
#   rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_surface_temperature,
#                                 subset = paste0("ebs_ste_", maxyr, "_surface_temperature"))
# } else { # in EBS only years
#   rasterbrick <- raster::subset(x = coldpool:::ebs_surface_temperature,
#                                 subset = paste0("ste_", maxyr, "_surface_temperature"))
# }
# 
# figure <- plot_temps_facet(
#   rasterbrick = rasterbrick, 
#   key.title = expression(bold("Surface Temperature (°C)")), 
#   reg_dat = reg_dat, 
#   colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
#   viridis_palette_option = "H") 
# 
# # save yo' stuff and do a lot of behind the scenes work
# # alt: this does the same thing as calling "child = " in the chunk header
# res <- knitr::knit_child(
#   text = knitr::knit_expand(
#     file = system.file("rmd/_child_save_fig.Rmd", 
#                        package = "NMFSReports")), 
#   quiet = TRUE
# )
# 
# list_figures[nickname][[1]]$res <- res

```

## fig_bt_temperature_ebs_[above or below]

```{r fig_bt_temperature_ebs_}
# nickname0 <- "fig_idw_bottemp_longterm_mean_"
nickname0 <- "fig_bt_temperature_ebs_"

for (i in 1:2) { # two cases, above and below
  
  height <- full_page_portrait_height 
  width <- full_page_portrait_width
  
  subobj <- TRUE
  newobj <- ifelse(i==1, TRUE, FALSE)
  TF <- ifelse(i==1, FALSE, TRUE)
  case <- ifelse(i==1, "below", "above")
  years <- sort(temps_avg_yr_abovebelow[case][[1]])
  
  header <- paste0("EBS shelf bottom trawl survey near-bottom temperatures in years ",
                   case,
                   " the time-series average (",
                   NMFSReports::text_list(years), ").")
  nickname <- paste0(nickname0, case)
  
  # Just EBS
  rasterbrick <- raster::subset(x = coldpool:::ebs_bottom_temperature,
                                subset = paste0("sebs_ste_", years, "_gear_temperature"))
  names(rasterbrick) <- gsub(pattern = "_", replacement = "", 
                             x = (gsub(x = names(rasterbrick), 
                                       pattern = "[a-zA-Z]+", replacement = "")))
  
  if (length(years)<3) {
    row0 <- 1
    height <- full_page_portrait_height - 4.5
  } else if (length(years)<7) {
    row0 <- 2
    height <- full_page_portrait_height - 2.5
  } else { # }  if (length(years)<10) {
    row0 <- 3
    height <- full_page_portrait_height 
  } 
  
  figure <- plot_temps_facet(
    rasterbrick = rasterbrick,
    key.title = expression(bold("Bottom Temperature (°C)")),
    reg_dat = report_types$EBS$reg_dat,
    colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
    viridis_palette_option = "H", 
    row0 = row0, # ifelse(length(year)<10, 3, 4), 
    title0 = paste0("Bottom Temperatures of Years ",
                    stringr::str_to_sentence(case), 
                    " Time-Series Average"))
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd",
                         package = "NMFSReports")),
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res
  
}
```

## fig_[st or bt]_temperature_nebs_surveys

```{r fig_[st or bt]_temperature_nebs_surveys}

if (SRVY == "NEBS") {
  
  for (i in 1:2) { # two cases, above and below
    case <- ifelse(i==1, "bottom", "surface")
    nickname <- paste0("fig_",ifelse(i==1, "bt", "st"),
                       "_temperature_nebs_surveys")
    
    subobj <- TRUE
    newobj <- ifelse(i==1, TRUE, FALSE)
    
    header <- paste0(stringr::str_to_title(case)," temperatures (°C) in the NBS and EBS during the ",
                     NMFSReports::text_list(nbsyr),
                     " surveys, which included the full NBS shelf bottom trawl survey. ")
    
    if (case == "surface") {
      rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_surface_temperature,
                                    subset = paste0("ebs_ste_", nbsyr, "_surface_temperature"))
    } else {
      rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_bottom_temperature,
                                    subset = paste0("ebs_ste_", nbsyr, "_gear_temperature"))
      # rasterbrick <- raster::subset(x = coldpool:::nbs_ebs_surface_temperature,
      #                               subset = paste0("ebs_ste_", nbsyr, "_surface_temperature"))    
    }
    
    height <- ifelse(length(nbsyr)>2, full_page_portrait_height, 5)
    width <- full_page_portrait_width
    
    figure <- plot_temps_facet(
      rasterbrick = rasterbrick, 
      key.title = ifelse(i==1, 
                         expression(bold("Bottom Temperature (°C)")), 
                         expression(bold("Surface Temperature (°C)"))), 
      reg_dat = report_types$NEBS$reg_dat, 
      colorbar_breaks = c(-Inf, seq(from = 0, to = 14, by = 2), Inf),
      row0 = ifelse(length(nbsyr)>2, 2, 1), 
      viridis_palette_option = "H", 
      title0 = paste0(stringr::str_to_title(case), " Temperature")) 
    
    # save yo' stuff and do a lot of behind the scenes work
    # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd",
                         package = "NMFSReports")),
    quiet = TRUE
  )
  
  list_figures[nickname][[1]]$res <- res
  }
}
```

## tab_specimen_samples

```{r tab_specimen_samples_}
nickname0 <- paste0("tab_specimen_samples_") 

# length data - from oracle
l <- length_maxyr %>% 
  dplyr::select(SRVY, species_code, frequency) %>% # common_name, 
  # dplyr::mutate(common_name = gsub(pattern = " (juvenile)", replacement = "", x = common_name, fixed = TRUE)) %>% 
  dplyr::group_by(SRVY, species_code) %>% 
  dplyr::summarise(length = sum(frequency, na.rm = TRUE)) %>% 
  dplyr::ungroup() 

# age oto data - from oracle
a <- specimen_maxyr %>% 
  dplyr::filter(!is.na(species_code) & specimen_sample_type == 1) %>%
  dplyr::select("SRVY", species_code) %>% 
  dplyr::group_by("SRVY" = SRVY, species_code) %>% 
  # also specimen_sample_type? 1 = otoliths, 
  # specimen_subsample_method 1=random, 2 = stratified?
  dplyr::summarise(age = as.numeric(n())) %>% 
  dplyr::ungroup()

# other collections not in oracle
temp <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_other_field_collections.xlsx"), 
                           sheet = "Sheet1", 
                           skip = 1) %>%
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(SRVY, print_name, dplyr::starts_with("count_")) %>% 
  dplyr::select(where(~sum(!is.na(.x)) > 0)) 
names(temp) <- gsub(pattern = "count_", replacement = "", x = names(temp))

# Combine
table_raw0 <- 
  dplyr::full_join(x = l, y = a, 
                   by = c("SRVY", "species_code")) %>% 
  dplyr::left_join(x = ., 
                   y = spp_info %>% 
                     dplyr::mutate(
                       common_name = gsub(pattern = " (juvenile)", replacement = "", x = common_name, fixed = TRUE), 
                       common_name = dplyr::case_when(
                         is.na(common_name) ~ report_name_scientific, 
                         common_name == "shorthorn (=warty) sculpin" ~ "shorthorn sculpin", 
                         TRUE ~ common_name)) %>% 
                     dplyr::select(species_code, common_name), 
                   by = "species_code") %>% 
  dplyr::group_by(SRVY, common_name) %>% 
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
  dplyr::ungroup() %>% 
  dplyr::full_join(x = ., 
                   y = temp, 
                   by = c("SRVY", "common_name" = "print_name")) %>% 
  dplyr::mutate(dplyr::across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
  dplyr::select(-species_code) %>% 
  dplyr::arrange(SRVY, common_name) %>% 
  dplyr::filter(!grepl(pattern = " crab", x = common_name, ignore.case = TRUE))

table_raw0$common_name[is.na(table_raw0$common_name)] <- "other" # TOLEDO

table_raw0 <- 
  dplyr::bind_rows(table_raw0, 
                   table_raw0 %>% 
                     dplyr::group_by(SRVY) %>% 
                     dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
                     dplyr::mutate(common_name = "Total") ) %>% 
  dplyr::relocate(SRVY, common_name, length, age) %>% 
  dplyr::rename("length_measurements" = length,
                "otolith_age_structure_samples" = age) %>%
  data.frame()

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  header <- paste0("Biological data collected during the ", maxyr, " ", 
                   haul_cruises_maxyr$SRVY[i],
                   " shelf bottom trawl survey. The annual crab technical memorandum produced by the shelfish assessment program summarizes crab samples collected during the survey. ")
  
  table_raw <- table_raw0 %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i])
  
  names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))] <- 
    stringr::str_to_sentence(gsub(pattern = "_",
                                  replacement = "\n", 
                                  x = names(table_raw)[!(names(table_raw) %in% 
                                                           c("SRVY", "common_name"))], 
                                  fixed = TRUE))
  names(table_raw)[names(table_raw) == "Otolith\nAge\nStructure\nMeasurements"] <- 
    "Otolith Age\nStructure Measurements"
  names(table_raw)[names(table_raw) == "Pathobiology\nBlood\nSample"] <- 
    "Pathobiology\nBlood Sample"
  
  
  table_print <- table_raw %>% 
    dplyr::mutate(across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f")) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    dplyr::select(-"SRVY") 
  
  table_print[is.na(table_print) | table_print == "0"] <- "-"
  
  
  table_print <- table_print %>% 
    flextable::flextable(data = .) %>%
    flextable::set_header_labels(x = .,
                                 common_name = haul_cruises_maxyr$SRVY[i]#,
                                 # Length = "Length\nmeasurements",
                                 # Age = "Age structure (otolith)\nmeasurements"
    ) %>% 
    flextable::bold(x = ., i = which(table_print$common_name == "Total")) %>%
    # flextable::merge_v(j = "SRVY") %>%
    flextable::valign(valign = "top") %>%
    NMFSReports::theme_flextable_nmfstm(x = ., 
                                        pad = 0, 
                                        spacing = 0.4,
                                        font0 = font0, 
                                        pgwidth = full_page_portrait_width) %>%
    flextable::align(x = ., j = 2:ncol(table_print), 
                     align = "right", part = "all")  %>%
    # flextable::width(x = ., width = 1.5, unit = "in")   %>%
    flextable::width(x = ., width = (4.5/(ncol(table_raw)-2)), unit = "in") %>%
    flextable::width(x = ., j = "common_name", width = 2, unit = "in")
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
  
}

```


## tab_species_composition

```{r tab_species_composition}

if (SRVY == "NEBS"){
  
  nickname <- "tab_species_composition" 
  header <- paste0("Fish taxa from survey catches exclusive to the ",
                   NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, " shelf (", 
                                                 haul_cruises_maxyr$SRVY, ")")),". ")
  
  height <- full_page_portrait_height # 7
  width <- full_page_portrait_width # 6.5
  
  # Select data and make plot
  table_raw <- catch_haul_cruises_maxyr %>% 
    dplyr::select(species_code, SRVY, 
                  "SRVY", start_latitude) %>% 
    dplyr::group_by(species_code, SRVY) %>% 
    dplyr::summarise(lat_max = max(start_latitude, na.rm = TRUE),
                     lat_min = min(start_latitude, na.rm = TRUE)) %>%
    dplyr::mutate(above_60 = (lat_max >= 60 & lat_min >= 60)) %>%
    tidyr::pivot_wider(data = ., 
                       id_cols = species_code, 
                       names_from = SRVY, 
                       values_from = c(above_60),#, lat_min, lat_max), 
                       values_fill = NA) %>% 
    dplyr::mutate(where = dplyr::case_when(
      !is.na(EBS) & !is.na(NBS) ~ "Present in EBS and NBS", 
      is.na(NBS) & !is.na(EBS)~ "Present in EBS but absent in NBS", 
      is.na(EBS) & !is.na(NBS) ~ "Present in NBS but absent in EBS")) %>% 
    dplyr::left_join(x = ., 
                     y = spp_info, #%>% 
                     # dplyr::rename(common_name = print_name), 
                     by = "species_code") %>% 
    dplyr::filter(taxon == "fish") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(species_code, common_name, report_name_scientific, all_of(SRVY1), where) %>% 
    dplyr::filter(!grepl(x = common_name, pattern = " unid.", fixed = TRUE)) %>%
    dplyr::filter(!grepl(x = common_name, pattern = " egg", fixed = TRUE)) %>%
    dplyr::filter(!is.na(common_name)) %>%
    dplyr::arrange(common_name)
  
  temp <- table_raw %>% 
    dplyr::select(-species_code)
  
  temp1 <- temp %>% 
    dplyr::filter(where == "Present in EBS but absent in NBS" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -NBS) %>% 
    dplyr::rename(above_60 = EBS)
  
  temp2 <- temp %>% 
    dplyr::filter(where == "Present in NBS but absent in EBS" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -EBS) %>% 
    dplyr::rename(above_60 = NBS)
  
  # make the same length so they can be bound together
  if (nrow(temp1)>nrow(temp2)) {
    temp2 <- temp2 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  } else {
    temp1 <- temp1 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  }
  
  names(temp1) <- paste0(names(temp1), "_")
  
  temp0 <- dplyr::bind_cols(temp1, temp2)
  
  for (iii in 1:nrow(temp0)) {
    if (grepl(pattern = " unid.", x = temp0$report_name_scientific[iii])) {
      temp0$common_name[iii] <- paste0(temp0$common_name[iii], 
                                       " (", temp0$report_name_scientific[iii], ")")
      temp0$report_name_scientific[iii] <- NA
      # } else {
      #   temp0$report_name_scientific[iii] <- paste0(" (", temp0$report_name_scientific[iii], ")")
    }
    if (grepl(pattern = " unid.", x = temp0$report_name_scientific[iii])) {
      temp0$common_name_[iii] <- paste0(temp0$common_name_[iii], 
                                        " (", temp0$report_name_scientific_[iii], ")")
      temp0$report_name_scientific_[iii] <- NA
      #   } else {
      # temp0$report_name_scientific_[iii] <- paste0(" (", temp0$report_name_scientific_[iii], ")")
    }
  }
  
  table_print <- flextable::flextable(
    data = temp0,
    col_keys = c("dummy_ebs","dummy_nbs"))  %>%
    flextable::compose(j = "dummy_ebs", part = "body",
                       value = as_paragraph(
                         as_chunk(ifelse(!is.na(common_name_), 
                                         paste0(common_name_), ""),
                                  props = fp_text_default(bold = FALSE, font.size = 10, font.family = font0)), 
                         as_chunk(ifelse(!is.na(report_name_scientific_), 
                                         paste0(" (", report_name_scientific_, ")"), ""),
                                  props = fp_text_default(italic = TRUE, font.size = 10, font.family = font0)))) %>%  
    flextable::compose(j = "dummy_nbs", part = "body",
                       value = as_paragraph(
                         as_chunk(ifelse(!is.na(common_name), 
                                         paste0(common_name), ""),
                                  props = fp_text_default(bold = FALSE, font.size = 10, font.family = font0)), 
                         as_chunk(ifelse(!is.na(report_name_scientific), 
                                         paste0(" (", report_name_scientific, ")"), ""),
                                  props = fp_text_default(italic = TRUE, font.size = 10, font.family = font0)))) %>%  
    flextable::compose(x = ., i = 1, j = "dummy_ebs", part = "header",
                       as_paragraph("Present in EBS but absent in NBS\nCommon Name ", 
                                    as_chunk(paste0("(Scientific Name)"),
                                             props = fp_text_default(italic = TRUE, bold = TRUE, 
                                                                     font.size = 10, font.family = font0)))) %>%  
    flextable::compose(x = ., i = 1, j = "dummy_nbs", part = "header",
                       as_paragraph("Present in NBS but absent in EBS\nCommon Name ", 
                                    as_chunk(paste0("(Scientific Name)"),
                                             props = fp_text_default(italic = TRUE, bold = TRUE, 
                                                                     font.size = 10, font.family = font0)))) %>%  
    NMFSReports::theme_flextable_nmfstm(x = ., 
                                        font0 = font0, 
                                        pad = 0, 
                                        row_lines = FALSE, 
                                        pgwidth = full_page_portrait_width) %>%
    flextable::vline(x = ., j = "dummy_ebs", part = "all") %>%
    flextable::padding(x = ., j = "dummy_nbs", padding.left = 5, part = "all")
  
  # table_print <- temp %>%
  #   dplyr::select(-above_60, -above_60_) %>%
  #   flextable::flextable(data = .) %>%
  #   flextable::italic(x = .,
  #                     j = c(2,4)) %>%
  #   # flextable::bold(x = .,
  #   #                 i = which(temp1$above_60_),
  #   #                 j = 1:2) %>%
  #   # flextable::bold(x = .,
  #   #                 i = which(temp2$above_60),
  #   #                 j = 3:4) %>%
  #   # flextable::footnote(x = ., part = "header", i = 1, j = 1,
  #   #                     value = as_paragraph(footnote0)) %>%
  #   flextable::add_header_row(x = .,
  #                  values = c("Present in EBS but absent in NBS", "Present in NBS but absent in EBS"),
  #                  colwidths = c(2, 2)) %>%
  #   flextable::set_header_labels(.,
  #                                common_name_ = "Common name",
  #                                report_name_scientific_ = "Scientific name",
  #                                common_name = "Common name",
  #                                report_name_scientific = "Scientific name"
  #   ) %>%
  #   NMFSReports::theme_flextable_nmfstm(x = ., 
  #                                       font0 = font0, 
  #                                       pad = 0, 
  #                                       row_lines = FALSE, 
  #                                       pgwidth = full_page_portrait_width) %>%
  #   flextable::vline(x = ., j = 2, part = "all") %>% 
  #   flextable::padding(x = ., j = "common_name", padding.left = 5, part = "all")
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
}

```

## tab_biomass_est_PREP

```{r tab_biomass_est_PREP}

# temp <- function(dat0, total_biomass){
temp <- function(exp0, 
                 maxyr, 
                 biomass_by_stratum0,
                 catch_haul_cruises_maxyr0,
                 total_biomass0, 
                 spp_code_rnge
) {
  
  confint <- function(num_hauls, bio_var) {
    out <- qt(p = 0.025, df = num_hauls - 1, lower.tail = F) * sqrt(bio_var)
    return(out)
  }
  
  # species level --------------------------------------------------------------
  
  # calculate cpue and biomass
  # a <- calc_cpue_bio(catch_haul_cruises0 = catch_haul_cruises_maxyr)
  # biomass_by_stratum0 <- a$biomass_cpue_by_stratum
  # total_biomass0 <- a$total_biomass
  
  # select spp 
  dat <- eval(parse(
    text=gsub(pattern = "DATAFRAME", 
              replacement = "biomass_by_stratum0", 
              x = exp0) )) %>% 
    ungroup() %>% 
    tidyr::separate(
      col = group0, 
      into = c("group", "taxon"), 
      sep = "_", 
      remove = FALSE) %>% 
    dplyr::select(SRVY, strata, group, group0, taxon, biomass_mt, ci, num_hauls, bio_var) %>% 
    dplyr::group_by(SRVY, strata, group, group0, taxon) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE), 
                     num_hauls = sum(num_hauls, na.rm = TRUE), 
                     ci = confint(num_hauls, bio_var)) %>% 
    dplyr::ungroup()
  
  
  #   dat <- eval(parse( 
  # text=gsub(pattern = "DATAFRAME", 
  #           replacement = "biomass_by_stratum0", 
  #           x = exp0) )) %>% 
  # ungroup() %>% 
  # tidyr::separate(
  #   col = group0, 
  #   into = c("group", "taxon"), 
  #   sep = "_", 
  #   remove = FALSE) %>% 
  # dplyr::select(SRVY, strata, group, group0, taxon, biomass_mt, ci, num_hauls, bio_var) %>% 
  # dplyr::group_by(SRVY, strata, group, group0, taxon) %>% 
  # dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
  #                  bio_var = sum(bio_var, na.rm = TRUE), 
  #                  num_hauls = sum(num_hauls, na.rm = TRUE), 
  #                  ci = confint(num_hauls, bio_var)) %>% 
  # dplyr::ungroup()
  
  biomass_spp_bystrata <- dat %>%
    # dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
    dplyr::group_by(SRVY, strata, group, taxon) %>% # , num_hauls
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     bio_var = sum(bio_var, na.rm = TRUE),
                     num_hauls = mean(num_hauls, na.rm = TRUE)) %>% # TOLEDO
    dplyr::mutate(ci = confint(num_hauls, bio_var)#, 
                  # taxon = paste0("total ", tolower(group)), 
                  # order = 1
    )
  
  biomass_spp_999 <- dat %>%
    dplyr::group_by(SRVY, group, taxon) %>% # , num_hauls
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     bio_var = sum(bio_var, na.rm = TRUE),
                     num_hauls = mean(num_hauls, na.rm = TRUE)) %>%
    dplyr::mutate(
      # order = 1, #ifelse(grepl(pattern = "other ", x = taxon), 2, 1),
      ci = confint(num_hauls, bio_var), 
      strata = 999)
  
  
  # group level --------------------------------------------------------------
  
  dat0 <- eval(parse(
    text=gsub(pattern = "DATAFRAME",
              replacement = "catch_haul_cruises_maxyr0",
              x = exp0) ))  %>%
    ungroup() %>%
    tidyr::separate(
      col = group0,
      into = c("group", "taxon"),
      sep = "_",
      remove = FALSE) %>%
    dplyr::filter(year == maxyr) %>%
    dplyr::distinct(SRVY, stratum, stationid, group, # not strictly necessary, but helpful
                    hauljoin, species_code) %>%
    dplyr::group_by(SRVY, group) %>%
    dplyr::summarise(num = n()) # the number of hauls the group was caught in for all strata
  
  # do I need to sum num_hauls from all spp or sum of tows where any of those species ever occured
  # 
  # temp00 <- eval(parse( 
  #   text=gsub(pattern = "DATAFRAME", 
  #             replacement = "catch_haul_cruises_maxyr", 
  #             x = exp0) )) %>% 
  #   ungroup() %>% 
  #   tidyr::separate(
  #     col = group0, 
  #     into = c("group", "taxon"), 
  #     sep = "_", 
  #     remove = FALSE) %>% 
  #   dplyr::mutate(species_code = group)
  # 
  # # calculate cpue and biomass
  # a <- calc_cpue_bio(catch_haul_cruises0 = temp00)
  # biomass_by_stratum0 <- a$biomass_cpue_by_stratum
  # total_biomass0 <- a$total_biomass
  
  # dat <- eval(parse( 
  #   text=gsub(pattern = "DATAFRAME", 
  #             replacement = "biomass_by_stratum0", 
  #             x = exp0) )) %>% 
  #   ungroup() %>% 
  #   tidyr::separate(
  #     col = group0, 
  #     into = c("group", "taxon"), 
  #     sep = "_", 
  #     remove = FALSE) %>% 
  #   dplyr::select(SRVY, strata, group, group0, taxon, biomass_mt, ci, num_hauls, bio_var) %>% 
  #   dplyr::group_by(SRVY, strata, group, group0, taxon) %>% 
  #   dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
  #                    bio_var = sum(bio_var, na.rm = TRUE), 
  #                    num_hauls = sum(num_hauls, na.rm = TRUE), 
  #                    ci = confint(num_hauls, bio_var)) %>% 
  #   dplyr::ungroup()
  
  ## find estimated total biomass by stratum for group complexes (e.g., groups with more than one line)
  biomass_group_bystrata <- dat %>%
    dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
    dplyr:: group_by(SRVY, strata, group) %>%
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE), 
                     num_hauls = sum(num_hauls, na.rm = TRUE)  # do I need to sum num_hauls from all spp or sum of tows where any of those species ever occured
    ) %>%
    dplyr::mutate(ci = confint(num_hauls, bio_var), 
                  taxon = paste0("total ", (group)))
  
  biomass_group_999 <- dat %>%  ## summarize by group to compare to prior years tech memo    
    dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
    dplyr::group_by(group, SRVY) %>%
    dplyr::summarize(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     bio_var = sum(bio_var, na.rm = TRUE)) %>%
    dplyr::left_join(x = ., 
                     y = dat0, 
                     by =  c("SRVY", "group")) %>%
    dplyr::mutate(
      num_hauls = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = confint(num_hauls, bio_var), 
      # up_ci_bio_tot = biomass_mt + ci,
      # ci_percent = ((1-(biomass_mt/up_ci_bio_tot))*100), 
      taxon = paste0("total ", (group)), 
      strata = 999) %>% 
    dplyr::select(-num)
  
  
  
  #   dat <- eval(parse( 
  #   text=gsub(pattern = "DATAFRAME", 
  #             replacement = "biomass_by_stratum0", 
  #             x = exp0) )) %>% 
  #   ungroup() %>% 
  #   tidyr::separate(
  #     col = group0, 
  #     into = c("group", "taxon"), 
  #     sep = "_", 
  #     remove = FALSE) %>% 
  #   dplyr::select(SRVY, strata, group, group0, taxon, biomass_mt, ci, num_hauls, bio_var) %>% 
  #   dplyr::group_by(SRVY, strata, group, group0, taxon) %>% 
  #   dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
  #                    bio_var = sum(bio_var, na.rm = TRUE), 
  #                    num_hauls = sum(num_hauls, na.rm = TRUE), 
  #                    ci = confint(num_hauls, bio_var)) %>% 
  #   dplyr::ungroup()
  # 
  # 
  # biomass_spp_bystrata <- dat %>%
  #   # dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
  #   dplyr::group_by(SRVY, strata, group, taxon) %>% # , num_hauls
  #   dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
  #                    bio_var = sum(bio_var, na.rm = TRUE),
  #                    num_hauls = mean(num_hauls, na.rm = TRUE)) %>% # TOLEDO
  #   dplyr::mutate(ci = confint(num_hauls, bio_var)#, 
  #                 # taxon = paste0("total ", tolower(group)), 
  #                 # order = 1
  #                 )
  # 
  # biomass_spp_999 <- dat %>%
  #   dplyr::group_by(SRVY, group, taxon, num_hauls) %>% # 
  #   dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
  #                    bio_var = sum(bio_var, na.rm = TRUE)) %>%
  #   dplyr::mutate(
  #     # order = 1, #ifelse(grepl(pattern = "other ", x = taxon), 2, 1),
  #     ci = confint(num_hauls, bio_var), 
  #     strata = 999)
  # 
  
  # total level -----------------------------------------------------------------
  
  # biomass_mt mtches
  # not sure if CI is right
  
  biomass_total_bystrata <- # find estimated total biomass for all stratum for all taxon
    biomass_by_stratum0 %>% 
    dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species codes greater than 35000 are invertebrates
    dplyr::mutate(group0 = "Total") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(SRVY, group0, strata, biomass_mt, ci, num_hauls, bio_var) %>% 
    dplyr::group_by(SRVY, group0, strata) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE)#, 
                     # num_hauls = sum(num_hauls, na.rm = TRUE), 
                     # num_hauls = ifelse(num_hauls == 1, 1, (num_hauls-1)), 
                     # ci = confint(num_hauls, bio_var)
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::left_join(
      x = ., 
      y = catch_haul_cruises_maxyr0 %>% 
        dplyr::mutate(strata = dplyr::case_when(
          (stratum == 31 | stratum == 32) ~ 30,
          (stratum == 41 | stratum == 42) | stratum == 43 ~ 40,
          (stratum == 61 | stratum == 62) ~ 60, 
          TRUE ~ as.numeric(stratum))) %>%
        dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species_code < 35000
        dplyr::group_by(year, SRVY, strata) %>%
        dplyr::distinct(hauljoin) %>%
        dplyr::summarize(num = n()),  # number of hauls the group was caught in for all strata,
      by = c("SRVY", "strata")) %>% 
    dplyr::mutate(
      num_hauls = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = NA, #confint(num_hauls, bio_var), # not right
      taxon = NA, 
      group = "Total")
  
  
  # not sure if CI is right
  
  biomass_total_999 <-  # find estimated total biomass for all stratum for all taxon
    biomass_by_stratum0 %>% 
    dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species codes greater than 35000 are invertebrates
    dplyr::mutate(group0 = "Total") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(SRVY, group0, biomass_mt, ci, num_hauls, bio_var) %>% 
    dplyr::group_by(SRVY, group0) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE), 
                     # num_hauls = sum(num_hauls, na.rm = TRUE), 
                     # num_hauls = ifelse(num_hauls == 1, 1, (num_hauls-1)), 
                     # ci = confint(num_hauls, bio_var)
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::left_join(
      x = ., 
      y = catch_haul_cruises_maxyr0 %>% 
        dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species_code < 35000
        dplyr::group_by(year, SRVY) %>%
        dplyr::distinct(hauljoin) %>%
        dplyr::summarize(num = n()),  # number of hauls the group was caught in for all strata,
      by = "SRVY") %>% 
    dplyr::mutate(
      num_hauls = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = confint(num_hauls, bio_var), # not right
      taxon = NA, 
      strata = 999, 
      group = "Total")
  
  
  out <- dplyr::bind_rows(biomass_group_bystrata, 
                          biomass_group_999, 
                          biomass_spp_bystrata,
                          biomass_spp_999,
                          biomass_total_bystrata, 
                          biomass_total_999) %>% 
    dplyr::select(-num, -num_hauls, -bio_var) %>%
    dplyr::mutate(order = dplyr::case_when(
      grepl(pattern = "other ", x = taxon) ~ 2,
      grepl(pattern = "total ", x = taxon) ~ 3,
      TRUE ~ 1)) %>%
    tidyr::pivot_wider(id_cols = c("SRVY", "group", "taxon", "order"), 
                       names_from = "strata", 
                       values_from = c("biomass_mt", "ci"))
  
  # out$order[grepl(pattern = "other ", x = out$group, ignore.case = TRUE)] <- 4
  
  out <- out %>% 
    dplyr::arrange(SRVY, group, order, taxon) %>% 
    # dplyr::select(-order) %>%
    dplyr::ungroup() 
  
  out$order <- 1:nrow(out)
  out$order[grepl(pattern = "other", x = out$group, ignore.case = TRUE)] <- nrow(out)+1
  out$order[grepl(pattern = "total", x = out$group, ignore.case = TRUE)] <- nrow(out)+2
  names(out) <- gsub(pattern = "biomass_mt_", replacement = "", x = names(out))
  
  out <- dplyr::left_join(
    x = out, 
    y = total_biomass, 
    by = "SRVY") %>% 
    dplyr::mutate(CI95 = ci_999, 
                  # `999` = biomass_mt_999,
                  a = "±", 
                  prop = `999`/total) %>% 
    dplyr::arrange(order) %>%
    dplyr::relocate(SRVY, group, taxon, `999`, a, CI95, prop) %>% 
    dplyr::filter(`999` != 0) %>% # TOLEDO 
    dplyr::select(-order, -total, -dplyr::starts_with("ci_"))
  
  return(out)
  
}

FitFlextableToPage <- function(x, pgwidth = 6) {
  ft_out <- x %>% flextable::autofit()
  ft_out <- flextable::width(ft_out, width = dim(ft_out)$widths * 
                               pgwidth/(flextable::flextable_dim(ft_out)$widths))
  return(ft_out)
}

temp1 <- function(table_raw, strat, total) {
  table_raw0 <- table_raw
  table_raw <- table_raw %>% 
    dplyr::select("group", "taxon", "999", "a", "CI95", "prop", 
                  all_of(strat))
  
  footnote0 <- paste0("Proportion of total estimated biomass is ", 
                      formatC(x = total, digits = 0, format = "f", big.mark = ","), 
                      " mt for fish and invertebrates in the ",  
                      unique(table_raw0$SRVY), " bottom trawl survey.")
  
  table_print <- table_raw %>% 
    dplyr::mutate(prop = ifelse(prop < 0.0001, "<0.0001", 
                                formatC(x = prop, digits = 4, 
                                        format = "f", big.mark = ",")), 
                  across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f"), 
                  `999` = paste0(`999`, " ", a)) %>% 
    dplyr::select(-a)
  
  table_print <- table_print %>%
    flextable::flextable(data = .)  %>%
    flextable::merge_v(x = ., j = ~ group) %>%
    flextable::merge_h_range(x = ., i = ~ is.na(taxon), j1 = "group", j2 = "taxon", part = "body") %>%
    flextable::add_header_row(top = TRUE, 
                              values = c("Taxon", 
                                         "Estimated total biomass (mt) ± 95% confidence interval", 
                                         "Proportion of total animal biomass", 
                                         "Estimated biomass by stratum (mt)"), 
                              colwidths = c(2,2,1,length(strat))) %>% 
    flextable::width(x = .,  
                     width = ifelse(length(strat)>3, 0.7, 1.25), unit = "in") %>%
    flextable::width(x = ., j = "prop", 
                     width = 0.8, unit = "in") %>%
    flextable::width(x = ., j = c("group"), 
                     width = 1, unit = "in") %>%    
    flextable::width(x = ., j = c("taxon"), 
                     width = 1.6, unit = "in") %>% 
    flextable::footnote(x = ., part = "header", i = 1, j = 5, ref_symbols = "1",
                        value = as_paragraph(footnote0)) %>%
    flextable::bold(x = ., i = ~ (grepl(pattern = "Total", x = group) )) %>%
    flextable::set_header_labels(.,
                                 "group" = "", 
                                 "taxon" = "",
                                 "999" = "", 
                                 "CI95" = "", 
                                 "prop" = "") %>%
    flextable::merge_at(x = ., j = c("group", "taxon"), part = "header") %>% 
    flextable::merge_at(x = ., j = c("999", "CI95"), part = "header") %>% 
    flextable::merge_at(x = ., j = c("prop"), part = "header") #%>% 
  # NMFSReports::theme_flextable_nmfstm(x = .,
  #                                     font0 = font0,
  #                                     pad = 0,
  #                                     row_lines = TRUE,
  #                                     pgwidth = full_page_landscape_width) %>%
  row_lines <- TRUE
  pad = 0
  body_size = 10
  header_size = 10
  spacing = 0.6
  pgwidth = full_page_landscape_width
  std_b <- officer::fp_border(width = 2, color = "grey10")
  thin_b <- officer::fp_border(width = 0.5, color = "grey10") 
  
  # x <- table_print
  
  x <- flextable::border_remove(x = table_print)
  if (row_lines == TRUE) {
    table_print <- flextable::hline(x = table_print, border = thin_b, part = "body")
  }
  
  table_print <- table_print %>% 
    flextable::hline(x = ., border = std_b, part = "header") %>% 
    flextable::hline_bottom(x = ., border = std_b, part = "body") %>% 
    flextable::bold(x = ., bold = TRUE, part = "header") %>% 
    flextable::align_text_col(x = ., align = "left", header = TRUE) %>% 
    flextable::align_nottext_col(x = ., align = "right", header = TRUE) %>% 
    flextable::padding(x = ., padding = pad, part = "all") %>% 
    flextable::font(x = ., fontname = font0, part = "all") %>% 
    flextable::fontsize(x = ., size = body_size - 2, part = "footer") %>% 
    flextable::fontsize(x = ., size = body_size, part = "body") %>% 
    flextable::fontsize(x = ., size = header_size, part = "header") %>% 
    flextable::fix_border_issues(x = .) %>% 
    flextable::align(x = ., j = c("999", "CI95", "prop",  strat), 
                     align = "right", part = "all") %>%
    flextable::align(x = ., 
                     j = c(strat), 
                     align = "center", i = 1, part = "header")
  
  return(list("table_raw" = table_raw, 
              "table_print" = table_print))
}

```

### tab_biomass_est_fish_ (EBS and NBS)

```{r tab_biomass_est_fish_}

nickname0 <- "tab_biomass_est_fish_"

# # Select data and make plot
# place species codes into groups and major species
exp0 <- ('DATAFRAME %>% dplyr::filter(species_code < 35000) %>% # species codes greater than 35000 are invertebrates
  dplyr::mutate(group0 = case_when(
    species_code == 471 ~ "Rajidae (skates)_Alaska skate",
    species_code >= 401 & 
      species_code <= 495 & 
      species_code != 471 ~ "Rajidae (skates)_other skates",
    species_code == 10210 ~ "Pleuronectidae (flatfishes)_yellowfin sole",
    species_code == 10261 ~ "Pleuronectidae (flatfishes)_northern rock sole",
    species_code == 10130 ~ "Pleuronectidae (flatfishes)_flathead sole",
    species_code == 10140 ~ "Pleuronectidae (flatfishes)_Bering flounder",
    species_code == 10285 ~ "Pleuronectidae (flatfishes)_Alaska plaice",
    species_code == 10110 ~ "Pleuronectidae (flatfishes)_arrowtooth flounder",
    species_code == 10112 ~ "Pleuronectidae (flatfishes)_Kamchatka flounder",
    species_code == 10120 ~ "Pleuronectidae (flatfishes)_Pacific halibut",
    species_code >= 10041 & 
      species_code <= 10295 & 
      species_code != 10210 &
      species_code != 10261 &
      species_code != 10130 &
      species_code != 10140 &
      species_code != 10285 &
      species_code != 10110 &
      species_code != 10112 &
      species_code != 10115 &
      species_code != 10120 ~ "Pleuronectidae (flatfishes)_other flatfish",
    species_code >= 21740 & species_code <= 21741 ~ "Gadidae (cods)_walleye pollock",
    species_code >= 21720 & species_code <= 21721 ~ "Gadidae (cods)_Pacific cod",
    species_code >= 21710 & 
      species_code <= 21737 &
      species_code != 21740 &
      species_code != 21741 &
      species_code != 21720 &
      species_code != 21721 ~ "Gadidae (cods)_other cods",
    species_code >= 20000 & species_code <= 20075 ~ "Agonidae (poachers)",
    species_code >= 21300 & species_code <= 21447 ~ "Cottidae (sculpins)",
    species_code >= 21900 & species_code <= 21935 ~ "Hexagrammidae (greenlings)",
    species_code >= 22170 & species_code <= 22199 ~ "Cyclopteridae (lumpsuckers)",
    species_code >= 22200 & species_code <= 22286 ~ "Liparidae (snailfishes)",
    species_code >= 23000 & species_code <= 23099 ~ "Osmeridae (smelts)",
    species_code >= 23800 & species_code <= 23870 ~ "Stichaeidae (blennies)", 
    species_code >= 24100 & species_code <= 24395 ~ "Zoarcidae (eelpouts)",
    species_code == 30060 ~ "Scorpaenidae (rockfishes)_Pacific ocean perch",
    species_code >= 30000 & 
      species_code <= 31550 & 
      species_code != 30060 ~ "Scorpaenidae (rockfishes)_other rockfish",
    TRUE ~ "Other"))')

table_raw0 <- temp(exp0 = exp0, 
                   maxyr = maxyr, 
                   biomass_by_stratum0 = biomass_by_stratum,
                   catch_haul_cruises_maxyr0 = catch_haul_cruises_maxyr,
                   total_biomass0 = total_biomass, 
                   spp_code_rnge = "species_code < 35000")

##find the 37kg that belong in other skate that is currently in other fish 
## answer:skate egg cases are included in the skate biomass     

for (i in 1:nrow(haul_cruises_maxyr)) {
  
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  header <- paste0("Biomass estimates (mt) for major fish taxa collected during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY[i],
                   " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  if (haul_cruises_maxyr$SRVY[i] == "EBS"){
    strat <- c("10", "20", "30", "40", "50", "60", "82", "90")
  } else {
    strat <- c("70", "71", "81")
  }
  
  a <- temp1(table_raw = table_raw0 %>% 
               dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]), 
             strat = strat, 
             total = total_biomass$total[total_biomass$SRVY ==
                                           haul_cruises_maxyr$SRVY[i]])
  table_raw <- a$table_raw
  table_print <- a$table_print
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
  
} 

```

### tab_biomass_est_invert\_ (EBS and NBS)

```{r tab_biomass_est_invert_}

nickname0 <- "tab_biomass_est_invert_"

#     species_code >= 68000 & species_code <= 69549 ~ "Crustacea_crabs",

# # Select data and make plot
# place species codes into groups and major species
exp0 <- ('DATAFRAME %>% dplyr::filter(species_code >= 40000 & 
                  species_code < 99991) %>% # groups greater than 99991 are empty shells, empty barnacles
  dplyr::mutate(group0 = dplyr::case_when(
    species_code >= 66000 & species_code <= 67499 ~ "Crustacea_shrimps",
    species_code >= 60000 & species_code <= 65999 ~ "Crustacea_other crustaceans",
    species_code >= 67500 & species_code <=	67999 ~ "Crustacea_other crustaceans",
    species_code >= 69550	& species_code <= 69999 ~ "Crustacea_other crustaceans",
    species_code >= 71000 & species_code <= 73999 ~ "Mollusca_Gastropoda (snails)",
    species_code >= 74000 & species_code <= 75799 ~ "Mollusca_Pelecypoda (bivalves)",
    species_code >= 78500 & species_code <= 79600 ~ "Mollusca_squids",
    species_code >= 78010 & species_code <= 78499 ~ "Mollusca_octopuses",
    species_code >= 70000	& species_code <= 70999	~ "Mollusca_other mollusks",
    species_code >= 78000 & species_code <=	78009 ~ "Mollusca_other mollusks",
    species_code >= 80000	& species_code <= 82499 ~ "Echinodermata_Asteroidea (sea stars)",
    species_code >= 83000	& species_code <= 83701 ~ "Echinodermata_Ophiuroidea (brittle stars)",
    species_code >= 83800 & species_code <= 83701 ~ "Echinodermata_Ophiuroidea (brittle stars)",
    species_code >= 82500	& species_code <= 82749 ~ "Echinodermata_Echinoidea (sea urchins)",
    species_code >= 85000 & species_code <= 85999 ~ "Echinodermata_Holothuroidea (sea cucumbers)",
    species_code >= 98000	& species_code <= 99909 ~ "Ascidiacea",
    species_code >= 91000 & species_code <=	91999 ~ "Porifera (sponges)",
    species_code >= 40000	& species_code <= 44999 ~ "Coelenterata",
    species_code >= 45000	& species_code <= 59999 ~ "Other",
    species_code >= 92000	& species_code <= 97999 ~ "Other",
    species_code >= 99990 & species_code <=	99992 ~ "Other",
    species_code >= 77011 & species_code <= 77012 ~ "Other",
    species_code == 99987 ~ "Porifera (sponges)",
    TRUE ~ "find my group"))')

table_raw0 <- temp(exp0 = exp0, 
                   maxyr = maxyr, 
                   biomass_by_stratum0 = biomass_by_stratum,
                   catch_haul_cruises_maxyr0 = catch_haul_cruises_maxyr,
                   total_biomass0 = total_biomass, 
                   spp_code_rnge = "species_code >= 40000 & species_code < 99991")

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  
  header <- paste0("Biomass estimates (mt) for major invertebrate taxa collected during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY[i],
                   " shelf bottom trawl survey. Crab data is summarized under other crustateans and discussed in detail in annual crab technical memorandum produced by the shelfish assessment program. ")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  if (haul_cruises_maxyr$SRVY[i] == "EBS"){
    strat <- c("10", "20", "30", "40", "50", "60", "82", "90")
  } else {
    strat <- c("70", "71", "81")
  }
  
  a <- temp1(table_raw0 %>% 
               dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]), 
             strat, 
             total = total_biomass$total[total_biomass$SRVY ==
                                           haul_cruises_maxyr$SRVY[i]])
  table_raw <- a$table_raw
  table_print <- a$table_print
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
  
} 
```

## tab_majortaxa_pchange_

```{r tab_majortaxa_pchange_}

nickname0 <- "tab_majortaxa_pchange_" 
yrs <- nbsyr

for (i in 1:nrow(haul_cruises_maxyr)) {
  if (nrow(haul_cruises_maxyr)>1) {
    subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
    newobj <- ifelse(i==1, TRUE, FALSE)
  }
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  header <- paste0(
    "Total estimated biomass in metric tons (mt) and the percent change between the ",
    compareyr," and ",maxyr," ", 
    haul_cruises_maxyr$SRVY[i], 
    " shelf bottom trawl surveys for predominant fish and invertebrate taxa.")
  
  a<-table_change(dat = cpue_biomass_total %>% 
                    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>%
                    dplyr::rename(y = biomass_mt), 
                  yrs = nbsyr, 
                  maxyr = maxyr, 
                  compareyr = compareyr, 
                  remove_all = TRUE) 
  
  table_raw <- a$table_raw %>% 
    dplyr::select(-"Survey", -starts_with("change_"), -ends_with(as.character(nbsyr[!(nbsyr %in% c(maxyr, compareyr))])))  %>% 
    dplyr::mutate(print_name = gsub(pattern = "smelts (*Osmeridae*) include eulachon, capelin, and rainbow smelt", replacement = "smelts", x = print_name, fixed = TRUE))
  
  temp1 <- table_raw %>% 
    dplyr::filter(taxon == "fish")
  
  temp2 <- table_raw %>% 
    dplyr::filter(taxon == "invert") 
  
  
  if (nrow(temp1)>nrow(temp2)){
    temp2 <- temp2 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))))) 
  } else {
    temp1 <- temp1 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1)))
                       ))
  }
  
  names(temp1) <- paste0(names(temp1), " ")
  
  table_raw <- dplyr::bind_cols(temp1, temp2) %>% 
    dplyr::select(-dplyr::starts_with("taxon"))
  
  
  table_print <- dplyr::bind_cols(temp1, temp2) %>%
    dplyr::mutate(across(starts_with("change"), 
                         formatC, big.mark=",", digits = 1, format = "f")) %>%
    dplyr::mutate(across(starts_with("change"), paste0, "%")) %>%
    dplyr::mutate(across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f")) %>%
    dplyr::mutate(group = stringr::str_to_title(print_name)) %>% 
    dplyr::mutate(dplyr::across(where(is.character), gsub, pattern = "NA%", replacement = "")) %>% 
    dplyr::mutate(dplyr::across(where(is.character), gsub, pattern = "NA", replacement = ""))
  
  
  if (TRUE) { # remove_all
    table_print$group <- gsub(pattern = "All ", replacement = "", 
                              x = table_print$group, fixed = TRUE)
  }
  
  table_print <- table_print %>% 
    dplyr::mutate(spp = dplyr::case_when(
      grepl(pattern = "sp.", x = species_name1, fixed = TRUE) ~ "sp.", 
      grepl(pattern = "spp.", x = species_name1, fixed = TRUE) ~ "spp.", 
      TRUE ~ "")) %>%
    dplyr::mutate(
      species_name = species_name1, 
      species_name1 = 
        gsub(pattern = " sp.", replacement = "", 
             x = species_name1, fixed = TRUE), 
      species_name1 =
        gsub(pattern = " spp.", replacement = "",
             x = species_name1, fixed = TRUE),
      species_name2 = dplyr::case_when(
        !grepl(pattern = " ", x = species_name, fixed = TRUE) ~ species_name1), 
      species_name1 = dplyr::case_when(
        grepl(pattern = " ", x = species_name, fixed = TRUE) ~ species_name1)) %>% 
    dplyr::rename("Fish taxon" = "print_name ", 
                  "Invertebrate taxon" = "print_name") %>% 
    dplyr::select(dplyr::all_of(c("Fish taxon", paste0(maxyr, " "), paste0(compareyr, " "), "change ",
                                  "Invertebrate taxon", maxyr, compareyr, "change")))
  table_print <- table_print %>%
    flextable::flextable(data = ., 
                         col_keys = c(ifelse(length(unique(table_print$SRVY)) == 1, 
                                             "", "Survey"), 
                                      "Fish taxon", 
                                      paste0(yrs, " "), "change ", 
                                      "Invertebrate taxon", 
                                      as.character(yrs), "change")) %>%
    flextable::color(color = "red", # https://stackoverflow.com/questions/57474647/italic-and-color-in-an-r-flextable
                     i = grepl(pattern = "-", x = as.character(table_print$change)), 
                     j = "change") %>% 
    flextable::color(color = "red", 
                     i = grepl(pattern = "-", x = as.character(table_print[, "change "])), 
                     j = "change ") %>% 
    flextable::width(x = ., j = "Fish taxon", width = 3) %>% 
    flextable::width(x = ., j = "Invertebrate taxon", width = 3) %>% 
    flextable::width(x = ., j = "change ", width = 1) %>% 
    flextable::width(x = ., j = "change", width = 1) %>% 
    flextable::set_header_labels(.,
                                 "change " = paste0("Change (", maxyr, ", ", compareyr, ")" ), 
                                 change = paste0("Change (", maxyr, ", ", compareyr, ")" )) %>% 
    NMFSReports::theme_flextable_nmfstm(x = ., 
                                        font0 = font0, 
                                        pad = 0, 
                                        row_lines = FALSE, 
                                        pgwidth = full_page_landscape_width) %>% 
    flextable::vline(x = ., part = "all", j = "change ") %>%
    flextable::align(x = ., j = c(paste0(maxyr, " "), paste0(compareyr, " "), "change ",
                                  maxyr, compareyr, "change"), 
                     align = "right", part = "all") %>% 
    flextable::padding(x = ., j = "change ", padding.right = 5, part = "all") %>% 
    flextable::padding(x = ., j = "Invertebrate taxon", padding.left = 5, part = "all")
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
}
```

## tab_estimates_maxyr_spp_

```{r tab_estimates_maxyr_spp_}
nickname0 <- paste0("tab_estimates_maxyr_spp_") 

temp <- biomass %>% 
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(species_code, SRVY, 
                meanwgtcpue, sdcpuewt, 
                biomass, sdbio, upperb, lowerb, 
                meannumcpue, sdcpuenum, 
                population, sdpop, upperp, lowerp, 
                # haulcount, 
                catcount, numcount, lencount) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(species_code, print_name, order, taxon), 
    by = "species_code") %>% 
  dplyr::filter(taxon == "fish" &
                  (catcount != 0 & numcount != 0 & lencount != 0) & # if there were none in that survey, don't include
                  order > 0) %>% 
  dplyr::arrange(order) %>% 
  dplyr::select(-species_code, -order, -taxon) %>% 
  dplyr::relocate(print_name)

# for (i in 1:2) {
#   subobj <- ifelse(i==1, TRUE, FALSE)
#   newobj <- ifelse(i==1, TRUE, FALSE)

type <- c("wt", "num")
for (i in 1:2) {
  subobj <- TRUE # ifelse(i==1, TRUE, FALSE)
  newobj <- ifelse(i==1, TRUE, FALSE)
  
  nickname <- paste0(nickname0, type[i]) 
  
  if (i == 1){ # CPUE (WT/HA) and BIOMASS
    
    header <- paste0("Mean CPUE by weight (kg/ha) with standard deviation, and estimated biomass (mt) with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for other common groundfish species for the ",
                     maxyr," ", NMFSReports::text_list(paste0(SRVY1), 
                     # NMFSReports::text_list(paste0( 
                     #   haul_cruises_maxyr$SRVY, " (",
                     #   haul_cruises_maxyr$stations_completed,
                     #   " stations completed)")),
                     " shelf bottom trawl survey."))
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    meanwgtcpue, sdcpuewt, 
                    biomass, sdbio, lowerb, upperb, 
                    # haulcount, 
                    catcount, numcount, lencount) 
    
    table_print <- table_raw %>% 
      dplyr::mutate(meanwgtcpue = formatC(x = meanwgtcpue, 
                                          digits = 2, 
                                          format = "f", big.mark = ","),
                    sdcpuewt = formatC(x = sdcpuewt, 
                                       digits = 2, 
                                       format = "f", big.mark = ","), 
                    biomass = formatC(x = biomass, 
                                      digits = 0, 
                                      format = "f", big.mark = ",") , 
                    upperb = formatC(x = upperb, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    lowerb = formatC(x = lowerb, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    sdbio = formatC(x = sdbio, 
                                    digits = 0, 
                                    format = "f", big.mark = ","))
    
    if (SRVY == "NEBS"){
      table_print <- table_print %>% 
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          SRVY = "Shelf area", 
          meanwgtcpue = paste0("Mean CPUE (kg/ha)"), 
          sdcpuewt = paste0("SD CPUE"), 
          biomass = paste0("Estimated\nBiomass"), 
          sdbio = paste0("SD Biomass"), 
          lowerb = paste0("95% LCL"), 
          upperb = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    } else {
      table_print <- table_print %>% 
        dplyr::select(-SRVY) %>%
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          # SRVY = "Shelf area", 
          meanwgtcpue = paste0("Mean CPUE (kg/ha)"), 
          sdcpuewt = paste0("SD CPUE"), 
          biomass = paste0("Estimated\nBiomass"), 
          sdbio = paste0("SD Biomass"), 
          lowerb = paste0("95% LCL"), 
          upperb = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    } 
    
  } else { # CPUE No/HA and POPULATION
    
    header <- paste0("Mean CPUE by number (no./ha) with standard deviation, and estimated population with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for other common groundfish species for the ", 
                     maxyr," ",
                     NMFSReports::text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                                   " shelf (", 
                                                   haul_cruises_maxyr$SRVY, "; ",
                                                   haul_cruises_maxyr$stations_completed,
                                                   " stations completed)")),
                     " trawl surveys.")
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    meannumcpue, sdcpuenum, 
                    population, sdpop, lowerp, upperp, 
                    # haulcount, 
                    catcount, numcount, lencount)
    
    # population0 <- find_units(unit = "", unt = "", dat = table_raw$population)
    # sdpop0 <- find_units(unit = "", unt = "", dat = table_raw$sdpop)
    
    table_print <- table_raw %>% 
      dplyr::mutate(meannumcpue = formatC(x = meannumcpue, 
                                          digits = 2, 
                                          format = "f", big.mark = ","),
                    sdcpuenum = formatC(x = sdcpuenum, 
                                        digits = 2, 
                                        format = "f", big.mark = ","), 
                    population = formatC(x = population, 
                                         digits = 0, 
                                         format = "f", big.mark = ",") , 
                    upperp = formatC(x = upperp, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    lowerp = formatC(x = lowerp, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    sdpop = formatC(x = sdpop, 
                                    digits = 0, 
                                    format = "f", big.mark = ","))
    
    if (SRVY == "EBS") {
      table_print <- table_print %>% 
        dplyr::select(-SRVY) %>%
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          # SRVY = "Shelf area", 
          meannumcpue = paste0("Mean CPUE (no/ha)"), 
          sdcpuenum = paste0("SD CPUE"), 
          population = paste0("Estimated\nPopulation"), 
          sdpop = paste0("SD Population"), 
          lowerp = paste0("95% LCL"), 
          upperp = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    } else {
      table_print <- table_print %>% 
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          SRVY = "Shelf area", 
          meannumcpue = paste0("Mean CPUE (no/ha)"), 
          sdcpuenum = paste0("SD CPUE"), 
          population = paste0("Estimated\nPopulation"), 
          sdpop = paste0("SD Population"), 
          lowerp = paste0("95% LCL"), 
          upperp = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    }
  }
  
  
  table_print <- table_print %>% 
    flextable::width(x = ., j = "print_name", width = 3) %>%
    # flextable::width(x = ., j = "SRVY", width = 0.5) %>%
    flextable::merge_v(x = ., target = "print_name", 
                       j = "print_name", part = "body") %>% 
    flextable::valign(valign = "top") %>%  
    NMFSReports::theme_flextable_nmfstm(x = ., 
                                        font0 = font0, 
                                        pad = 0, 
                                        row_lines = TRUE, 
                                        pgwidth = full_page_landscape_width) %>%
    flextable::align(x = ., align = "right", part = "all") %>%
    flextable::align(x = ., j = c("print_name"), #, "SRVY"
                     align = "left", part = "all") #%>%
  # flextable::hline(x = ., i = 1, part = "header")
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
    quiet = TRUE
  )
  
  list_tables[nickname][[1]]$res <- res
}
```
