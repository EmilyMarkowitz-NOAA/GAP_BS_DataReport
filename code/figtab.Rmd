---
output:
  officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```


## fig-temperature-[st/bt]

```{r fig-temperature-[st/bt]}
for (iii in c(1:2)) {
  
    nickname0 <- "fig-temperature-"
  if (iii == 1) { # report_title0 == "pres"
    height <- 8
    width <- full_page_portrait_width
    yrs <- nbsyr
    row0 <- 2
    reg_dat0 <- report_types$NEBS$reg_dat
    case_yr <- 1
  } else {
    height <- full_page_portrait_height
    width <- full_page_portrait_width
    yrs0 <- (maxyr-17):maxyr
    row0 <- 3
    case_yr <- 1:2
  }
  reg_dat0 <- report_types$NEBS$reg_dat
  
  for (case in c("bottom", "surface")) {
    for (case_yr in case_yr0) {
      
      if (case_yr == 1) {
        yrs <- yrs0[1:(length(yrs0)/2)]
      } else if (case_yr == 2) {
        yrs <- yrs0[((length(yrs0)/2)+1):length(yrs0)]
      }
      
      if (case == "surface") {
        raster_nebs <- terra::rast(coldpool::nbs_ebs_surface_temperature)
        raster_ebs <- terra::rast(coldpool::ebs_surface_temperature)
        colorbar_breaks <- c(-Inf, seq(-1, 8, 1), Inf)
      } else if (case == "bottom") {
        raster_nebs <- terra::rast(coldpool::nbs_ebs_bottom_temperature)
        raster_ebs <- terra::rast(coldpool::ebs_bottom_temperature)
        # colorbar_breaks <- c(-Inf, -1, 0, 1, seq(2, 8, 2), Inf)
        colorbar_breaks <- c(-Inf, seq(-1, 8, 1), Inf)
      }
      
      header <- paste0(stringr::str_to_title(case)," temperatures (°C) during the ", 
                       range_text(yrs), " ", 
                       SURVEY, " shelf bottom trawl survey",
                       ifelse(SRVY=="NEBS", "s", ""),
                       ". Years in which the mean ", case, 
                       " temperature is 1 or more standard deviations above or below the time-series mean ", case, 
                       " temperature are denoted with '+' and '-' in the upper right-hand corner of each subplot, respectively. ")
      
      nickname <- paste0(nickname0, ifelse(case=="bottom", "bt", "st"), 
                         ifelse(iii == 2, "", paste0("-", case_yr)))
      
      # Create figure
      key.title = ifelse(case == "bottom", 
                         expression(bold("Bottom temperature (°C)")), 
                         expression(bold("Surface temperature (°C)")))
      reg_dat = reg_dat0
      title0 = paste0("Eastern", ifelse(SRVY == "NEBS", " and northern", ""), 
                      " Bering Sea\n", 
                      case, " temperature (", range_text(yrs), ")") 
      
      # yrs_nbs <- unlist(c(yrs, nbsyr)[duplicated(c(yrs, nbsyr))])
      
      figure <- plot_temperature_facet(
        raster_nebs = raster_nebs, 
        raster_ebs = raster_ebs, 
        colorbar_breaks = colorbar_breaks, 
        yrs = yrs, 
        yrs_nbs = nbsyr[nbsyr %in% names(raster_nebs)], # in case data isn't ready yet at time of run 
        key.title = key.title, 
        reg_dat = reg_dat0, 
        row0 = row0, 
        title0 = title0, 
        temperature_zscore = TRUE) 
      
      res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
    }
  }
}
```
