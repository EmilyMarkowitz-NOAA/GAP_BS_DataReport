---
output: officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

# Introduction

## fig-sampled-survey-stations

```{r fig-sampled-survey-stations}
nickname <- "fig-sampled-survey-stations"
header <- paste0(
  "Stratification scheme used for data analysis of the ", maxyr," ",
                 SURVEY, " shelf bottom trawl survey", plural_surveys, 
                 ". The map also depicts the stations sampled by the ",
                 text_list(paste0(vessel_info$vessel_ital, " (",
                                  vessel_info$vess_shape, ")")), 
                 ifelse(crab_resample == TRUE, " and where Bristol Bay crab resampling was conducted", ""), ". ")

height <- ifelse(SRVY == "NEBS", full_page_portrait_height, 6) # height <- 6
width <- full_page_portrait_width # width <- 6.5

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- 
  dplyr::left_join(x = reg_dat0$survey.grid, 
                   y = dplyr::left_join(x = haul_maxyr, 
                                        y = vessel_info) %>% 
                     dplyr::select(stationid, vessel_name, vess_shape) %>%
                     dplyr::mutate(vess_col = dplyr::case_when(
                       (vess_shape == vessel_info$vess_shape[1]) ~ nmfspalette::nmfs_cols("dkgray"), 
                       (vess_shape == vessel_info$vess_shape[2]) ~ nmfspalette::nmfs_cols("supdkgray"))) %>% 
                     dplyr::rename(STATIONID = stationid), 
                   by = ("STATIONID"))

if (crab_resample == TRUE){
  reg_dat0$survey.grid <- dplyr::left_join(
    x = reg_dat0$survey.grid, 
    y = haul_maxyr_crabretow %>% 
      dplyr::mutate(study = "crab_resample", 
                    study_col = nmfspalette::nmfs_cols("medgray"),
                    study = "crab_resample", 
                    study_long = "Red King Crab\nResample") %>% 
      dplyr::select(stationid, study, study_col, study_long) %>%
      dplyr::rename(STATIONID = stationid) %>% 
      unique(), 
    by = ("STATIONID")) 
}

figure <- plot_survey_stations(
  reg_dat = reg_dat0, 
  station_info, 
  haul_cruises_maxyr, 
  station_grid = FALSE, 
  stratum_no = TRUE, 
  bathymetry = FALSE, 
  station_pts_srvy = FALSE, 
  station_pts_vess = TRUE, 
  study = crab_resample) # defined in data.r

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## fig-sample-grid

```{r fig-sample-grid}
header <- paste0("Sampling grid and station identifiers for the ",maxyr," ",
                 SURVEY, " shelf bottom trawl survey", plural_surveys,
                 ". ", ifelse(SRVY == "NBS", "", "Corner stations (denoted by circles) are not labeled for legibility. "))
nickname <- "fig-sample-grid"
subobj <- FALSE

height <- ifelse(SRVY == "NEBS", full_page_portrait_height, 6) # height <- 6
width <- full_page_portrait_width # width <- 6.5

reg_dat0 <- reg_dat
reg_dat0$survey.grid <- reg_dat0$survey.grid %>% 
  dplyr::mutate(STATIONID = ifelse(!grepl(pattern = "-", x = STATIONID), "", STATIONID))
reg_dat0$place.labels <- reg_dat0$place.labels %>% 
  dplyr::filter(type %in% c("mainland", "peninsula"))

figure <- plot_survey_stations(reg_dat = reg_dat0, 
                               station_info = station_info, 
                               haul_cruises_maxyr = haul_cruises_maxyr, 
                               station_grid = TRUE, 
                               stratum_no = FALSE, 
                               station_pts_srvy = FALSE, 
                               place_labels = TRUE)

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

# Methods

## fig-vessels

```{r fig-vessels}
header <- paste0(
  "Fishing vessels ",
                 text_list(paste0(vessel_info$vessel_ital, 
                                  " (", c("left", "right"), ")")),
                 " contracted to conduct the ",maxyr," ",
                 SURVEY, " shelf bottom trawl survey", plural_surveys)
nickname <- "fig-vessels"

height <- 2.5
width <- full_page_portrait_width # width <- 6.5

# Select data and make plot
p1 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, vessel_info$img[1])), 
                      scale = 0.9 )

p2 <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, vessel_info$img[2])), 
                      scale = 0.9 )

figure <- cowplot::plot_grid(p1, p2,  
                             ncol = 2, rel_heights = c(0.1, 1))

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## fig-trawl-gear

```{r fig-trawl-gear}
header <- paste0(
  "Schematic diagram of the 83-112 eastern otter trawl gear used during the ", 
  maxyr ," ", 
  SURVEY, " shelf bottom trawl survey", plural_surveys, ".")
footnote<- NA
nickname <- "fig-trawl-gear"
alttext <- paste0(header)
height = 8
width <- full_page_portrait_width # width <- 6.5

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, "EASTERN83-112.png")) )

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## tab-stratum-areas

```{r tab-stratum-areas}
header <- paste0(
  "Stratum areas and sampling densities used during the ",maxyr, " ", 
  SURVEY, " shelf bottom trawl survey", plural_surveys,
  ". Stratum area calculations were updated in ", 
  stratum_info$year[1] , ". ")

nickname <- "tab-stratum-areas" 

temp <- stratum_info %>% 
  dplyr::select(area, stations_completed, stratum, type, SRVY) 

if (length(unique(station_info$SRVY))>1) {
  totals_sub <- stratum_info %>%
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(
      area = sum(area, na.rm = TRUE),
      stations_completed = sum(stations_completed, na.rm = TRUE)) %>%
    dplyr::mutate(stratum = "") %>%
    dplyr::mutate(type = "Total") %>% 
    dplyr::relocate(names(temp))
}

totals <- stratum_info %>% 
  dplyr::summarise(area = sum(area, na.rm = TRUE), 
                   stations_completed = sum(stations_completed, na.rm = TRUE)) %>% 
  dplyr::mutate(stratum = "") %>% 
  dplyr::mutate(type = "Total") %>% 
  dplyr::mutate(SRVY = text_list(SRVY1)) %>% 
  dplyr::relocate(names(temp))

table_raw <- 
  rbind.data.frame(temp, 
                   if(exists("totals_sub")){totals_sub}, 
                   totals) %>% 
  dplyr::mutate(density = round(area/stations_completed, 0)) %>% 
  dplyr::mutate(area = round(area, 0)) %>% 
  dplyr::mutate(Region = paste0(SRVY, " ", type)) %>% 
  dplyr::mutate(order = dplyr::case_when(
    Region == "EBS Inner Shelf" ~ 1,
    Region == "EBS Middle Shelf" ~ 2,
    Region == "EBS Outer Shelf" ~ 3,
    Region == "EBS Total" ~ 4,
    Region == "NBS Shelf" ~ 5,
    Region == "NBS Total" ~ 6,
    Region == "EBS and NBS Total" ~ 7
  ))  %>%
  dplyr::arrange(order, stratum) %>% #SRVY, stratum) %>% 
  # dplyr::select(Region, stratum, area, stations_completed, density, -order) %>% 
  dplyr::select(-Region, -order) %>%
  dplyr::relocate(SRVY, type, #Region, 
                  stratum, area, stations_completed, density) %>% 
  dplyr::rename(Region = type)

table_print <- table_raw %>%
  flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL)  %>%
  flextable::as_flextable(font = font0, x = ., hide_grouplabel = TRUE) %>%
  flextable::compose(x = ., i = 1, j = "area", part = "header",
                     value = as_paragraph("Representative\narea (km", as_sup("2"), ")")) %>%
  flextable::compose(x = ., i = 1, j = "density", part = "header",
                     value = as_paragraph("Sampling density\n(km", as_sup("2"), "/Stations successfully sampled)")) %>%  
  flextable::set_header_labels(., 
                               Region = "",
                               stratum = "Stratum",
                               # area = "Representative\narea (km2)",
                               # density = "Sampling density\n(km2/Stations successfully sampled)"
                               stations_completed = "Stations\nsuccessfully sampled") %>% 
  flextable::merge_v(j = "Region") %>%
  flextable::merge_h_range(x = ., 
                           i = ~ stratum == "", 
                           j1 = "Region", 
                           j2 = "stratum", 
                           part = "body") %>%
  flextable::valign(valign = "top") %>%
  theme_flextable_nmfstm(x = ., 
                         row_lines = FALSE, 
                         pad = 0, 
                         font0 = font0, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::align(x = ., j = c("stratum", "area", "stations_completed", "density"), 
                   align = "right", part = "all")  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::padding(x = .,
                     j = 1, i = ~ is.na(SRVY),
                     padding.left = 5)   %>%
  flextable::hline(x = ., i = ~ !is.na(Region), #j = SRVY, #border = fp_border(width = 3), 
                   part = "body")  %>%
  flextable::hline(x = ., i = ~ (Region == "Total"), #j = SRVY, #border = fp_border(width = 3), 
                   part = "body", border = fp_border(width = 2)) 

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## tab-oto-collection-scheme

```{r tab-oto-collection-scheme-[SRVY]}

nickname <- paste0("tab-oto-collection-scheme") 

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                                sheet = "Sheet1", 
                                skip = 1) %>% 
  dplyr::filter(year == maxyr & !is.na(oto_target)) %>% 
  dplyr::select(SRVY, print_name, species_code, oto_target, oto_rules, oto_samp_type) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_name1, order) %>% 
      dplyr::rename(species_name = species_name1) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::arrange(order) %>% 
  dplyr::arrange(oto_samp_type) %>% 
  dplyr::arrange(SRVY) %>% 
  dplyr::select(-order, -species_code) %>% 
  dplyr::relocate(SRVY, print_name, species_name, oto_samp_type, oto_target, oto_rules) %>% 
  dplyr::select(-species_name)

header <- paste0(
  "Otolith collection types and counts during the ", 
                 maxyr, " ", 
                 SURVEY, " shelf bottom trawl survey", plural_surveys, ".")

table_print <- table_raw %>% 
  flextable::as_grouped_data(x = ., groups = c(
    "SRVY", "oto_samp_type"), 
    columns = NULL) %>% 
  flextable::as_flextable(x = ., hide_grouplabel = TRUE) %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(oto_samp_type) ) %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>% 
  flextable::set_header_labels(.,
                               print_name = "Common name", 
                               oto_rules = "Collect when \u2265 n individuals\n caught in each haul",
                               oto_target = "Target collection number per haul") %>%
  theme_flextable_nmfstm(x = ., pad = 0, 
                         font0 = font0, 
                         row_lines = TRUE, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::padding(x = .,
                     j = 1, i = ~ !is.na(oto_samp_type),
                     padding.left = 5) %>%
  flextable::padding(x = .,
                     j = 1, i = ~ (is.na(oto_samp_type) &  is.na(SRVY)),
                     padding.left = 10) %>%
  flextable::width(x = ., j = "oto_rules", width = 1.5, unit = "in") %>%
  flextable::width(x = ., j = "oto_target", width = 3, unit = "in") %>%
  flextable::width(x = ., j = c("print_name"), width = 2) %>% 
  flextable::hline(x = ., i = ~ !is.na(oto_samp_type), 
                   border = fp_border(color = "white"), 
                   part = "body") 

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## tab-stomach-collection-scheme

```{r tab-stomach-collection-scheme}

nickname <- paste0("tab-stomach-collection-scheme") 

header <- paste0(
  "Stomach collection targets during the ", 
  maxyr, " ", 
  SURVEY, " shelf bottom trawl survey", plural_surveys ,".")

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_collection_scheme.xlsx"), 
                                sheet = "Sheet1", 
                                skip = 1) %>% 
  dplyr::filter(year == maxyr & !is.na(stomach_target)) %>% 
  dplyr::select(SRVY, print_name, species_code, stomach_target) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(print_name, species_name1, order) %>% 
      dplyr::rename(species_name = species_name1) %>% 
      dplyr::distinct(), 
    by = "print_name") %>% 
  dplyr::arrange(order) %>% 
  dplyr::arrange(stomach_target) %>% 
  dplyr::arrange(SRVY) %>% 
  dplyr::select(-order, -species_code) %>% 
  dplyr::relocate(SRVY, print_name, species_name, stomach_target) %>% 
  dplyr::mutate(stomach_target = as.character(round(as.numeric(stomach_target), digits = 0))) %>% 
  tidyr::pivot_wider(data = ., id_cols = c("print_name", "species_name"), 
                     names_from = "SRVY", values_from = "stomach_target")

table_raw[is.na(table_raw)] <- "-"

table_print <- flextable::flextable(table_raw %>% 
                                      dplyr::select(-species_name)) %>% 
  flextable::set_header_labels(.,
                               print_name = "Common name", 
                               stomach_target = "Target collection number per survey") %>%
  theme_flextable_nmfstm(x = ., 
                         pad = 0, 
                         font0 = font0, 
                         row_lines = TRUE, 
                         pgwidth = full_page_portrait_width)  %>%
  flextable::align(x = ., j = c(SRVY1), 
                   align = "right", part = "all")   %>%
  flextable::width(x = ., width = (2.5/length(SRVY1)))  %>%
  flextable::width(x = ., j = "print_name", width = 4)  


# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## tab-special-projects

```{r tab-special-projects}
nickname <- "tab-special-projects" 
places <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                             sheet = "affiliations", 
                             skip = 1) 

table_raw <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_special_projects.xlsx"), 
                                sheet = "projects", 
                                skip = 1)  %>% 
  dplyr::filter(!is.na(`Project title`) & 
                  year == maxyr) %>% 
  dplyr::select(SRVY, `Project title`, `Principal investigator`, Agency) %>% 
  dplyr::mutate(SRVY = factor(x = SRVY, 
                              levels = c("EBS & NBS", "EBS", "NBS"), 
                              labels = c("EBS & NBS", "EBS", "NBS"), 
                              ordered = TRUE))%>%
  dplyr::arrange(SRVY, Agency, `Principal investigator`, `Project title`)

header <- paste0(
  "Special projects and collections undertaken during the ",
                 maxyr, " ", 
SURVEY, " shelf bottom trawl survey", plural_surveys,
                 ", sorted by principal investigator and agency.")

# find places
temp0 <- unlist(strsplit(x = table_raw$Agency, split = " & ", fixed = TRUE))
temp0 <- unlist(strsplit(x = temp0, split = ", ", fixed = TRUE))
temp1 <- places[places$Agency %in% 
                  unique(temp0), ]

footnote0 <- paste(paste(temp1$Agency, " - ", temp1$agency_long, sep = ""), collapse = "; ")

table_print <- table_raw %>%
  flextable::as_grouped_data(groups = c("SRVY"), columns = NULL) %>% 
  flextable::as_flextable(., hide_grouplabel = TRUE)  %>% 
  flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
  flextable::width(x = ., j = "Agency", width = 2, unit = "in") %>%
  flextable::width(x = ., j = "Principal investigator", width = 3, unit = "in") %>%
  flextable::width(x = ., j = "Project title", width = 4, unit = "in") %>% 
  flextable::footnote(x = ., 
                      value = as_paragraph(footnote0), 
                      ref_symbols = "1",
                      part = "header", 
                      j = "Agency", i = 1)  %>%
  theme_flextable_nmfstm(x = ., 
                         font0 = font0, 
                         pad = 0, 
                         row_lines = TRUE, 
                         pgwidth = full_page_portrait_width) %>% 
  flextable::padding(x = .,
                     j = 1, i = ~ is.na(SRVY),
                     padding.left = 5) %>% 
  flextable::hline(x = ., i = ~ !is.na(SRVY), 
                   border = fp_border(color = "white"), 
                   part = "body")

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

# Results

## fig-mean-temperature

```{r fig-mean-temperature}

# code orig from sean rohan's coldpool package! Jan 23 2021 

nickname <- "fig-mean-temperature"
header <- paste0("Average summer surface and bottom and time-series average surface and bottom (dashed lines) temperatures (°C) on the eastern Bering Sea shelf, based on data collected during standardized summer bottom trawl surveys from 1982–", maxyr,
                 ifelse(SRVY == "NEBS", 
                        paste0(" (left), and northern Bering Sea shelf (right) based on data collected during standardized summer bottom trawl survey", plural_surveys), ""), 
                 ". ")

height <- 3.25
width <- full_page_portrait_width # 6.5

a <- plot_mean_temperatures(maxyr, SRVY)
for (jjj in 1:length(a)) { assign(names(a)[jjj], a[[jjj]]) }

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## fig-cold-pool-area

```{r fig-cold-pool-area}
header <- paste0("Annual summer cold pool extent on the eastern Bering Sea shelf, based on observations from the eastern Bering Sea bottom trawl survey. The extent of the cold pool is shown as a percentage of the total southern eastern Bering Sea shelf survey area. Shading denotes near-bottom temperatures \u2264 2°C, \u2264 1°C, \u2264 0°C, and \u2264 -1°C.")

footnote <- "Areas were summarized from areas in inverse distance weighted rasters."
nickname <- "fig-cold-pool-area"

height <- 3
width <- full_page_portrait_width # 6.5

figure <- plot_coldpool_area(coldpool_ebs_bin_area = coldpool_ebs_bin_area, maxyr = maxyr)

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```

## fig-temperature-[SRVY]-[st/bt]

```{r fig-temperature-[SRVY]-[st/bt]}

height <- full_page_portrait_height
width <- full_page_portrait_width
yrs0 <- (maxyr-17):maxyr 
row0 <- 3
reg_dat0 <- report_types$NEBS$reg_dat

for (case in c("bottom", "surface")) {
  
  for (case_yr in c(1,2)) {
    
    if (case_yr == 1) {
      yrs <- yrs0[1:(length(yrs0)/2)]
    } else if (case_yr == 2) {
      yrs <- yrs0[((length(yrs0)/2)+1):length(yrs0)]
    }
    
    if (case == "surface") {
      
      nbs_no_2018 <- raster::subset(coldpool::nbs_ebs_surface_temperature, 
                                    subset = names(coldpool::nbs_ebs_surface_temperature)[!grepl(
                                      x = names(coldpool::nbs_ebs_surface_temperature),
                                      pattern = 2018)]) %>%
        raster::projectRaster(crs = crs(coldpool::nbs_ebs_surface_temperature))
      
      sebs_only <- names(coldpool::ebs_surface_temperature)[
        which(!(names(coldpool::ebs_surface_temperature) %in% 
                  paste0("s", names(nbs_no_2018))))]
      
      sebs_temp <- raster::subset(coldpool::ebs_surface_temperature,
                                  subset = sebs_only) %>%
        raster::projectRaster(raster::projectExtent(nbs_no_2018, crs = out.crs))
      
      
      rasterbrick <- raster::addLayer(sebs_temp, nbs_no_2018)
      
    } else if (case == "bottom") {
      
      nbs_no_2018 <- raster::subset(coldpool::nbs_ebs_bottom_temperature, 
                                    subset = names(coldpool::nbs_ebs_bottom_temperature)[!grepl(
                                      x = names(coldpool::nbs_ebs_bottom_temperature),
                                      pattern = 2018)])  %>%
        raster::projectRaster(crs = crs(coldpool::nbs_ebs_bottom_temperature))
      
      sebs_only <- names(coldpool::ebs_bottom_temperature)[
        which(!(names(coldpool::ebs_bottom_temperature) %in% 
                  paste0("s", names(nbs_no_2018))))]
      
      sebs_temp <- raster::subset(coldpool::ebs_bottom_temperature,
                                  subset = sebs_only) %>%
        raster::projectRaster(raster::projectExtent(nbs_no_2018, crs = out.crs))
      
      rasterbrick <- raster::addLayer(sebs_temp, 
                                      nbs_no_2018)
    }
    
    temperature_zscore <- coldpool::cold_pool_index %>% 
      dplyr::rename(var = dplyr::all_of(ifelse(case == "bottom", "MEAN_GEAR_TEMPERATURE", "MEAN_SURFACE_TEMPERATURE")), 
                    year = YEAR) %>%
      dplyr::select(year, var) %>% 
      dplyr::filter(year <= maxyr) %>%
      dplyr::arrange(var) %>% 
      dplyr::mutate(
        sd = sd(var, na.rm = TRUE), 
        mean = mean(var, na.rm = TRUE), 
        zscore  = ((var-mean)/sd), # z = (x-μ)/σ
        sign = dplyr::case_when(
          zscore <= -1 ~ "-", 
          zscore >= 1 ~ "+"), 
        color = dplyr::case_when(
          sign == "+" ~ "#d8b365", 
          sign == "-" ~ "#5ab4ac")) %>% 
      dplyr::arrange(year) %>% 
      dplyr::filter(year %in% yrs) 
    
    
    
    a_name <- names(rasterbrick)[length(names(rasterbrick))-1]
    a <- raster::subset(x = rasterbrick,
                        subset = a_name)
    
    names(a) <- gsub(pattern = gsub("[^0-9.-]", "", names(a)), 
                     replacement = "2020", 
                     x = names(a))
    a@data@values <- rep_len(x = NA, length.out = length(a@data@values))
    a@data@max <- a@data@min <- NA
    rasterbrick$temp <- a
    names(rasterbrick)[names(rasterbrick) == "temp"] <- a@data@names
    
    header <- paste0(
      stringr::str_to_title(case)," temperatures (°C) during the ", range_text(yrs), " ", 
                     SURVEY, " shelf bottom trawl survey", plural_surveys,
                     ". Years in which the mean ", case, 
                     " temperature is 1 or more standard deviations above or below the time-series mean ", case, 
                     " temperature are denoted with '+' and '-' in the upper right-hand corner of each subplot, respectively. ")
    
    # Remove non-numeric characters from layer names for subsetting
    names(rasterbrick) <- gsub("[^0-9.-]", "", names(rasterbrick))
    
    # Subset layers for the selected years
    rasterbrick <- raster::subset(rasterbrick, subset = paste0("X", yrs))
    
    nickname <- paste0("fig-temperature-", ifelse(case=="bottom", "bt", "st"), "-", case_yr)
    
    # Create figure
    key.title = ifelse(case == "bottom", 
                       expression(bold("Bottom temperature (°C)")), 
                       expression(bold("Surface temperature (°C)")))
    reg_dat = reg_dat0
    title0 = paste0("Eastern", ifelse(SRVY == "NEBS", " and northern", ""), 
                    " Bering Sea\n", 
                    case, " temperature (", range_text(yrs), ")") 
    
    figure <- plot_temperature_facet(
      rasterbrick = rasterbrick, 
      key.title = key.title, 
      reg_dat = reg_dat0, 
      row0 = row0, 
      title0 = title0, 
      temperature_zscore = temperature_zscore) 
    
    # Save figure
    res <- knitr::knit_child(
      text = knitr::knit_expand(
        file = paste0(dir_code, "_child_save_figtab.Rmd")),
      quiet = TRUE)
  }
}

```

## tab-specimen-samples

```{r tab-specimen-samples-}
nickname0 <- paste0("tab-specimen-samples-") 

# length data - from oracle
l <- length_maxyr %>% 
  dplyr::select(SRVY, species_code, frequency) %>% # common_name, 
  # dplyr::mutate(common_name = gsub(pattern = " (juvenile)", replacement = "", x = common_name, fixed = TRUE)) %>% 
  dplyr::group_by(SRVY, species_code) %>% 
  dplyr::summarise(length = sum(frequency, na.rm = TRUE)) %>% 
  dplyr::ungroup() 

# age oto data - from oracle
a <- specimen_maxyr %>% 
  dplyr::filter(!is.na(species_code) & specimen_sample_type == 1) %>%
  dplyr::select("SRVY", species_code) %>% 
  dplyr::group_by("SRVY" = SRVY, species_code) %>% 
  # also specimen_sample_type? 1 = otoliths, 
  # specimen_subsample_method 1=random, 2 = stratified?
  dplyr::summarise(age = as.numeric(n())) %>% 
  dplyr::ungroup()

# other collections not in oracle
temp <- readxl::read_excel(path = paste0(dir_out_rawdata, "/0_other_field_collections.xlsx"), 
                           sheet = "Sheet1", 
                           skip = 1) %>%
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(SRVY, print_name, dplyr::starts_with("count_")) %>% 
  dplyr::select(where(~sum(!is.na(.x)) > 0)) 
names(temp) <- gsub(pattern = "count_", replacement = "", x = names(temp))

# Combine
table_raw0 <- 
  dplyr::full_join(x = l, y = a, 
                   by = c("SRVY", "species_code")) %>% 
  dplyr::left_join(x = ., 
                   y = spp_info %>% 
                     dplyr::mutate(
                       common_name = gsub(pattern = " (juvenile)", replacement = "", x = common_name, fixed = TRUE), 
                       common_name = dplyr::case_when(
                         is.na(common_name) ~ report_name_scientific, 
                         common_name == "shorthorn (=warty) sculpin" ~ "shorthorn sculpin", 
                         TRUE ~ common_name)) %>% 
                     dplyr::select(species_code, common_name), 
                   by = "species_code") %>% 
  dplyr::group_by(SRVY, common_name) %>% 
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
  dplyr::ungroup() %>% 
  dplyr::full_join(x = ., 
                   y = temp, 
                   by = c("SRVY", "common_name" = "print_name")) %>% 
  dplyr::mutate(dplyr::across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
  dplyr::select(-species_code) %>% 
  dplyr::arrange(SRVY, common_name) %>% 
  dplyr::filter(!grepl(pattern = " crab", x = common_name, ignore.case = TRUE))

table_raw0$common_name[is.na(table_raw0$common_name)] <- "other" # TOLEDO

table_raw0 <- 
  dplyr::bind_rows(table_raw0, 
                   table_raw0 %>% 
                     dplyr::group_by(SRVY) %>% 
                     dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>% 
                     dplyr::mutate(common_name = "Total") ) %>% 
  dplyr::relocate(SRVY, common_name, length, age) %>% 
  dplyr::rename("length_measurements" = length,
                "otolith_age_structure_samples" = age) #%>%
# data.frame()

for (i in 1:nrow(haul_cruises_maxyr)) {
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  header <- paste0("Biological data collected during the ", maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey. The annual crab technical memorandum produced by the shellfish assessment program summarizes crab samples collected during the survey. ")
  
  table_raw <- table_raw0 %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    dplyr::select(where(~ any(. != 0)))
  
  names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))] <- 
    stringr::str_to_sentence(names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))])
  
  names(table_raw)[!(names(table_raw) %in% c("SRVY", "common_name"))] <- 
    (gsub(pattern = "_",
          replacement = "\n", 
          x = names(table_raw)[!(names(table_raw) %in% 
                                   c("SRVY", "common_name"))], 
          fixed = TRUE))
  names(table_raw)[names(table_raw) == "Otolith\nage\nstructure\nsamples"] <- 
    "Otolith age\nstructure samples"
  names(table_raw)[names(table_raw) == "Pathobiology\nblood\nsamples"] <- 
    "Pathobiology\nblood samples"
  
  
  table_print <- table_raw %>% 
    dplyr::mutate(across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f")) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    dplyr::select(-"SRVY") 
  
  table_print[is.na(table_print) | table_print == "0"] <- "-"
  
  
  table_print <- table_print %>% 
    flextable::flextable(data = .) %>%
    flextable::set_header_labels(x = .,
                                 common_name = haul_cruises_maxyr$SRVY[i]#,
                                 # Length = "Length\nmeasurements",
                                 # Age = "Age structure (otolith)\nmeasurements"
    ) %>% 
    flextable::bold(x = ., i = which(table_print$common_name == "Total")) %>%
    # flextable::merge_v(j = "SRVY") %>%
    flextable::valign(valign = "top") %>%
    theme_flextable_nmfstm(x = ., 
                           pad = 0, 
                           spacing = 0.4,
                           font0 = font0, 
                           pgwidth = full_page_portrait_width) %>%
    flextable::align(x = ., j = 2:ncol(table_print), 
                     align = "right", part = "all")  %>%
    # flextable::width(x = ., width = 1.5, unit = "in")   %>%
    flextable::width(x = ., width = (5/(ncol(table_raw)-2)), unit = "in") %>%
    flextable::width(x = ., j = "common_name", width = 1.5, unit = "in")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
}

```

## tab-species-composition

```{r tab-species-composition}

if (SRVY == "NEBS"){
  
  nickname <- "tab-species-composition" 
  header <- paste0("Composition of fish taxa encountered in the catches of the ",
                   SURVEY, " shelf bottom trawl survey", plural_surveys, ". ")
  
  height <- full_page_portrait_height # 7
  width <- full_page_portrait_width # 6.5
  
  # Select data and make plot
  table_raw <- catch_haul_cruises_maxyr %>% 
    dplyr::select(species_code, SRVY, 
                  "SRVY", start_latitude) %>% 
    dplyr::group_by(species_code, SRVY) %>% 
    dplyr::summarise(lat_max = max(start_latitude, na.rm = TRUE),
                     lat_min = min(start_latitude, na.rm = TRUE)) %>%
    dplyr::mutate(above_60 = (lat_max >= 60 & lat_min >= 60)) %>%
    tidyr::pivot_wider(data = ., 
                       id_cols = species_code, 
                       names_from = SRVY, 
                       values_from = c(above_60),#, lat_min, lat_max), 
                       values_fill = NA) %>% 
    dplyr::mutate(where = dplyr::case_when(
      !is.na(EBS) & !is.na(NBS) ~ "both", 
      is.na(NBS) & !is.na(EBS)~ "ebs", 
      is.na(EBS) & !is.na(NBS) ~ "nbs")) %>% 
    dplyr::left_join(x = ., 
                     y = spp_info, #%>% 
                     # dplyr::rename(common_name = print_name), 
                     by = "species_code") %>% 
    dplyr::filter(taxon == "fish") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(species_code, common_name, report_name_scientific, all_of(SRVY1), where) %>% 
    dplyr::filter(!grepl(x = common_name, pattern = " unid.", fixed = TRUE)) %>%
    dplyr::filter(!grepl(x = common_name, pattern = " egg", fixed = TRUE)) %>%
    dplyr::filter(!is.na(common_name)) %>%
    dplyr::arrange(common_name)
  
  temp <- table_raw %>% 
    dplyr::select(-species_code)
  
  temp1 <- temp %>% 
    dplyr::filter(where == "ebs" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -NBS) %>% 
    dplyr::rename(above_60 = EBS)
  
  temp2 <- temp %>% 
    dplyr::filter(where == "nbs" & 
                    !is.na(common_name)) %>% 
    dplyr::select(-where, -EBS) %>% 
    dplyr::rename(above_60 = NBS)
  
  # make the same length so they can be bound together
  if (nrow(temp1)>nrow(temp2)) {
    temp2 <- temp2 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  } else {
    temp1 <- temp1 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1))), 
                                  report_name_scientific = NA, 
                                  above_60 = FALSE))
  }
  
  names(temp1) <- paste0(names(temp1), "_")
  
  temp0 <- dplyr::bind_cols(temp1, temp2)
  
  for (iii in 1:nrow(temp0)) {
    if (grepl(pattern = " unid.", x = temp0$report_name_scientific[iii])) {
      temp0$common_name[iii] <- paste0(temp0$common_name[iii], 
                                       " (", temp0$report_name_scientific[iii], ")")
      temp0$report_name_scientific[iii] <- NA
      # } else {
      #   temp0$report_name_scientific[iii] <- paste0(" (", temp0$report_name_scientific[iii], ")")
    }
    if (grepl(pattern = " unid.", x = temp0$report_name_scientific[iii])) {
      temp0$common_name_[iii] <- paste0(temp0$common_name_[iii], 
                                        " (", temp0$report_name_scientific_[iii], ")")
      temp0$report_name_scientific_[iii] <- NA
      #   } else {
      # temp0$report_name_scientific_[iii] <- paste0(" (", temp0$report_name_scientific_[iii], ")")
    }
  }
  
  table_print <- flextable::flextable(
    data = temp0,
    col_keys = c("dummy_ebs","dummy_nbs"))  %>%
    flextable::compose(j = "dummy_ebs", part = "body",
                       value = as_paragraph(
                         as_chunk(ifelse(!is.na(common_name_), 
                                         paste0(common_name_), ""),
                                  props = fp_text_default(bold = FALSE, font.size = 10, font.family = font0)), 
                         as_chunk(ifelse(!is.na(report_name_scientific_), 
                                         paste0(" (", report_name_scientific_, ")"), ""),
                                  props = fp_text_default(italic = TRUE, font.size = 10, font.family = font0)))) %>%  
    flextable::compose(j = "dummy_nbs", part = "body",
                       value = as_paragraph(
                         as_chunk(ifelse(!is.na(common_name), 
                                         paste0(common_name), ""),
                                  props = fp_text_default(bold = FALSE, font.size = 10, font.family = font0)), 
                         as_chunk(ifelse(!is.na(report_name_scientific), 
                                         paste0(" (", report_name_scientific, ")"), ""),
                                  props = fp_text_default(italic = TRUE, font.size = 10, font.family = font0)))) %>%  
    flextable::compose(x = ., i = 1, j = "dummy_ebs", part = "header",
                       as_paragraph("Encountered in EBS but not in NBS\nCommon Name ", 
                                    as_chunk(paste0("(Scientific Name)"),
                                             props = fp_text_default(italic = TRUE, bold = TRUE, 
                                                                     font.size = 10, font.family = font0)))) %>%  
    flextable::compose(x = ., i = 1, j = "dummy_nbs", part = "header",
                       as_paragraph("Encountered in NBS but not in EBS\nCommon Name ", 
                                    as_chunk(paste0("(Scientific Name)"),
                                             props = fp_text_default(italic = TRUE, bold = TRUE, 
                                                                     font.size = 10, font.family = font0)))) %>%  
    theme_flextable_nmfstm(x = ., 
                           font0 = font0, 
                           pad = 0, 
                           row_lines = FALSE, 
                           pgwidth = full_page_portrait_width) %>%
    flextable::vline(x = ., j = "dummy_ebs", part = "all") %>%
    flextable::padding(x = ., j = "dummy_nbs", padding.left = 5, part = "all")
  
  # table_print <- temp %>%
  #   dplyr::select(-above_60, -above_60_) %>%
  #   flextable::flextable(data = .) %>%
  #   flextable::italic(x = .,
  #                     j = c(2,4)) %>%
  #   # flextable::bold(x = .,
  #   #                 i = which(temp1$above_60_),
  #   #                 j = 1:2) %>%
  #   # flextable::bold(x = .,
  #   #                 i = which(temp2$above_60),
  #   #                 j = 3:4) %>%
  #   # flextable::footnote(x = ., part = "header", i = 1, j = 1,
  #   #                     value = as_paragraph(footnote0)) %>%
  #   flextable::add_header_row(x = .,
  #                  values = c("Present in EBS but absent in NBS", "Present in NBS but absent in EBS"),
  #                  colwidths = c(2, 2)) %>%
  #   flextable::set_header_labels(.,
  #                                common_name_ = "Common name",
  #                                report_name_scientific_ = "Scientific name",
  #                                common_name = "Common name",
  #                                report_name_scientific = "Scientific name"
  #   ) %>%
  #   theme_flextable_nmfstm(x = ., 
  #                                       font0 = font0, 
  #                                       pad = 0, 
  #                                       row_lines = FALSE, 
  #                                       pgwidth = full_page_portrait_width) %>%
  #   flextable::vline(x = ., j = 2, part = "all") %>% 
  #   flextable::padding(x = ., j = "common_name", padding.left = 5, part = "all")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
}

```

## tab-biomass-est-PREP

```{r tab-biomass-est-PREP}

temp <- function(exp0, 
                 maxyr, 
                 biomass_by_stratum0,
                 catch_haul_cruises_maxyr0,
                 total_biomass0,
                 spp_code_rnge
) {
  
  confint <- function(num_hauls, bio_var) {
    out <- qt(p = 0.025, df = num_hauls - 1, lower.tail = F) * sqrt(bio_var)
    return(out)
  }
  
  # species level --------------------------------------------------------------
  
  # select spp 
  dat <- eval(parse(
    text=gsub(pattern = "DATAFRAME", 
              replacement = "biomass_by_stratum0", 
              x = exp0) )) %>% 
    ungroup() %>% 
    tidyr::separate(
      col = group0, 
      into = c("group", "taxon"), 
      sep = "_", 
      remove = FALSE) %>% 
    dplyr::select(SRVY, strata, group, group0, taxon, biomass_mt, ci, num_hauls, bio_var) %>% 
    dplyr::group_by(SRVY, strata, group, group0, taxon) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE), 
                     num_hauls = sum(num_hauls, na.rm = TRUE), 
                     ci = confint(num_hauls, bio_var)) %>% 
    dplyr::ungroup()
  
  biomass_spp_bystrata <- dat %>%
    dplyr::group_by(SRVY, strata, group, taxon) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     bio_var = sum(bio_var, na.rm = TRUE),
                     num_hauls = mean(num_hauls, na.rm = TRUE)) %>% 
    dplyr::mutate(ci = confint(num_hauls, bio_var))
  
  biomass_spp_999 <- dat %>%
    dplyr::group_by(SRVY, group, taxon) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     bio_var = sum(bio_var, na.rm = TRUE),
                     num_hauls = mean(num_hauls, na.rm = TRUE)) %>%
    dplyr::mutate(
      ci = confint(num_hauls, bio_var), 
      strata = 999)
  
  
  # group level --------------------------------------------------------------
  
  dat0 <- eval(parse(
    text = gsub(pattern = "DATAFRAME",
                replacement = "catch_haul_cruises_maxyr0",
                x = exp0) ))  %>%
    ungroup() %>%
    tidyr::separate(
      col = group0,
      into = c("group", "taxon"),
      sep = "_",
      remove = FALSE) %>%
    dplyr::filter(year == maxyr) %>%
    dplyr::distinct(SRVY, stratum, stationid, group, # not strictly necessary, but helpful
                    hauljoin, species_code) %>%
    dplyr::group_by(SRVY, group) %>%
    dplyr::summarise(num = n()) # the number of hauls the group was caught in for all strata
  
  
  ## find estimated total biomass by stratum for group complexes (e.g., groups with more than one line)
  biomass_group_bystrata <- dat %>%
    dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
    dplyr:: group_by(SRVY, strata, group) %>%
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE), 
                     num_hauls = sum(num_hauls, na.rm = TRUE)  # do I need to sum num_hauls from all spp or sum of tows where any of those species ever occured
    ) %>%
    dplyr::mutate(ci = confint(num_hauls, bio_var), 
                  taxon = paste0("total ", gsub("\\s*\\([^\\)]+\\)","",as.character(group)))) %>% 
    dplyr::ungroup()
  
  biomass_group_999 <- dat %>%  ## summarize by group to compare to prior years tech memo    
    dplyr::filter(grepl(pattern = "_", x = group0)) %>% 
    dplyr::group_by(group, SRVY) %>%
    dplyr::summarize(biomass_mt = sum(biomass_mt, na.rm = TRUE),
                     bio_var = sum(bio_var, na.rm = TRUE)) %>%
    dplyr::left_join(x = ., 
                     y = dat0, 
                     by =  c("SRVY", "group")) %>%
    dplyr::mutate(
      num_hauls = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = confint(num_hauls, bio_var), 
      # up_ci_bio_tot = biomass_mt + ci,
      # ci_percent = ((1-(biomass_mt/up_ci_bio_tot))*100), 
      taxon = paste0("total ", gsub("\\s*\\([^\\)]+\\)","", as.character(group))), 
      # taxon = paste0("total ", (group)), 
      strata = 999) %>% 
    dplyr::select(-num) %>% 
    dplyr::ungroup()
  
  # total level -----------------------------------------------------------------
  
  # biomass_mt matches
  # not sure if CI is right
  
  biomass_total_bystrata <- # find estimated total biomass for all stratum for all taxon
    biomass_by_stratum0 %>% 
    dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species codes greater than 35000 are invertebrates
    dplyr::mutate(group0 = "Total") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(SRVY, group0, strata, biomass_mt, ci, num_hauls, bio_var) %>% 
    dplyr::group_by(SRVY, group0, strata) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE)#, 
                     # num_hauls = sum(num_hauls, na.rm = TRUE), 
                     # num_hauls = ifelse(num_hauls == 1, 1, (num_hauls-1)), 
                     # ci = confint(num_hauls, bio_var)
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::left_join(
      x = ., 
      y = catch_haul_cruises_maxyr0 %>% 
        dplyr::mutate(strata = dplyr::case_when(
          (stratum == 31 | stratum == 32) ~ 30,
          (stratum == 41 | stratum == 42) | stratum == 43 ~ 40,
          (stratum == 61 | stratum == 62) ~ 60, 
          TRUE ~ as.numeric(stratum))) %>%
        dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species_code < 35000
        dplyr::group_by(year, SRVY, strata) %>%
        dplyr::distinct(hauljoin) %>%
        dplyr::summarize(num = n()),  # number of hauls the group was caught in for all strata,
      by = c("SRVY", "strata")) %>% 
    dplyr::mutate(
      num_hauls = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = NA, #confint(num_hauls, bio_var), # not right
      taxon = NA, 
      group = "Total")
  
  
  # not sure if CI is right
  
  biomass_total_999 <-  # find estimated total biomass for all stratum for all taxon
    biomass_by_stratum0 %>% 
    dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species codes greater than 35000 are invertebrates
    dplyr::mutate(group0 = "Total") %>% 
    dplyr::ungroup() %>% 
    dplyr::select(SRVY, group0, biomass_mt, ci, num_hauls, bio_var) %>% 
    dplyr::group_by(SRVY, group0) %>% 
    dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE), 
                     bio_var = sum(bio_var, na.rm = TRUE), 
                     # num_hauls = sum(num_hauls, na.rm = TRUE), 
                     # num_hauls = ifelse(num_hauls == 1, 1, (num_hauls-1)), 
                     # ci = confint(num_hauls, bio_var)
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::left_join(
      x = ., 
      y = catch_haul_cruises_maxyr0 %>% 
        dplyr::filter(eval(parse( text = spp_code_rnge))) %>% # species_code < 35000
        dplyr::group_by(year, SRVY) %>%
        dplyr::distinct(hauljoin) %>%
        dplyr::summarize(num = n()),  # number of hauls the group was caught in for all strata,
      by = "SRVY") %>% 
    dplyr::mutate(
      num_hauls = ifelse(num == 1, 1, (num-1)), # ifelse require bc lumpsuckers only caught in 1 hauls (can't divide by 0)
      ci = confint(num_hauls, bio_var), # not right
      taxon = NA, 
      strata = 999, 
      group = "Total")
  
  
  out <- dplyr::bind_rows(biomass_group_bystrata, 
                          biomass_group_999, 
                          biomass_spp_bystrata,
                          biomass_spp_999,
                          biomass_total_bystrata, 
                          biomass_total_999) %>% 
    dplyr::select(-num, -num_hauls, -bio_var) %>%
    dplyr::mutate(order = dplyr::case_when(
      grepl(pattern = "other ", x = taxon) ~ 2,
      grepl(pattern = "total ", x = taxon) ~ 3,
      TRUE ~ 1)) %>%
    tidyr::pivot_wider(id_cols = c("SRVY", "group", "taxon", "order"), 
                       names_from = "strata", 
                       values_from = c("biomass_mt", "ci"))
  
  # out$order[grepl(pattern = "other ", x = out$group, ignore.case = TRUE)] <- 4
  
  out <- out %>% 
    dplyr::arrange(SRVY, group, order, taxon) %>% 
    # dplyr::select(-order) %>%
    dplyr::ungroup() 
  
  out$order <- 1:nrow(out)
  out$order[grepl(pattern = "other", x = out$group, ignore.case = TRUE)] <- nrow(out)+1
  out$order[grepl(pattern = "total", x = out$group, ignore.case = TRUE)] <- nrow(out)+2
  names(out) <- gsub(pattern = "biomass_mt_", replacement = "", x = names(out))
  
  out <- dplyr::left_join(
    x = out, 
    y = total_biomass0 %>% 
      dplyr::filter(year == maxyr), 
    by = "SRVY") %>% 
    dplyr::mutate(CI95 = ci_999, 
                  # `999` = biomass_mt_999,
                  a = "±", 
                  prop = `999`/total) %>% 
    dplyr::arrange(order) %>%
    dplyr::relocate(SRVY, group, taxon, `999`, a, CI95, prop) %>% 
    dplyr::filter(`999` != 0) %>% # TOLEDO 
    dplyr::select(-order, -total, -dplyr::starts_with("ci_"))
  
  return(out)
  
}

FitFlextableToPage <- function(x, pgwidth = 6) {
  ft_out <- x %>% flextable::autofit()
  ft_out <- flextable::width(ft_out, width = dim(ft_out)$widths * 
                               pgwidth/(flextable::flextable_dim(ft_out)$widths))
  return(ft_out)
}

temp1 <- function(table_raw, strat, total) {
  table_raw0 <- table_raw
  table_raw <- table_raw %>% 
    dplyr::select("group", "taxon", "999", "a", "CI95", "prop", 
                  all_of(strat))
  
  footnote0 <- paste0("Total estimated biomass is ", 
                      formatC(x = total, digits = 0, format = "f", big.mark = ","), 
                      " t for fish and invertebrates in the ",  
                      unique(table_raw0$SRVY), " bottom trawl survey.")
  
  table_print <- table_raw %>% 
    dplyr::mutate(prop = ifelse(prop < 0.0001, "<0.0001", 
                                formatC(x = prop, digits = 4, 
                                        format = "f", big.mark = ",")), 
                  across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f"), 
                  `999` = paste0(`999`, " ", a)) %>% 
    dplyr::select(-a)
  
  table_print <- table_print %>%
    flextable::flextable(data = .)  %>%
    flextable::merge_v(x = ., j = ~ group) %>%
    flextable::merge_h_range(x = ., i = ~ is.na(taxon), j1 = "group", j2 = "taxon", part = "body") %>%
    flextable::add_header_row(top = TRUE, 
                              values = c("Taxon", 
                                         "Estimated total biomass (t) ± 95% confidence interval", 
                                         "Proportion of total animal biomass", 
                                         "Estimated biomass by stratum (t)"), 
                              colwidths = c(2,2,1,length(strat))) %>% 
    flextable::width(x = .,  
                     width = ifelse(length(strat)>3, 0.7, 1.25),
                     unit = "in") %>%
    flextable::width(x = ., j = "prop", 
                     width = 0.8, unit = "in") %>%
    flextable::width(x = ., j = c("group"), 
                     width = 1, unit = "in") %>%    
    flextable::width(x = ., j = c("taxon"), 
                     ifelse(length(strat)>3, 1.5, 1), 
                     unit = "in") %>% 
    flextable::footnote(x = ., part = "header", i = 1, j = 5, ref_symbols = "1",
                        value = as_paragraph(footnote0)) %>%
    flextable::bold(x = ., i = ~ (grepl(pattern = "Total", x = group) )) %>%
    flextable::set_header_labels(.,
                                 "group" = "", 
                                 "taxon" = "",
                                 "999" = "", 
                                 "CI95" = "", 
                                 "prop" = "") %>%
    flextable::merge_at(x = ., j = c("group", "taxon"), part = "header") %>% 
    flextable::merge_at(x = ., j = c("999", "CI95"), part = "header") %>% 
    flextable::merge_at(x = ., j = c("prop"), part = "header") #%>% 
  # theme_flextable_nmfstm(x = .,
  #                                     font0 = font0,
  #                                     pad = 0,
  #                                     row_lines = TRUE,
  #                                     pgwidth = full_page_landscape_width) %>%
  row_lines <- TRUE
  pad = 0
  body_size = 10
  header_size = 10
  spacing = 0.6
  pgwidth = full_page_landscape_width
  std_b <- officer::fp_border(width = 2, color = "grey10")
  thin_b <- officer::fp_border(width = 0.5, color = "grey10") 
  
  # x <- table_print
  
  x <- flextable::border_remove(x = table_print)
  if (row_lines == TRUE) {
    table_print <- flextable::hline(x = table_print, border = thin_b, part = "body")
  }
  
  table_print <- table_print %>% 
    flextable::hline(x = ., border = std_b, part = "header") %>% 
    flextable::hline_bottom(x = ., border = std_b, part = "body") %>% 
    flextable::bold(x = ., bold = TRUE, part = "header") %>% 
    flextable::align_text_col(x = ., align = "left", header = TRUE) %>% 
    flextable::align_nottext_col(x = ., align = "right", header = TRUE) %>% 
    flextable::padding(x = ., padding = pad, part = "all") %>% 
    flextable::font(x = ., fontname = font0, part = "all") %>% 
    flextable::fontsize(x = ., size = body_size - 2, part = "footer") %>% 
    flextable::fontsize(x = ., size = body_size, part = "body") %>% 
    flextable::fontsize(x = ., size = header_size, part = "header") %>% 
    flextable::fix_border_issues(x = .) %>% 
    flextable::align(x = ., j = c("999", "CI95", "prop",  strat), 
                     align = "right", part = "all") %>%
    flextable::align(x = ., 
                     j = c(strat), 
                     align = "center", i = 1, part = "header")
  
  return(list("table_raw" = table_raw, 
              "table_print" = table_print))
}

```

### tab-biomass-est-[SRVY]-fish

```{r tab-biomass-est-[SRVY]-fish}

nickname0 <- "tab-biomass-est-"

# # Select data and make plot
# place species codes into groups and major species
exp0 <- ('DATAFRAME %>% dplyr::filter(species_code < 35000) %>% # species codes greater than 35000 are invertebrates
  dplyr::mutate(group0 = case_when(
    species_code == 471 ~ "Rajidae (skates)_Alaska skate",
    species_code >= 401 & 
      species_code <= 495 & 
      species_code != 471 ~ "Rajidae (skates)_other skates",
    species_code == 10210 ~ "Pleuronectidae (flatfishes)_yellowfin sole",
    species_code == 10261 ~ "Pleuronectidae (flatfishes)_northern rock sole",
    species_code == 10130 ~ "Pleuronectidae (flatfishes)_flathead sole",
    species_code == 10140 ~ "Pleuronectidae (flatfishes)_Bering flounder",
    species_code == 10285 ~ "Pleuronectidae (flatfishes)_Alaska plaice",
    species_code == 10110 ~ "Pleuronectidae (flatfishes)_arrowtooth flounder",
    species_code == 10112 ~ "Pleuronectidae (flatfishes)_Kamchatka flounder",
    species_code == 10120 ~ "Pleuronectidae (flatfishes)_Pacific halibut",
    species_code >= 10041 & 
      species_code <= 10295 & 
      species_code != 10210 &
      species_code != 10261 &
      species_code != 10130 &
      species_code != 10140 &
      species_code != 10285 &
      species_code != 10110 &
      species_code != 10112 &
      species_code != 10115 &
      species_code != 10120 ~ "Pleuronectidae (flatfishes)_other flatfish",
    species_code >= 21740 & species_code <= 21741 ~ "Gadidae (cods)_walleye pollock",
    species_code >= 21720 & species_code <= 21721 ~ "Gadidae (cods)_Pacific cod",
    species_code >= 21710 & 
      species_code <= 21737 &
      species_code != 21740 &
      species_code != 21741 &
      species_code != 21720 &
      species_code != 21721 ~ "Gadidae (cods)_other cods",
    species_code >= 20000 & species_code <= 20075 ~ "Agonidae (poachers)",
    species_code >= 21300 & species_code <= 21447 ~ "Cottidae (sculpins)",
    species_code >= 21900 & species_code <= 21935 ~ "Hexagrammidae (greenlings)",
    species_code >= 22170 & species_code <= 22199 ~ "Cyclopteridae (lumpsuckers)",
    species_code >= 22200 & species_code <= 22286 ~ "Liparidae (snailfishes)",
    species_code >= 23000 & species_code <= 23099 ~ "Osmeridae (smelts)",
    species_code >= 23800 & species_code <= 23870 ~ "Stichaeidae (blennies)", 
    species_code >= 24100 & species_code <= 24395 ~ "Zoarcidae (eelpouts)",
    species_code == 30060 ~ "Scorpaenidae (rockfishes)_Pacific ocean perch",
    species_code >= 30000 & 
      species_code <= 31550 & 
      species_code != 30060 ~ "Scorpaenidae (rockfishes)_other rockfish",
    TRUE ~ "Other"))')

table_raw0 <- temp(exp0 = exp0, 
                   maxyr = maxyr, 
                   biomass_by_stratum0 = biomass_by_stratum,
                   catch_haul_cruises_maxyr0 = catch_haul_cruises_maxyr,
                   total_biomass0 = total_biomass,
                   spp_code_rnge = "species_code < 35000")

for (i in 1:nrow(haul_cruises_maxyr)) {
  
  header <- paste0("Biomass estimates (t) for major fish taxa collected during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i], "-fish") 
  
  if (haul_cruises_maxyr$SRVY[i] == "EBS"){
    strat <- c("10", "20", "30", "40", "50", "60", "82", "90")
  } else {
    strat <- c("70", "71", "81")
  }
  
  a <- temp1(table_raw = table_raw0 %>% 
               dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]), 
             strat = strat, 
             total = total_biomass$total[
               total_biomass$year == maxyr & 
                 total_biomass$SRVY == haul_cruises_maxyr$SRVY[i]])
  table_raw <- a$table_raw
  table_print <- a$table_print
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
} 

```

### tab-biomass-est-[SRVY]-invert

```{r tab-biomass-est-[SRVY]-invert}

nickname0 <- "tab-biomass-est-"

#     species_code >= 68000 & species_code <= 69549 ~ "Crustacea_crabs",

# # Select data and make plot
# place species codes into groups and major species
exp0 <- ('DATAFRAME %>% dplyr::filter(species_code >= 40000 & 
                  species_code < 99991) %>% # groups greater than 99991 are empty shells, empty barnacles
  dplyr::mutate(group0 = dplyr::case_when(
    species_code >= 66000 & species_code <= 67499 ~ "Crustacea_shrimps",
    species_code >= 60000 & species_code <= 65999 ~ "Crustacea_other crustaceans",
    species_code >= 67500 & species_code <=	67999 ~ "Crustacea_other crustaceans", 
    species_code >= 69550	& species_code <= 68999 ~ "Crustacea_other crustaceans",
    species_code >= 71000 & species_code <= 73999 ~ "Mollusca_Gastropoda (snails)",
    species_code >= 74000 & species_code <= 75799 ~ "Mollusca_Pelecypoda (bivalves)",
    species_code >= 78500 & species_code <= 79600 ~ "Mollusca_squids",
    species_code >= 78010 & species_code <= 78499 ~ "Mollusca_octopuses",
    species_code >= 70000	& species_code <= 70999	~ "Mollusca_other mollusks",
    species_code >= 78000 & species_code <=	78009 ~ "Mollusca_other mollusks",
    species_code >= 80000	& species_code <= 82499 ~ "Echinodermata_Asteroidea (sea stars)",
    species_code >= 83000	& species_code <= 83701 ~ "Echinodermata_Ophiuroidea (brittle stars)",
    species_code >= 83800 & species_code <= 83701 ~ "Echinodermata_Ophiuroidea (brittle stars)",
    species_code >= 82500	& species_code <= 82749 ~ "Echinodermata_Echinoidea (sea urchins)",
    species_code >= 85000 & species_code <= 85999 ~ "Echinodermata_Holothuroidea (sea cucumbers)",
    species_code >= 98000	& species_code <= 99909 ~ "Ascidiacea",
    species_code >= 91000 & species_code <=	91999 ~ "Porifera (sponges)",
    species_code >= 40000	& species_code <= 44999 ~ "Coelenterata",
    species_code >= 45000	& species_code <= 59999 ~ "Other",
    species_code >= 92000	& species_code <= 97999 ~ "Other",
    species_code >= 99990 & species_code <=	99992 ~ "Other",
    species_code >= 77011 & species_code <= 77012 ~ "Other",
    species_code == 99987 ~ "Porifera (sponges)",
    TRUE ~ "Other"))')

table_raw0 <- temp(exp0 = exp0, 
                   maxyr = maxyr, 
                   biomass_by_stratum0 = biomass_by_stratum,
                   catch_haul_cruises_maxyr0 = catch_haul_cruises_maxyr,
                   total_biomass0 = total_biomass, 
                   spp_code_rnge = "species_code >= 40000 & species_code < 99991")

for (i in 1:nrow(haul_cruises_maxyr)) {
  
  header <- paste0("Biomass estimates (t) for major invertebrate taxa collected during the ", 
                   maxyr, " ", 
                   haul_cruises_maxyr$SRVY_long[i],
                   " shelf bottom trawl survey. ")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i], "-invert") 
  
  if (haul_cruises_maxyr$SRVY[i] == "EBS"){
    strat <- c("10", "20", "30", "40", "50", "60", "82", "90")
  } else {
    strat <- c("70", "71", "81")
  }
  
  a <- temp1(table_raw0 %>% 
               dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]), 
             strat, 
             total = total_biomass$total[
               total_biomass$year == maxyr & 
                 total_biomass$SRVY == haul_cruises_maxyr$SRVY[i]])
  table_raw <- a$table_raw
  table_print <- a$table_print
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
} 
```

## tab-majortaxa-pchange-[SRVY]

```{r tab-majortaxa-pchange-[SRVY]}

nickname0 <- "tab-majortaxa-pchange-" 
yrs <- nbsyr

for (i in 1:nrow(haul_cruises_maxyr)) {
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
  
  header <- paste0(
    "Total estimated biomass in metric tons (t) and the percent change between the ",
    compareyr," and ",maxyr," ", 
    haul_cruises_maxyr$SRVY_long[i], 
    ' shelf bottom trawl surveys for predominant fish and invertebrate taxa. Crab data are summarized under other crabs and discussed in detail in the annual crab technical memorandum produced by the Shellfish Assessment Program. ')
  
  a<-table_change(dat = cpue_biomass_total %>% 
                    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>%
                    dplyr::rename(y = biomass_mt), 
                  yrs = nbsyr, 
                  maxyr = maxyr, 
                  compareyr = compareyr, 
                  remove_all = TRUE) 
  
  table_raw <- a$table_raw %>% 
    dplyr::select(-"Survey", -starts_with("change_"), -ends_with(as.character(nbsyr[!(nbsyr %in% c(maxyr, compareyr))])))  %>% 
    dplyr::mutate(print_name = gsub(pattern = "smelts (*Osmeridae*) include eulachon, capelin, and rainbow smelt", replacement = "smelts", x = print_name, fixed = TRUE))
  
  temp1 <- table_raw %>% 
    dplyr::filter(taxon == "fish")
  
  temp2 <- table_raw %>% 
    dplyr::filter(taxon == "invert") 
  
  
  if (nrow(temp1)>nrow(temp2)){
    temp2 <- temp2 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp1)-nrow(temp2))))) 
  } else {
    temp1 <- temp1 %>% 
      dplyr::bind_rows(., 
                       data.frame(common_name = rep_len(NA, (nrow(temp2)-nrow(temp1)))
                       ))
  }
  
  names(temp1) <- paste0(names(temp1), " ")
  
  table_raw <- dplyr::bind_cols(temp1, temp2) %>% 
    dplyr::select(-dplyr::starts_with("taxon"))
  
  
  table_print <- dplyr::bind_cols(temp1, temp2) %>%
    dplyr::mutate(across(starts_with("change"), 
                         formatC, big.mark=",", digits = 1, format = "f")) %>%
    dplyr::mutate(across(starts_with("change"), paste0, "%")) %>%
    dplyr::mutate(across(where(is.numeric), 
                         formatC, big.mark=",", digits = 0, format = "f")) %>%
    dplyr::mutate(group = stringr::str_to_title(print_name)) %>% 
    dplyr::mutate(dplyr::across(where(is.character), gsub, pattern = "NA%", replacement = "")) %>% 
    dplyr::mutate(dplyr::across(where(is.character), gsub, pattern = "NA", replacement = ""))
  
  
  if (TRUE) { # remove_all
    table_print$group <- gsub(pattern = "All ", replacement = "", 
                              x = table_print$group, fixed = TRUE)
  }
  
  table_print <- table_print %>% 
    dplyr::mutate(spp = dplyr::case_when(
      grepl(pattern = "sp.", x = species_name1, fixed = TRUE) ~ "sp.", 
      grepl(pattern = "spp.", x = species_name1, fixed = TRUE) ~ "spp.", 
      TRUE ~ "")) %>%
    dplyr::mutate(
      species_name = species_name1, 
      species_name1 = 
        gsub(pattern = " sp.", replacement = "", 
             x = species_name1, fixed = TRUE), 
      species_name1 =
        gsub(pattern = " spp.", replacement = "",
             x = species_name1, fixed = TRUE),
      species_name2 = dplyr::case_when(
        !grepl(pattern = " ", x = species_name, fixed = TRUE) ~ species_name1), 
      species_name1 = dplyr::case_when(
        grepl(pattern = " ", x = species_name, fixed = TRUE) ~ species_name1)) %>% 
    dplyr::rename("Fish taxon" = "print_name ", 
                  "Invertebrate taxon" = "print_name") %>% 
    dplyr::select(dplyr::all_of(c("Fish taxon", paste0(maxyr, " "), paste0(compareyr, " "), "change ",
                                  "Invertebrate taxon", maxyr, compareyr, "change")))
  table_print <- table_print %>%
    flextable::flextable(data = ., 
                         col_keys = c(ifelse(length(unique(table_print$SRVY)) == 1, 
                                             "", "Survey"), 
                                      "Fish taxon", 
                                      paste0(yrs, " "), "change ", 
                                      "Invertebrate taxon", 
                                      as.character(yrs), "change")) %>%
    flextable::color(color = "red", # https://stackoverflow.com/questions/57474647/italic-and-color-in-an-r-flextable
                     i = grepl(pattern = "-", x = as.character(table_print$change)), 
                     j = "change") %>% 
    flextable::color(color = "red", 
                     i = grepl(pattern = "-", x = as.character(table_print[, "change "])), 
                     j = "change ") %>% 
    flextable::width(x = ., j = "Fish taxon", width = 2.75) %>% 
    flextable::width(x = ., j = "Invertebrate taxon", width = 2.75) %>% 
    flextable::width(x = ., j = "change ", width = 1) %>% 
    flextable::width(x = ., j = "change", width = 1) %>% 
    flextable::set_header_labels(.,
                                 "change " = paste0("Change (", maxyr, ", ", compareyr, ")" ), 
                                 change = paste0("Change (", maxyr, ", ", compareyr, ")" )) %>% 
    theme_flextable_nmfstm(x = ., 
                           font0 = font0, 
                           pad = 0, 
                           row_lines = FALSE, 
                           pgwidth = full_page_landscape_width) %>% 
    flextable::vline(x = ., part = "all", j = "change ") %>%
    flextable::align(x = ., j = c(paste0(maxyr, " "), paste0(compareyr, " "), "change ",
                                  maxyr, compareyr, "change"), 
                     align = "right", part = "all") %>% 
    flextable::padding(x = ., j = "change ", padding.right = 5, part = "all") %>% 
    flextable::padding(x = ., j = "Invertebrate taxon", padding.left = 5, part = "all")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
}
```

## tab-est-spp-[SRVY]

```{r tab-est-spp-[SRVY]}

nickname0 <- paste0("tab-est-spp-") 

temp <- biomass %>% 
  dplyr::filter(year == maxyr) %>% 
  dplyr::select(species_code, SRVY, 
                meanwgtcpue, sdcpuewt, 
                biomass, sdbio, upperb, lowerb, 
                meannumcpue, sdcpuenum, 
                population, sdpop, upperp, lowerp, 
                # haulcount, 
                catcount, numcount, lencount) %>% 
  dplyr::left_join(
    x = ., 
    y = report_spp1 %>% 
      dplyr::select(species_code, print_name, order, taxon), 
    by = "species_code") %>% 
  dplyr::filter(taxon == "fish" &
                  (catcount != 0 & numcount != 0 & lencount != 0) & # if there were none in that survey, don't include
                  order > 0) %>% 
  dplyr::arrange(order) %>% 
  dplyr::select(-species_code, -order, -taxon) %>% 
  dplyr::relocate(print_name)

type <- c("wt", "num")
for (i in 1:2) {
  nickname <- paste0(nickname0, type[i]) 
  
  if (i == 1){ # CPUE (WT/HA) and BIOMASS
    
    header <- paste0(
      "Mean CPUE by weight (kg/ha) with standard deviation, and estimated biomass (t) with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for common groundfish species for the ",
      maxyr," ", SURVEY, " shelf bottom trawl survey", plural_surveys, ".")
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    meanwgtcpue, sdcpuewt, 
                    biomass, sdbio, lowerb, upperb, 
                    # haulcount, 
                    catcount, numcount, lencount) 
    
    table_print <- table_raw %>% 
      dplyr::mutate(meanwgtcpue = formatC(x = meanwgtcpue, 
                                          digits = 2, 
                                          format = "f", big.mark = ","),
                    sdcpuewt = formatC(x = sdcpuewt, 
                                       digits = 2, 
                                       format = "f", big.mark = ","), 
                    biomass = formatC(x = biomass, 
                                      digits = 0, 
                                      format = "f", big.mark = ",") , 
                    upperb = formatC(x = upperb, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    lowerb = formatC(x = lowerb, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    sdbio = formatC(x = sdbio, 
                                    digits = 0, 
                                    format = "f", big.mark = ","))
    
    if (SRVY == "NEBS"){
      table_print <- table_print %>% 
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          SRVY = "Shelf area", 
          meanwgtcpue = paste0("Mean CPUE (kg/ha)"), 
          sdcpuewt = paste0("SD CPUE"), 
          biomass = paste0("Estimated\nBiomass"), 
          sdbio = paste0("SD Biomass"), 
          lowerb = paste0("95% LCL"), 
          upperb = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    } else {
      table_print <- table_print %>% 
        dplyr::select(-SRVY) %>%
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          # SRVY = "Shelf area", 
          meanwgtcpue = paste0("Mean CPUE (kg/ha)"), 
          sdcpuewt = paste0("SD CPUE"), 
          biomass = paste0("Estimated\nBiomass"), 
          sdbio = paste0("SD Biomass"), 
          lowerb = paste0("95% LCL"), 
          upperb = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    } 
    
  } else { # CPUE No/HA and POPULATION
    
    header <- paste0("Mean CPUE by number (no./ha) with standard deviation, and estimated population with standard deviation and 95% lower (LCL) and upper (UCL) confidence limits for other common groundfish species for the ", 
                     maxyr," ",
                     text_list(paste0(haul_cruises_maxyr$SRVY_long, 
                                      " shelf (", 
                                      haul_cruises_maxyr$SRVY, "; ",
                                      haul_cruises_maxyr$stations_completed,
                                      " stations completed)")),
                     " trawl surveys.")
    
    table_raw <- temp %>% 
      dplyr::select(print_name, SRVY, 
                    meannumcpue, sdcpuenum, 
                    population, sdpop, lowerp, upperp, 
                    # haulcount, 
                    catcount, numcount, lencount)
    
    # population0 <- find_units(unit = "", unt = "", dat = table_raw$population)
    # sdpop0 <- find_units(unit = "", unt = "", dat = table_raw$sdpop)
    
    table_print <- table_raw %>% 
      dplyr::mutate(meannumcpue = formatC(x = meannumcpue, 
                                          digits = 2, 
                                          format = "f", big.mark = ","),
                    sdcpuenum = formatC(x = sdcpuenum, 
                                        digits = 2, 
                                        format = "f", big.mark = ","), 
                    population = formatC(x = population, 
                                         digits = 0, 
                                         format = "f", big.mark = ",") , 
                    upperp = formatC(x = upperp, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    lowerp = formatC(x = lowerp, 
                                     digits = 0, 
                                     format = "f", big.mark = ",") , 
                    sdpop = formatC(x = sdpop, 
                                    digits = 0, 
                                    format = "f", big.mark = ","))
    
    if (SRVY == "EBS") {
      table_print <- table_print %>% 
        dplyr::select(-SRVY) %>%
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          # SRVY = "Shelf area", 
          meannumcpue = paste0("Mean CPUE (no/ha)"), 
          sdcpuenum = paste0("SD CPUE"), 
          population = paste0("Estimated\nPopulation"), 
          sdpop = paste0("SD Population"), 
          lowerp = paste0("95% LCL"), 
          upperp = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    } else {
      table_print <- table_print %>% 
        flextable::flextable(data = .) %>% 
        flextable::set_header_labels(
          x = ., 
          print_name = "Species", 
          SRVY = "Shelf area", 
          meannumcpue = paste0("Mean CPUE (no/ha)"), 
          sdcpuenum = paste0("SD CPUE"), 
          population = paste0("Estimated\nPopulation"), 
          sdpop = paste0("SD Population"), 
          lowerp = paste0("95% LCL"), 
          upperp = paste0("95% UCL"), 
          # haulcount = "Total hauls", 
          catcount = "Hauls with\nweights", 
          numcount = "Hauls with\ncounts", 
          lencount = "Hauls with\nlengths") 
    }
  }
  
  
  table_print <- table_print %>% 
    flextable::width(x = ., j = "print_name", width = 3) %>%
    # flextable::width(x = ., j = "SRVY", width = 0.5) %>%
    flextable::merge_v(x = ., target = "print_name", 
                       j = "print_name", part = "body") %>% 
    flextable::valign(valign = "top") %>%  
    theme_flextable_nmfstm(x = ., 
                           font0 = font0, 
                           pad = 0, 
                           row_lines = TRUE, 
                           pgwidth = full_page_landscape_width) %>%
    flextable::align(x = ., align = "right", part = "all") %>%
    flextable::align(x = ., j = c("print_name"), #, "SRVY"
                     align = "left", part = "all") #%>%
  # flextable::hline(x = ., i = 1, part = "header")
  
  # Save table
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
}
```
