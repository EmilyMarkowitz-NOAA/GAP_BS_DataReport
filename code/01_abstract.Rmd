
# Abstract

```{r survey_summary}

nbs_str0 <- ifelse(SRVY == "NEBS", 
                   # NBS + EBS
                   paste0("The survey covered the Bering Sea continental shelf (bottom depths between approximately 20 and 200 m) from the Alaska coastline to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and the Bering Strait, including Norton Sound."), 
                   # EBS
                   paste0("The EBS bottom trawl survey covers the Bering Sea continental shelf (bottom depths between approximately 20 and 200 m) from the Alaska coastline to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and roughly 62° N latitude."))#, 
# "The study area covered the eastern Bering Sea continental shelf from approximately 20 to 200 m bottom depth. Geographically, this area spans from the Alaska coastline to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and roughly 62° N latitude.")


# if (sum(haul_cruises_maxyr$stations_avail == haul_cruises_maxyr$stations_completed) == 1) { # diff answers or only 1 srvy
#   str0 <- text_list(
#     paste0(ifelse(haul_cruises_maxyr$stations_avail ==
#                     haul_cruises_maxyr$stations_completed, "All", "Most"), 
#            " survey stations in the ", 
#            haul_cruises_maxyr$SRVY, 
#            " were sampled successfully"))
# } else { # answers both "Most" or "All"
#   str0 <- paste0(unique(ifelse(haul_cruises_maxyr$stations_avail ==
#                                  haul_cruises_maxyr$stations_completed, "All", "Most")), 
#                  " survey stations in the ",
#                  text_list(haul_cruises_maxyr$SRVY), 
#                  " were sampled successfully")
# } 

temp <- haul_cruises_maxyr # %>%
  # dplyr::mutate(
  #   survey_name_extra = unlist(lapply(X = strsplit(x = survey_name, split = " - ", fixed = TRUE), "[[", 1)), 
  #   survey_name_extra = unlist(lapply(X = strsplit(x = survey_name_extra, split = "Bering Sea ", fixed = TRUE), "[[", 2)))
str1 <- gsub(pattern = " ,", replacement = ",", 
             x = text_list(paste0(temp$yrofsurvey, 
                                  temp$stndth, " ", temp$SRVY_long, " (", temp$SRVY, ") Crab/Groundfish Bottom Trawl Survey"), 
                           sep_last = ", as well as the "))
```

In `r maxyr`, the Resource Assessment and Conservation Engineering (RACE) division of the National Marine Fisheries Service’s (NMFS) Alaska Fisheries Science Center (AFSC) conducted the `r str1`. `r nbs_str0` `r stringr::str_to_sentence(NMFSReports::numbers2words(nrow(vessel_info)))` stern trawler`r ifelse(nrow(vessel_info)>1, "s", "")`, the `r text_list(paste0(vessel_info$length_m, "-m ",  vessel_info$vessel_ital)) `, were chartered for `r ifelse(SRVY=="NEBS", "these surveys", "the survey")`. Demersal populations of fishes and invertebrates were sampled by trawling for 30 minutes at stations arranged on a systematic grid, which consisted of `r text_list(paste0(haul_cruises_maxyr$stations_avail, " total stations in the ", haul_cruises_maxyr$SRVY))`. At each station, species composition, length distribution, and age structure samples were collected from ecologically and commercially important species. 


```{r }
#| label: abstract_temperature

temp0 <- temps_avg_yr

str01 <- ""
# warmer than previous year/how many consecutive years?
for (i in 1:length(unique(temp0$SRVY))){
  
  temp <- temp0 %>% 
    dplyr::filter(year == maxyr)
  
  # if (sum(temp$nthyr > 1)>(nrow(temp)-1)) { 
    str01 <- paste0(str01, 
                    text_list(
                      paste0("The recent trend of ",
                             ifelse(grepl(pattern = "warm", x = temp$case), "higher", "lower"),
                             "-than-average ocean temperatures continued on the ", temp$SRVY, " shelf for the ",
                             numbers2words_th(x = temp$nthyr, type = "word"),
                             " consecutive year. ")))
  # }
  
  # were both sst and bt both warmer/colder?
  if (grepl(pattern = "both", x = temp$case)) { # they were both...
    str01 <- paste0(str01, "In ", maxyr,", both the mean surface (",
                    round(x = temp$st, digits = 1),
                    "°C) and bottom (",
                    round(x = temp$bt, digits = 1),
                    "°C) water temperatures were ", 
                    ifelse(grepl(pattern = "warm", x = temp$case), "warmer", "colder"))
  } else { # they were not both...
    str01 <- paste0(str01, "In ", maxyr,", the surface (",
                    round(x = temp$st, digits = 1),
                    "°C) were ",
                    ifelse(temp$st_mean, "warmer", "colder"),
                    " and bottom (",
                    round(x = temp$bt, digits = 1),
                    "°C) water temperatures were ", 
                    ifelse(temp$bt_mean, "warmer", "colder"))
  }
}

str0 <- paste0(str01,
               " than the survey long-term averages. ")

if ((temp$warmest_rank > (nrow(temp0)-6)) |  (temp$warmest_rank < 6)) {
  str0 <- paste0(str0, 
                 "The ", maxyr, " mean bottom temperatures were the ")
  
  # if this year is within the 6th warmest or coldest years...
  if (temp$warmest_rank > (nrow(temp0)-6)) { # is it of the 5 coldest
    str0 <- paste0(str0, 
                   ifelse(temp$warmest_rank != nrow(temp0), 
                          paste0(NMFSReports::numbers2words_th(temp$warmest_rank), " "), 
                          ""),
                   "coldest")
  }
  
  if (temp$warmest_rank < 6) {  # or is it of the 5 warmest?
    str0 <- paste0(str0, 
                   ifelse(temp$warmest_rank != 1, 
                          paste0(NMFSReports::numbers2words_th(nrow(temp0)-temp$warmest_rank), " "), 
                          ""),
                   "warmest")
  }

str0 <- paste0(str0, 
               " observed since the beginning of the EBS shelf bottom trawl survey time series in 1982. ")
}
str0 <- paste0(str0, 
               paste0("NBS mean surface and bottom temperatures were not calculated because the NBS has only been surveyed ",
                  numbers2words(x = haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY %in% "NBS"]),
                  " times since ",
                  haul_cruises_maxyr$SRVY_start[haul_cruises_maxyr$SRVY %in% "NBS"],". ") )

```

`r str0` 

```{r abstract_species_counts}

# count fish spp
temp <- dplyr::left_join(
  x = catch_haul_cruises_maxyr %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct(), 
  y = spp_info %>% 
    dplyr::filter(used_in_counts) %>%
    dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon) %>%
    dplyr::distinct(), 
  by = "species_code") %>% 
  dplyr::filter(taxon == "fish") %>% 
  dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(SRVY, species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(species_code = n()),
  by = "SRVY") %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(family_taxon)) %>% 
      dplyr::select(SRVY, family_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(family_taxon = n()),
    by = "SRVY")  %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(genus_taxon)) %>% 
      dplyr::select(SRVY, genus_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(genus_taxon = n()),
    by = "SRVY") #%>%
# dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

temp1 <- dplyr::bind_cols(
  temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_code = n()), 
  temp %>% 
    dplyr::filter(!is.na(family_taxon)) %>% 
    dplyr::select(family_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(family_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(genus_taxon)) %>% 
    dplyr::select(genus_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(genus_taxon = n())) 

fish_sp <- xunits(temp1$species_code) 
fish_genera <- xunits(temp1$genus_taxon) 
fish_family <- xunits(temp1$family_taxon) 

# count invert spp
temp <- dplyr::left_join(
  x = catch_haul_cruises_maxyr %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct(), 
  y = spp_info %>% 
    dplyr::filter(used_in_counts) %>%
    dplyr::select(species_code, species_taxon, phylum_taxon, genus_taxon, taxon) %>%
    dplyr::distinct(), 
  by = "species_code") %>% 
  dplyr::filter(taxon == "invert") %>% 
  dplyr::select(species_code, species_taxon, phylum_taxon, genus_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(SRVY, species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(species_code = n()),
  by = "SRVY") %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(phylum_taxon)) %>% 
      dplyr::select(SRVY, phylum_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(phylum_taxon = n()),
    by = "SRVY")  %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(genus_taxon)) %>% 
      dplyr::select(SRVY, genus_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(genus_taxon = n()),
    by = "SRVY") #%>%
# dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

temp1 <- dplyr::bind_cols(
  temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_code = n()), 
  temp %>% 
    dplyr::filter(!is.na(phylum_taxon)) %>% 
    dplyr::select(phylum_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(phylum_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(genus_taxon)) %>% 
    dplyr::select(genus_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(genus_taxon = n())) 

invert_spp <- xunits(temp1$species_code) 
invert_phyla <- xunits(temp1$phylum_taxon) 

# temp <- spp_info_maxyr %>% 
#   dplyr::filter(used_in_counts == TRUE) 

# temp <- dplyr::left_join(
#   x = catch_haul_cruises_maxyr %>% 
#     dplyr::select(SRVY, species_code) %>% 
#     dplyr::distinct(), 
#   y = spp_info %>% 
#     dplyr::filter(used_in_counts) %>%
#     dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon) %>%
#     dplyr::distinct(), 
#   by = "species_code") %>% 
#   dplyr::filter(taxon == "fish") %>% 
#   dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon, SRVY) %>% 
#   dplyr::distinct()

# fish_sp <- xunits(length(unique(temp$report_name_scientific[
#   temp$taxon == "fish" & 
#     !(grepl(pattern = " sp.", 
#             x = temp$report_name_scientific, fixed = T)) & 
#     !(grepl(pattern = " unid.", x = 
#               temp$report_name_scientific, fixed = T))])))
```


```{r abstract_biomass}
str00 <- ""
# if (SRVY == "NEBS") {
  for (i in 1:length(unique(cruises_maxyr$SRVY))){

    srvy <- sort(unique(cruises_maxyr$SRVY))[i]
  
  str0 <- paste0(
    "The total estimated biomass in the ", srvy ," ",
    ifelse(sum(biomass_compareyr$biomass[biomass_compareyr$SRVY == srvy]) < 
             sum(biomass_maxyr$biomass[biomass_maxyr$SRVY == srvy]), 
           "increased", "decreased"),
    " from ", 
    NMFSReports::xunits(sum(biomass_compareyr$biomass[biomass_compareyr$SRVY == srvy], na.rm = TRUE)) ,
    " metric tons (t) ", #"(", NMFSReports::xunits(sum(biomass_compareyr$sdbio[biomass_compareyr$SRVY == "NBS"], na.rm = TRUE)) ,
    # " standard deviation (SD) t) ", 
    "in ", compareyr, " to ", 
    NMFSReports::xunits(sum(biomass_maxyr$biomass[biomass_maxyr$SRVY == srvy], na.rm = TRUE)),
    " t", # "(", NMFSReports::xunits(sum(biomass_maxyr$sdbio[biomass_maxyr$SRVY == "NBS"], na.rm = TRUE)) ,
    # " SD t)", 
    " in ", maxyr)
  
  str00 <- paste0(str00, str0, ". ")
  
}
```

`r str00`A total of `r fish_sp ` species of fishes were identified during the `r text_list(SRVY1)` survey`r ifelse(SRVY=="NEBS", "s", "")`, as well as `r invert_spp ` invertebrate taxa.

This report compares the distribution and relative abundance of `r xunits(length(unique(report_spp1$order[report_spp1$taxon == "fish"])))`  fish species and `r xunits(length(unique(report_spp1$order[report_spp1$taxon == "invert"])))` invertebrate taxa with side-by-side maps from the `r compareyr ` and `r maxyr` `r text_list(SRVY1)` shelf bottom trawl surveys. For select and common fish species, abundance-at-length plots comparing the `r compareyr ` and `r maxyr` `r text_list(SRVY1)` surveys are also presented. Survey results reported herein include estimates of biomass for most fishes and invertebrates, and estimates of population size, geographic distributions, and abundance-at-length of select fish species. Appendices provide tables listing population estimates by sex and size group for principal fish species and species encountered during the `r text_list(SRVY1)` survey`r ifelse(SRVY=="NEBS", "s", "")`. 

```{r abstract_insert_text, child=paste0(dir_out_rawdata, "/0_abstract_conclusion.Rmd")}
```

\pagebreak
