---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

# Abstract

```{r}
# use haul_cruises_maxyr TOLEDO 

temp <- haul_cruises_maxyr %>%
  dplyr::filter(SRVY == "EBS") %>% 
  dplyr::mutate(start_mo_long = format(x = as.POSIXlt(x = start_date_haul ), format="%B")) %>%
  dplyr::mutate(end_mo_long = format(x = as.POSIXlt(x = end_date_haul ), format="%B")) #%>%
  # dplyr::select(start_mo_long, end_mo_long)

nbs_insert <- ifelse(SRVY == "NEBS", 
                      #NBS
                      paste0("In addition, the ", maxyr, 
                             " survey coverage was expanded to include the northern Bering Sea (NBS). This is only the ", 
                             NMFSReports::numbers2words_th(
                               haul_cruises_maxyr %>% 
                                 dplyr::filter(SRVY == "NBS") %>%
                                 dplyr::select(yrofsurvey )),
                             " time since 2010 that the NBS survey was done. The expanded study area covered the entire Bering Sea continental shelf (hereafter referred to as the “NEBS”) from 20 to 200 m bottom depth to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and the Bering Strait, including Norton Sound."), 
                             # EBS
                             "The study area covered the southeastern Bering Sea continental shelf from 20 to 200 m bottom depth to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and to approximately the latitude of St. Matthew Island (60° 50' N).")


if (sum(haul_cruises_maxyr$stations_avail == haul_cruises_maxyr$stations_completed) == 1) { # diff answers or only 1 srvy
  temp_insert <- CapFirst(NMFSReports::text_list(
    paste0(ifelse(haul_cruises_maxyr$stations_avail ==
                    haul_cruises_maxyr$stations_completed, "all", "most"), 
           " survey stations in the ", 
           haul_cruises_maxyr$SRVY, 
           " were sampled successfully")))
} else { # answers both "Most" or "All"
  temp_insert <- paste0(unique(ifelse(haul_cruises_maxyr$stations_avail ==
                    haul_cruises_maxyr$stations_completed, "All", "Most")), 
           " survey stations in the ",
           NMFSReports::text_list(haul_cruises_maxyr$SRVY), 
           " were sampled successfully")
} 
```

From `r temp$start_mo_long` to `r temp$end_mo_long` `r maxyr`, the National Marine Fisheries Service’s Alaska Fisheries Science Center’s Resource Assessment and Conservation Engineering Division conducted its `r temp$yrofsurvey ``r temp$stndth ` annual `r SURVEY ` (`r SRVY `) continental shelf bottom trawl survey of groundfish and invertebrate fauna. `r nbs_insert` `r CapFirst(NMFSReports::numbers2words(nrow(vessel_info)))` stern trawler`r ifelse(nrow(vessel_info)>1, "s", "")`, the `r NMFSReports::text_list(paste0(vessel_info$length_m, "-m ",  vessel_info$vessel_ital)) `, were chartered to sample the `r SRVY `. Demersal populations of fishes and invertebrates were sampled by trawling for 30 minutes at stations centered within a stratified systematic grid consisting of a total of `r NMFSReports::text_list(paste0(haul_cruises_maxyr$stations_avail, " stations in the ", haul_cruises_maxyr$SRVY))`. At each station, species composition of the catch was determined, and length distributions and age structure samples were collected from ecologically and commercially important species. `r temp_insert `. 

> need weighted temperature by bottom area script from rebecca

```{r}
# long term mean --------------------------------
temp0 <- temps_wt_avg_yr_longterm


if (sum(temps_wt_avg_yr$SRVY == "NBS") <= 6 |   # TOLEDO - may do NBS in the future when there are more years?
    sum(temp_longterm$SRVY == "NBS") == 0) {
temp0 <- temp0 %>% 
  dplyr::filter(SRVY == "EBS")
temp_insert2 <- paste0("NBS weighted mean surface and bottom temperatures were not calculated because the NBS has only been surveyed ",
                        numbers2words(x = haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY %in% "NBS"]),
                        " times since ",
                        haul_cruises_maxyr$SRVY_start[haul_cruises_maxyr$SRVY %in% "NBS"],". ")
} else {
  temp_insert2 <- ""
}

temp_insert1 <- ""
# warmer than previous year/how many consecutive years?
for (i in 1:nrow(temp0)){
  
  temp <- temp0 %>% 
  dplyr::filter(SRVY == temp$SRVY[i])
    
  if (sum(temp$nthyr > 1)>(nrow(temp)-1)) { # 
    temp_insert1 <- paste0(temp_insert1, 
                           NMFSReports::text_list(
      paste0(ifelse(grepl(pattern = "warm", x = temp$case), "Warm", "Cold"),
                         " temperatures continued on the ", temp$SRVY, " shelf for the ",
                         numbers2words_th(x = temp$nthyr, type = "word"),
                         " consecutive year. ")))
  }
  
  # were both sst and bt both warmer/colder?
  if (grepl(pattern = "both", x = temp$case)) { # they were both...
    temp_insert1 <- paste0(temp_insert1, "In ", maxyr,", both the mean surface (",
                           round(x = temp$st_wt, digits = 1),
                           "°C) and bottom (",
                           round(x = temp$bt_wt, digits = 1),
                           "°C) water temperatures were ", 
                           ifelse(grepl(pattern = "warm", x = temp$case), "warmer", "colder"))
  } else { # they were not both...
    temp_insert1 <- paste0(temp_insert1, "In ", maxyr,", the surface (",
                           round(x = temp$st_wt, digits = 1),
                           "°C) were ",
                         ifelse(temp$st_wt_above_mean, "warmer", "colder"),
                         " and bottom (",
                           round(x = temp$bt_wt, digits = 1),
                           "°C) water temperatures were ", 
                         ifelse(temp$bt_wt_above_mean, "warmer", "colder"))
  }
}

temp_insert <- paste0(temp_insert1,
                       " than the survey long term (",
                         haul_cruises_maxyr$SRVY_start[haul_cruises_maxyr$SRVY %in% temp$SRVY],"-",(maxyr-1), 
                       ") averages of ",
                       round(x = mean(temp$st_wt_mean, na.rm = T), digits = 1),
                       "°C for the surface and ",
                       round(x = mean(temp$bt_wt_mean, na.rm = T), digits = 1),
                       "°C for the bottom. ", 
                      temp_insert2)

```

`r temp_insert` 

```{r}
# Species counts -------------------------------------
  temp <- spp_info_maxyr %>% 
    dplyr::filter(used_in_counts == TRUE) 
  
  fish_sp <- xunits(length(unique(temp$report_name_scientific[temp$fish==TRUE & 
                                                     !(grepl(pattern = " sp.", x = temp$report_name_scientific, fixed = T)) & 
                                                     !(grepl(pattern = " unid.", x = temp$report_name_scientific, fixed = T))])))

```


In the `r SRVY`, there was a total of `r fish_sp ` species of fishes were identified. `r xunits(length(unique(temp$family_taxon[temp$fish==TRUE])))` families and `r xunits(length(unique(temp$genus_taxon[temp$fish==TRUE])))` genera of fish were observed in the data, as well as `r xunits(length(unique(temp$report_name_scientific[temp$invert==TRUE])))` invertebrate taxa. In total, organisms across `r xunits(length(unique(temp$phylum_taxon)))` phyla were identified in the catches.

The distribution and relative abundance of `r xunits(sum(length(report_species$fish1), length(report_species$fish2), length(report_species$fish3)))` different fish species and `r xunits(sum(length(report_species$invert1), length(report_species$invert3)))` invertebrate taxa are compared with side-by-side maps from both the `r compareyr ` and `r maxyr` `r SRVY` shelf bottom trawl surveys. For the more common fish species, there are also plots of abundance-at-length comparing the `r compareyr ` and `r maxyr` `r SRVY` surveys. Tables provide estimates of bottom trawl survey biomass for most fishes and invertebrates, as well as estimates of population size for the most common fishes. Appendices provide station data, summarized catch data by station, listings of taxa, and detailed analyses of abundance and biological data of the sampled populations. 


> not getting the right numbers... also, def for "noticable, significant"

> unsure how to automate the following paragraph


```{r}

if (
  # NMFSReports::pchange(start = sum(biomass_compareyr$biomass),
  #                        end = sum(biomass_maxyr$biomass),
  #                        value_only = TRUE)>10 & # if there is a greater than X% difference
    SRVY == "NEBS") {

  # dat_biomass_compspp <- 
  #   dplyr::left_join(
  #   x = biomass_maxyr %>%
  #     dplyr::select(biomass, SRVY, species_name, species_code, fish, invert) %>%
  #     dplyr::group_by(SRVY, species_name, species_code, fish, invert) %>%
  #     dplyr::summarise(biomass_maxyr = sum(biomass, na.rm=T)),
  #   y = biomass_compareyr %>%
  #     dplyr::select(biomass, SRVY, species_name, species_code, fish, invert) %>%
  #     dplyr::group_by(SRVY, species_name, species_code, fish, invert) %>%
  #     dplyr::summarise(biomass_compareyr = sum(biomass, na.rm=T))) %>%
  #   dplyr::mutate(diff = (biomass_maxyr - biomass_compareyr)) %>%
  #   # dplyr::mutate(absdiff = abs(diff)) %>%
  #   dplyr::mutate(pchange = diff/biomass_compareyr) %>%
  #   # dplyr::mutate(abspchange = abs(pchange)) %>%
  #   dplyr::arrange(desc(abs(diff), abs(pchange))) %>%
  #   dplyr::filter(!is.na(species_name) &
  #                   !(pchange %in% c(0,-1,NaN,NA, Inf,-Inf)))
  # 
  #   dat_biomass_compspp_notfish1 <- dat_biomass_compspp %>%
  #     dplyr::filter(invert == TRUE)
  #   inc <- sum(dat_biomass_compspp_notfish1$pchange > 0)
  #   dec <- inc-nrow(dat_biomass_compspp_notfish1)
  # 
  # 
  #   dat_biomass_compspp_fish <- dat_biomass_compspp %>%
  #     dplyr::filter(fish == TRUE)

nbs_insert <- paste0("Between ", compareyr, " and ", maxyr,

                             ", there were noticeable changes in the benthic community of the NBS. Total CPUE values for many of the animals in the NBS shifted from being low in ", compareyr, " to being much higher in ", maxyr, " The total estimated animal biomass in the NBS increased from ", xunits(sum(biomass_compareyr$biomass[biomass_compareyr$SRVY == "NBS"])) ," t in ", compareyr, " to ", xunits(sum(biomass_maxyr$biomass[biomass_maxyr$SRVY == "NBS"]))," t in ", maxyr, " driven primarily by increases in walleye pollock and Pacific cod. ")

} else {
  nbs_insert <- ""
}

insert <- readtext(paste0(dir_out_rawdata, "/doc_abstract_conclusion.docx"))

```

`r nbs_insert ``r insert$text`



