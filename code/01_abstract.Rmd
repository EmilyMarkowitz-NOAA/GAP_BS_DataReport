
# Abstract

```{r survey_summary}

nbs_str0 <- ifelse(SRVY == "NEBS", 
                   # NBS + EBS
                   paste0("The survey covered the eastern Bering Sea continental shelf (bottom depths between approximately 20 and 200 m) from the Alaska mainland coast to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and the Bering Strait."), 
                   # EBS
                   paste0("The EBS bottom trawl survey covers the Bering Sea continental shelf (bottom depths between approximately 20 and 200 meters (m)) from the Alaska coastline to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and roughly 62° N latitude."))#, 
# "The study area covered the eastern Bering Sea continental shelf from approximately 20 to 200 m bottom depth. Geographically, this area spans from the Alaska coastline to the U.S.-Russia Maritime Boundary between the Alaska Peninsula and roughly 62° N latitude.")


# if (sum(haul_cruises_maxyr$stations_avail == haul_cruises_maxyr$stations_completed) == 1) { # diff answers or only 1 srvy
#   str0 <- text_list(
#     paste0(ifelse(haul_cruises_maxyr$stations_avail ==
#                     haul_cruises_maxyr$stations_completed, "All", "Most"), 
#            " survey stations in the ", 
#            haul_cruises_maxyr$SRVY, 
#            " were sampled successfully"))
# } else { # answers both "Most" or "All"
#   str0 <- paste0(unique(ifelse(haul_cruises_maxyr$stations_avail ==
#                                  haul_cruises_maxyr$stations_completed, "All", "Most")), 
#                  " survey stations in the ",
#                  text_list(haul_cruises_maxyr$SRVY), 
#                  " were sampled successfully")
# } 

temp <- haul_cruises_maxyr # %>%
# dplyr::mutate(
#   survey_name_extra = unlist(lapply(X = strsplit(x = survey_name, split = " - ", fixed = TRUE), "[[", 1)), 
#   survey_name_extra = unlist(lapply(X = strsplit(x = survey_name_extra, split = "Bering Sea ", fixed = TRUE), "[[", 2)))
str1 <- gsub(pattern = " ,", replacement = ",", 
             x = text_list(paste0(temp$yrofsurvey, 
                                  temp$stndth, " ", temp$SRVY_long, " (", temp$SRVY, ") Crab/Groundfish Bottom Trawl Survey"), 
                           sep_last = ", as well as the "))
```

In `r maxyr`, the Resource Assessment and Conservation Engineering (RACE) division of the National Marine Fisheries Service’s (NMFS) Alaska Fisheries Science Center (AFSC) conducted the `r str1`. `r nbs_str0` Survey sampling was conducted using `r (numbers2words(nrow(vessel_info)))` chartered commercial stern trawler`r ifelse(nrow(vessel_info)>1, "s", "")`, the `r text_list(paste0(vessel_info$length_m, "-m ",  vessel_info$vessel_ital)) `. Demersal populations of fishes and invertebrates were sampled by trawling for 30 minutes at stations arranged on a systematic grid, which consisted of `r text_list(paste0(haul_cruises_maxyr$stations_avail, " total stations in the ", haul_cruises_maxyr$SRVY))`. At each station, species composition, sex, length-frequency composition, and age structure samples were collected from ecologically and commercially important fish species. 


```{r }
#| label: abstract_temperature

temp0 <- temps_avg_yr %>% 
  dplyr::filter(year == maxyr) %>% 
  dplyr::mutate(
    dplyr::across(is.numeric, round, digits = 1), 
    bt_case = dplyr::case_when( 
      bt_case == "average" ~ "near", 
      bt_case == "warmer" ~ "above", 
      bt_case == "colder" ~ "below"), 
    st_case = dplyr::case_when(
      st_case == "average" ~ "near", 
      st_case == "warmer" ~ "above", 
      st_case == "colder" ~ "below"))

if (temp0$bt_case == temp0$st_case) {

str0 <- paste0("The ", maxyr, " mean bottom and surface temperatures in the EBS (",
                temp0$bt, "°C and ", temp0$st, "°C) were ",
                temp0$bt_case, # only need to list one
                " the ",
       temp0$bt_mean, "°C and ", temp0$st_mean, 
       "°C time-series average in ",
       maxyr, ", respectively. ")

} else {
  str0 <- ""
  for (i in c("bottom", "surface")){
  str0 <- paste0(str0, 
                  ifelse(i == "bottom", paste0("The ", maxyr), ", while"), 
                  " mean ",i," temperature in the EBS (",
                temp0[ifelse(i == "surface", "st", "bt")], "°C) was ",
                temp0[ifelse(i == "surface", "st_case", "bt_case")]," the ",
       temp0[ifelse(i == "surface", "st_mean", "bt_mean")],
       "°C time-series")
  }
  str0 <- paste0(str01, ". ")
}

if ((temp0$warmest_rank > (nrow(temps_avg_yr)-6)) |  (temp0$warmest_rank < 6)) {
  str0 <- paste0(str0, 
                 "The mean bottom temperatures were the ")
  
  # if this year is within the 6th warmest or coldest years...
  if (temp0$warmest_rank > (nrow(temps_avg_yr)-6)) { # is it of the 5 coldest
    str0 <- paste0(str0, 
                   ifelse(temp0$warmest_rank != nrow(temps_avg_yr), 
                          paste0(numbers2words_th(temp0$warmest_rank), " "), 
                          ""),
                   "coldest")
  }
  
  if (temp$warmest_rank < 6) {  # or is it of the 5 warmest?
    str0 <- paste0(str0, 
                   ifelse(temp0$warmest_rank != 1, 
                          paste0(numbers2words_th(nrow(temps_avg_yr)-temp0$warmest_rank), " "), 
                          ""),
                   "warmest")
  }
  
  str0 <- paste0(str0, 
                 " observed since the beginning of the EBS shelf bottom trawl survey time series in 1982. ")
}
# str0 <- paste0(str0, 
#                paste0("NBS mean surface and bottom temperatures were not calculated because the NBS has only been surveyed ",
#                       numbers2words(x = haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY %in% "NBS"]),
#                       " times since ",
#                       haul_cruises_maxyr$SRVY_start[haul_cruises_maxyr$SRVY %in% "NBS"],". ") )

```

Environmental data, including temperature, salinity, and irradiance were collected at every survey station. `r str0` 

```{r abstract_species_counts}

# count fish spp
temp <- dplyr::left_join(
  x = catch_haul_cruises_maxyr %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct(), 
  y = spp_info %>% 
    dplyr::filter(used_in_counts) %>%
    dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon) %>%
    dplyr::distinct(), 
  by = "species_code") %>% 
  dplyr::filter(taxon == "fish") %>% 
  dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(SRVY, species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(species_code = n()),
  by = "SRVY") %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(family_taxon)) %>% 
      dplyr::select(SRVY, family_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(family_taxon = n()),
    by = "SRVY")  %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(genus_taxon)) %>% 
      dplyr::select(SRVY, genus_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(genus_taxon = n()),
    by = "SRVY") #%>%
# dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

temp1 <- dplyr::bind_cols(
  temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_code = n()), 
  temp %>% 
    dplyr::filter(!is.na(family_taxon)) %>% 
    dplyr::select(family_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(family_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(genus_taxon)) %>% 
    dplyr::select(genus_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(genus_taxon = n())) 

fish_sp <- xunits(temp1$species_code) 
fish_genera <- xunits(temp1$genus_taxon) 
fish_family <- xunits(temp1$family_taxon) 

# count invert spp
temp <- dplyr::left_join(
  x = catch_haul_cruises_maxyr %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct(), 
  y = spp_info %>% 
    dplyr::filter(used_in_counts) %>%
    dplyr::select(species_code, species_taxon, phylum_taxon, genus_taxon, taxon) %>%
    dplyr::distinct(), 
  by = "species_code") %>% 
  dplyr::filter(taxon == "invert") %>% 
  dplyr::select(species_code, species_taxon, phylum_taxon, genus_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(SRVY, species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(species_code = n()),
  by = "SRVY") %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(phylum_taxon)) %>% 
      dplyr::select(SRVY, phylum_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(phylum_taxon = n()),
    by = "SRVY")  %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
      dplyr::filter(!is.na(genus_taxon)) %>% 
      dplyr::select(SRVY, genus_taxon) %>% 
      dplyr::distinct() %>% 
      dplyr::group_by(SRVY) %>%
      dplyr::summarise(genus_taxon = n()),
    by = "SRVY") #%>%
# dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

temp1 <- dplyr::bind_cols(
  temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_code = n()), 
  temp %>% 
    dplyr::filter(!is.na(phylum_taxon)) %>% 
    dplyr::select(phylum_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(phylum_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(genus_taxon)) %>% 
    dplyr::select(genus_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(genus_taxon = n())) 

invert_spp <- xunits(temp1$species_code) 
invert_phyla <- xunits(temp1$phylum_taxon) 

# temp <- spp_info_maxyr %>% 
#   dplyr::filter(used_in_counts == TRUE) 

# temp <- dplyr::left_join(
#   x = catch_haul_cruises_maxyr %>% 
#     dplyr::select(SRVY, species_code) %>% 
#     dplyr::distinct(), 
#   y = spp_info %>% 
#     dplyr::filter(used_in_counts) %>%
#     dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon) %>%
#     dplyr::distinct(), 
#   by = "species_code") %>% 
#   dplyr::filter(taxon == "fish") %>% 
#   dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon, SRVY) %>% 
#   dplyr::distinct()

# fish_sp <- xunits(length(unique(temp$report_name_scientific[
#   temp$taxon == "fish" & 
#     !(grepl(pattern = " sp.", 
#             x = temp$report_name_scientific, fixed = T)) & 
#     !(grepl(pattern = " unid.", x = 
#               temp$report_name_scientific, fixed = T))])))
```


```{r abstract_biomass}
str00 <- ""
# if (SRVY == "NEBS") {
for (i in 1:length(unique(cruises_maxyr$SRVY))){
  
  srvy <- sort(unique(cruises_maxyr$SRVY))[i]
  
  str0 <- paste0(
    "The estimated total biomass in the ", srvy ," ",
    ifelse(sum(biomass_compareyr$biomass[biomass_compareyr$SRVY == srvy]) < 
             sum(biomass_maxyr$biomass[biomass_maxyr$SRVY == srvy]), 
           "increased", "decreased"),
    " from ", 
    xunits(sum(biomass_compareyr$biomass[biomass_compareyr$SRVY == srvy], na.rm = TRUE)) ,
    ifelse(i == 1, " metric tons (t) ", " t "), #"(", xunits(sum(biomass_compareyr$sdbio[biomass_compareyr$SRVY == "NBS"], na.rm = TRUE)) ,
    # " standard deviation (SD) t) ", 
    "in ", compareyr, " to ", 
    xunits(sum(biomass_maxyr$biomass[biomass_maxyr$SRVY == srvy], na.rm = TRUE)),
    " t", # "(", xunits(sum(biomass_maxyr$sdbio[biomass_maxyr$SRVY == "NBS"], na.rm = TRUE)) ,
    # " SD t)", 
    " in ", maxyr)
  
  str00 <- paste0(str00, str0, ". ")
  
}
```

`r str00`A total of `r fish_sp ` species of fish and `r invert_spp ` invertebrate taxa were identified during the `r text_list(SRVY1)` survey`r ifelse(SRVY=="NEBS", "s", "")`.

This report compares the distribution and relative abundance of `r xunits(length(unique(report_spp1$order[report_spp1$taxon == "fish"])))`  fish species and `r xunits(length(unique(report_spp1$order[report_spp1$taxon == "invert"])))` invertebrate taxa with side-by-side maps from the `r compareyr ` and `r maxyr` `r text_list(SRVY1)` shelf bottom trawl surveys. For common fish species, abundance-at-length plots comparing the `r compareyr ` and `r maxyr` `r text_list(SRVY1)` surveys are also presented. Survey results reported herein include estimates of biomass for most fishes and invertebrates, and estimates of population size, geographic distributions, and abundance-at-length of select fish species. Tables in the appendix list population estimates by sex and size group for principal fish species and species encountered during the survey`r ifelse(SRVY=="NEBS", "s", "")`. 

```{r abstract_insert_text, child=paste0(dir_out_rawdata, "/0_abstract_conclusion.Rmd")}
```

\pagebreak
