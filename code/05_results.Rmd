---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE)
```

# Results and Discussion

A total of `r NMFSReports::text_list(paste0(haul_cruises_maxyr$stations_completed, " ", haul_cruises_maxyr$SRVY, " stations")) ` were successfully sampled in `r maxyr` (Figure `r crossref(list_obj = list_figures, nickname = "fig_sampled_survey_stations", sublist = "number")`). Summarized haul and raw catch sample data for successfully trawled stations used in the analyses are listed in Appendixes `r NMFSReports::text_list(NMFSReports::crossref(list_tables, "tab_hauls_catch_", "number", exact = FALSE))` by vessel along with date, time, start and end positions, mean bottom depth, tow duration, distance fished over ground, mean net width, and trawl performance.

## Ocean Conditions

```{r}
temp <- dplyr::left_join(
  x = temps_avg_yr %>% 
    dplyr::filter(year %in% c(maxyr)), 
  y = temps_avg_yr %>% 
    dplyr::filter(year %in% c(lastyr)) %>% 
    dplyr::select(SRVY, bt, st) %>% 
    dplyr::rename(bt_1 = bt,
                  st_1 = st),
  by = "SRVY") %>% 
  dplyr::mutate(bt_diff = (bt_1 - bt)) %>% 
  dplyr::mutate(st_diff = (st_1 - st)) %>% 
  dplyr::mutate(bt_mean_diff = (bt_mean - bt)) %>% 
  dplyr::mutate(st_mean_diff = (st_mean - st)) 

temp2 <- dplyr::left_join(
  x = haul_maxyr, 
  y = station_info, 
  by = c("stratum", "stationid", "SRVY")) %>% 
  dplyr::filter(reg == "Norton Sound")

a <- summary(lm(haul_maxyr$surface_temperature ~ haul_maxyr$start_longitude))
temp3 <- ifelse(a$coefficients[2]<0 & a$coefficients[8] <= 0.05, "surface temperatures increased from east to west across the shelf, and ", "")
```

Sea surface temperatures recorded during the `r maxyr` `r SRVY` survey ranged from `r round(x = min(haul_maxyr$surface_temperature, na.rm = TRUE), digits = 1)`° to `r round(x = max(haul_maxyr$surface_temperature, na.rm = TRUE), digits = 1)`°C and bottom temperatures ranged from `r round(x = min(haul_maxyr$gear_temperature, na.rm = TRUE), digits = 1)`° to `r round(x = max(haul_maxyr$gear_temperature, na.rm = TRUE), digits = 1)`°C. The mean sea surface temperature for the EBS in `r maxyr` was `r round(x = temp$st, digits = 1)`°C, which was `r round(x = temp$st_diff, digits = 1)`°C `r ifelse((temp$st_diff > 0), "lower", "higher")` than `r lastyr` (`r round(x = temp$st_1, digits = 1)`°C) and `r round(x = temp$st_mean_diff, digits = 1)`°C `r ifelse((temp$st_mean_diff > 0), "lower", "higher")` than the time-series mean (`r round(x = temp$st_mean, digits = 1)`°C) (Figure `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')`, `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`, and `r crossref(list_obj = list_figures, nickname = 'fig_st_maxyr', sublist = 'number')`). `r ifelse(SRVY == "NEBS", paste0("In the EBS south of 60° N, ", temp3,"an average of ", round(x = mean(temp2$surface_temperature), digits = 1),"°C was observed in the NBS's Norton Sound (Figure ", crossref(list_obj = list_figures, nickname = 'fig_st_maxyr', sublist = 'number'), ")."), "")`

`r list_figures$fig_mean_temperature$res `

`r list_figures$fig_cold_pool_area$res `

`r list_figures$fig_st_maxyr$res `

During the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"]`-year time series (`r haul_cruises_maxyr$SRVY_start[haul_cruises_maxyr$SRVY == "EBS"] `–`r maxyr`) of the annual EBS shelf bottom trawl survey, mean summer bottom temperatures were highly variable, ranging from a low of `r round(x = min(temps_avg_yr$bt), digits = 1)`°C to a high of `r round(x = max(temps_avg_yr$bt), digits = 1)`°C, with a grand mean for all years of `r round(x = min(temps_avg_yr$bt_mean[1]), digits = 1)`°C (Figure `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')`). The mean survey bottom temperature for the EBS in `r maxyr` was `r round(x = (temps_avg_yr_maxyr$bt), digits = 1)`°C (Figure `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')`), which was `r round(x = abs(temp$bt_mean_diff), digits = 1) `°C `r ifelse(temps_avg_yr_maxyr$bt_above_mean, "warmer", "colder")` than the time-series mean.

The size of the cold pool each summer depends on sea ice coverage from the previous winter, the timing of its retreat during the spring and early summer as well as other oceanographic and meteorological conditions [@RN941]. During the coldest years, sea ice extended farther south and lasted later into spring resulting in cold pools that extended farther south down the middle domain into Bristol Bay and near the Alaska Peninsula (Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_below', sublist = 'number')` and `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_above', sublist = 'number')`). Interannual variability in the dynamics of seasonal ice is a major environmental driver on the Bering Sea shelf [@RN930; @RN931; @RN932] that can change recruitment and migration patterns and cause major distributional shifts in groundfishes and crabs [@RN905; @RN913; @RN977]. 

```{r}
temp <- cold_pool_area %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(perc = sum(perc, na.rm = T), 
                   freq = sum(freq, na.rm = T)) %>% 
  dplyr::mutate(area_km2 = (perc/100) * 
                  sum(stratum_info %>% 
                        dplyr::filter(SRVY == "EBS") %>% 
                        dplyr::select(area_km2), na.rm = TRUE)) %>%
  dplyr::arrange((perc)) %>% 
  dplyr::mutate(rank = 1:nrow(.)) %>% 
  dplyr::arrange(desc(year))

```
During the last `r length(unlist(temps_avg_yr_abovebelow)[!is.na(unlist(temps_avg_yr_abovebelow))])` years, `r NMFSReports::range_text(x = temps_avg_yr_abovebelow$below)` were colder than average ("cold stanza"; Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_below', sublist = 'number')`), and `r NMFSReports::range_text(x = temps_avg_yr_abovebelow$above)` were warmer than average ("warm stanza"; Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_above', sublist = 'number')`). `r ifelse((maxyr>2020 & maxyr<(2021+length(unlist(temps_avg_yr_abovebelow)[!is.na(unlist(temps_avg_yr_abovebelow))]))), "There was no survey in 2020 due to the COVID-19 pandemic. ", )`The highly variable survey bottom temperatures in the EBS shelf are related to the area occupied by the summer cold pool (Figure `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`), defined by the extent of bottom temperatures below 2°C. Over the period of the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"] `-year time series, the areal coverage of the summer survey cold pool in the EBS varied in size from `r NMFSReports::xunits(min(temp$area_km2, na.rm = TRUE)) ` km^2^ in `r temp$year[temp$area_km2 == min(temp$area_km2, na.rm = TRUE)] ` to `r NMFSReports::xunits(max(temp$area_km2, na.rm = TRUE)) ` km^2^ in `r temp$year[temp$area_km2 == max(temp$area_km2, na.rm = TRUE)] `, respectively comprising `r round(temp$perc[temp$area_km2 == min(temp$area_km2, na.rm = TRUE)], digits = 1)`% to `r round(temp$perc[temp$area_km2 == max(temp$area_km2, na.rm = TRUE)], digits = 1)`% of EBS shelf area (Figure `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`). In `r maxyr`, the cold pool covered `r round(temp$perc[temp$year == maxyr], digits = 1) `% of the EBS shelf survey area `r formatC(temp$area_km2[temp$year == maxyr], digits = 0, big.mark = ",", format = "f") ` km^2^, which was the `r NMFSReports::numbers2words_th(temp$rank[temp$year == maxyr])` lowest areal coverage in the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"] `-year EBS shelf time series.

`r list_figures$fig_bt_timeseries_below$res `

`r list_figures$fig_bt_timeseries_above$res `


```{r}
# insert <- readtext(file = paste0(dir_out_rawdata, "/doc_abstract_conclusion.docx"))
insert <- readtext2(file = paste0(dir_out_rawdata, "/0_cold_pool_description.docx"), 
                    refcontent = refcontent)
```

`r insert`

## Survey Data and Specimen Collections 

```{r}
temp <- function(cols, SRVY){
  nspec <- c()
  ntaxa <- c()
  ctaxa <- c()
  a <- report_spp1
  a$taxon[a$taxon == "invert" & 
            grepl(pattern = "crab", x = a$print_name)] <- "crab"
  
  for (i in 1:length(cols)){
    
    col <- cols[i]
    if (SRVY == "NEBS") {
      temp <- dplyr::bind_rows(
        crossref(list_obj = list_tables, 
                 nickname = "tab_specimen_samples_EBS", sublist = "raw")[[1]], 
        crossref(list_obj = list_tables, 
                 nickname = "tab_specimen_samples_NBS", sublist = "raw")[[1]])      
    } else {
      temp <- crossref(list_obj = list_tables, 
                       nickname = "tab_specimen_samples_EBS", sublist = "raw")[[1]]      
    }
    
    temp <- temp[temp[,col]!=0,]
    
    nspec <- c(nspec, 
               xunits(sum(temp[temp$common_name == "Total", 
                               names(temp) %in% col]))) # how many specimen
    ntaxa <- c(ntaxa, 
               xunits(length(unique(temp$common_name)[unique(temp$common_name) != "Total"]))) # number of taxa
    
    ctaxa <- c(ctaxa,
               NMFSReports::text_list(unique(a$taxon[a$print_name %in% 
                                                       unique(temp$common_name)])) )
  }
  
  return(list("col" = tolower(cols), 
              "nspec" = nspec, 
              "ctaxa" = ctaxa, # kinds of taxa
              "ntaxa" = ntaxa))
}

cols <- names(crossref(list_obj = list_tables, 
                       nickname = "tab_specimen_samples_EBS", sublist = "raw")[[1]])
cols <- cols[!(cols %in% c("common_name", "SRVY"))]

# "", "stomachs collected"	count_pathobiology_samples	count_fecundity_and_maturity_(ovaries)_samples

temp <- temp(cols, SRVY)

str <- paste0("A total of ", NMFSReports::text_list(paste0(temp$nspec, " ", temp$col, " were collected from ", temp$ntaxa, " ", temp$ctaxa, ifelse(temp$ntaxa==1, " taxon", " taxa"))), ". ")

```

During the `r SRVY` (Table`r ifelse(SRVY == "NEBS", "s", "")` `r crossref(list_obj = list_tables, nickname = "tab_specimen_samples_EBS", sublist = "number") ``r ifelse(SRVY == "NEBS", paste0(" and ", crossref(list_obj = list_tables, nickname = "tab_specimen_samples_NBS", sublist = "number")), "")`) trawl survey`r ifelse(SRVY == "NEBS", "s", "")` many samples were collected. `r str` Other special collections are listed in table `r crossref(list_obj = list_tables, nickname = "tab_special_projects", sublist = "number")`. 

## Species Composition

```{r}
insert <- ""

# No. fish spp
temp <- spp_info_maxyr %>% 
  dplyr::filter(used_in_counts == TRUE) 

fish_sp <- xunits(length(unique(temp$report_name_scientific[temp$taxon == "fish" & 
                                                              !(grepl(pattern = " sp.", x = temp$report_name_scientific, fixed = T)) & 
                                                              !(grepl(pattern = " unid.", x = temp$report_name_scientific, fixed = T))])))


if (SRVY == "NEBS") {
  
  temp0 <- list_tables$tab_species_composition$raw %>% 
    dplyr::left_join(x = ., 
                     y = spp_info %>% 
                       dplyr::select(species_code, order_taxon, species_name), 
                     by = c("species_code"))
  
  
  insert <- paste0("The EBS had a total of ",
                   xunits(nrow(temp0[!is.na(temp0$EBS),])),
                   " fish species, ", 
                   xunits(nrow(temp0[temp0$where == 
                                       "Present in EBS but absent in NBS",])), 
                   " of which did not occur in the NBS (Table ",
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"),
                   "). In comparison, the NBS had ",
                   xunits(nrow(temp0[!is.na(temp0$NBS),])),
                   " total fish species, ", 
                   xunits(nrow(temp0[temp0$where == 
                                       "Present in NBS but absent in EBS",])), 
                   " of which did not occur in the EBS (Table ", 
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"), "). ",
                   xunits(nrow(temp0[temp0$where == 
                                       "Present in NBS but absent in EBS" & 
                                       temp0$NBS == TRUE,])),
                   " of the ", 
                   xunits(nrow(temp0[temp0$where == 
                                       "Present in NBS but absent in EBS",])), 
                   " species observed in the NBS during ",maxyr," (Table ", 
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"), ") are only documented north of 60° N, which are generally corroborated in @RN912. ")
  
  # flatfish
  temp1 <- temp0[temp0$order_taxon %in% c("Pleuronectiformes"), ]
  temp2 <- temp1 %>% 
    dplyr::filter(where != "Present in EBS and NBS") %>% 
    dplyr::group_by(where) %>% 
    dplyr::summarise(n = n()) %>% 
    dplyr::mutate(where = paste0(tolower(substr(x = where, start = 1, stop = 1)), 
                                 substr(x = where, start = 2, stop = nchar(where))), 
                  including = NA)
  for (i in 1:nrow(temp2)) {
    temp2$including[i] <- 
      NMFSReports::text_list(
        paste0(
          temp1$common_name[grepl(pattern = temp2$where[i], 
                                  x = temp1$where, 
                                  ignore.case = TRUE)], 
          " (*", 
          temp1$species_name[grepl(pattern = temp2$where[i], 
                                   x = temp1$where, 
                                   ignore.case = TRUE)],
          "*)"))
  }
  
  insert <- paste0(insert, "In ", maxyr, " ", 
                   
                   NMFSReports::text_list(
                     paste0(xunits(temp2$n), 
                            " flatfish species that were ", 
                            temp2$where, " including ",
                            temp2$including )),
                   " (Table ", 
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"), ").")
}
```

In the `r SRVY`, a total of `r fish_sp ` species of fishes were identified, representing `r xunits(length(unique(temp$family_taxon[temp$taxon == "fish"])))` families and `r xunits(length(unique(temp$genus_taxon[temp$taxon == "fish"])))` genera were identified from catch samples taken in `r ifelse(SRVY == "NEBS", "each", "the")` survey area (`r NMFSReports::text_list(NMFSReports::crossref(list_tables, "tab_taxa_encountered_", "number", exact = FALSE))`). `r insert`

```{r}
# No. fish spp
temp <- spp_info_maxyr %>% 
  dplyr::filter(used_in_counts == TRUE) 

invert_sp <- xunits(length(unique(temp$report_name_scientific[temp$taxon == "invert" & 
                                                                !(grepl(pattern = " sp.", x = temp$report_name_scientific, fixed = T)) & 
                                                                !(grepl(pattern = " unid.", x = temp$report_name_scientific, fixed = T))])))
```

`r list_tables$tab_species_composition$res `

```{r}
temp <- dplyr::left_join(x = catch_haul_cruises, 
                         y = spp_info, 
                         by = "species_code") %>% 
  dplyr::filter(taxon == "invert") %>% 
  dplyr::select(species_code, species_taxon, phylum_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_code = n()), 
  by = "SRVY") %>% 
  dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

```

A total of `r invert_sp ` different invertebrate taxa representing `r xunits(length(unique(temp$phylum_taxon[temp$taxon == "invert"])))` phyla were identified in the combined catch samples taken from the EBS (`r NMFSReports::crossref(list_tables, "tab_taxa_encountered_EBS_invertebrate", "number")`)`r ifelse(SRVY == "NEBS", paste0(" and NBS (",NMFSReports::crossref(list_tables, "tab_taxa_encountered_NBS_invertebrate", "number"),")", ""))`. In `r maxyr`, `r NMFSReports::text_list(paste0("the ", temp0$SRVY, " had a total of ", xunits(temp0$species_code), " taxa of which ", xunits(temp0$species_taxon), " were identified to the species level"))`. The remaining of invertebrate taxa in each survey area were identified to the genus level or higher. The lack of species level identifications among invertebrates was due to a variety of factors that are outlined in @RN934.

All species are identified using and logged in AFSC’s databases as (Eschmeyer’s Catalog of Fishes)[https://www.calacademy.org/scientists/projects/eschmeyers-catalog-of-fishes] which is regularly updated [@Frickeetal2022] and An Annotated Checklist of the Marine Macroinvertebrates of Alaska [@Drummetal2016].

## Total Biomass and Relative Biomass and Relative Abundance Catch per Unit Effort

```{r}
temp <- data.frame()
temp0 <- tidyr::crossing(SRVY = SRVY1, type = c("fish", "invert"))
for (i in 1:nrow(temp0)) {
  temp <- list_tables[names(list_tables) ==
                        paste0("tab_biomass_est_",temp0$type[i],"_", temp0$SRVY[i])][[1]]$raw %>%
    dplyr::mutate(SRVY = temp0$SRVY[i]) %>%
    dplyr::filter(grepl(pattern = "Total ", x = group, ignore.case = TRUE )) %>% 
    dplyr::select(SRVY, group, `999`) %>% 
    dplyr::bind_rows(temp, .)
}

temp2 <- dplyr::left_join(
  x = temp, 
  y = total_biomass %>% 
    dplyr::group_by(SRVY),
  by = "SRVY") %>% 
  dplyr::mutate(
    prop = (`999`/total), 
    perc = paste0(formatC(x = prop*100, 
                          digits = 0, format = "f", big.mark = ","), 
                  "%"), 
    group = gsub(pattern = "Total ", replacement = "", x = group)) %>% 
  tidyr::pivot_wider(id_cols = "SRVY", 
                     names_from = "group", 
                     values_from = c("999", "perc", "prop"))

temp1 <- left_join(
  x = temp, 
  y = stratum_info %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(area = sum(area, na.rm = TRUE)), 
  by = "SRVY") %>% 
  dplyr::mutate(prop = `999`/area, 
                group = gsub(pattern = "Total ", replacement = "", x = group)) %>% 
  dplyr::filter(group == "fish")

str0 <- paste0("Total demersal animal biomass for the ", 
               NMFSReports::text_list(
                 paste0(total_biomass$SRVY, 
                        " was estimated at ", 
                        NMFSReports::xunits(total_biomass$total), 
                        " metric tons (t)")), ". ", 
               
               NMFSReports::text_list(
                 paste0("In the ", temp2$SRVY, 
                        " the proportion of fishes (", 
                        temp2$perc_fish, 
                        "; ", crossref(list_obj = list_tables, 
                                       nickname = paste0("tab_biomass_est_fish_", temp2$SRVY), 
                                       sublist = "number"), 
                        ") was ", 
                        ifelse(temp2$prop_fish>temp2$prop_invertebrates, "higher","lower"),
                        " than invertebrates (", 
                        temp2$perc_invertebrates, 
                        "; ", crossref(list_obj = list_tables, 
                                       nickname = paste0("tab_biomass_est_invert_", temp2$SRVY), 
                                       sublist = "number"), 
                        ")")), ". ")

if (SRVY == "NEBS") {
  str0 <- paste0(str0, 
                 paste0(ifelse(temp1$prop[temp1$SRVY=="EBS"]>temp1$prop[temp1$SRVY=="NBS"], 
                               "The lower fish biomass in the NBS than in the EBS is consistent", 
                               "The higher fish biomass in the NBS than in the EBS is inconsistent"), 
                        " with results of a broader analysis of all survey years showing decreasing fish biomass with increasing latitude on the Bering Sea continental shelf [@RN936]", 
                        crossref(list_obj = list_tables, 
                                       nickname = "tab_biomass_est_fish_", 
                                       sublist = "number", 
                                 exact = FALSE),".", 
                        "") ) 
}
```

`r str0 `

```{r}
if (SRVY == "NEBS") {
  
  #temp1
  temp1 <- data.frame()
  for (i in 1:length(SRVY1)) {
    
    temp1 <- list_tables[names(list_tables) ==
                           paste0("tab_biomass_est_fish_", SRVY1[i])][[1]]$raw %>%
      dplyr::mutate(SRVY = SRVY1[i]) %>%
      dplyr::filter(is.na(taxon) |
                      grepl(pattern = "Total ", x = taxon, ignore.case = TRUE )) %>% 
      dplyr::filter(!grepl(pattern = "Total ", x = group, ignore.case = TRUE ) &
                      !grepl(pattern = "Other ", x = group, ignore.case = TRUE )) %>% 
      dplyr::select(SRVY, group, `999`, prop) %>% 
      dplyr::arrange(-prop) %>% 
      dplyr::mutate(order = 1:nrow(.)) %>% 
      dplyr::bind_rows(temp1, .)
  }
  
  temp1 <- temp1 %>% 
    tidyr::pivot_wider(id_cols = c("group"), 
                       names_from = "SRVY", 
                       values_from = c("999", "prop", "order")) %>%
    dplyr::mutate(same =ifelse(order_EBS == order_NBS, TRUE, FALSE))
  
  # temp2
  temp2 <- data.frame()
  
  for (i in 1:length(SRVY1)) {
    
    temp2 <- list_tables[names(list_tables) ==
                           paste0("tab_biomass_est_fish_", SRVY1[i])][[1]]$raw %>%
      dplyr::mutate(SRVY = SRVY1[i]) %>%
      dplyr::filter(group %in% temp1$group[1:2] & 
                      !grepl(pattern = "Total ", x = taxon, ignore.case = TRUE )) %>% 
      dplyr::select(SRVY, group, taxon, `999`, prop) %>% 
      dplyr::arrange(-prop) %>% 
      dplyr::mutate(order = 1:nrow(.)) %>% 
      dplyr::bind_rows(temp2, .)
  }
  
  temp2 <- temp2 %>% 
    tidyr::pivot_wider(id_cols = c("group", "taxon"), 
                       names_from = "SRVY", 
                       values_from = c("999", "prop", "order")) %>%
    dplyr::mutate(same =ifelse(order_EBS == order_NBS, TRUE, FALSE)) %>% 
    dplyr::left_join(
      x = ., 
      y = spp_info_maxyr %>% 
        dplyr::select(species_name, common_name), 
      by = c("taxon" = "common_name")
    )
  
  # temp3: top 3 spp in each group
  temp3 <- data.frame()
  temp0 <- tidyr::crossing(group = unique(temp2$group), 
                           SRVY = SRVY1) %>% 
    dplyr::arrange(SRVY, group) %>% 
    dplyr::mutate(str0 = NA)
  
  for (i in 1:nrow(temp0)) {
    temp3 <- temp2 %>% 
      dplyr::rename(prop = paste0("prop_", temp0$SRVY[i]), 
                    order = paste0("order_", temp0$SRVY[i])) %>%
      dplyr::filter(#order %in% c(1:3) & 
        group == temp0$group[i]) %>% 
      head(3) %>%
      dplyr::mutate(prop = paste0(round(x = prop*100, digits = 1), "%"), 
                    SRVY = temp0$SRVY[i]) %>%
      dplyr::arrange(order) %>% 
      dplyr::select(SRVY, group, taxon, species_name, prop) %>% 
      dplyr::filter(prop != "0%")
    # dplyr::bind_rows(temp3, .)
    
    if (nrow(temp3)>1) {
      temp0$str0[temp0$SRVY == temp0$SRVY[i] & temp0$group == temp0$group[i]] <- 
        NMFSReports::text_list(paste0(temp3$taxon, " (*", temp3$species_name, 
                                      "*; ",temp3$prop,")"))
      temp0$group0 <- unlist(regmatches(temp0$group, 
                                        gregexpr("(?<=\\().*?(?=\\))", 
                                                 temp0$group, perl=T)))
    }
  }
  
  temp0$str0 <- gsub(pattern = "*NA*; ", replacement = "", x = temp0$str0, fixed = TRUE)
  temp0$str0 <- gsub(pattern = "  ", replacement = " ", x = temp0$str0, fixed = TRUE)
  
  temp3 <- c()
  for (i in 1:length(SRVY1)){
    temp3 <- paste0(temp3, 
                    paste0("In the ", SRVY1[i], " ", 
                           NMFSReports::text_list(paste0(
                             temp0$group0[temp0$SRVY == SRVY1[i]], 
                             " comprised of ", 
                             temp0$str0[temp0$SRVY == SRVY1[i]])), 
                           " (", 
                           NMFSReports::crossref(list_obj = list_tables, sublist = "number", 
                                                 nickname = "tab_biomass_est_fish_EBS"), 
                           " and ", 
                           NMFSReports::crossref(list_obj = list_tables, sublist = "number", 
                                                 nickname = "tab_biomass_est_fish_NBS"), 
                           "). "))
  }
  
  str0 <- paste0(
    "The biomass of ",
    NMFSReports::text_list(temp1$group[1:2]),
    " were the greatest in both the EBS (",
    NMFSReports::text_list(
      paste0(round(x = temp1$prop_EBS[1:2]*100, digits = 1), "%")), 
    " of the total biomass, respectively) and NBS (",
    NMFSReports::text_list(
      paste0(round(x = temp1$prop_NBS[1:2]*100, digits = 1), "%")), 
    " of the total biomass, respectively; ", 
    NMFSReports::crossref(list_obj = list_tables, sublist = "number", nickname = "tab_biomass_est_fish_EBS"), 
    " and ", 
    NMFSReports::crossref(list_obj = list_tables, sublist = "number", nickname = "tab_biomass_est_fish_NBS"), "). ", 
    temp3)
  
  
  # In the EBS, there were 15 different flatfish species that together comprised almost half of the total fish biomass (48%) with yellowfin sole (22%) and northern rock sole (11%) having the greatest proportions. This contrasted with the NBS where there were twelve flatfish species with yellowfin sole (15%) and Alaska plaice (12%) making up a majority of the total fish biomass. 
  
  # redundant - species composition
  # Four flatfish species that were present in the EBS were absent from catches in the NBS including arrowtooth flounder, butter sole (Isopsetta isolepis), rex sole (Glyptocephalus zachirus) and southern rock sole (Table 4). One flatfish species, the Arctic flounder (Liopsetta glacialis), was only present in the NBS.
  
}

```

`r str0 ` The abundance of walleye pollock was relatively high in the `r SRVY ` middle and outer shelf compared to the inner shelf and in the NBS where bottom depths are generally less than 50 m (Figure `r ifelse(SRVY == "NEBS", crossref(list_obj = list_tables, nickname = "tab_biomass_est_fish_NBS", sublist = "number"), "") `). Unlike the `r SRVY `, saffron cod (*Eleginus gracilis*), was among the 12 most abundant fish species in the NBS, and Arctic cod (*Boreogadus saida*) was the 18th most abundant. For a descending rank of all organisms caught, see `r crossref(list_obj = list_tables, nickname = "tab_taxa_encountered_EBS_fish", sublist = "number")``r ifelse(SRVY == "NEBS", paste0(" (EBS) and ", crossref(list_obj = list_tables, nickname = "tab_taxa_encountered_EBS_fish", sublist = "number"), " (NBS)"), "") `.

<!-- Walleye pollock and Pacific cod together comprised 44% of the total fish biomass in the EBS compared to only 57% in the NBS. The abundance of walleye pollock was relatively high in the EBS middle and outer shelf compared to the inner shelf and in the NBS where bottom depths are generally less than 50 m (Figure 7). Unlike the EBS, saffron cod (Eleginus gracilis), was among the 12 most abundant fish species in the NBS, and Arctic cod (Boreogadus saida) was the 18th most abundant. For a descending rank of all organisms caught in each area, see Appendix B1 (EBS) and Appendix B2 (NBS). -->

`r list_tables$tab_biomass_est_fish_EBS$res `

`r ifelse(SRVY == "NEBS", list_tables$tab_biomass_est_fish_NBS$res, "") `

`r list_tables$tab_biomass_est_invert_EBS$res `

`r ifelse(SRVY == "NEBS", list_tables$tab_biomass_est_invert_NBS$res, "") `

Between `r compareyr` and `r maxyr`, there were noticeable changes in the benthic community of the NBS (Table `r crossref(list_obj = list_tables, nickname = "tab_majortaxa_pchange_NBS", sublist = "number")`). 
<!-- Total CPUE values for the NBS were lower than for the EBS in 2010 but shifted to higher than the EBS in 2017 [@RN936]. -->
The total estimated biomass in the NBS increased from 3.0 million t in 2010 to 4.5 million t in 2017 driven primarily by increases in walleye pollock (1.3 million t) and Pacific cod (254 thousand t). Other taxa that significantly increased included jellyfishes (405%), sea urchins (233%), blue king crab (199%), shorthorn sculpin (185%), and northern rock sole (162%; Table 7). Large decreases in biomass were observed for Arctic cod (-90%), tunicates (-72%), smelts (-69%), basket seastars (-45%), brittle stars (-42%), corals (-32%), snow crab (-30%), Pacific halibut (-22%), saffron cod (-17%), and red king crab (-8%). Although there were large percentage increases in biomass for many invertebrate taxa, there was relatively little change in the combined total biomass of invertebrates (-0.2 million t) compared to 2010 (Table 6a).

`r list_tables$tab_majortaxa_pchange_EBS$res `

`r ifelse(SRVY == "NEBS", list_tables$tab_majortaxa_pchange_NBS$res, "") `

<!-- ## Biomass, Abundance, Distribution, CPUE, and Size Composition of Principal Species and Species Groups -->


> Why 12? changed it to 10 because it felt more natural

> shouldnt we use kg/km2

```{r}

temp <- data.frame()
for (i in 1:nrow(haul_cruises_maxyr)) {
  
  temp1 <- cpue_maxyr %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>% 
    dplyr::select(cpue_kgha, species_code, taxon) %>%
    dplyr::group_by(species_code, taxon) %>% 
    dplyr::summarise(cpue_kgha = sum(cpue_kgha, na.rm = TRUE)) %>%
    dplyr::arrange(-cpue_kgha) %>% 
    dplyr::ungroup()
  
  temp <- rbind.data.frame(
    temp,
    data.frame(
      SRVY = haul_cruises_maxyr$SRVY[i], 
      fish = temp1 %>% # sum of all fish
        dplyr::filter(taxon == "fish") %>%
        dplyr::summarise(cpue_kgha = sum(cpue_kgha)) %>% 
        as.numeric(), 
      invert = temp1 %>% # sum of all invert
        dplyr::filter(taxon == "invert") %>%
        dplyr::summarise(cpue_kgha = sum(cpue_kgha)) %>% 
        as.numeric(), 
      all = temp1 %>% # sum of all taxon ever
        dplyr::summarise(cpue_kgha = sum(cpue_kgha)) %>% 
        as.numeric(), 
      topfish = temp1 %>% # sum of the top 12 fish
        dplyr::filter(taxon == "fish") %>%
        head(12) %>%
        dplyr::summarise(cpue_kgha = sum(cpue_kgha)) %>% 
        as.numeric()))
}  
temp <- temp %>% 
  dplyr::mutate(top_fish = paste0(round(x = (temp$topfish/temp$fish)*100, digits = 0), "%"), 
                top_all = paste0(round(x = (temp$topfish/temp$all)*100, digits = 0), "%"), 
                across(where(is.numeric), format, digits = 0, trim = F, big.mark = ",", scientific = F))
# temp[,1:4]<-NMFSReports::mod_number(x = temp[,1:4], comma_seperator = T, digits = 0)
temp[,2:5] <- format(temp[,2:5], digits = 0, trim = F, big.mark = ",", scientific = F)


# top12 <- data.frame()
# top12_tot <- data.frame()
# 
# for (i in 1:length(SRVY1)) {
#   
#   top12_ <- list_tables[names(list_tables) == 
#                          paste0("tab_biomass_est_fish_", SRVY1[i])][[1]]$raw %>% 
#       dplyr::mutate(SRVY = SRVY1[i]) %>% 
#   dplyr::select(SRVY, group, taxon, prop, `999`) %>% 
#   dplyr::filter(!grepl(pattern = "Total ", x = group, ignore.case = TRUE) & 
#                   !grepl(pattern = "Total ", x = group, ignore.case = TRUE) & 
#                   !grepl(pattern = "Total ", x = taxon, ignore.case = TRUE) & 
#                   !grepl(pattern = "Other ", x = taxon, ignore.case = TRUE)) %>%
#   dplyr::group_by(SRVY) %>%
#   dplyr::arrange(SRVY, -prop) %>% 
#   dplyr::mutate(prop_cumsum = cumsum(prop*100), 
#                 taxon = ifelse(is.na(taxon), group, taxon)) %>% 
#   head(10) 
#   
#   top12 <- dplyr::bind_rows(top12, top12_)
# 
# top12_tot_ <- top12 %>% 
#   dplyr::group_by(SRVY) %>%
#   dplyr::summarise(perc = formatC(x = sum(prop, na.rm = TRUE)*100, 
#                                   digits = 1, big.mark = ",", format = "f"), 
#                    bio = formatC(x = sum(`999`, na.rm = TRUE), digits = 0, 
#                                  big.mark = ",", format = "f"))
# 
#   top12_tot <- dplyr::bind_rows(top12_tot, top12_tot_)
# 
# }
```

<!-- The top 12 fish taxa in the EBS accounted for 73% (243 kg/ha) of total catch CPUE (335 kg/ha) and 97% of total fish CPUE (252 kg/ha), compared with the NBS where the top 12 fish taxa accounted for only 61% (140 kg/ha) of the total catch CPUE (228 kg/ha) and 98% of total fish CPUE (143 kg/ha). -->

`r NMFSReports::text_list(paste0("Of the top 10 fish taxa in the ",temp$SRVY," accounted for ",temp$top_all," (",temp$topfish," kg/ha) of total catch CPUE (",temp$all," kg/ha) and ",temp$top_fish," of total fish CPUE (",temp$fish," kg/ha)")) `

```{r}
# This trend was similarly true in the NBS where the proportion of fishes (63%; Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_fish_NBS", sublist = "number")`) was greater than invertebrates (37%; Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_invert_NBS", sublist = "number")`). Pleuronectids dominated the fish biomass in both the EBS (6.0 million t) and NBS (0.9 million t), and gadids were the second most abundant fish group in both areas. Walleye pollock were the most abundant gadid in both the `r SRVY ` and NBS (Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_fish_EBS", sublist = "number")` and 6a). Echinoderms and crustaceans were the major invertebrate taxa comprising 16% of the total animal biomass in the `r SRVY ` (Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_invert_EBS", sublist = "number")`) and 25% in the NBS (Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_invert_NBS", sublist = "number")`).
```


Survey results for major fish fauna are presented in maps of geographic distribution and abundance, plots of total abundance-at-size, and tables with estimates of biomass and population number (Table `r crossref(list_obj = list_tables, nickname = "tab_estimates_maxyr_spp_EBS", sublist = "number")``r ifelse(SRVY == "NEBS", paste0(" and ", crossref(list_obj = list_tables, nickname = "tab_estimates_maxyr_spp_NBS", sublist = "number")), "")`). Major species presented include walleye pollock (Figures 7-8 and Table 7a, b), Pacific cod (Figures 9-10 and Table 8a, b), yellowfin sole (Figures 11-12 and Table 9a, b), northern rock sole (Figures 13-14 and Table 10a, b), flathead sole (Figures 15-16 and Table 11a, b), Bering flounder (Figures 17-18 and Table 12a, b), Alaska plaice (Figures 19-20 and Table 13a, b), Greenland turbot (Figures 21-22 and Table 14a, b), arrowtooth flounder (Figures 23-24 and Table 15a, b), Kamchatka flounder (Figures 25-26 and Table 16a, b), and Pacific halibut (Figures 27-28 and Table 17a, b). Mean CPUE by weight and number and maps of geographic distribution for many other species are also included (Tables 18-19, Figures 29-61). Appendix D (`r NMFSReports::text_list(NMFSReports::crossref(list_tables, "tab_principal_fish_", "number", exact = FALSE))`) contains population estimates by sex and size class for all 11 of these fish species. 

> test

`r NMFSReports::crossref(list_tables, "tab_estimates_maxyr_spp_", "number", exact = FALSE)`

<!-- `r list_tables$tab_estimates_maxyr_spp_EBS$res ` -->

<!-- `r ifelse(SRVY == "NEBS", list_tables$tab_estimates_maxyr_spp_NBS$res, "") ` -->

Total biomass and population size were estimated for an additional 24 fish species that were common in either the `r SRVY ` and NBS or both (Tables 18 to 19). For each of the 24 species, there is a corresponding map showing the geographic distribution and relative abundance (Figures 29 to 53). 

## Spatial Distribution of Selected Invertebrates

> from 2018

Plots of the broad spatial distribution patterns for eight major invertebrates on the combined `r SRVY ` and NBS continental shelf are presented in Figures 54 to 61. The purple sea star, (Asterias amurensis), is common in the Bering and Chukchi Seas (Hamizaki et al. 2005, Feder et al. 2005) and it was the invertebrate taxon with the highest ranked catch rate by weight in both the `r SRVY ` and NBS. Catch rates for the purple sea star were highest in the middle shelf between the Pribilof Islands and Nunivak Island and along the inner shelf from Bristol Bay to the Bering Strait (Figure 61). 

Figures 54 to 57 show the shelf-wide distributions of the four major commercial crab species: blue king crab, red king crab, snow crab (Chionoecetes opilio), and Tanner crab (Chionoecetes bairdi). Commercial crab stocks are managed by the ADF&G with federal oversight by NMFS. For more detailed information on BT survey results for commercial crab refer to Chilton et al. (2011), and for the most recent modeling data on the status of these commercial crab stocks, refer to the annual Stock Assessment and Fishery Evaluation report prepared by the NPFMC. 

> from 2017

Plots of distribution for seven major invertebrate taxa are presented in Figures 55 to 61 including the purple sea star (Asterias amurensis), northern neptune snail (Neptunea heros), jellyfishes (Scyphozoa), red king crab (Paralithodes camtschaticus), blue king crab (P. platypus), snow crab (Chionoecetes opilio), and Tanner crab (C. bairdi). These last four plots are the major commercial crab species in Alaska. Commercial crab stocks are managed by the ADF&G with federal oversight by NMFS. For more detailed information on bottom trawl survey results for commercial crab refer to Lang et al. (2018), and for the most recent modeling data on the status of these commercial crab stocks, refer to the annual Stock Assessment and Fishery Evaluation report prepared by the NPFMC. 

An interactive map of CPUE by species overlaid with temperature data for the 2017 EBS and NBS surveys, as well as all for other AFSC bottom trawls surveys, can be found at https://www.afsc.noaa.gov/RACE/groundfish/survey_data/default.htm. The CPUE data with associated station information that includes position, surface and bottom temperatures, and bottom depth can be downloaded from https://www.fisheries.noaa.gov/alaska/commercial-fishing/alaska-groundfish-bottom-trawl-survey-data.

## Summary of Results for Selected `r NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)` Fish and Invertebrate Fauna




