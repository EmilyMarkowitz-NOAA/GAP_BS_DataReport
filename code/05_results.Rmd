---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE)
```

# Results and Discussion

> problem with "time" in appendix 5 - I couldnt find that data in the haul table/it came up weird?

A total of `r NMFSReports::text_list(paste0(haul_cruises_maxyr$stations_completed, " ", haul_cruises_maxyr$SRVY, " stations")) ` were successfully sampled in `r maxyr` (Figure `r crossref(list_obj = list_figures, nickname = "fig_sampled_survey_stations", sublist = "number")`). Summarized haul and raw catch sample data for successfully trawled stations used in the analyses are listed in appendices `r NMFSReports::crossref(list_tables, "tab_hauls_catch_", "number", exact = FALSE)` by vessel along with date, time, start and end positions, mean bottom depth, tow duration, distance fished over ground, mean net width, and trawl performance.

## Ocean Conditions

```{r}
temp <- dplyr::left_join(
  x = temps_avg_yr %>% 
    dplyr::filter(year %in% c(maxyr)), 
  y = temps_avg_yr %>% 
    dplyr::filter(year %in% c(lastyr)) %>% 
    dplyr::select(SRVY, bt, st) %>% 
    dplyr::rename(bt_1 = bt,
                  st_1 = st),
  by = "SRVY") %>% 
  dplyr::mutate(bt_diff = (bt_1 - bt)) %>% 
  dplyr::mutate(st_diff = (st_1 - st)) %>% 
  dplyr::mutate(bt_mean_diff = (bt_mean - bt)) %>% 
  dplyr::mutate(st_mean_diff = (st_mean - st)) 

temp2 <- dplyr::left_join(
  x = haul_maxyr, 
  y = station_info, 
  by = c("stratum", "stationid", "SRVY")) %>% 
  dplyr::filter(reg == "Norton Sound")

a <- summary(lm(haul_maxyr$surface_temperature ~ haul_maxyr$start_longitude))
temp3 <- ifelse(a$coefficients[2]<0 & a$coefficients[8] <= 0.05, "surface temperatures increased from east to west across the shelf, and ", "")

str0 <- paste0(
  "Sea surface temperatures recorded during the ", maxyr," ", SRVY,
  " survey ranged from ", 
  round(x = min(haul_maxyr$surface_temperature, na.rm = TRUE), digits = 1), "° to ", 
  round(x = max(haul_maxyr$surface_temperature, na.rm = TRUE), digits = 1),
  "°C and bottom temperatures ranged from ", 
  round(x = min(haul_maxyr$gear_temperature, na.rm = TRUE), digits = 1), "° to ", 
  round(x = max(haul_maxyr$gear_temperature, na.rm = TRUE), digits = 1),
  "°C. The mean sea surface temperature for the EBS in ", maxyr," was ", 
  round(x = temp$st, digits = 1),"°C, which was ", 
  round(x = temp$st_diff*ifelse(temp$st_diff > 0, 1, -1), digits = 1),"°C ", 
  ifelse((temp$st_diff > 0), "lower", "higher"),
  " than ", lastyr," (", 
  round(x = temp$st_1, digits = 1),"°C) and ", 
  round(x = temp$st_mean_diff*ifelse(temp$st_mean_diff > 0, 1, -1), digits = 1),"°C ", 
  ifelse((temp$st_mean_diff > 0), "lower", "higher"),
  " than the time-series mean (", round(x = temp$st_mean, digits = 1),"°C) (Figure ", 
  NMFSReports::crossref(list_obj = list_figures, 
                        nickname = c('fig_mean_temperature', 'fig_cold_pool_area', 'fig_st_maxyr'), 
                        sublist = 'number'),"). ", 
  ifelse(SRVY == "NEBS", 
         paste0("In the EBS south of 60°N, ", temp3,"an average of ", 
                round(x = mean(temp2$surface_temperature), digits = 1),
                "°C was observed in the NBS's Norton Sound (Figure ", 
                NMFSReports::crossref(list_obj = list_figures, 
                                      nickname = 'fig_st_maxyr', sublist = 'number'), 
                ")."), 
         ""))

str0 <- gsub(x = str0, pattern = ") (", replacement = "; ", fixed = TRUE)

```

`r str0 `

During the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"]`-year time series (`r haul_cruises_maxyr$SRVY_start[haul_cruises_maxyr$SRVY == "EBS"] `–`r maxyr`) of the annual EBS shelf bottom trawl survey, mean summer bottom temperatures were highly variable, ranging from a low of `r round(x = min(temps_avg_yr$bt), digits = 1)`°C to a high of `r round(x = max(temps_avg_yr$bt), digits = 1)`°C, with a grand mean for all years of `r round(x = min(temps_avg_yr$bt_mean[1]), digits = 1)`°C (Figure `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')`). The mean survey bottom temperature for the EBS in `r maxyr` was `r round(x = (temps_avg_yr_maxyr$bt), digits = 1)`°C (Figure `r crossref(list_obj = list_figures, nickname = 'fig_mean_temperature', sublist = 'number')`), which was `r round(x = abs(temp$bt_mean_diff), digits = 1) `°C `r ifelse(temps_avg_yr_maxyr$bt_above_mean, "warmer", "colder")` than the time-series mean.

The size of the cold pool each summer depends on sea ice coverage from the previous winter, the timing of its retreat during the spring and early summer, as well as other oceanographic and meteorological conditions [@RN941]. During the coldest years, sea ice extended farther south and lasted later into spring resulting in cold pools that extended farther south down the middle domain into Bristol Bay and near the Alaska Peninsula (Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_below', sublist = 'number')` and `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_above', sublist = 'number')`). Interannual variability in the dynamics of seasonal ice is a major environmental driver on the Bering Sea shelf [@RN930; @RN931; @RN932] that can change recruitment and migration patterns and cause major distributional shifts in groundfishes and crabs [@RN905; @RN913; @RN977]. 

```{r}
temp <- cold_pool_area %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(perc = sum(perc, na.rm = T), 
                   freq = sum(freq, na.rm = T)) %>% 
  dplyr::mutate(area_km2 = (perc/100) * 
                  sum(stratum_info %>% 
                        dplyr::filter(SRVY == "EBS") %>% 
                        dplyr::select(area_km2), na.rm = TRUE)) %>%
  dplyr::arrange((perc)) %>% 
  dplyr::mutate(rank = 1:nrow(.)) %>% 
  dplyr::arrange(desc(year))

```

During the last `r length(unlist(temps_avg_yr_abovebelow)[!is.na(unlist(temps_avg_yr_abovebelow))])` years, `r NMFSReports::range_text(x = temps_avg_yr_abovebelow$below)` were colder than average ("cold stanza"; Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_below', sublist = 'number')`), and `r NMFSReports::range_text(x = temps_avg_yr_abovebelow$above)` were warmer than average ("warm stanza"; Figure `r NMFSReports::crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_above', sublist = 'number')`). `r ifelse((maxyr>2020 & maxyr<(2021+length(unlist(temps_avg_yr_abovebelow)[!is.na(unlist(temps_avg_yr_abovebelow))]))), "There was no survey in 2020 due to the COVID-19 pandemic.", "")` The highly variable survey bottom temperatures in the EBS shelf are related to the area occupied by the summer cold pool (Figure `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`), defined by the extent of bottom temperatures below 2°C. Over the period of the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"] `-year time series, the areal coverage of the summer survey cold pool in the EBS varied in size from `r NMFSReports::xunits(min(temp$area_km2, na.rm = TRUE)) ` km^2^ in `r temp$year[temp$area_km2 == min(temp$area_km2, na.rm = TRUE)] ` to `r NMFSReports::xunits(max(temp$area_km2, na.rm = TRUE)) ` km^2^ in `r temp$year[temp$area_km2 == max(temp$area_km2, na.rm = TRUE)] `, respectively comprising `r round(temp$perc[temp$area_km2 == min(temp$area_km2, na.rm = TRUE)], digits = 1)`% to `r round(temp$perc[temp$area_km2 == max(temp$area_km2, na.rm = TRUE)], digits = 1)`% of EBS shelf area (Figure `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`). In `r maxyr`, the cold pool covered `r formatC(temp$area_km2[temp$year == maxyr], digits = 0, big.mark = ",", format = "f") ` km^2^ (`r round(temp$perc[temp$year == maxyr], digits = 1) `%) of the EBS shelf survey area, which was the `r NMFSReports::numbers2words_th(temp$rank[temp$year == maxyr])` lowest areal coverage in the `r haul_cruises_maxyr$yrofsurvey[haul_cruises_maxyr$SRVY == "EBS"] `-year EBS shelf time series.

> Liz - should this next paragraph be hand written? I suspect so :/ but I think we can also possibly restructure it and refold it into other paragraphs so we might not need to hand write it. 

The `r compareyr` and `r maxyr` `r NMFSReports::text_list(SRVY1)` surveys provided a synoptic view of the spatial pattern of bottom temperatures across the entire `r SRVY` shelf allowing comparisons of annual differences in demersal fauna distribution patterns and investigations of potential annual differences in fish migration pathways. The `r compareyr` cold pool was composed of colder water that occupied `r round(temp$perc[temp$year == compareyr], digits = 1) `% of the EBS shelf survey area (Figure `r crossref(list_obj = list_figures, nickname = 'fig_cold_pool_area', sublist = 'number')`) with < 1°C bottom temperatures extending north of St. Lawrence Island into Chirikov Basin, east to Nunivak Island, and south to the Alaska Peninsula (Figure `r crossref(list_obj = list_figures, nickname = 'fig_bt_timeseries_below', sublist = 'number')`). Cold water in the middle of the EBS can restrict marine fauna from moving east-west across the shelf or north-south along the inner domain.


```{r}
# insert <- readtext(file = paste0(dir_out_rawdata, "/doc_abstract_conclusion.docx"))
insert <- readtext2(file = paste0(dir_out_rawdata, "/0_cold_pool_description.docx"), 
                    refcontent = refcontent)
```

`r insert`

`r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_mean_temperature", sublist = "res") `

`r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_cold_pool_area", sublist = "res") `

`r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_st_maxyr", sublist = "res") `


> still need to add nbs to some plots

`r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_bt_timeseries_", sublist = "res", exact = FALSE) `

> need to cite this in the report (NEBS only) make sure nothing appears here in 2018 after this line

`r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_st_all_nebs_", sublist = "res", exact = FALSE) `

## Survey Data and Specimen Collections 

```{r}
temp0 <- function(cols, SRVY, report_spp1){
  nspec <- c()
  ntaxa <- c()
  ctaxa <- c()
  a <- report_spp1
  a$taxon[a$taxon == "invert" & 
            grepl(pattern = "crab", x = a$print_name)] <- "crab"
  
  for (i in 1:length(cols)){
    
    col <- cols[i]
    if (SRVY == "NEBS") {
      temp <- dplyr::bind_rows(
        list_tables$tab_specimen_samples_EBS$raw, 
        list_tables$tab_specimen_samples_NBS$raw)      
    } else {
      temp <- list_tables$tab_specimen_samples_EBS$raw      
    }
    
    temp <- temp[temp[,col]!=0,]
    
    nspec <- c(nspec, 
               xunits(sum(temp[temp$common_name == "Total", 
                               names(temp) %in% col]))) # how many specimen
    ntaxa <- c(ntaxa, 
               xunits(length(unique(temp$common_name)[unique(temp$common_name) != "Total"]))) # number of taxa
    
    ctaxa <- c(ctaxa,
               NMFSReports::text_list(unique(a$taxon[a$print_name %in% 
                                                       unique(temp$common_name)])) )
  }
  
  return(list("col" = tolower(cols), 
              "nspec" = nspec, 
              "ctaxa" = ctaxa, # kinds of taxa
              "ntaxa" = ntaxa))
}

cols <- names(list_tables$tab_specimen_samples_EBS$raw)
cols <- cols[!(cols %in% c("common_name", "SRVY"))]

# "", "stomachs collected"	count_pathobiology_samples	count_fecundity_and_maturity_(ovaries)_samples

temp <- temp0(cols, SRVY, a)

str0 <- paste0("Specifically, a total of ", NMFSReports::text_list(paste0(temp$nspec, " ", temp$col, " were collected from ", temp$ntaxa, " ", temp$ctaxa, ifelse(temp$ntaxa==1, " taxon", " taxa"))), ". ")

```

Many specimen samples were collected during the `r SRVY` shelf trawl survey (Table`r ifelse(SRVY == "NEBS", "s", "")` `r crossref(list_obj = list_tables, nickname = "tab_specimen_samples_", sublist = "number", exact = FALSE)`). `r str0` Other special collections are listed in table `r crossref(list_obj = list_tables, nickname = "tab_special_projects", sublist = "number")`. 

## Species Composition

```{r}
insert <- ""

# count spp
temp <- dplyr::left_join(
  x = catch_haul_cruises_maxyr %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct(), 
  y = spp_info %>% 
    dplyr::filter(used_in_counts) %>%
    dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon) %>%
    dplyr::distinct(), 
  by = "species_code") %>% 
  dplyr::filter(taxon == "fish") %>% 
  dplyr::select(species_code, species_taxon, family_taxon, genus_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(SRVY, species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(species_code = n()),
  by = "SRVY") %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
    dplyr::filter(!is.na(family_taxon)) %>% 
    dplyr::select(SRVY, family_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(family_taxon = n()),
  by = "SRVY")  %>% 
  dplyr::left_join(
    x = ., 
    y = temp %>% 
    dplyr::filter(!is.na(genus_taxon)) %>% 
    dplyr::select(SRVY, genus_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(genus_taxon = n()),
  by = "SRVY") #%>%
  # dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

temp1 <- dplyr::bind_cols(
  temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_code = n()), 
  temp %>% 
    dplyr::filter(!is.na(family_taxon)) %>% 
    dplyr::select(family_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(family_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(genus_taxon)) %>% 
    dplyr::select(genus_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(genus_taxon = n())) #%>% 
  # dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

if (SRVY == "NEBS") {
# how many species in one survey area but noth the other?

  temp3 <- list_tables$tab_species_composition$raw %>%
    dplyr::left_join(x = .,
                     y = spp_info %>%
                       dplyr::select(species_code, order_taxon, species_name),
                     by = c("species_code"))

  insert <- paste0( 
    "Of the fish species found in the EBS, ",
                   xunits(nrow(temp3[temp3$where == 
                                       "Present in EBS but absent in NBS",])), 
                   " did not occur in the NBS (Table ",
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"),
                   "). In comparison, ",
                   xunits(nrow(temp3[temp3$where == 
                                       "Present in NBS but absent in EBS",])), 
                   " present in NBS but absent in EBS (Table ", 
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"), "). ")
  
  # flatfish
  temp4 <- temp3[temp3$order_taxon %in% c("Pleuronectiformes"), ]
  temp5 <- temp4 %>% 
    dplyr::filter(where != "Present in EBS and NBS") %>% 
    dplyr::group_by(where) %>% 
    dplyr::summarise(n = n()) %>% 
    dplyr::mutate(where = paste0(tolower(substr(x = where, start = 1, stop = 1)), 
                                 substr(x = where, start = 2, stop = nchar(where))), 
                  including = NA)
  for (i in 1:nrow(temp5)) {
    temp5$including[i] <- 
      NMFSReports::text_list(
        paste0(
          temp4$common_name[grepl(pattern = temp5$where[i], 
                                  x = temp4$where, 
                                  ignore.case = TRUE)], 
          " (*", 
          temp4$species_name[grepl(pattern = temp5$where[i], 
                                   x = temp4$where, 
                                   ignore.case = TRUE)],
          "*)"))
  }
  
  insert <- paste0(insert, "In ", maxyr, ", ", 
                   
                   NMFSReports::text_list(
                     paste0(xunits(temp5$n), 
                            " flatfish species were ", 
                            temp5$where, " including ",
                            temp5$including )),
                   " (Table ", 
                   crossref(list_obj = list_tables, 
                            nickname = "tab_species_composition", 
                            sublist = "number"), ").")
}

insert <- gsub(pattern = ") (", replacement = "; ", x = insert, fixed = TRUE)

```

There were a total of `r xunits(temp1$species_code) ` different fish taxa representing `r xunits(temp1$family_taxon)` families and `r xunits(temp1$genus_taxon)` genera identified during the `r maxyr` `r SRVY` survey (`r ifelse(SRVY == "NEBS", "appendices", "appendix")` `r NMFSReports::crossref(list_tables, "tab_taxa_encountered_*_fish", "number", exact = FALSE)`). In `r maxyr`, `r NMFSReports::text_list(paste0("the ", temp0$SRVY, " had a total of ", xunits(temp0$species_code), " taxa of which ", xunits(temp0$species_taxon), " were identified to the species level"))`. The remaining fish taxa in each survey area were identified to the genus level or higher. `r insert `

```{r}
# if (SRVY == "NEBS") {
#   
#   temp0 <- list_tables$tab_species_composition$raw %>% 
#     dplyr::left_join(x = ., 
#                      y = spp_info %>% 
#                        dplyr::select(species_code, order_taxon, species_name), 
#                      by = c("species_code"))
#   
#   
#   insert <- paste0(#"The EBS had a total of ",
#                    #xunits(nrow(temp0[!is.na(temp0$EBS),])),
#                    #" fish species, ", 
#     "Of the fish species found in the EBS, ",
#                    xunits(nrow(temp0[temp0$where == 
#                                        "Present in EBS but absent in NBS",])), 
#                    " did not occur in the NBS (Table ",
#                    crossref(list_obj = list_tables, 
#                             nickname = "tab_species_composition", 
#                             sublist = "number"),
#                    "). In comparison, ",#had ",
#                    # xunits(nrow(temp0[!is.na(temp0$NBS),])),
#                    # " total fish species, ", 
#                    xunits(nrow(temp0[temp0$where == 
#                                        "Present in NBS but absent in EBS",])), 
#                    " present in NBS but absent in EBS (Table ", 
#                    crossref(list_obj = list_tables, 
#                             nickname = "tab_species_composition", 
#                             sublist = "number"), "). "#,
#                    ## 21 of the 21 species observed in the NBS during 2021 (Table 6) are only documented north of 60° N, which are generally corroborated in Mecklenburg, Mecklenburg, and Thorsteinson (2002).
#                    # xunits(nrow(temp0[temp0$where == 
#                    #                     "Present in NBS but absent in EBS" & 
#                    #                     temp0$NBS == TRUE,])),
#                    # " of the ", 
#                    # xunits(nrow(temp0[temp0$where == 
#                    #                     "Present in NBS but absent in EBS",])), 
#                    # " species observed in the NBS during ",maxyr," (Table ", 
#                    # crossref(list_obj = list_tables, 
#                    #          nickname = "tab_species_composition", 
#                    #          sublist = "number"), ") are only documented north of 60° N, which are generally corroborated in @RN912. "
#                    )
#   
#   # flatfish
#   temp1 <- temp0[temp0$order_taxon %in% c("Pleuronectiformes"), ]
#   temp2 <- temp1 %>% 
#     dplyr::filter(where != "Present in EBS and NBS") %>% 
#     dplyr::group_by(where) %>% 
#     dplyr::summarise(n = n()) %>% 
#     dplyr::mutate(where = paste0(tolower(substr(x = where, start = 1, stop = 1)), 
#                                  substr(x = where, start = 2, stop = nchar(where))), 
#                   including = NA)
#   for (i in 1:nrow(temp2)) {
#     temp2$including[i] <- 
#       NMFSReports::text_list(
#         paste0(
#           temp1$common_name[grepl(pattern = temp2$where[i], 
#                                   x = temp1$where, 
#                                   ignore.case = TRUE)], 
#           " (*", 
#           temp1$species_name[grepl(pattern = temp2$where[i], 
#                                    x = temp1$where, 
#                                    ignore.case = TRUE)],
#           "*)"))
#   }
#   
#   insert <- paste0(insert, "In ", maxyr, " there were ", 
#                    
#                    NMFSReports::text_list(
#                      paste0(xunits(temp2$n), 
#                             " flatfish species that were ", 
#                             temp2$where, " including ",
#                             temp2$including )),
#                    " (Table ", 
#                    crossref(list_obj = list_tables, 
#                             nickname = "tab_species_composition", 
#                             sublist = "number"), ").")
# }
```

<!-- `r insert` -->

```{r}
# count spp - invert
temp <- dplyr::left_join(
  x = catch_haul_cruises_maxyr %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct(), 
  y = spp_info %>% 
    dplyr::filter(used_in_counts) %>%
    dplyr::select(species_code, species_taxon, phylum_taxon, taxon) %>%
    dplyr::distinct(), 
  by = "species_code") %>% 
  dplyr::filter(taxon == "invert") %>% 
  dplyr::select(species_code, species_taxon, phylum_taxon, taxon, SRVY) %>% 
  dplyr::distinct()

temp0 <- dplyr::full_join(
  x = temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(SRVY, species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(species_taxon = n()),
  y = temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(SRVY, species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::group_by(SRVY) %>%
    dplyr::summarise(species_code = n()),
  by = "SRVY") %>% 
  dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

temp1 <- dplyr::bind_cols(
  temp %>% 
    dplyr::filter(!is.na(species_taxon)) %>% 
    dplyr::select(species_taxon) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_taxon = n()),
  temp %>% 
    dplyr::filter(!is.na(species_code)) %>% 
    dplyr::select(species_code) %>% 
    dplyr::distinct() %>% 
    dplyr::summarise(species_code = n())) %>% 
  dplyr::mutate(perc = round(((species_code - species_taxon)/species_code)*100, digits = 2))

```

A total of `r xunits(temp1$species_code) ` different invertebrate taxa representing `r xunits(temp1$species_taxon)` phyla were identified during the `r maxyr` `r SRVY` survey (`r ifelse(SRVY == "NEBS", "appendices", "appendix")` `r NMFSReports::crossref(list_tables, "tab_taxa_encountered_*_invertebrate", "number", exact = FALSE)`). In `r maxyr`, `r NMFSReports::text_list(paste0("the ", temp0$SRVY, " had a total of ", xunits(temp0$species_code), " taxa of which ", xunits(temp0$species_taxon), " were identified to the species level"))`. The remaining invertebrate taxa in each survey area were identified to the genus level or higher. The lack of species level identifications among invertebrates was due to a variety of factors that are outlined in @RN934.

```{r}
# All species are identified using as Eschmeyer’s Catalog of Fishes (found at https://www.calacademy.org/scientists/projects/eschmeyers-catalog-of-fishes) which is regularly updated [@Frickeetal2022] and An Annotated Checklist of the Marine Macroinvertebrates of Alaska [@Drummetal2016] and logged in AFSC’s databases.
```

`r list_tables$tab_species_composition$res `

## Total Biomass and Relative Biomass and Relative Abundance Catch per Unit Effort

```{r}
temp <- data.frame()
temp0 <- tidyr::crossing(SRVY = SRVY1, type = c("fish", "invert"))
for (i in 1:nrow(temp0)) {
  temp <- list_tables[names(list_tables) ==
                        paste0("tab_biomass_est_",temp0$type[i],"_", temp0$SRVY[i])][[1]]$raw %>%
    dplyr::mutate(SRVY = temp0$SRVY[i]) %>%
    dplyr::filter(grepl(pattern = "Total ", x = group, ignore.case = TRUE )) %>% 
    dplyr::select(SRVY, group, `999`) %>% 
    dplyr::bind_rows(temp, .)
}

temp2 <- dplyr::left_join(
  x = temp, 
  y = total_biomass %>% 
    dplyr::group_by(SRVY),
  by = "SRVY") %>% 
  dplyr::mutate(
    prop = (`999`/total), 
    perc = paste0(formatC(x = prop*100, 
                          digits = 0, format = "f", big.mark = ","), 
                  "%"), 
    group = gsub(pattern = "Total ", replacement = "", x = group)) %>% 
  tidyr::pivot_wider(id_cols = "SRVY", 
                     names_from = "group", 
                     values_from = c("999", "perc", "prop"))

temp1 <- left_join(
  x = temp, 
  y = stratum_info %>% 
    dplyr::group_by(SRVY) %>% 
    dplyr::summarise(area = sum(area, na.rm = TRUE)), 
  by = "SRVY") %>% 
  dplyr::mutate(prop = `999`/area, 
                group = gsub(pattern = "Total ", replacement = "", x = group)) %>% 
  dplyr::filter(group == "fish")

str0 <- paste0("The ", 
               NMFSReports::text_list(paste0(
                 "total demersal animal biomass for the ", 
                 total_biomass$SRVY, 
                        " was estimated at ", 
                        NMFSReports::xunits(total_biomass$total), 
                        " metric tons (t)")), ". ", 
               "In the ", NMFSReports::text_list(
                 paste0(temp2$SRVY, 
                        ", the proportion of fishes (", 
                        temp2$perc_fish, 
                        "; ", crossref(list_obj = list_tables, 
                                       nickname = paste0("tab_biomass_est_fish_", temp2$SRVY), 
                                       sublist = "number"), 
                        ") was ", 
                        ifelse(temp2$prop_fish>temp2$prop_invertebrates, "higher","lower"),
                        " than invertebrates (", 
                        temp2$perc_invertebrates, 
                        "; ", crossref(list_obj = list_tables, 
                                       nickname = paste0("tab_biomass_est_invert_", temp2$SRVY), 
                                       sublist = "number"), 
                        ")")), ". ")

if (SRVY == "NEBS") {
  str0 <- paste0(str0, 
                 paste0(ifelse(temp1$prop[temp1$SRVY=="EBS"]>temp1$prop[temp1$SRVY=="NBS"], 
                               "The lower fish biomass in the NBS than in the EBS is consistent", 
                               "The higher fish biomass in the NBS than in the EBS is inconsistent"), 
                        " with results of a broader analysis of all survey years in @RN936 showing decreasing fish biomass with increasing latitude on the Bering Sea continental shelf (Tables ", 
                        NMFSReports::text_list(crossref(list_obj = list_tables, 
                                       nickname = "tab_biomass_est_fish_", 
                                       sublist = "number", 
                                 exact = FALSE)),").", 
                        "") ) 
}

str0 <- gsub(pattern = ") (", replacement = "; ", x = str0, fixed = TRUE)

```

`r str0 `

```{r}
if (SRVY == "NEBS") {
  
  #temp1
  temp1 <- data.frame()
  for (i in 1:length(SRVY1)) {
    
    temp1 <- list_tables[names(list_tables) ==
                           paste0("tab_biomass_est_fish_", SRVY1[i])][[1]]$raw %>%
      dplyr::mutate(SRVY = SRVY1[i]) %>%
      dplyr::filter(is.na(taxon) |
                      grepl(pattern = "Total ", x = taxon, ignore.case = TRUE )) %>% 
      dplyr::filter(!grepl(pattern = "Total ", x = group, ignore.case = TRUE ) &
                      !grepl(pattern = "Other ", x = group, ignore.case = TRUE )) %>% 
      dplyr::select(SRVY, group, `999`, prop) %>% 
      dplyr::arrange(-prop) %>% 
      dplyr::mutate(order = 1:nrow(.)) %>% 
      dplyr::bind_rows(temp1, .)
  }
  
  temp1 <- temp1 %>% 
    tidyr::pivot_wider(id_cols = c("group"), 
                       names_from = "SRVY", 
                       values_from = c("999", "prop", "order")) %>%
    dplyr::mutate(same =ifelse(order_EBS == order_NBS, TRUE, FALSE))
  
  # temp2
  temp2 <- data.frame()
  
  for (i in 1:length(SRVY1)) {
    
    temp2 <- list_tables[names(list_tables) ==
                           paste0("tab_biomass_est_fish_", SRVY1[i])][[1]]$raw %>%
      dplyr::mutate(SRVY = SRVY1[i]) %>%
      dplyr::filter(group %in% temp1$group[1:2] & 
                      !grepl(pattern = "Total ", x = taxon, ignore.case = TRUE )) %>% 
      dplyr::select(SRVY, group, taxon, `999`, prop) %>% 
      dplyr::arrange(-prop) %>% 
      dplyr::mutate(order = 1:nrow(.)) %>% 
      dplyr::bind_rows(temp2, .)
  }
  
  temp2 <- temp2 %>% 
    tidyr::pivot_wider(id_cols = c("group", "taxon"), 
                       names_from = "SRVY", 
                       values_from = c("999", "prop", "order")) %>%
    dplyr::mutate(same =ifelse(order_EBS == order_NBS, TRUE, FALSE)) %>% 
    dplyr::left_join(
      x = ., 
      y = spp_info_maxyr %>% 
        dplyr::select(species_name, common_name), 
      by = c("taxon" = "common_name")
    )
  
  # temp3: top 3 spp in each group
  temp3 <- data.frame()
  temp0 <- tidyr::crossing(group = unique(temp2$group), 
                           SRVY = SRVY1) %>% 
    dplyr::arrange(SRVY, group) %>% 
    dplyr::mutate(str0 = NA)
  
  for (i in 1:nrow(temp0)) {
    temp3 <- temp2 %>% 
      dplyr::rename(prop = paste0("prop_", temp0$SRVY[i]), 
                    order = paste0("order_", temp0$SRVY[i])) %>%
      dplyr::filter(#order %in% c(1:3) & 
        group == temp0$group[i]) %>% 
      head(3) %>%
      dplyr::mutate(prop = paste0(round(x = prop*100, digits = 1), "%"), 
                    SRVY = temp0$SRVY[i]) %>%
      dplyr::arrange(order) %>% 
      dplyr::select(SRVY, group, taxon, species_name, prop) %>% 
      dplyr::filter(prop != "0%")
    # dplyr::bind_rows(temp3, .)
    
    if (nrow(temp3)>1) {
      temp0$str0[temp0$SRVY == temp0$SRVY[i] & temp0$group == temp0$group[i]] <- 
        NMFSReports::text_list(paste0(temp3$taxon, " (*", temp3$species_name, 
                                      "*, ",temp3$prop,")"))
      temp0$group1 <- unlist(regmatches(temp0$group,
                                        gregexpr(
                                          "(?<=\\().*?(?=\\))", # everything within a (*)
                                                 temp0$group, perl=T)))
      temp0$group0 <- unlist(lapply(strsplit(x = temp0$group, split = " ", fixed = TRUE), `[[`, 1))
      # temp0$group0 <- temp$group
    }
  }
  
  temp0$group0 <- paste0("the family ", temp0$group0)
  
  temp0$str0 <- gsub(pattern = "*NA*, ", replacement = "", x = temp0$str0, fixed = TRUE)
  temp0$str0 <- gsub(pattern = "  ", replacement = " ", x = temp0$str0, fixed = TRUE)
  
  temp3 <- c()
  for (i in 1:length(SRVY1)){
    temp4 <- NMFSReports::text_list(paste0(
                             temp0$group0[temp0$SRVY == SRVY1[i]], 
                             " was majoritarily comprised of ", 
                             temp0$str0[temp0$SRVY == SRVY1[i]]))
    temp3 <- paste0(temp3, 
                    paste0("In the ", SRVY1[i], " ", 
                           substr(temp4, start = 1, stop = (nchar(temp4)-1)), # get rid of last ")" 
                           "; ", 
                           NMFSReports::crossref(list_obj = list_tables, sublist = "number", 
                                                 nickname = "tab_biomass_est_fish_", exact = FALSE), 
                           "). "))
  }
  
  str0 <- paste0(
    "The biomass of ",
    NMFSReports::text_list(temp1$group[1:2]),
    " were the greatest in both the EBS (",
    NMFSReports::text_list(
      paste0(round(x = temp1$prop_EBS[1:2]*100, digits = 1), "%")), 
    " of the total biomass, respectively) and NBS (",
    NMFSReports::text_list(
      paste0(round(x = temp1$prop_NBS[1:2]*100, digits = 1), "%")), 
    " of the total biomass, respectively; ", 
    NMFSReports::crossref(list_obj = list_tables, sublist = "number", nickname = "tab_biomass_est_fish_EBS"), 
    " and ", 
    NMFSReports::crossref(list_obj = list_tables, sublist = "number", nickname = "tab_biomass_est_fish_NBS"), "). ", 
    temp3)
  
  
  # In the EBS, there were 15 different flatfish species that together comprised almost half of the total fish biomass (48%) with yellowfin sole (22%) and northern rock sole (11%) having the greatest proportions. This contrasted with the NBS where there were twelve flatfish species with yellowfin sole (15%) and Alaska plaice (12%) making up a majority of the total fish biomass. 
  
  # redundant - species composition
  # Four flatfish species that were present in the EBS were absent from catches in the NBS including arrowtooth flounder, butter sole (Isopsetta isolepis), rex sole (Glyptocephalus zachirus) and southern rock sole (Table 4). One flatfish species, the Arctic flounder (Liopsetta glacialis), was only present in the NBS.
  
}

```

`r str0 ` 

```{r}

str0 <- paste0("There were noticeable changes in the benthic community of the ",
               NMFSReports::text_list(SRVY1)," between ", compareyr," and ", maxyr,". ")

for (i in 1:length(SRVY1)) {
  
  temp0 <- list_tables[names(list_tables) %in% paste0("tab_majortaxa_pchange_", SRVY1[i])][[1]]$raw

  temp <- dplyr::bind_rows(
    temp0 %>%
      dplyr::rename("maxyr" = paste0(maxyr), 
                    "compareyr" = paste0(compareyr)) %>%
      dplyr::select(print_name, maxyr, compareyr, change),
    temp0 %>%
      dplyr::select(-print_name, -change) %>% 
      dplyr::rename("maxyr" = paste0(maxyr, " "), 
                    "compareyr" = paste0(compareyr, " "), 
                    "print_name" = "print_name ", 
                    "change" = "change ") %>%
      dplyr::select(print_name, maxyr, compareyr, change)
    ) %>% 
    dplyr::filter(!is.na(change)) %>% 
    dplyr::mutate(case = case_when(
                      change>0 ~ "increased", 
                      change<0 ~ "decreased")) %>% 
    dplyr::arrange(-change)
  
  temp <-  
    dplyr::bind_rows(
      temp %>% 
        dplyr::filter(case == "increased") %>% 
        head(5), 
      temp %>% 
        dplyr::filter(case == "decreased") %>% 
        tail(5)
    )

  temp1 <- data.frame(maxyr = sum(biomass_maxyr$biomass[biomass_maxyr$SRVY == SRVY1[i]]), 
                      compareyr = sum(biomass_compareyr$biomass[biomass_compareyr$SRVY == SRVY1[i]]))
  
  
str0 <- paste0(str0, 

               "The total estimated biomass in the ",SRVY1[i]," ", 
               ifelse(temp1$compareyr<temp1$maxyr, "increased", "decreased"),
               " from ",
               NMFSReports::xunits(temp1$compareyr)," t in ", compareyr," to ",
               NMFSReports::xunits(temp1$maxyr)," t in ", maxyr, ". ", 

               # taxa increased
               "Taxa that significantly increased included ", 
               NMFSReports::text_list(paste0(temp$print_name[temp$case == "increased"],
                                             " (", formatC(x = temp$change[temp$case == "increased"], 
                                                           digits = 0, format = "f", big.mark = ","), "%)")), 
               " (Table ",
               NMFSReports::crossref(list_obj = list_tables, 
                                     nickname = paste0("tab_majortaxa_pchange_", SRVY1[i]), sublist = "number"),
               "). ",
               # taxa decreased
               "Large decreases in biomass were observed for ", 
               NMFSReports::text_list(paste0(temp$print_name[temp$case == "decreased"],
                                             " (", formatC(x = temp$change[temp$case == "decreased"], 
                                                           digits = 0, format = "f", big.mark = ","), "%)")), 
               " (Table ",
               NMFSReports::crossref(list_obj = list_tables, 
                                     nickname = paste0("tab_majortaxa_pchange_", SRVY1[i]), sublist = "number"),
               "). "
               # something else
               # "Although there were large percentage increases in biomass for many invertebrate taxa, there was relatively little change in the combined total biomass of invertebrates (-0.2 million t) compared to 2010 (Table ",
               # NMFSReports::crossref(list_obj = list_tables, 
               #                       nickname = "tab_majortaxa_pchange_NBS", sublist = "number"),
               # "). "
               )

}
```

> took out the "driven by" because complicated to calculate and not as obvious in more recent years?

`r str0`

> Why 12? changed it to 10 because it felt more natural

> shouldnt we use kg/km2

> couldn't recreate values

```{r}
temp <- data.frame()
for (i in 1:nrow(haul_cruises_maxyr)) {
  temp <- list_tables$tab_estimates_maxyr_spp_wt$raw %>% 
    dplyr::filter(SRVY == haul_cruises_maxyr$SRVY[i]) %>%
    dplyr::select(meanwgtcpue , print_name) %>%
    dplyr::arrange(-meanwgtcpue) %>% 
    dplyr::ungroup() %>% 
    head(10) %>% 
    dplyr::summarise(meanwgtcpue = sum(meanwgtcpue, na.rm = TRUE)) %>% 
    dplyr::mutate(SRVY = haul_cruises_maxyr$SRVY[i], 
                  taxon = "topfish") %>% 
    dplyr::bind_rows(temp, .)
}  
  
  temp <- biomass %>% 
    dplyr::filter(year == maxyr & 
                   stratum == 999) %>%
    dplyr::select(meanwgtcpue, SRVY, taxon) %>% 
  dplyr::group_by(SRVY, taxon) %>% 
  dplyr::summarise(meanwgtcpue = sum(meanwgtcpue, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
    dplyr::bind_rows(temp, .) %>% 
    pivot_wider(data = ., id_cols = "SRVY", names_from = taxon, values_from = meanwgtcpue ) %>% 
    dplyr::mutate(all = fish + invert, 
                  top_fish = paste0(round(x = (topfish/fish)*100, digits = 0), "%"), 
                top_all = paste0(round(x = (topfish/(all))*100, digits = 0), "%"), 
                across(where(is.numeric), format, digits = 0, trim = F, big.mark = ",", scientific = F))
# temp[,1:4]<-NMFSReports::mod_number(x = temp[,1:4], comma_seperator = T, digits = 0)
# temp[,2:5] <- format(temp[,2:5], digits = 0, trim = F, big.mark = ",", scientific = F)

str0 <- NMFSReports::text_list(paste0(
  "The top 10 fish taxa in the ",temp$SRVY,
  " accounted for ",temp$top_all,
  " (an average of ",temp$topfish," kg/ha per station) ", 
  "of total mean fish and invertebrate CPUE (an average of ",
  temp$all," kg/ha per station) and ",
  temp$top_fish," of total mean fish CPUE (an average of ",temp$fish,
  " kg/ha per station; Table ", NMFSReports::crossref(
    list_obj = list_tables, 
    nickname = "tab_estimates_maxyr_spp_wt",
    sublist = "number"), ")."))

# str0 <- gsub(pattern = ")(", replacement = "; ", x = str0, fixed = TRUE)

```

`r str0 `

```{r}
# str0 <- ""
# if (SRVY == "NEBS"){
#   
#   #NBS
#   temp1 <- 
#     list_tables$tab_majortaxa_pchange_NBS$raw %>% 
#       dplyr::select(all_of("species_name1 "), all_of(paste0(maxyr, " "))) %>% 
#       dplyr::mutate(SRVY = "NBS") %>% 
#     dplyr::rename(biomass = paste0(maxyr, " "), 
#                   name = "species_name1 ") %>% 
#     dplyr::arrange(-biomass) %>%
#     dplyr::mutate(order = 1:nrow(.))
#   
#   # EBS
#   temp2 <- list_tables$tab_majortaxa_pchange_EBS$raw %>% 
#       dplyr::select(all_of("species_name1 "), all_of(paste0(maxyr, " "))) %>% 
#       dplyr::mutate(SRVY = "EBS") %>% 
#       dplyr::rename(biomass = paste0(maxyr, " "), 
#                   name = "species_name1 ") %>% 
#       dplyr::arrange(-biomass) %>%
#     dplyr::mutate(order = 1:nrow(.))
# 
#   temp3 <- temp1 %>% 
#     dplyr::filter(name %in% c(temp2$name[1], temp1$name[1]))
#   
#   temp4 <- temp2 %>% 
#     dplyr::filter(name %in% c(temp2$name[1], temp1$name[1]))
#     
#   str0 <- 
# }
# 
# In addition to the discussion for the major fish species below, it is important to highlight: Unlike the EBS, saffron cod (Eleginus gracilis), was among the 12 most abundant fish species in the NBS, and Arctic cod (Boreogadus saida) was the 18th most abundant. For a descending rank of all organisms caught, see `r ifelse(SRVY == "NEBS", "appendices", "appendix")` `r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_taxa_encountered_*_fish", sublist = "number", exact = FALSE)`.


```


```{r}
# <!-- The abundance of walleye pollock was relatively high in the `r SRVY ` middle and outer shelf compared to the inner shelf and in the NBS where bottom depths are generally less than 50 m (Figure `r ifelse(SRVY == "NEBS", crossref(list_obj = list_tables, nickname = "tab_biomass_est_fish_NBS", sublist = "number"), "") `). Unlike the `r SRVY `, saffron cod (*Eleginus gracilis*), was among the 12 most abundant fish species in the NBS, and Arctic cod (*Boreogadus saida*) was the 18th most abundant. For a descending rank of all organisms caught, see `r crossref(list_obj = list_tables, nickname = "tab_taxa_encountered_EBS_fish", sublist = "number")``r ifelse(SRVY == "NEBS", paste0(" (EBS) and ", crossref(list_obj = list_tables, nickname = "tab_taxa_encountered_EBS_fish", sublist = "number"), " (NBS)"), "") `. -->
  
# This trend was similarly true in the NBS where the proportion of fishes (63%; Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_fish_NBS", sublist = "number")`) was greater than invertebrates (37%; Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_invert_NBS", sublist = "number")`). Pleuronectids dominated the fish biomass in both the EBS (6.0 million t) and NBS (0.9 million t), and gadids were the second most abundant fish group in both areas. Walleye pollock were the most abundant gadid in both the `r SRVY ` and NBS (Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_fish_EBS", sublist = "number")` and 6a). Echinoderms and crustaceans were the major invertebrate taxa comprising 16% of the total animal biomass in the `r SRVY ` (Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_invert_EBS", sublist = "number")`) and 25% in the NBS (Table `r crossref(list_obj = list_tables, nickname = "tab_biomass_est_invert_NBS", sublist = "number")`).
```


`r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_biomass_est_", sublist = "res", exact = FALSE) `

`r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_majortaxa_pchange_", sublist = "res", exact = FALSE) `

`r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_estimates_maxyr_spp_", sublist = "res", exact = FALSE)`

## Summary of Results for Selected eastern Bering Sea and northern Bering Sea Fish and Invertebrate Fauna

> links may not be true for much longer - hopefully DisMP will come to the rescue!

An interactive map of CPUE by species overlaid with temperature data for the `r maxyr` `r NMFSReports::text_list(SRVY1)` surveys, as well as for all other AFSC bottom trawls surveys, can be found at https://www.afsc.noaa.gov/RACE/groundfish/survey_data/default.htm. The CPUE data with associated station information including position, surface and bottom temperatures, and bottom depth can be downloaded from https://www.fisheries.noaa.gov/alaska/commercial-fishing/alaska-groundfish-bottom-trawl-survey-data.


### Spatial Distribution and Abundance, Size Compositions and Biomass and Population Estimates of Selected Fish

```{r}
# major fish 
temp0 <- report_spp1 %>% 
  dplyr::filter(taxon == "fish" & 
                  text_spp == TRUE) %>% 
  dplyr::select(file_name, print_name) %>% 
  dplyr::distinct()

  # compile
temp <- c()
for (i in 1:nrow(temp0)) {
  temp <- c(temp, 
                 paste0(
  temp0$print_name[i], " (Figure",
  ifelse(length(NMFSReports::crossref(list_obj = list_figures, 
                      nickname = paste0("fig_idw_cpue_*_",temp0$file_name[i], "*"), 
                      sublist = "number", exact = FALSE, text = FALSE))>1, "s", ""),
  " ", 
  NMFSReports::crossref(list_obj = list_figures, 
                        nickname = paste0("fig_idw_cpue_*_",temp0$file_name[i], "*"), 
                        sublist = "number", exact = FALSE),
  " and Tables ",
  NMFSReports::crossref(list_obj = list_tables, 
                        nickname = paste0("tab_estimates_maxyr_*_",temp0$file_name[i],"_*"), 
                        sublist = "number", exact = FALSE), 
  ")"))
}
str0 <- NMFSReports::text_list(temp)

# not major fish
temp2 <- report_spp1 %>% 
  dplyr::filter(taxon == "fish" &
                  (isFALSE(text_spp) | is.na(text_spp))) %>% 
  dplyr::select(file_name, print_name) %>% 
  dplyr::distinct()

```

Plots of the broad spatial distribution patterns and tables of relative biomass (kg/hectare) and relative abundance (no./hectare) for `r length(NMFSReports::crossref(list_obj = list_figures, nickname = "fig_idw_cpue_fish_", sublist = "number", exact = FALSE, text = FALSE)) ` major fish species (Figures `r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_idw_cpue_fish_", sublist = "number", exact = FALSE) ` and Tables `r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_estimates_maxyr_fish_", sublist = "number", exact = FALSE)`) caught during the `r NMFSReports::text_list(SRVY1)` continental shelf are presented in the subsections below. Additionally total abundance-at-length and mean length estimates for major fish species (Figures `r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_sizecomp_fish_", sublist = "number", exact = FALSE) `)

Survey results for major fish fauna are presented in maps of geographic distribution and abundance, plots of total abundance-at-size, and tables with estimates of biomass and population number (Table `r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_estimates_maxyr_spp_", sublist = "number", exact = FALSE)`). Major species presented include `r str0`. Mean CPUE by weight and number, as well as maps of geographic distribution, for many other species are also included (Tables `r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_majortaxa_pchange_", sublist = "number", exact = FALSE)` and Figures `r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_idw_cpue_fish_", sublist = "number", exact = FALSE)`). Appendices `r NMFSReports::crossref(list_tables, "tab_principal_fish_", "number", exact = FALSE)` contain population estimates by sex and size class for all `r nrow(temp0)` of these fish species. 

### Spatial Distribution of Selected Invertebrates

```{r}
# invert 
temp0 <- report_spp1 %>% 
  dplyr::filter(taxon == "invert") %>% 
  dplyr::select(file_name, print_name) %>% 
  dplyr::distinct()

```

Plots of the broad spatial distribution patterns and tables of relative biomass (kg/hectare) and relative abundance (no./hectare) for `r length(NMFSReports::crossref(list_obj = list_figures, nickname = "fig_idw_cpue_invert_", sublist = "number", exact = FALSE, text = FALSE)) ` major invertebrate species (Figures `r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_idw_cpue_invert_", sublist = "number", exact = FALSE) ` and Tables `r NMFSReports::crossref(list_obj = list_tables, nickname = "tab_estimates_maxyr_invert_", sublist = "number", exact = FALSE)`) caught during the `r NMFSReports::text_list(SRVY1)` continental shelf are presented in the subsections below. 

```{r}
if (SRVY == "NEBS") {
  temp <- dplyr::bind_rows(
    list_tables$tab_majortaxa_pchange_EBS$raw, 
    list_tables$tab_majortaxa_pchange_NBS$raw) 
} else {
  temp <- list_tables$tab_majortaxa_pchange_EBS$raw
}
  temp <- temp %>% 
    dplyr::select(print_name, species_name1, paste(maxyr)) %>% 
    dplyr::rename(bio = paste0(maxyr)) %>%
    dplyr::group_by(print_name, species_name1) %>% 
    dplyr::summarise(bio = sum(bio, na.rm = TRUE)) %>% 
    dplyr::ungroup() %>%
    dplyr::filter(!is.na(bio) &
                    bio == max(bio, na.rm = TRUE))

if (length(unique(temp$print_name))==1) {
  
  temp0 <- paste0("tab_estimates_maxyr_invert_",report_spp1$file_name[report_spp1$print_name == temp$print_name[1]],"_wt")
  
  temp1 <- list_tables[names(list_tables) %in% temp0][[1]]$raw %>% 
    dplyr::select(SRVY, stratum, meanwgtcpue) %>% 
    dplyr::filter(!grepl(pattern = "Total", x = stratum, ignore.case = TRUE) & 
                  meanwgtcpue == max(meanwgtcpue, na.rm = TRUE)) %>% 
    dplyr::left_join(x = ., 
                     y = stratum_info %>% 
                       dplyr::select(stratum, description) %>% 
                       dplyr::mutate(stratum = as.character(stratum)), 
                     by = "stratum") %>% 
    dplyr::mutate(tidyr::separate(data = ., col = description, 
                                          sep = "- ", into = c("d1", "d2"), 
                                          remove = TRUE), 
                  d2 = stringr::str_to_lower(d2), 
                  d2 = gsub(pattern = "domain", replacement = "shelf", x = d2)) 

  str0 <- paste0("The ",temp$print_name[1],", (*",temp$species_name1[1],"*), is common in the Bering ",
                 ifelse(temp$species_name1[1] == "Asterias amurensis", 
                        "and Chukchi Seas [@Hamazakietal2005; @Federetal2005]", "") , 
                 " and it was the invertebrate taxon with the highest ranked catch rate by weight in the " , 
                 NMFSReports::text_list(SRVY1)," (Table",ifelse(SRVY == "NEBS", "s", "")," ",
                 NMFSReports::crossref(list_obj = list_tables, nickname = "tab_majortaxa_pchange_", sublist = "number", exact = FALSE),
                 "). Catch rates for the ",temp$print_name[1]," were highest in the ",
                 temp1$d2," (",temp1$d1,
                 "; Figure ", 
                 NMFSReports::crossref(list_obj = list_figures, nickname = temp0, sublist = "number"), 
                 "and Table ", 
                 NMFSReports::crossref(list_obj = list_tables, 
                                       nickname = paste0("fig_idw_cpue_invert_",report_spp1$file_name[report_spp1$print_name == temp$print_name[1]]), 
                                       sublist = "number"),").")
  
} else {
  str0<-""
}
  
```

`r str0 `

Figures `r NMFSReports::crossref(list_obj = list_figures, nickname = "fig_idw_cpue_*_crab", sublist = "number", exact = FALSE) ` show the shelf-wide distributions of the four major commercial crab species: blue king crab (*Paralithodes platypus*), red king crab (*Paralithodes camtschaticus*), snow crab (*Chionoecetes opilio*), and Tanner crab (*Chionoecetes bairdi*). Commercial crab stocks are managed by the ADF&G with federal oversight by NMFS. For more detailed information on bottom trawl survey results for commercial crab refer to @RNChilton2011 and @RN973, and for the most recent modeling data on the status of these commercial crab stocks, refer to the annual Stock Assessment and Fishery Evaluation report prepared by the NPFMC.

## Summary of Results for Selected `r NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)` Fish and Invertebrate Fauna

