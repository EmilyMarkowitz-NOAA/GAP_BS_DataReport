
```{r}

figtab <- dplyr::case_when(
  grepl(pattern = "fig-", x = nickname) ~ "fig", 
  grepl(pattern = "tab-", x = nickname) ~ "tab"
)

dir0 <- ifelse(figtab == "fig", dir_out_figures, dir_out_tables)

a <- list.files(path = dir0, 
                pattern = nickname, 
                full.names = FALSE)

nickname0 <- gsub(pattern = ".rdata", 
                  replacement = "", 
                  x = a[grepl(pattern = ".rdata", x = a)], 
                  ignore.case = TRUE)

src <- list()
for(i in 1:length(nickname0)){
  nickname00 <- nickname0[i]
  path <- paste0(dir0, nickname00, ".Rdata", collapse = "")
  if (figtab == "tab"){
    load(path) 
    caption <- obj$caption
  } else if (figtab == "fig") {
    caption <- readtext(file = paste0(dir_out_figures, nickname00, ".txt"))$text
    img <- magick::image_read(path = paste0(dir_out_figures, nickname00, ".png")) # read the image using the magic library
    img.asp <- image_info(img)$height / image_info(img)$width # calculate the figures aspect ratio
    fig.width = 6.5
  }
  src[[i]] <- knitr::knit_expand(file = paste0(dir_code, '_child_report_',figtab,'.Rmd'))
}

res <- knitr::knit_child(text = paste0(unlist(src), collapse = ""), quiet = TRUE)
cat(res, sep = '\n')

```
