---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

# Introduction

> edit notes: 
> need to update [@RN956]
> in 2018, can't calculate 49 stations: length(unique(haul_cruises_maxyr$stationid[haul_cruises_maxyr$SRVY %in% "NBS"]))

```{r fig_sample_grid}
header <- paste0("Sampling grid and station identifiers for the ", maxyr, " eastern and northern Bering Sea continental shelf bottom trawl surveys.")
footnote<- NA
nickname <- "fig_sample_grid"
alttext <- paste0(header)
width = 6
height = 6
usePNGPDF = "png"

# Select data and make plot

# placenames <- reg_dat$place.labels %>% 
#   dplyr::filter(!(lab %in% c("Pribilof Isl.", "St. Matthew")))

survey_reg_col <- gray.colors(length(unique(haul_cruises_maxyr$SRVY))+2)
survey_reg_col <- survey_reg_col[-((length(survey_reg_col)-1):length(survey_reg_col))]

figure <- ggplot() +
  # geom_sf(data = reg_dat$bathymetry, color = "grey50") +
  geom_sf(data = reg_dat$survey.strata, fill = NA, color = "grey50") +
  geom_sf(data = reg_dat$graticule,
          color = "grey90",
          alpha = 0.5) +
  geom_sf(data = reg_dat$survey.area, 
          aes(color = reg_dat$survey.area$SURVEY), 
          fill = NA, 
          size = 2,
          show.legend = TRUE) +
  scale_color_manual(
    name = "", #"Survey Region",
    values = c(alpha(survey_reg_col, 0.7)),
    breaks = rev(unique(reg_dat$survey.area$SURVEY)), #TOLEDO rev
    labels = rev(unique(stringr::str_to_title(haul_cruises_maxyr$SRVY_long))))  +
  ggplot2::guides(
    shape = guide_legend(
      order = 1, # vessels
      override.aes = list(#fill = "white", 
        linetype = c("blank"))), 
    colour = guide_legend( 
      order = 2,# survey regions
      override.aes = list(fill = "white",
                          color = survey_reg_col,
                          size = 2)), 
    fill = guide_legend( 
      order = 3,# survey regions
      override.aes = list(
                          color = NA,
                          size = 2))
      ) +
  geom_sf(data = reg_dat$akland, color = NA, fill = "grey80") +
  geom_sf(data = reg_dat$survey.grid, color = "grey20", fill = NA) +
  geom_sf_text(data = reg_dat$survey.grid, 
               lineheight = 0.7,
               mapping = aes(label = gsub(x = STATIONID, 
                                          replacement = "\n", 
                                          pattern = "-")),
               color = "black",
               size = 1.3,
               show.legend = FALSE) +
  coord_sf(xlim = reg_dat$plot.boundary$x, 
           ylim = reg_dat$plot.boundary$y) +
  scale_x_continuous(name = "Longitude", 
                     breaks = reg_dat$lon.breaks) + 
  scale_y_continuous(name = "Latitude", 
                     breaks = reg_dat$lat.breaks) +
  geom_text(data = subset(reg_dat$place.labels, type == "mainland"), 
            aes(x = x, y = y, label = lab), 
            size = 14, group = 99) + 
  geom_shadowtext(data = subset(reg_dat$place.labels, type == "peninsula"), 
                  aes(x = x, y = y, label = lab), size = 5, angle = 40, 
                  bg.color = "white", color = "black", group = 99) + 
  geom_shadowtext(
    data = subset(reg_dat$place.labels, type %in% c("bathymetry", "islands")),
    aes(x = x, y = y, label = lab), 
    bg.color = "white", color = "black", 
    size = 2, group = 99) +
  ggsn::scalebar(data = reg_dat$survey.grid, 
                 location = "bottomright",
                 dist = 100, 
                 dist_unit = "km", 
                 transform = FALSE, 
                 st.dist = .02, 
                 height = 0.02, 
                 st.bottom = TRUE, 
                 st.size = 3, 
                 # transform = TRUE, 
                 model = reg_dat$crs) +
  #set legend position and vertical arrangement
  # theme_bw()  +
  theme(#plot.background = element_rect(fill = "white"), 
    panel.background = element_rect(fill = "white", 
                                    colour = NA), 
    panel.border = element_rect(fill = NA, 
                                colour = "grey20"), 
    strip.background = element_rect(fill = "grey85", 
                                    colour = "grey20"),
    legend.spacing.y = unit(-0.35, "cm"),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 7),
    # strip.background = element_rect(color = NA, fill = NA, size = 0),
    legend.background = element_rect(colour = "transparent", fill = "transparent"),
    legend.key = element_rect(colour = "transparent", 
                              fill = "transparent"),
    legend.position = c(.15, .22),
    # legend.justification = c("right"),
    legend.box.just = "left",
    # legend.margin = margin(6, 6, 6, 6), 
    legend.box = "vertical"
  )


# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

assign(value = res, x = nickname)

```


> this plot seems more relevant to the intro or results, not history or methods

> How do I know what stations were retowed?

```{r fig_sampled_survey_stations}
header <- paste0("Sampled survey stations by vessel and the stratification scheme used for data analysis of ",maxyr," ",NMFSReports::text_list(haul_cruises_maxyr$SRVY_long)," continental shelf bottom trawl surveys.")
footnote<- NA
nickname <- "fig_sampled_survey_stations"
alttext <- paste0(header, "The map also depicts the stations sampled by each survey vessel and where, if any, Norton Sound crab resampling was done.")
width = 6
height = 6
usePNGPDF = "png"

# Select data and make plot

survey_reg_col <- gray.colors(length(unique(reg_dat$survey.area$SURVEY))+2)
survey_reg_col <- survey_reg_col[-((length(survey_reg_col)-1):length(survey_reg_col))]

vess_stat <- 
  dplyr::left_join(x = haul_maxyr, 
                   y = vessel_info) %>% 
  st_as_sf(., coords = c("start_longitude","start_latitude"), crs = 4326) %>% 
  st_transform(., reg_dat$crs)

crab_resample <- TRUE
study1530 <- TRUE

# TOLEDO - made these up!
reg_dat$survey.grid$study <- sample(x = c("crab_resample", "study1530", ""), 
                                    size = length(reg_dat$survey.grid$STATIONID),
                                    replace = TRUE)

figure <- ggplot() 
  
if (crab_resample == TRUE | study1530 == TRUE) {
  
  survey.grid0 <- 
    dplyr::left_join(x = reg_dat$survey.grid, 
                     y = data.frame(
                       survey_study_col = c("white", nmfs_cols("medgreen"), nmfs_cols("processblue")), 
                       study = c("", "crab_resample", "study1530"), 
                       study_long = c("No additional Study", "Red King Crab Resample", 
                                      "15/30 minute Tow Study")), 
                     by = "study")
  figure <- figure +
    geom_sf(data = survey.grid0, 
            mapping  = aes(fill = study), alpha = .2,
            color = NA,
            size = .2) +
    scale_fill_manual(
      name = "", #"Additional Study",
      values = alpha(unique(survey.grid0$survey_study_col), 0.7),
      breaks = (unique(survey.grid0$study)), #TOLEDO rev
      labels = (unique(survey.grid0$study_long)))  

# } else {
  
}  
  
figure <- figure + 
  geom_sf(data = reg_dat$bathymetry, color = "grey50") +
  geom_sf(data = reg_dat$survey.strata, fill = NA, color = "grey50") +
  geom_sf(data = reg_dat$graticule,
          color = "grey90",
          alpha = 0.5) +
  geom_sf(data = vess_stat, 
          mapping = aes(shape = factor(vess_shape)), 
          size = 1.5, 
          show.legend = TRUE) + 
  scale_shape_manual(
    name = "", #"Survey Vessels",
    values = sort(unique(vess_stat$vess_shape)),
    breaks = sort(unique(vess_stat$vess_shape)), 
    labels = gsub(x = sort(unique(vess_stat$vessel_name)), 
                  pattern = "\\*\\*", replacement = "")) +
  geom_sf(data = reg_dat$survey.area, 
          aes(color = reg_dat$survey.area$SURVEY), 
          fill = NA, 
          size = 2,
          show.legend = TRUE) +
  scale_color_manual(
    name = "", #"Survey Region",
    values = c(alpha(survey_reg_col, 0.7)),
    breaks = rev(unique(reg_dat$survey.area$SURVEY)), #TOLEDO rev
    labels = rev(unique(stringr::str_to_title(haul_cruises_maxyr$SRVY_long))))  +
  geom_sf_text(data = reg_dat$survey.strata, 
               lineheight = 0.7,
               mapping = aes(label = reg_dat$survey.strata$Stratum),
               color = "black",
               size = 5,
               show.legend = FALSE) +
  ggplot2::guides(
    shape = guide_legend(
      order = 1, # vessels
      override.aes = list(#fill = "white", 
        linetype = c("blank"))), 
    colour = guide_legend( 
      order = 2,# survey regions
      override.aes = list(fill = "white",
                          color = survey_reg_col,
                          size = 2)), 
    fill = guide_legend( 
      order = 3,# survey regions
      override.aes = list(
                          color = NA,
                          size = 2))
      ) +
  geom_sf(data = reg_dat$akland, color = NA, fill = "grey80") +
  coord_sf(xlim = reg_dat$plot.boundary$x, 
           ylim = reg_dat$plot.boundary$y) +
  scale_x_continuous(name = "Longitude", 
                     breaks = reg_dat$lon.breaks) + 
  scale_y_continuous(name = "Latitude", 
                     breaks = reg_dat$lat.breaks) +
  geom_text(data = subset(reg_dat$place.labels, type == "mainland"), 
            aes(x = x, y = y, label = lab), 
            size = 14, group = 99) + 
  geom_shadowtext(data = subset(reg_dat$place.labels, type == "peninsula"), 
                  aes(x = x, y = y, label = lab), size = 5, angle = 40, 
                  bg.color = "white", color = "black", group = 99) + 
  geom_shadowtext(
    data = subset(reg_dat$place.labels, type %in% c("bathymetry", "islands")),
    aes(x = x, y = y, label = lab), 
    bg.color = "white", color = "black", 
    size = 2, group = 99) +
  # ggsn::north(data = reg_dat$survey.grid, 
  #             symbol = 10, 
  #             location = "topright") +
  ggsn::scalebar(data = reg_dat$survey.grid, 
                 location = "bottomright",
                 dist = 100, 
                 dist_unit = "km", 
                 transform = FALSE, 
                 st.dist = .02, 
                 height = 0.02, 
                 st.bottom = TRUE, 
                 st.size = 3, 
                 # transform = TRUE, 
                 model = reg_dat$crs) +
  #set legend position and vertical arrangement
  # theme_bw()  +
  theme(#plot.background = element_rect(fill = "white"), 
    panel.background = element_rect(fill = "white", 
                                    colour = NA), 
    panel.border = element_rect(fill = NA, 
                                colour = "grey20"), 
    strip.background = element_rect(fill = "grey85", 
                                    colour = "grey20"),
    legend.spacing.y = unit(-0.35, "cm"),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 7),
    # strip.background = element_rect(color = NA, fill = NA, size = 0),
    legend.background = element_rect(colour = "transparent", fill = "transparent"),
    legend.key = element_rect(colour = "transparent", 
                              fill = "transparent"),
    legend.position = c(.15, .22),
    # legend.justification = c("right"),
    legend.box.just = "left",
    # legend.margin = margin(6, 6, 6, 6), 
    legend.box = "vertical"
  )

# save yo' stuff and do a lot of behind the scenes work
# alt: this does the same thing as calling "child = " in the chunk header
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = system.file("rmd/_child_save_fig.Rmd", 
                       package = "NMFSReports")), 
  quiet = TRUE
)

assign(value = res, x = nickname)

```

```{r}
surv_insert1 <- paste0(ifelse(length(haul_cruises_maxyr$SRVY_long)>1, xunits(length(haul_cruises_maxyr$SRVY_long)), "a"), 
       ' contiguous bottom trawl ', 
       ifelse(length(haul_cruises_maxyr$SRVY_long)>1, 'surveys', 'survey'),
       ' on the Bering Sea continental shelf: ', 
              text_list(paste0('the ',haul_cruises_maxyr$yrofsurvey ,haul_cruises_maxyr$stndth, ' "',haul_cruises_maxyr$SRVY_long,'" (',haul_cruises_maxyr$SRVY,') survey')), '. ')

surv_insert2 <- ""
if (sum(haul_cruises_maxyr$SRVY %in% "EBS")>0) {
  surv_insert2 <- paste0(surv_insert2, 
                         'EBS in an annual time series that began in 1982 [@RN976]. ')
}

if (sum(haul_cruises_maxyr$SRVY %in% "NBS")>0) {
  surv_insert2 <- paste0(surv_insert2,
                         'NBS has only been conducted since 2010 [@RN909]. ')
  if (maxyr >= 2018 & maxyr > 2021) {
      surv_insert2 <- paste0(surv_insert2,
  'In 2018, the "Northern Bering Sea Rapid Response" (NBS) survey was conducted for the first time in response to warmer than average seafloor water temperatures and changes in historical fish and invertebrate distribution patterns observed during the NBS survey [@RN909]. The NBS standardized 20 x 20 nautical mile (nmi) sampling grid and survey station plan implemented in 2010 and 2017 was reduced in scope and resolution for 2018 to a 30 x 30 nmi grid and the survey extent was reduced by eliminating sampling in Norton Sound and near the Alaska coastline from near Nome, AK south towards Nunivak Island, AK (Figure ', crossref(list_obj = list_figures, nickname = "fig_sample_grid", sublist = "number"),').') 
      
      haul_cruises_maxyr %>% 
        dplyr::filter(SRVY %in% "NBS")
      
      length(unique(haul_cruises_maxyr$stationid[haul_cruises_maxyr$SRVY %in% "NBS"]))
      
    if (maxyr == 2018) {
      surv_insert2 <- paste0(surv_insert2,
  'The modified station grid resulted in 49 northern Bering Sea stations for sampling in ', maxyr,'. The NBS is a region of critical importance for increased scientific monitoring because it is a transitional zone between the NBS and Arctic Ocean that is transforming with the changing climate [@RN923]. In this document, we provide snapshots of survey results from 2018 for the NBS and rapid response NBS and compare NBS results with those from previous years.')
    }

  }
}

```

In `r maxyr`, the National Marine Fisheries Service’s (NMFS) Resource Assessment and Conservation Engineering (RACE) Division of the Alaska Fisheries Science Center (AFSC) conducted `r surv_insert1`


`r surv_insert2` Both bottom trawl surveys are mission critical to the AFSC because the results are critical to managing fisheries resources, monitoring the ecosystem, and providing a valuable data time-series for doing basic fisheries research. Fishery-independent abundance estimates and other biological and oceanographic information from Bering Sea bottom trawl surveys are used by the AFSC, North Pacific Fishery Management Council (NPFMC) and the Alaska Department of Fish and Game (ADF&G) to manage groundfish and crab stocks and to do ecosystem forecast modeling that are requirements of the Bering Sea and Aleutian Island (BSAI) Fishery Management Plan (FMP) established under the Magnuson-Stevens Fishery Conservation and Management Act. 


> **Moved the below paragraph from history section**

> add notes on retow and 15/30 studys mentioned in (Figure `r crossref(list_obj = list_figures, nickname = "fig_sample_grid", sublist = "number") `)

In this document, we will compare the `r NMFSReports::text_list(x = paste0(maxyr, " ", haul_cruises_maxyr$SRVY, " survey results with those from the ", haul_cruises_maxyr$compareyr, " ", haul_cruises_maxyr$SRVY, " survey [", haul_cruises_maxyr$compareyr_ref, "]"))`. `r ifelse(SRVY == "NEBS", paste0("To simplify the results and discussion from here forward, the terms “EBS” and “NBS” will be used to refer specifically to either the eastern or northern Bering Sea bottom trawl survey area, respectively, and “NEBS” will be used when referring to the combined EBS and NBS survey areas. The combined ", maxyr, ' NEBS survey will be comapred with the ', min(haul_cruises_maxyr$compareyr) ," NEBS survey [", haul_cruises_maxyr$compareyr_ref[haul_cruises_maxyr$SRVY == "NBS"], "]."), "")` For survey results referenced from previous surveys herein, the reader should refer to the AFSC Technical Memoranda cited here.

Good management of fisheries resources and a healthy ecosystem are especially important to the Alaska Native communities as a way of life and to the tens of thousands of people who are employed by the Alaska fishing industry that generates billions of dollars for the U.S. economy.


`r fig_sample_grid `

`r fig_sampled_survey_stations `

